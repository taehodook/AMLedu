<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìˆ˜ê°• ëŒ€ì‹œë³´ë“œ â€” KASG LMS</title>
<link rel="stylesheet" href="css/main.css">
<style>
body{background:#ECEAE4;min-height:100vh}

/* â”€â”€ í—¤ë” ì¹© â”€â”€ */
.grade-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:12px;font-size:11px;font-weight:700}
.grade-board  {background:rgba(200,150,10,.18);color:var(--kasg-gold);border:1px solid rgba(200,150,10,.3)}
.grade-aml    {background:rgba(26,62,160,.18);color:#6B9DFF;border:1px solid rgba(100,150,255,.25)}
.grade-general{background:rgba(255,255,255,.12);color:rgba(255,255,255,.8);border:1px solid rgba(255,255,255,.2)}
.grade-research{background:rgba(200,48,42,.15);color:#FF8A85;border:1px solid rgba(200,48,42,.2)}

/* â”€â”€ íˆì–´ë¡œ â”€â”€ */
.dash-hero{background:var(--navy);padding:18px 28px 16px;border-bottom:3px solid var(--kasg-gold)}
.hero-top{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.hero-welcome{font-family:'Noto Serif KR',serif;font-size:17px;font-weight:700;color:#fff}
.hero-meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.hero-chip{display:flex;align-items:center;gap:5px;background:rgba(255,255,255,.07);padding:3px 10px;border-radius:12px;color:rgba(255,255,255,.65);font-size:11px}

/* â”€â”€ íƒ­ â”€â”€ */
.dash-tabs{display:flex;background:#fff;border-bottom:2px solid var(--border);padding:0 24px}
.dash-tab{padding:11px 16px;font-size:12.5px;font-weight:600;color:var(--text-mid);cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .15s;display:flex;align-items:center;gap:6px;white-space:nowrap}
.dash-tab:hover{color:var(--navy)}
.dash-tab.active{color:var(--navy);border-bottom-color:var(--kasg-gold)}
.dash-tab .tab-badge{background:var(--kasg-red);color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:8px;min-width:14px;text-align:center}

/* â”€â”€ ì½˜í…ì¸  ì˜ì—­ â”€â”€ */
.dash-body{max-width:1000px;margin:0 auto;padding:22px 20px}
.tab-pane{display:none}
.tab-pane.active{display:block}

/* â”€â”€ ê°•ì˜ ì¹´ë“œ â”€â”€ */
.course-card{background:#fff;border-radius:var(--radius-lg);overflow:hidden;display:flex;border-left:5px solid var(--kasg-gold);box-shadow:var(--shadow-sm);transition:transform .15s,box-shadow .15s;cursor:pointer;margin-bottom:10px}
.course-card:last-child{margin-bottom:0}
.course-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.course-thumb{width:72px;flex-shrink:0;background:linear-gradient(135deg,var(--navy),var(--navy-mid));display:flex;align-items:center;justify-content:center;font-size:26px}
.course-body{flex:1;padding:12px 14px;min-width:0}
.course-title{font-family:'Noto Serif KR',serif;font-size:13.5px;font-weight:700;color:var(--navy);margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.course-tags{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:7px}
.c-tag{padding:2px 7px;background:var(--cream);border-radius:9px;font-size:10px;color:var(--text-mid)}
.c-prog{display:flex;align-items:center;gap:8px}
.prog-pct{font-size:11px;font-weight:600;color:var(--navy);min-width:28px}
.course-action{padding:12px;display:flex;align-items:center;flex-shrink:0}

/* â”€â”€ ê°•ì˜ ì‹ ì²­ â”€â”€ */
.apply-card{background:#fff;border-radius:var(--radius-lg);overflow:hidden;border:1.5px solid var(--border);box-shadow:var(--shadow-sm);margin-bottom:10px;transition:border-color .15s}
.apply-card:hover{border-color:var(--navy)}
.apply-card-body{display:flex;align-items:center;gap:14px;padding:13px 16px}
.apply-thumb{width:54px;height:54px;border-radius:var(--radius);background:linear-gradient(135deg,var(--navy),var(--navy-mid));display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.apply-info{flex:1;min-width:0}
.apply-title{font-family:'Noto Serif KR',serif;font-size:13px;font-weight:700;color:var(--navy);margin-bottom:3px}
.apply-meta{font-size:11px;color:var(--text-mid)}
.apply-btn{padding:7px 16px;border-radius:var(--radius);font-size:12px;font-weight:600;cursor:pointer;border:1.5px solid var(--navy);background:var(--navy);color:#fff;transition:all .13s;white-space:nowrap;flex-shrink:0}
.apply-btn:hover{background:var(--navy-mid)}
.apply-btn.applied{background:rgba(12,31,63,.06);color:var(--text-mid);border-color:var(--border);cursor:default}
.apply-btn.approved{background:rgba(16,185,129,.1);color:var(--success);border-color:var(--success);cursor:default}

/* â”€â”€ ì‹ ì²­ í˜„í™© ë±ƒì§€ â”€â”€ */
.status-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:9px;font-size:10.5px;font-weight:600}
.sb-pending {background:#FEF3C7;color:#7A4F00}
.sb-approved{background:#D1FAE5;color:var(--success)}
.sb-rejected{background:#FEE2E2;color:var(--error)}
.sb-assigned{background:rgba(26,62,160,.1);color:#1A3EA0}

/* â”€â”€ ìˆ˜ë£Œ í˜„í™© â”€â”€ */
.cert-card{background:#fff;border-radius:var(--radius-lg);padding:14px 18px;box-shadow:var(--shadow-sm);border-left:4px solid var(--kasg-gold);margin-bottom:10px;display:flex;align-items:center;gap:16px}
.cert-icon{font-size:28px;flex-shrink:0}
.cert-info{flex:1}
.cert-title{font-family:'Noto Serif KR',serif;font-size:13.5px;font-weight:700;color:var(--navy)}
.cert-meta{font-size:11px;color:var(--text-mid);margin-top:3px}
.cert-score{font-size:18px;font-weight:700;color:var(--success);flex-shrink:0}

/* â”€â”€ ì‚¬ì´ë“œ í˜„í™© â”€â”€ */
.dash-layout{display:grid;grid-template-columns:1fr 260px;gap:18px}
@media(max-width:780px){.dash-layout{grid-template-columns:1fr}}
.my-status{background:#fff;border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-sm);position:sticky;top:16px}
.my-status-hd{background:var(--navy);padding:11px 15px;font-size:12.5px;font-weight:700;color:#fff;font-family:'Noto Serif KR',serif}
.status-rows{padding:10px 15px}
.s-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(0,0,0,.05);font-size:12px}
.s-row:last-child{border-bottom:none}
.s-key{color:var(--text-mid)}
.s-val{font-weight:600;color:var(--text)}
.cert-cta{background:linear-gradient(135deg,var(--kasg-gold),#DAA010);border-radius:var(--radius-lg);padding:15px;text-align:center;cursor:pointer;transition:transform .15s;box-shadow:0 4px 14px rgba(200,150,10,.28);margin-top:12px}
.cert-cta:hover{transform:translateY(-2px)}
.cert-cta .icon{font-size:24px;margin-bottom:4px}
.cert-cta .t{font-family:'Noto Serif KR',serif;font-size:13px;font-weight:700;color:var(--navy)}
.cert-cta .s{font-size:10px;color:rgba(12,31,63,.65);margin-top:1px}

/* â”€â”€ ë¹ˆ ìƒíƒœ â”€â”€ */
.empty-state{background:#fff;border-radius:var(--radius-lg);padding:40px 24px;text-align:center;box-shadow:var(--shadow-sm)}
.empty-icon{font-size:36px;margin-bottom:10px}
.empty-title{font-family:'Noto Serif KR',serif;font-size:15px;font-weight:700;color:var(--navy);margin-bottom:6px}
.empty-sub{font-size:12px;color:var(--text-mid);line-height:1.7}

/* â”€â”€ ì•ˆë‚´ ê°€ì´ë“œ â”€â”€ */
.guide{background:#fff;border-radius:var(--radius-lg);padding:13px 15px;box-shadow:var(--shadow-sm);margin-top:12px}
.guide-t{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:8px}
.guide-step{display:flex;align-items:flex-start;gap:7px;font-size:11px;color:var(--text-mid);padding:3px 0;line-height:1.5}
.step-n{width:16px;height:16px;border-radius:50%;background:var(--navy);color:#fff;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;flex-shrink:0;margin-top:1px}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-brand">
    <img class="header-logo-img" src="assets/logo-wide.png" alt="KASG">
  </div>
  <div class="header-nav">
    <div class="header-chip" id="hd-chip">ğŸ‘¤</div>
    <button class="header-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<!-- íˆì–´ë¡œ -->
<div class="dash-hero">
  <div class="hero-top">
    <div class="hero-welcome" id="hero-welcome">í™˜ì˜í•©ë‹ˆë‹¤!</div>
  </div>
  <div class="hero-meta">
    <div class="hero-chip">ğŸ“… <span id="hero-date"></span></div>
    <div class="hero-chip">ğŸ¯ ìˆ˜ë£Œê¸°ì¤€: 70ì  ì´ìƒ</div>
    <div class="hero-chip" id="grade-chip"></div>
  </div>
</div>

<!-- íƒ­ ë©”ë‰´ -->
<div class="dash-tabs">
  <div class="dash-tab active" onclick="switchTab('courses')" id="dtab-courses">ğŸ“š ë‚´ ê°•ì˜</div>
  <div class="dash-tab" onclick="switchTab('apply')"   id="dtab-apply">ğŸ“‹ ê°•ì˜ ì‹ ì²­ <span class="tab-badge" id="apply-cnt" style="display:none">0</span></div>
  <div class="dash-tab" onclick="switchTab('status')"  id="dtab-status">â³ ì‹ ì²­ í˜„í™© <span class="tab-badge" id="status-cnt" style="display:none">0</span></div>
  <div class="dash-tab" onclick="switchTab('certs')"   id="dtab-certs">ğŸ† ìˆ˜ë£Œ í˜„í™© <span class="tab-badge" id="certs-cnt" style="background:var(--success);display:none">0</span></div>
</div>

<!-- íƒ­ ë³¸ë¬¸ -->
<div class="dash-body">
  <div class="dash-layout">
    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div>

      <!-- â‘  ë‚´ ê°•ì˜ -->
      <div class="tab-pane active" id="pane-courses">
        <div id="course-list" style="display:flex;flex-direction:column">
          <div style="text-align:center;padding:40px;color:var(--text-light)">
            <div class="spinner" style="margin:0 auto 10px"></div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>
      </div>

      <!-- â‘¡ ê°•ì˜ ì‹ ì²­ -->
      <div class="tab-pane" id="pane-apply">
        <div id="apply-list">
          <div style="text-align:center;padding:40px;color:var(--text-light)">
            <div class="spinner" style="margin:0 auto 10px"></div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>
      </div>

      <!-- â‘¢ ì‹ ì²­ í˜„í™© -->
      <div class="tab-pane" id="pane-status">
        <div id="apply-status-list">
          <div style="text-align:center;padding:40px;color:var(--text-light)">
            <div class="spinner" style="margin:0 auto 10px"></div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>
      </div>

      <!-- â‘£ ìˆ˜ë£Œ í˜„í™© -->
      <div class="tab-pane" id="pane-certs">
        <div id="cert-list">
          <div style="text-align:center;padding:40px;color:var(--text-light)">
            <div class="spinner" style="margin:0 auto 10px"></div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>
      </div>

    </div>

    <!-- ì‚¬ì´ë“œë°” -->
    <div>
      <div class="my-status">
        <div class="my-status-hd">ğŸ“Š ë‚´ í•™ìŠµ í˜„í™©</div>
        <div class="status-rows">
          <div class="s-row"><span class="s-key">ë°°ì • ê°•ì˜</span><span class="s-val" id="st-assigned">-</span></div>
          <div class="s-row"><span class="s-key">ìˆ˜ë£Œ ì™„ë£Œ</span><span class="s-val" id="st-done">-</span></div>
          <div class="s-row"><span class="s-key">ì‹ ì²­ ê°•ì˜</span><span class="s-val" id="st-applied">-</span></div>
          <div class="s-row"><span class="s-key">ìˆ˜ê°•ìƒ ë“±ê¸‰</span><span class="s-val" id="st-grade">-</span></div>
          <div class="s-row"><span class="s-key">ì†Œì†</span><span class="s-val" id="st-org" style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">-</span></div>
        </div>
      </div>

      <div class="cert-cta" id="cert-cta" style="display:none" onclick="window.location.href='certificate.html'">
        <div class="icon">ğŸ†</div>
        <div class="t">ìˆ˜ë£Œì¦ ë°œê¸‰</div>
        <div class="s">í´ë¦­í•˜ì—¬ ìˆ˜ë£Œì¦ í™•ì¸Â·ì¶œë ¥</div>
      </div>

      <div class="guide">
        <div class="guide-t">ğŸ“‹ ìˆ˜ê°• ì ˆì°¨</div>
        <div class="guide-step"><div class="step-n">1</div><span>ê°•ì˜ ì‹ ì²­ íƒ­ì—ì„œ ì›í•˜ëŠ” ê°•ì˜ ì‹ ì²­</span></div>
        <div class="guide-step"><div class="step-n">2</div><span>ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë‚´ ê°•ì˜ì— í‘œì‹œ</span></div>
        <div class="guide-step"><div class="step-n">3</div><span>ì˜ìƒ ì‹œì²­ í›„ ì¤‘ê°„ í€´ì¦ˆ í†µê³¼</span></div>
        <div class="guide-step"><div class="step-n">4</div><span>ìµœì¢… í‰ê°€ 70ì  ì´ìƒ â†’ ìˆ˜ë£Œ</span></div>
      </div>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script type="module">
import { DB } from './js/firebase-config.js';
import { requireAuth, fmtDate, showToast } from './js/utils.js';

const user = requireAuth(); if (!user) throw 0;

const GRADE_LABELS  = { board:'ì´ì‚¬íšŒÂ·ì„ì›', aml:'AML ë‹´ë‹¹ì', general:'ì¼ë°˜', research:'ì—°êµ¬íšŒ' };
const GRADE_ICONS   = { board:'ğŸ›', aml:'ğŸ”', general:'ğŸ‘¤', research:'ğŸ“' };
const GRADE_CLASSES = { board:'grade-board', aml:'grade-aml', general:'grade-general', research:'grade-research' };

document.getElementById('hd-chip').innerHTML =
  `ğŸ‘¤ ${user.name} <span class="grade-pill ${GRADE_CLASSES[user.grade]||'grade-general'}" style="margin-left:5px">${GRADE_ICONS[user.grade]||'ğŸ‘¤'} ${GRADE_LABELS[user.grade]||'ì¼ë°˜'}</span>`;
document.getElementById('hero-welcome').textContent = `ì•ˆë…•í•˜ì„¸ìš”, ${user.name}ë‹˜ ğŸ‘‹`;
document.getElementById('hero-date').textContent    = fmtDate(new Date());
document.getElementById('grade-chip').textContent   = `${GRADE_ICONS[user.grade]||'ğŸ‘¤'} ${GRADE_LABELS[user.grade]||'ì¼ë°˜'}`;
window.logout = () => { sessionStorage.removeItem('kasg_user'); window.location.href='index.html'; };

// â”€â”€ íƒ­ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TABS = ['courses','apply','status','certs'];
window.switchTab = function(t) {
  TABS.forEach(id => {
    document.getElementById(`dtab-${id}`).classList.toggle('active', id===t);
    document.getElementById(`pane-${id}`).classList.toggle('active', id===t);
  });
};

// â”€â”€ ë°ì´í„° ìºì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allCourses={}, learner={}, courseApplies=[];

// â”€â”€ ì´ˆê¸° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  [allCourses, learner] = await Promise.all([
    DB.get('courses').then(d=>d||{}),
    DB.get(`learners/${user.id}`).then(d=>d||{})
  ]);
  // courseApplies: learner.courseApplies = { courseId: {status, appliedAt} }
  courseApplies = learner.courseApplies || {};

  updateSidebar();
  renderCourses();
  renderApply();
  renderApplyStatus();
  renderCerts();
}

// â”€â”€ ì‚¬ì´ë“œë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSidebar() {
  const assigned = (learner.assignedCourses||[]).length;
  const doneCount = Object.values(learner.courseStatus||{}).filter(s=>s==='completed').length;
  const appliedCount = Object.keys(courseApplies).length;
  document.getElementById('st-assigned').textContent = assigned + 'ê°œ';
  document.getElementById('st-done').textContent     = doneCount + 'ê°œ';
  document.getElementById('st-applied').textContent  = appliedCount + 'ê°œ';
  document.getElementById('st-grade').textContent    = learner.gradeLabel || GRADE_LABELS[user.grade] || 'ì¼ë°˜';
  document.getElementById('st-org').textContent      = learner.org || user.org;
  if (doneCount > 0) document.getElementById('cert-cta').style.display='';

  // ë°°ì§€
  const pendingApplies = Object.values(courseApplies).filter(a=>a.status==='pending').length;
  const cntEl = document.getElementById('status-cnt');
  if (pendingApplies > 0) { cntEl.textContent=pendingApplies; cntEl.style.display=''; }
  if (doneCount > 0) { document.getElementById('certs-cnt').textContent=doneCount; document.getElementById('certs-cnt').style.display=''; }
}

// â”€â”€ â‘  ë‚´ ê°•ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCourses() {
  const assigned = learner.assignedCourses || [];
  const listEl   = document.getElementById('course-list');
  if (!assigned.length) {
    listEl.innerHTML = `<div class="empty-state">
      <div class="empty-icon">ğŸ“­</div>
      <div class="empty-title">ë°°ì •ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤</div>
      <div class="empty-sub">ã€Œê°•ì˜ ì‹ ì²­ã€ íƒ­ì—ì„œ ì›í•˜ëŠ” ê°•ì˜ë¥¼ ì‹ ì²­í•˜ë©´<br>ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>`; return;
  }
  const arr = assigned.map(id=>allCourses[id]?{id,...allCourses[id]}:null).filter(Boolean);
  listEl.innerHTML = arr.map(c => {
    const cp  = learner.courseProgress?.[c.id] || 0;
    const cs  = learner.courseStatus?.[c.id]   || 'new';
    const pct = Math.round(cp*100);
    const badge = cs==='completed'
      ? '<span class="badge badge-success">âœ… ìˆ˜ë£Œ</span>'
      : cs==='in_progress'||cs==='watched'
      ? '<span class="badge badge-warn">â–¶ ìˆ˜ê°• ì¤‘</span>'
      : '<span class="badge badge-neutral">ğŸ†• ë¯¸ì‹œì‘</span>';
    const btnLbl = cs==='completed'?'ì¬ìˆ˜ê°•':cs==='in_progress'||cs==='watched'?'ì´ì–´ë³´ê¸°':'ìˆ˜ê°• ì‹œì‘';
    const btnCls = cs==='completed'?'btn-outline':'btn-primary';

    // ìˆ˜ê°•ê¸°í•œ
    const dl = learner.courseDeadlines?.[c.id];
    let dlBadge = '';
    if (dl) {
      const today=new Date(); today.setHours(0,0,0,0);
      const due=new Date(dl); due.setHours(0,0,0,0);
      const diff=Math.round((due-today)/86400000);
      if (cs!=='completed') {
        if (diff<0)       dlBadge=`<span class="c-tag" style="background:#FEE2E2;color:var(--error);font-weight:700">â›” ê¸°í•œë§Œë£Œ</span>`;
        else if (diff===0) dlBadge=`<span class="c-tag" style="background:#FEE2E2;color:var(--error);font-weight:700">ğŸ”´ ì˜¤ëŠ˜ë§ˆê°</span>`;
        else if (diff<=5)  dlBadge=`<span class="c-tag" style="background:#FEF3C7;color:#7A4F00;font-weight:700">âš ï¸ D-${diff}</span>`;
        else               dlBadge=`<span class="c-tag" style="color:var(--text-light)">ğŸ“… ${dl} ê¹Œì§€</span>`;
      }
    }
    return `<div class="course-card" onclick="goCourse('${c.id}')">
      <div class="course-thumb">ğŸ¬</div>
      <div class="course-body">
        <div class="course-title">${c.title}</div>
        <div class="course-tags">
          <span class="c-tag">ğŸ• ${c.duration||'?'}ì‹œê°„</span>
          <span class="c-tag">ğŸ“‹ ${c.examCount||20}ë¬¸í•­</span>
          ${badge}${dlBadge}
        </div>
        <div class="c-prog">
          <div style="flex:1"><div class="progress-wrap" style="height:4px"><div class="progress-fill" style="width:${pct}%"></div></div></div>
          <span class="prog-pct">${pct}%</span>
        </div>
      </div>
      <div class="course-action">
        <button class="btn ${btnCls} btn-sm" onclick="event.stopPropagation();goCourse('${c.id}')">${btnLbl}</button>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ â‘¡ ê°•ì˜ ì‹ ì²­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderApply() {
  const listEl = document.getElementById('apply-list');
  const courses = Object.entries(allCourses);
  if (!courses.length) {
    listEl.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‚</div><div class="empty-title">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>`;
    return;
  }
  const assigned = new Set(learner.assignedCourses||[]);
  let availCnt = 0;
  listEl.innerHTML = courses.map(([id, c]) => {
    const appStatus = courseApplies[id]?.status;
    const isAssigned = assigned.has(id);
    let btnHtml='', statusHtml='';
    if (isAssigned) {
      btnHtml = `<span class="apply-btn approved">âœ… ìˆ˜ê°• ì¤‘</span>`;
      statusHtml = `<span class="status-badge sb-assigned">ë°°ì •ì™„ë£Œ</span>`;
    } else if (appStatus==='pending') {
      btnHtml = `<span class="apply-btn applied">â³ ìŠ¹ì¸ ëŒ€ê¸°</span>`;
      statusHtml = `<span class="status-badge sb-pending">ì‹ ì²­ì™„ë£Œ</span>`;
    } else if (appStatus==='approved') {
      btnHtml = `<span class="apply-btn approved">âœ… ìŠ¹ì¸ë¨</span>`;
      statusHtml = `<span class="status-badge sb-approved">ìŠ¹ì¸ì™„ë£Œ</span>`;
    } else if (appStatus==='rejected') {
      btnHtml = `<button class="apply-btn" onclick="applyCourse('${id}')">ğŸ”„ ì¬ì‹ ì²­</button>`;
      statusHtml = `<span class="status-badge sb-rejected">ë°˜ë ¤ë¨</span>`;
    } else {
      availCnt++;
      btnHtml = `<button class="apply-btn" onclick="applyCourse('${id}')">ì‹ ì²­í•˜ê¸°</button>`;
    }
    return `<div class="apply-card">
      <div class="apply-card-body">
        <div class="apply-thumb">ğŸ¬</div>
        <div class="apply-info">
          <div class="apply-title">${c.title}</div>
          <div class="apply-meta">ğŸ• ${c.duration||'?'}ì‹œê°„ &nbsp;Â·&nbsp; ğŸ“‹ ${c.examCount||20}ë¬¸í•­ &nbsp;Â·&nbsp; ${c.purpose||'AML êµìœ¡'}</div>
          <div style="margin-top:4px">${statusHtml}</div>
        </div>
        ${btnHtml}
      </div>
    </div>`;
  }).join('');
  if (availCnt > 0) { document.getElementById('apply-cnt').textContent=availCnt; document.getElementById('apply-cnt').style.display=''; }
}

// â”€â”€ â‘¢ ì‹ ì²­ í˜„í™© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderApplyStatus() {
  const listEl = document.getElementById('apply-status-list');
  const entries = Object.entries(courseApplies);
  if (!entries.length) {
    listEl.innerHTML = `<div class="empty-state">
      <div class="empty-icon">ğŸ“‹</div>
      <div class="empty-title">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
      <div class="empty-sub">ã€Œê°•ì˜ ì‹ ì²­ã€ íƒ­ì—ì„œ ê°•ì˜ë¥¼ ì‹ ì²­í•˜ì„¸ìš”.</div>
    </div>`; return;
  }
  const STATUS_MAP = {
    pending:  { label:'ìŠ¹ì¸ ëŒ€ê¸°', cls:'sb-pending',  icon:'â³' },
    approved: { label:'ìŠ¹ì¸ ì™„ë£Œ', cls:'sb-approved', icon:'âœ…' },
    rejected: { label:'ë°˜ë ¤ë¨',   cls:'sb-rejected', icon:'âŒ' },
  };
  listEl.innerHTML = `<div class="tbl-wrap"><table class="data-table">
    <thead><tr><th>ê°•ì˜ëª…</th><th>ì‹ ì²­ì¼</th><th>ì²˜ë¦¬ì¼</th><th>ìƒíƒœ</th><th>ë¹„ê³ </th></tr></thead>
    <tbody>
    ${entries.map(([cid, a]) => {
      const c = allCourses[cid];
      const s = STATUS_MAP[a.status] || STATUS_MAP.pending;
      const assigned = (learner.assignedCourses||[]).includes(cid);
      return `<tr>
        <td><strong>${c?.title||cid}</strong></td>
        <td style="font-size:11px;color:var(--text-light)">${a.appliedAt?fmtDate(new Date(a.appliedAt)):'-'}</td>
        <td style="font-size:11px;color:var(--text-light)">${a.processedAt?fmtDate(new Date(a.processedAt)):'-'}</td>
        <td><span class="status-badge ${s.cls}">${s.icon} ${s.label}</span></td>
        <td style="font-size:11px;color:var(--text-mid)">${assigned?'ê°•ì˜ ë°°ì •ë¨':a.reason||'-'}</td>
      </tr>`;
    }).join('')}
    </tbody>
  </table></div>`;
}

// â”€â”€ â‘£ ìˆ˜ë£Œ í˜„í™© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCerts() {
  const listEl  = document.getElementById('cert-list');
  const assigned = learner.assignedCourses||[];
  const completed = assigned.filter(id=>(learner.courseStatus?.[id])==='completed');
  if (!completed.length) {
    listEl.innerHTML = `<div class="empty-state">
      <div class="empty-icon">ğŸ†</div>
      <div class="empty-title">ìˆ˜ë£Œí•œ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤</div>
      <div class="empty-sub">ê°•ì˜ë¥¼ ìˆ˜ê°•í•˜ê³  ìµœì¢… í‰ê°€ë¥¼ í†µê³¼í•˜ë©´<br>ì´ê³³ì— ìˆ˜ë£Œ ë‚´ì—­ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>`; return;
  }
  const certs = learner.courseCerts||{};
  listEl.innerHTML = completed.map(id => {
    const c = allCourses[id];
    const cert = certs[id] || {};
    return `<div class="cert-card">
      <div class="cert-icon">ğŸ†</div>
      <div class="cert-info">
        <div class="cert-title">${c?.title||id}</div>
        <div class="cert-meta">
          ìˆ˜ë£Œì¼: ${cert.certDate?fmtDate(new Date(cert.certDate)):'-'}
          ${cert.certNo ? `&nbsp;Â·&nbsp; ìˆ˜ë£Œë²ˆí˜¸: ì œ ${cert.certNo}í˜¸` : ''}
        </div>
      </div>
      <div class="cert-score">${cert.score!=null?cert.score+'ì ':'-'}</div>
    </div>`;
  }).join('');
}

// â”€â”€ ê°•ì˜ ì‹ ì²­ ì²˜ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.applyCourse = async function(courseId) {
  const c = allCourses[courseId];
  if (!confirm(`ã€Œ${c?.title}ã€ ê°•ì˜ë¥¼ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  const now = new Date().toISOString();
  await DB.update(`learners/${user.id}/courseApplies/${courseId}`, {
    status: 'pending',
    courseTitle: c?.title||courseId,
    appliedAt: now,
    processedAt: null,
    reason: null
  });
  courseApplies[courseId] = { status:'pending', courseTitle:c?.title, appliedAt:now };
  renderApply();
  renderApplyStatus();
  updateSidebar();
  showToast('ê°•ì˜ ì‹ ì²­ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.','success');
};

window.goCourse = function(id) {
  sessionStorage.setItem('kasg_course', id);
  window.location.href = 'player.html';
};

init();
</script>
</body>
</html>
