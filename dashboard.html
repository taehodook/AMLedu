<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìˆ˜ê°• ëŒ€ì‹œë³´ë“œ â€” KASG LMS</title>
<link rel="stylesheet" href="css/main.css">
<style>
body{background:#EDE9E1;min-height:100vh}
.dash-wrap{max-width:1080px;margin:0 auto;padding:28px 20px}
.dash-hero{background:var(--navy);border-radius:var(--radius-lg);padding:26px 32px;margin-bottom:24px;position:relative;overflow:hidden;border-left:6px solid var(--kasg-gold)}
.dash-hero::after{content:'';position:absolute;right:0;top:0;bottom:0;width:180px;background:url('assets/logo-circle.png') center/80px no-repeat;opacity:.05}
.hero-welcome{font-family:'Noto Serif KR',serif;font-size:22px;font-weight:700;color:#fff;margin-bottom:4px}
.hero-sub{color:rgba(255,255,255,.5);font-size:12.5px}
.hero-chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:14px}
.hero-chip{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.08);padding:5px 12px;border-radius:16px;color:rgba(255,255,255,.75);font-size:11.5px}
.grade-pill{display:inline-flex;align-items:center;gap:5px;padding:4px 11px;border-radius:14px;font-size:11px;font-weight:700;letter-spacing:.3px}
.grade-board   {background:rgba(200,150,10,.2);color:var(--kasg-gold);border:1px solid rgba(200,150,10,.3)}
.grade-aml     {background:rgba(26,62,160,.2);color:#6B9DFF;border:1px solid rgba(100,150,255,.25)}
.grade-general {background:rgba(255,255,255,.1);color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.15)}
.grade-research{background:rgba(200,48,42,.15);color:#FF8A85;border:1px solid rgba(200,48,42,.2)}
.dash-layout{display:grid;grid-template-columns:1fr 300px;gap:20px}
@media(max-width:800px){.dash-layout{grid-template-columns:1fr}}

/* Course card */
.course-card{background:#fff;border-radius:var(--radius-lg);overflow:hidden;display:flex;border-left:5px solid var(--kasg-gold);box-shadow:var(--shadow-sm);transition:transform .18s,box-shadow .18s;cursor:pointer}
.course-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.course-thumb{width:100px;flex-shrink:0;background:linear-gradient(135deg,var(--navy),var(--navy-mid));display:flex;align-items:center;justify-content:center;font-size:32px}
.course-body{flex:1;padding:14px 16px;min-width:0}
.course-title{font-family:'Noto Serif KR',serif;font-size:14px;font-weight:700;color:var(--navy);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.course-tags{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.c-tag{padding:2px 8px;background:var(--cream);border-radius:10px;font-size:10.5px;color:var(--text-mid)}
.c-prog{display:flex;align-items:center;gap:9px}
.prog-bar{flex:1;height:4px}
.prog-pct{font-size:11px;font-weight:600;color:var(--navy);min-width:28px}
.course-action{padding:14px;display:flex;align-items:center;flex-shrink:0}
.empty-courses{background:#fff;border-radius:var(--radius-lg);padding:48px 32px;text-align:center;box-shadow:var(--shadow-sm)}
.empty-icon{font-size:40px;margin-bottom:12px}
.empty-title{font-family:'Noto Serif KR',serif;font-size:16px;font-weight:700;color:var(--navy);margin-bottom:6px}
.empty-sub{font-size:13px;color:var(--text-mid);line-height:1.6}

/* Sidebar */
.my-status{background:#fff;border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-sm)}
.my-status-hd{background:var(--navy);padding:13px 16px;font-family:'Noto Serif KR',serif;font-size:13px;font-weight:700;color:#fff}
.status-rows{padding:12px 16px}
.s-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(0,0,0,.04);font-size:12.5px}
.s-row:last-child{border-bottom:none}
.s-key{color:var(--text-mid)}
.s-val{font-weight:600;color:var(--text)}
.cert-cta{background:linear-gradient(135deg,var(--kasg-gold),#DAA010);border-radius:var(--radius-lg);padding:18px;text-align:center;cursor:pointer;transition:transform .18s;box-shadow:0 4px 14px rgba(200,150,10,.28);margin-top:14px}
.cert-cta:hover{transform:translateY(-2px)}
.cert-cta .icon{font-size:28px;margin-bottom:5px}
.cert-cta .t{font-family:'Noto Serif KR',serif;font-size:14px;font-weight:700;color:var(--navy)}
.cert-cta .s{font-size:11px;color:rgba(12,31,63,.65);margin-top:2px}
.guide{background:#fff;border-radius:var(--radius-lg);padding:16px;box-shadow:var(--shadow-sm);margin-top:14px}
.guide-t{font-size:12.5px;font-weight:700;color:var(--navy);margin-bottom:9px}
.guide-step{display:flex;align-items:flex-start;gap:8px;font-size:11.5px;color:var(--text-mid);padding:4px 0;line-height:1.5}
.step-n{width:18px;height:18px;border-radius:50%;background:var(--navy);color:#fff;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;flex-shrink:0;margin-top:1px}
</style>
</head>
<body>
<header class="site-header">
  <div class="header-brand">
    <img class="header-logo-img" src="assets/logo-wide.png" alt="KASG">
  </div>
  <div class="header-nav">
    <div class="header-chip" id="hd-chip">ğŸ‘¤</div>
    <button class="header-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<div class="dash-wrap">
  <!-- Hero -->
  <div class="dash-hero">
    <div class="hero-welcome" id="hero-welcome">í™˜ì˜í•©ë‹ˆë‹¤!</div>
    <div class="hero-sub">í•œêµ­ìê¸ˆì„¸íƒë°©ì§€ì—°êµ¬íšŒ AML ì˜¨ë¼ì¸ êµìœ¡ ì‹œìŠ¤í…œ</div>
    <div class="hero-chips">
      <div class="hero-chip">ğŸ“… <span id="hero-date"></span></div>
      <div class="hero-chip">ğŸ¯ ìˆ˜ë£Œê¸°ì¤€: 70ì  ì´ìƒ</div>
      <div class="hero-chip" id="grade-chip"></div>
    </div>
  </div>

  <div class="dash-layout">
    <!-- Left: course list -->
    <div>
      <div class="section-title">ğŸ“š ë°°ì •ëœ ê°•ì˜ ëª©ë¡</div>
      <div id="course-list" style="display:flex;flex-direction:column;gap:12px">
        <div style="text-align:center;padding:40px;color:var(--text-light)">
          <div class="spinner" style="margin:0 auto 12px"></div>ê°•ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>
      </div>
    </div>

    <!-- Right: sidebar -->
    <div>
      <div class="my-status">
        <div class="my-status-hd">ğŸ“Š ë‚´ í•™ìŠµ í˜„í™©</div>
        <div class="status-rows">
          <div class="s-row"><span class="s-key">ë°°ì • ê°•ì˜</span><span class="s-val" id="st-assigned">-</span></div>
          <div class="s-row"><span class="s-key">ìˆ˜ë£Œ ì™„ë£Œ</span><span class="s-val" id="st-done">-</span></div>
          <div class="s-row"><span class="s-key">ìµœì¢… ì ìˆ˜</span><span class="s-val" id="st-score">-</span></div>
          <div class="s-row"><span class="s-key">ìˆ˜ê°•ìƒ ë“±ê¸‰</span><span class="s-val" id="st-grade">-</span></div>
          <div class="s-row"><span class="s-key">ì†Œì†</span><span class="s-val" id="st-org" style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">-</span></div>
        </div>
      </div>

      <div class="cert-cta" id="cert-cta" style="display:none" onclick="window.location.href='certificate.html'">
        <div class="icon">ğŸ†</div>
        <div class="t">ìˆ˜ë£Œì¦ ë°œê¸‰</div>
        <div class="s">í´ë¦­í•˜ì—¬ ìˆ˜ë£Œì¦ í™•ì¸Â·ì¶œë ¥</div>
      </div>

      <div class="guide">
        <div class="guide-t">ğŸ“‹ ìˆ˜ê°• ì•ˆë‚´</div>
        <div class="guide-step"><div class="step-n">1</div><span>ë°°ì •ëœ ê°•ì˜ ì˜ìƒì„ ì²˜ìŒë¶€í„° ëê¹Œì§€ ì‹œì²­</span></div>
        <div class="guide-step"><div class="step-n">2</div><span>25%Â·50%Â·75% ì§€ì  ì´í•´ë„ í€´ì¦ˆ í†µê³¼</span></div>
        <div class="guide-step"><div class="step-n">3</div><span>ì˜ìƒ ì™„ë£Œ í›„ ìµœì¢… í‰ê°€ ì‘ì‹œ (20ë¬¸í•­, 40ë¶„)</span></div>
        <div class="guide-step"><div class="step-n">4</div><span>70ì  ì´ìƒ â†’ ìˆ˜ë£Œì¦ ë°œê¸‰</span></div>
        <div class="guide-step"><div class="step-n">5</div><span>ë¯¸ìˆ˜ë£Œ ì‹œ ì¬ìˆ˜ê°• í›„ ì¬ì‘ì‹œ (ìµœëŒ€ 2íšŒ)</span></div>
      </div>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script type="module">
import { DB } from './js/firebase-config.js';
import { requireAuth, fmtDate } from './js/utils.js';

const user = requireAuth(); if (!user) throw 0;

const GRADE_LABELS = { board:'ì´ì‚¬íšŒÂ·ì„ì›', aml:'AML ë‹´ë‹¹ì', general:'ì¼ë°˜', research:'ì—°êµ¬íšŒ' };
const GRADE_ICONS  = { board:'ğŸ›', aml:'ğŸ”', general:'ğŸ‘¤', research:'ğŸ“' };
const GRADE_CLASSES= { board:'grade-board', aml:'grade-aml', general:'grade-general', research:'grade-research' };

document.getElementById('hd-chip').innerHTML =
  `ğŸ‘¤ ${user.name} <span class="grade-pill ${GRADE_CLASSES[user.grade]||'grade-general'}" style="margin-left:5px">${GRADE_ICONS[user.grade]||'ğŸ‘¤'} ${GRADE_LABELS[user.grade]||'ì¼ë°˜'}</span>`;
document.getElementById('hero-welcome').textContent = `ì•ˆë…•í•˜ì„¸ìš”, ${user.name}ë‹˜ ğŸ‘‹`;
document.getElementById('hero-date').textContent    = fmtDate(new Date());
document.getElementById('grade-chip').textContent   = `${GRADE_ICONS[user.grade]||'ğŸ‘¤'} ${GRADE_LABELS[user.grade]||'ì¼ë°˜'}`;

window.logout = () => { sessionStorage.removeItem('kasg_user'); window.location.href='index.html'; };

async function init() {
  const [allCourses, learner] = await Promise.all([
    DB.get('courses'), DB.get(`learners/${user.id}`)
  ]);

  // Sidebar stats
  if (learner) {
    const assigned = (learner.assignedCourses||[]).length;
    const doneCount= Object.values(learner.courseStatus||{}).filter(s=>s==='completed').length;
    document.getElementById('st-assigned').textContent = assigned + 'ê°œ';
    document.getElementById('st-done').textContent     = doneCount + 'ê°œ';
    document.getElementById('st-score').textContent    = learner.finalScore!=null ? learner.finalScore+'ì ' : 'ë¯¸ì‘ì‹œ';
    document.getElementById('st-grade').textContent    = learner.gradeLabel || GRADE_LABELS[user.grade] || 'ì¼ë°˜';
    document.getElementById('st-org').textContent      = learner.org || user.org;
    if (learner.completedStatus==='completed'||learner.status==='completed') {
      document.getElementById('cert-cta').style.display='';
    }
  }

  // Show only assigned courses
  const assigned = learner?.assignedCourses || [];
  const listEl   = document.getElementById('course-list');

  if (!assigned.length) {
    listEl.innerHTML = `<div class="empty-courses">
      <div class="empty-icon">ğŸ“­</div>
      <div class="empty-title">ë°°ì •ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤</div>
      <div class="empty-sub">ê´€ë¦¬ìê°€ ê°•ì˜ë¥¼ ë°°ì •í•˜ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.<br>
      ìˆ˜ê°•ê¸°í•œ ì•Œë¦¼ì€ ë“±ë¡ ì´ë©”ì¼ë¡œ ìë™ ë°œì†¡ë©ë‹ˆë‹¤.</div>
    </div>`;
    return;
  }

  const courseArr = assigned
    .map(id => allCourses?.[id] ? { id, ...allCourses[id] } : null)
    .filter(Boolean);

  if (!courseArr.length) {
    listEl.innerHTML = `<div class="empty-courses"><div class="empty-icon">ğŸ“‚</div><div class="empty-title">ê°•ì˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div></div>`;
    return;
  }

  listEl.innerHTML = courseArr.map(c => {
    const cp   = learner?.courseProgress?.[c.id] || 0;
    const cs   = learner?.courseStatus?.[c.id]   || 'new';
    const pct  = Math.round(cp * 100);
    const badge = cs==='completed'
      ? '<span class="badge badge-success">âœ… ìˆ˜ë£Œ</span>'
      : cs==='in_progress'||cs==='watched'
      ? '<span class="badge badge-warn">â–¶ ìˆ˜ê°• ì¤‘</span>'
      : '<span class="badge badge-neutral">ğŸ†• ë¯¸ì‹œì‘</span>';
    const btnLbl = cs==='completed'?'ì¬ìˆ˜ê°•':cs==='in_progress'||cs==='watched'?'ì´ì–´ë³´ê¸°':'ìˆ˜ê°• ì‹œì‘';
    const btnCls = cs==='completed'?'btn-outline':'btn-primary';

    // ìˆ˜ê°•ê¸°í•œ í‘œì‹œ
    const dl = learner?.courseDeadlines?.[c.id];
    let deadlineBadge = '';
    if (dl) {
      const today = new Date(); today.setHours(0,0,0,0);
      const due   = new Date(dl); due.setHours(0,0,0,0);
      const diff  = Math.round((due - today) / 86400000);
      if (cs !== 'completed') {
        if (diff < 0) {
          deadlineBadge = `<span class="c-tag" style="background:#FEE2E2;color:var(--error);font-weight:700">â›” ê¸°í•œ ë§Œë£Œ</span>`;
        } else if (diff === 0) {
          deadlineBadge = `<span class="c-tag" style="background:#FEE2E2;color:var(--error);font-weight:700">ğŸ”´ ì˜¤ëŠ˜ ë§ˆê°</span>`;
        } else if (diff <= 5) {
          deadlineBadge = `<span class="c-tag" style="background:#FEF3C7;color:#7A4F00;font-weight:700">âš ï¸ D-${diff}</span>`;
        } else {
          deadlineBadge = `<span class="c-tag" style="color:var(--text-light)">ğŸ“… ${due.getFullYear()}.${String(due.getMonth()+1).padStart(2,'0')}.${String(due.getDate()).padStart(2,'0')} ê¹Œì§€</span>`;
        }
      } else {
        deadlineBadge = `<span class="c-tag" style="color:var(--text-light)">ğŸ“… ${due.getFullYear()}.${String(due.getMonth()+1).padStart(2,'0')}.${String(due.getDate()).padStart(2,'0')}</span>`;
      }
    }

    return `<div class="course-card" onclick="goCourse('${c.id}')">
      <div class="course-thumb">ğŸ¬</div>
      <div class="course-body">
        <div class="course-title">${c.title}</div>
        <div class="course-tags">
          <span class="c-tag">ğŸ• ${c.duration||'?'}ì‹œê°„</span>
          <span class="c-tag">ğŸ“‹ ${c.examCount||20}ë¬¸í•­</span>
          ${badge}
          ${deadlineBadge}
        </div>
        <div class="c-prog">
          <div class="prog-bar"><div class="progress-wrap" style="height:4px"><div class="progress-fill" style="width:${pct}%"></div></div></div>
          <span class="prog-pct">${pct}%</span>
        </div>
      </div>
      <div class="course-action">
        <button class="btn ${btnCls} btn-sm" onclick="event.stopPropagation();goCourse('${c.id}')">${btnLbl}</button>
      </div>
    </div>`;
  }).join('');
}

window.goCourse = function(id) {
  sessionStorage.setItem('kasg_course', id);
  window.location.href = 'player.html';
};

init();
</script>
</body>
</html>
