<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìˆ˜ê°• ëŒ€ì‹œë³´ë“œ â€” KASG LMS</title>
<link rel="stylesheet" href="css/main.css">
<style>
body{background:#EDE9E1;min-height:100vh}
.dash-wrap{max-width:1080px;margin:0 auto;padding:32px 22px}
.dash-hero{background:var(--navy);border-radius:var(--radius-lg);padding:32px 36px;margin-bottom:28px;position:relative;overflow:hidden;border-left:6px solid var(--kasg-gold)}
.dash-hero::after{content:'';position:absolute;right:0;top:0;bottom:0;width:200px;background:url('assets/logo-circle.png') center/90px no-repeat;opacity:.05}
.hero-welcome{font-family:'Noto Serif KR',serif;font-size:24px;font-weight:700;color:#fff;margin-bottom:5px}
.hero-sub{color:rgba(255,255,255,.55);font-size:13px}
.hero-chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:18px}
.hero-chip{display:flex;align-items:center;gap:7px;background:rgba(255,255,255,.1);padding:7px 14px;border-radius:18px;color:rgba(255,255,255,.8);font-size:12px}
.dash-grid{display:grid;grid-template-columns:1fr 320px;gap:22px}
@media(max-width:768px){.dash-grid{grid-template-columns:1fr}}

/* course card */
.course-item{background:#fff;border-radius:var(--radius-lg);overflow:hidden;display:flex;border-left:5px solid var(--kasg-gold);box-shadow:var(--shadow-sm);transition:transform .2s,box-shadow .2s;cursor:pointer}
.course-item:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.course-thumb{width:110px;min-height:110px;flex-shrink:0;background:linear-gradient(135deg,var(--navy) 0%,var(--navy-mid) 100%);display:flex;align-items:center;justify-content:center;font-size:36px}
.course-info{flex:1;padding:16px 20px}
.course-name{font-family:'Noto Serif KR',serif;font-size:15px;font-weight:700;color:var(--navy);margin-bottom:7px}
.course-tags{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:12px}
.course-tag{padding:2px 9px;background:var(--cream);border-radius:11px;font-size:11px;color:var(--text-mid)}
.course-prog{display:flex;align-items:center;gap:10px}
.prog-bar{flex:1;height:5px}
.prog-pct{font-size:11px;font-weight:600;color:var(--navy);min-width:32px}
.course-action{padding:16px;display:flex;align-items:center}

/* sidebar */
.my-status{background:#fff;border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-sm)}
.my-status-head{background:var(--navy);padding:14px 18px;font-family:'Noto Serif KR',serif;font-size:14px;font-weight:600;color:#fff}
.status-rows{padding:14px 18px}
.status-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid rgba(0,0,0,.04);font-size:13px}
.status-row:last-child{border-bottom:none}
.sr-key{color:var(--text-mid)}
.sr-val{font-weight:600;color:var(--text)}
.cert-cta{background:linear-gradient(135deg,var(--kasg-gold) 0%,#DAA010 100%);border-radius:var(--radius-lg);padding:22px;text-align:center;cursor:pointer;transition:transform .2s;box-shadow:0 4px 14px rgba(200,150,10,.3);margin-top:16px}
.cert-cta:hover{transform:translateY(-2px)}
.cert-cta-icon{font-size:34px;margin-bottom:6px}
.cert-cta-title{font-family:'Noto Serif KR',serif;font-size:15px;font-weight:700;color:var(--navy)}
.cert-cta-sub{font-size:11px;color:rgba(12,31,63,.7);margin-top:3px}
.guide-card{background:#fff;border-radius:var(--radius-lg);padding:18px;box-shadow:var(--shadow-sm);margin-top:16px}
.guide-title{font-size:13px;font-weight:600;color:var(--navy);margin-bottom:10px}
.guide-step{display:flex;align-items:flex-start;gap:9px;font-size:12px;color:var(--text-mid);padding:5px 0}
.step-num{width:19px;height:19px;border-radius:50%;background:var(--navy);color:#fff;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0}
</style>
</head>
<body>
<header class="site-header">
  <div class="header-brand">
    <img class="header-logo-img" src="assets/logo-wide.png" alt="KASG">
  </div>
  <div class="header-nav">
    <div class="header-chip">ğŸ‘¤ <span id="hd-name"></span><span style="opacity:.35">|</span><span id="hd-org" style="font-size:12px;opacity:.75"></span></div>
    <button class="header-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<div class="dash-wrap">
  <div class="dash-hero">
    <div class="hero-welcome" id="hero-welcome">í™˜ì˜í•©ë‹ˆë‹¤!</div>
    <div class="hero-sub">í•œêµ­ìê¸ˆì„¸íƒë°©ì§€ì—°êµ¬íšŒ AML ì˜¨ë¼ì¸ êµìœ¡ ì‹œìŠ¤í…œ</div>
    <div class="hero-chips">
      <div class="hero-chip">ğŸ“… <span id="hero-date"></span></div>
      <div class="hero-chip">ğŸ¯ ìˆ˜ë£Œê¸°ì¤€: 70ì  ì´ìƒ</div>
      <div class="hero-chip">â± ì˜ìƒ ì™„ë£Œ í›„ í‰ê°€ ì‘ì‹œ</div>
    </div>
  </div>

  <div class="dash-grid">
    <div>
      <div class="section-title">ğŸ“š ìˆ˜ê°• ê³¼ì • ëª©ë¡</div>
      <div id="course-list" style="display:flex;flex-direction:column;gap:14px">
        <div style="text-align:center;padding:40px;color:var(--text-light)"><div class="spinner" style="margin:0 auto 14px"></div>ê°•ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <div>
      <div class="my-status">
        <div class="my-status-head">ğŸ“Š ë‚´ í•™ìŠµ í˜„í™©</div>
        <div class="status-rows">
          <div class="status-row"><span class="sr-key">ì „ì²´ ì§„ë„</span><span class="sr-val" id="st-prog">-</span></div>
          <div class="status-row"><span class="sr-key">ì¤‘ê°„ í€´ì¦ˆ</span><span class="sr-val" id="st-mq">-</span></div>
          <div class="status-row"><span class="sr-key">ìµœì¢… ì ìˆ˜</span><span class="sr-val" id="st-score">-</span></div>
          <div class="status-row"><span class="sr-key">ì‘ì‹œ íšŸìˆ˜</span><span class="sr-val" id="st-att">-</span></div>
          <div class="status-row"><span class="sr-key">ìˆ˜ë£Œ ìƒíƒœ</span><span class="sr-val" id="st-status">-</span></div>
        </div>
      </div>

      <div class="cert-cta" id="cert-cta" style="display:none" onclick="window.location.href='certificate.html'">
        <div class="cert-cta-icon">ğŸ†</div>
        <div class="cert-cta-title">ìˆ˜ë£Œì¦ ë°œê¸‰</div>
        <div class="cert-cta-sub">í´ë¦­í•˜ì—¬ ìˆ˜ë£Œì¦ í™•ì¸ Â· ì¶œë ¥</div>
      </div>

      <div class="guide-card">
        <div class="guide-title">ğŸ“‹ ìˆ˜ê°• ì•ˆë‚´</div>
        <div class="guide-step"><div class="step-num">1</div><span>ê°•ì˜ ì˜ìƒì„ ì²˜ìŒë¶€í„° ëê¹Œì§€ ì‹œì²­í•˜ì„¸ìš”</span></div>
        <div class="guide-step"><div class="step-num">2</div><span>ì˜ìƒ ì¤‘ê°„ ì´í•´ë„ í€´ì¦ˆ 3ê°œë¥¼ í†µê³¼í•´ì•¼ í•©ë‹ˆë‹¤</span></div>
        <div class="guide-step"><div class="step-num">3</div><span>ì˜ìƒ ì™„ë£Œ í›„ ìµœì¢… í‰ê°€(20ë¬¸í•­)ì— ì‘ì‹œí•˜ì„¸ìš”</span></div>
        <div class="guide-step"><div class="step-num">4</div><span>70ì  ì´ìƒ ì‹œ ìˆ˜ë£Œì¦ì´ ë°œê¸‰ë©ë‹ˆë‹¤</span></div>
        <div class="guide-step"><div class="step-num">5</div><span>ë¯¸ìˆ˜ë£Œ ì‹œ ì¬ìˆ˜ê°• í›„ ìƒˆ ë¬¸ì œë¡œ ì¬ì‘ì‹œ ê°€ëŠ¥ (ìµœëŒ€ 2íšŒ)</span></div>
      </div>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script type="module">
import { DB } from './js/firebase-config.js';
import { requireAuth, fmtDate } from './js/utils.js';

const user = requireAuth(); if (!user) throw 0;
document.getElementById('hd-name').textContent    = user.name;
document.getElementById('hd-org').textContent     = user.org;
document.getElementById('hero-welcome').textContent = `ì•ˆë…•í•˜ì„¸ìš”, ${user.name}ë‹˜ ğŸ‘‹`;
document.getElementById('hero-date').textContent   = fmtDate(new Date());

window.logout = () => { sessionStorage.removeItem('kasg_user'); window.location.href = 'index.html'; };

async function init() {
  const [courses, learner] = await Promise.all([
    DB.get('courses'), DB.get(`learners/${user.id}`)
  ]);

  // Sidebar status
  if (learner) {
    const prog  = Math.round((learner.progress||0)*100);
    const mq    = learner.midQuizTotal > 0 ? `${learner.midQuizCorrect}/${learner.midQuizTotal} ì •ë‹µ` : 'ë¯¸ì‘ì‹œ';
    const score = learner.finalScore != null ? learner.finalScore + 'ì ' : 'ë¯¸ì‘ì‹œ';
    document.getElementById('st-prog').textContent  = prog + '%';
    document.getElementById('st-mq').textContent    = mq;
    document.getElementById('st-score').textContent = score;
    document.getElementById('st-att').textContent   = (learner.attempt||0) + '/2íšŒ';
    const s = learner.completedStatus || learner.status;
    document.getElementById('st-status').innerHTML  =
      s==='completed' ? '<span style="color:var(--success);font-weight:700">âœ… ìˆ˜ë£Œ</span>'
      : s==='in_progress' ? '<span style="color:var(--warn-text);font-weight:700">â–¶ ìˆ˜ê°• ì¤‘</span>'
      : '<span style="color:var(--text-light)">ë¯¸ìˆ˜ê°•</span>';
    if (s === 'completed') document.getElementById('cert-cta').style.display = '';
  }

  const courseArr = courses ? Object.entries(courses).map(([id,c])=>({id,...c})) : [];
  const listEl = document.getElementById('course-list');

  if (!courseArr.length) {
    listEl.innerHTML = `<div class="card" style="text-align:center;padding:44px"><div style="font-size:36px;margin-bottom:10px">ğŸ“‚</div><div style="color:var(--text-mid)">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>`;
    return;
  }

  listEl.innerHTML = courseArr.map(c => {
    const cp   = learner?.courseProgress?.[c.id] || 0;
    const cs   = learner?.courseStatus?.[c.id] || 'new';
    const pct  = Math.round(cp*100);
    const badge = cs==='completed' ? '<span class="badge badge-success">âœ… ìˆ˜ë£Œ</span>'
      : cs==='in_progress' ? '<span class="badge badge-warn">â–¶ ìˆ˜ê°• ì¤‘</span>'
      : '<span class="badge badge-neutral">ğŸ†• ìˆ˜ê°• ì „</span>';
    const btn   = cs==='completed' ? 'ì¬ìˆ˜ê°•' : cs==='in_progress' ? 'ì´ì–´ë³´ê¸°' : 'ìˆ˜ê°• ì‹œì‘';
    const btnCls= cs==='completed' ? 'btn-outline' : 'btn-primary';
    return `<div class="course-item" onclick="goCourse('${c.id}')">
      <div class="course-thumb">ğŸ¬</div>
      <div class="course-info">
        <div class="course-name">${c.title}</div>
        <div class="course-tags">
          <span class="course-tag">ğŸ• ${c.duration||'?'}ì‹œê°„</span>
          <span class="course-tag">ğŸ“‹ 20ë¬¸í•­</span>
          <span class="course-tag">ğŸ¯ 70% ì´ìƒ</span>
          ${badge}
        </div>
        <div class="course-prog">
          <div class="prog-bar"><div class="progress-wrap" style="height:5px"><div class="progress-fill" style="width:${pct}%"></div></div></div>
          <span class="prog-pct">${pct}%</span>
        </div>
      </div>
      <div class="course-action">
        <button class="btn ${btnCls} btn-sm" onclick="event.stopPropagation();goCourse('${c.id}')">${btn}</button>
      </div>
    </div>`;
  }).join('');
}

window.goCourse = function(id) {
  sessionStorage.setItem('kasg_course', id);
  window.location.href = 'player.html';
};

init();
</script>
</body>
</html>
