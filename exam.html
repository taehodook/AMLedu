<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìµœì¢… í‰ê°€ â€” KASG LMS</title>
<link rel="stylesheet" href="css/main.css">
<style>
body{background:#EDE9E1;min-height:100vh}
.exam-wrap{max-width:780px;margin:0 auto;padding:32px 20px}
.exam-top{background:var(--navy);border-radius:var(--radius-lg) var(--radius-lg) 0 0;padding:26px 32px;display:flex;align-items:center;justify-content:space-between}
.exam-title{font-family:'Noto Serif KR',serif;font-size:20px;font-weight:700;color:#fff}
.exam-sub{color:var(--kasg-gold);font-size:12px;margin-top:3px}
.timer-box{background:rgba(255,255,255,.08);border:1.5px solid var(--kasg-gold);border-radius:var(--radius);padding:9px 20px;font-family:'DM Mono',monospace;font-size:26px;color:var(--kasg-gold);letter-spacing:2px}
.timer-box.urgent{color:#FF6B6B;border-color:#FF6B6B;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.65}}
.exam-body{background:#fff;border-radius:0 0 var(--radius-lg) var(--radius-lg);padding:32px;box-shadow:var(--shadow-md)}
.ep-bar-wrap{display:flex;align-items:center;gap:13px;margin-bottom:28px}
.ep-fill-wrap{flex:1;height:5px}
.ep-text{font-size:12px;color:var(--text-mid);white-space:nowrap}
.q-num{font-size:11px;font-weight:600;color:var(--kasg-gold);letter-spacing:1px;text-transform:uppercase;margin-bottom:9px}
.q-text{font-family:'Noto Serif KR',serif;font-size:18px;font-weight:600;color:var(--navy);line-height:1.75;margin-bottom:24px}
.exam-opts{display:flex;flex-direction:column;gap:9px}
.exam-opt{padding:14px 16px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:14px;display:flex;align-items:center;gap:13px;transition:all .15s}
.exam-opt:hover{border-color:var(--navy);background:rgba(12,31,63,.03)}
.exam-opt.selected{border-color:var(--navy);background:var(--navy);color:#fff}
.exam-opt-n{width:27px;height:27px;border-radius:50%;border:1.5px solid currentColor;opacity:.5;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}
.exam-nav{display:flex;justify-content:space-between;align-items:center;margin-top:32px}
.palette-wrap{margin-top:24px;padding-top:20px;border-top:1px solid var(--border)}
.palette-title{font-size:11px;font-weight:600;color:var(--text-mid);letter-spacing:.5px;text-transform:uppercase;margin-bottom:11px}
.palette-grid{display:flex;flex-wrap:wrap;gap:6px}
.pc{width:34px;height:34px;border-radius:var(--radius);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:500;cursor:pointer;transition:all .15s}
.pc.answered{background:var(--navy);color:#fff;border-color:var(--navy)}
.pc.current{border-color:var(--kasg-gold)}
.review-warn{margin-top:14px;padding:10px 14px;background:var(--warn-bg);border-radius:var(--radius);font-size:13px;color:var(--warn-text);border-left:3px solid var(--kasg-gold);display:none}
.review-warn.show{display:block}
</style>
</head>
<body>
<header class="site-header">
  <div class="header-brand"><img class="header-logo-img" src="assets/logo-wide.png" alt="KASG"></div>
  <div class="header-nav"><div class="header-chip">ğŸ‘¤ <span id="hd-name"></span></div></div>
</header>
<div class="exam-wrap">
  <div class="exam-top">
    <div><div class="exam-title">ìµœì¢… ì´í•´ë„ í‰ê°€</div><div class="exam-sub" id="exam-sub">1ì°¨ ì‹œí—˜ Â· ì´ 20ë¬¸í•­ Â· 40ë¶„</div></div>
    <div class="timer-box" id="timer">40:00</div>
  </div>
  <div class="exam-body">
    <div class="ep-bar-wrap">
      <div class="ep-fill-wrap"><div class="progress-wrap" style="height:5px"><div class="progress-fill" id="ep-fill" style="width:5%"></div></div></div>
      <span class="ep-text" id="ep-text">1 / 20</span>
    </div>
    <div class="q-num" id="q-num">Q 01 / 20</div>
    <div class="q-text" id="q-text">ë¬¸ì œ ë¡œë”© ì¤‘...</div>
    <div class="exam-opts" id="q-opts"></div>
    <div class="exam-nav">
      <button class="btn btn-outline" id="prev-btn" onclick="navigate(-1)">â† ì´ì „</button>
      <button class="btn btn-primary" id="next-btn" onclick="navigate(1)">ë‹¤ìŒ â†’</button>
    </div>
    <div class="palette-wrap">
      <div class="palette-title">ë‹µì•ˆ í˜„í™©</div>
      <div class="palette-grid" id="palette"></div>
    </div>
    <div class="review-warn" id="review-warn">âš ï¸ ì•„ì§ ë‹µí•˜ì§€ ì•Šì€ ë¬¸í•­ì´ ìˆìŠµë‹ˆë‹¤.</div>
  </div>
</div>
<div id="toast-container"></div>
<script type="module">
import { DB } from './js/firebase-config.js';
import { requireAuth, fmtDate, generateCertNo } from './js/utils.js';
import { QUIZ_BANK } from './js/quiz-data.js';

const user = requireAuth(); if (!user) throw 0;
const courseId = sessionStorage.getItem('kasg_course');
if (!courseId) { window.location.href='dashboard.html'; throw 0; }
document.getElementById('hd-name').textContent = user.name;

let questions=[], answers={}, curIdx=0, timerSec=2400, timerInt=null, attempt=1, learner=null, course=null;

async function init() {
  [learner, course] = await Promise.all([DB.get(`learners/${user.id}`), DB.get(`courses/${courseId}`)]);
  // Guard: must have watched
  const cp = learner?.courseProgress?.[courseId] || 0;
  if (cp < 0.99 && learner?.courseStatus?.[courseId] !== 'watched') {
    alert('ì˜ìƒì„ ëê¹Œì§€ ì‹œì²­í•´ì•¼ í‰ê°€ì— ì‘ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    window.location.href='player.html'; return;
  }
  attempt = (learner?.attempt||0)+1;
  if (attempt > 2) { alert('ìµœëŒ€ ì‘ì‹œ íšŸìˆ˜(2íšŒ)ë¥¼ ì´ˆê³¼í•˜ì˜€ìŠµë‹ˆë‹¤.'); window.location.href='dashboard.html'; return; }
  questions = QUIZ_BANK[attempt===1?'A':'B'];
  document.getElementById('exam-sub').textContent = `${attempt}ì°¨ ì‹œí—˜ Â· ì´ ${questions.length}ë¬¸í•­ Â· 40ë¶„`;
  buildPalette(); renderQ(); startTimer();
}

function renderQ() {
  const q=questions[curIdx], n=curIdx+1, t=questions.length, sel=answers[curIdx];
  document.getElementById('q-num').textContent  = `Q ${String(n).padStart(2,'0')} / ${String(t).padStart(2,'0')}`;
  document.getElementById('q-text').textContent = q.q;
  document.getElementById('ep-fill').style.width= (n/t*100)+'%';
  document.getElementById('ep-text').textContent = `${n} / ${t}`;
  document.getElementById('q-opts').innerHTML = q.opts.map((o,i) =>
    `<div class="exam-opt${sel===i?' selected':''}" onclick="selOpt(${i})"><span class="exam-opt-n">${i+1}</span>${o}</div>`
  ).join('');
  document.getElementById('prev-btn').disabled = curIdx===0;
  document.getElementById('next-btn').textContent = curIdx===t-1 ? 'ìµœì¢… ì œì¶œ ğŸ' : 'ë‹¤ìŒ â†’';
  updatePalette();
  document.getElementById('review-warn').classList.remove('show');
}
window.selOpt = function(i){ answers[curIdx]=i; renderQ(); };
window.navigate = function(dir) {
  const isLast=curIdx===questions.length-1;
  if (isLast && dir===1) {
    const un=questions.filter((_,i)=>answers[i]===undefined).length;
    if (un>0){document.getElementById('review-warn').classList.add('show');return;}
    if(confirm('ìµœì¢… ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìˆ˜ì •ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.')) submitExam();
    return;
  }
  curIdx=Math.max(0,Math.min(questions.length-1,curIdx+dir)); renderQ();
};
function buildPalette(){document.getElementById('palette').innerHTML=questions.map((_,i)=>`<div class="pc" id="pc-${i}" onclick="jumpTo(${i})">${i+1}</div>`).join('');}
function updatePalette(){questions.forEach((_,i)=>{const c=document.getElementById('pc-'+i);if(!c)return;c.className='pc'+(answers[i]!==undefined?' answered':'')+(i===curIdx?' current':'');});}
window.jumpTo=function(i){curIdx=i;renderQ();};
function startTimer(){updateTimerEl();timerInt=setInterval(()=>{timerSec--;updateTimerEl();if(timerSec<=0){clearInterval(timerInt);alert('ì‹œí—˜ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');submitExam();}},1000);}
function updateTimerEl(){const m=Math.floor(timerSec/60).toString().padStart(2,'0'),s=(timerSec%60).toString().padStart(2,'0');const el=document.getElementById('timer');el.textContent=`${m}:${s}`;el.className='timer-box'+(timerSec<300?' urgent':'');}
async function submitExam(){
  clearInterval(timerInt);
  let correct=0; questions.forEach((q,i)=>{if(answers[i]===q.ans)correct++;});
  const score=Math.round(correct/questions.length*100), passed=score>=70, now=new Date();
  const up={attempt, finalScore:score, finalPassed:passed, lastExamDate:now.toISOString(), [`courseStatus/${courseId}`]:passed?'completed':'failed'};
  if(passed){
    const certNo=generateCertNo();
    up.completedStatus='completed'; up.certNo=certNo; up.certDate=now.toISOString();
    up[`courseCerts/${courseId}`]={certNo,certDate:now.toISOString(),score};
    await DB.push('completions',{name:user.name,org:user.org,userId:user.id,courseId,courseTitle:course?.title||'',certNo,score,date:now.toISOString()});
  }
  await DB.update(`learners/${user.id}`,up);
  sessionStorage.setItem('kasg_result',JSON.stringify({score,passed,correct,total:questions.length,attempt}));
  window.location.href='result.html';
}
init();
</script>
</body>
</html>
