<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìµœì¢… ì´í•´ë„ í‰ê°€ â€” KASG LMS</title>
<link rel="stylesheet" href="css/main.css">
<style>
  body { background: #F0EDE6; min-height: 100vh; }

  .exam-layout {
    max-width: 800px; margin: 0 auto;
    padding: 36px 24px;
  }

  .exam-header-card {
    background: var(--navy);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    padding: 28px 36px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .exam-title {
    font-family: 'Noto Serif KR', serif;
    font-size: 22px; font-weight: 700; color: var(--white);
  }
  .exam-subtitle { color: var(--kasg-gold); font-size: 13px; margin-top: 4px; }

  .timer-box {
    background: rgba(255,255,255,0.08);
    border: 1.5px solid var(--kasg-gold);
    border-radius: var(--radius);
    padding: 10px 24px;
    font-family: 'DM Mono', monospace;
    font-size: 28px; font-weight: 500;
    color: var(--kasg-gold); letter-spacing: 2px;
  }
  .timer-box.urgent { color: #FF6B6B; border-color: #FF6B6B; animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }

  .exam-body {
    background: var(--white);
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    padding: 36px;
    box-shadow: var(--shadow-md);
  }

  .exam-progress {
    display: flex; align-items: center; gap: 14px;
    margin-bottom: 32px;
  }
  .ep-bar { flex: 1; height: 6px; }
  .ep-text { font-size: 12px; color: var(--text-mid); white-space: nowrap; }

  .question-num {
    font-size: 11px; font-weight: 600;
    color: var(--kasg-gold); letter-spacing: 1px;
    text-transform: uppercase; margin-bottom: 10px;
  }
  .question-text {
    font-family: 'Noto Serif KR', serif;
    font-size: 19px; font-weight: 600;
    color: var(--navy); line-height: 1.7;
    margin-bottom: 28px;
  }

  .exam-opts { display: flex; flex-direction: column; gap: 10px; }
  .exam-opt {
    padding: 15px 18px;
    border: 1.5px solid var(--border); border-radius: var(--radius);
    cursor: pointer; font-size: 14px;
    display: flex; align-items: center; gap: 14px;
    transition: all 0.15s;
  }
  .exam-opt:hover { border-color: var(--navy); background: rgba(12,31,63,0.03); }
  .exam-opt.selected { border-color: var(--navy); background: var(--navy); color: var(--white); }
  .exam-opt-n {
    width: 28px; height: 28px; border-radius: 50%;
    border: 1.5px solid currentColor; opacity: 0.5;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; flex-shrink: 0;
  }

  .exam-nav {
    display: flex; justify-content: space-between; align-items: center;
    margin-top: 36px;
  }

  /* Answer palette */
  .answer-palette {
    margin-top: 28px; padding-top: 24px;
    border-top: 1px solid var(--border);
  }
  .palette-title { font-size: 11px; font-weight: 600; color: var(--text-mid); letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 12px; }
  .palette-grid  { display: flex; flex-wrap: wrap; gap: 6px; }
  .palette-cell  {
    width: 36px; height: 36px; border-radius: var(--radius);
    border: 1.5px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 500; cursor: pointer;
    transition: all 0.15s;
  }
  .palette-cell.answered { background: var(--navy); color: var(--white); border-color: var(--navy); }
  .palette-cell.current  { border-color: var(--kasg-gold); }

  /* Review warning */
  .review-warn {
    margin-top: 16px; padding: 12px 16px;
    background: #FEF3C7; border-radius: var(--radius);
    font-size: 13px; color: var(--warn);
    border-left: 3px solid var(--kasg-gold);
    display: none;
  }
  .review-warn.show { display: block; }
</style>
</head>
<body>

<header class="site-header">
  <div class="header-brand">
    <img class="header-logo-img" src="assets/logo-wide.png" alt="KASG">
  </div>
  <div class="header-nav">
    <div class="header-user-chip">ğŸ‘¤ <span id="header-name"></span></div>
  </div>
</header>

<div class="exam-layout">
  <div class="exam-header-card">
    <div>
      <div class="exam-title" id="exam-title">ìµœì¢… ì´í•´ë„ í‰ê°€</div>
      <div class="exam-subtitle" id="exam-subtitle">1ì°¨ ì‹œí—˜ Â· ì´ 20ë¬¸í•­ Â· ì‹œê°„ 40ë¶„</div>
    </div>
    <div class="timer-box" id="timer">40:00</div>
  </div>

  <div class="exam-body">
    <div class="exam-progress">
      <div class="ep-bar">
        <div class="progress-wrap" style="height:6px"><div class="progress-fill" id="ep-fill" style="width:5%"></div></div>
      </div>
      <span class="ep-text" id="ep-text">1 / 20</span>
    </div>

    <div class="question-num" id="q-num">Q 01 / 20</div>
    <div class="question-text" id="q-text">ë¬¸ì œ ë¡œë”© ì¤‘...</div>
    <div class="exam-opts" id="q-opts"></div>

    <div class="exam-nav">
      <button class="btn btn-outline" id="prev-btn" onclick="navigate(-1)">â† ì´ì „</button>
      <button class="btn btn-primary" id="next-btn" onclick="navigate(1)">ë‹¤ìŒ â†’</button>
    </div>

    <div class="answer-palette">
      <div class="palette-title">ë‹µì•ˆ í˜„í™©</div>
      <div class="palette-grid" id="palette"></div>
    </div>

    <div class="review-warn" id="review-warn">
      âš ï¸ ì•„ì§ ë‹µí•˜ì§€ ì•Šì€ ë¬¸í•­ì´ ìˆìŠµë‹ˆë‹¤. ëª¨ë‘ ë‹µí•œ í›„ ì œì¶œí•´ ì£¼ì„¸ìš”.
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script type="module">
import { DB } from './js/firebase-config.js';
import { requireAuth, fmtDate, generateCertNo, showToast } from './js/utils.js';
import { QUIZ_BANK } from './js/quiz-data.js';

const user     = requireAuth();
const courseId = sessionStorage.getItem('kasg_course');
if (!user || !courseId) { window.location.href = 'dashboard.html'; throw 0; }

document.getElementById('header-name').textContent = user.name;

let questions = [];
let answers   = {};
let curIdx    = 0;
let timerSec  = 40 * 60;
let timerInt  = null;
let attempt   = 1;
let learner   = null;
let course    = null;

async function init() {
  [learner, course] = await Promise.all([
    DB.get(`learners/${user.safeId}`),
    DB.get(`courses/${courseId}`)
  ]);

  // Guard: must have watched video
  const status = learner?.courseStatus?.[courseId];
  if (status !== 'watched' && learner?.status !== 'completed') {
    const prog = learner?.courseProgress?.[courseId] || 0;
    if (prog < 0.99) {
      alert('ì˜ìƒì„ ëê¹Œì§€ ì‹œì²­í•´ì•¼ í‰ê°€ì— ì‘ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      window.location.href = 'player.html';
      return;
    }
  }

  // Guard: max 2 attempts
  attempt = (learner?.attempt || 0) + 1;
  if (attempt > 2) {
    alert('ìµœëŒ€ ì‘ì‹œ íšŸìˆ˜(2íšŒ)ë¥¼ ì´ˆê³¼í•˜ì˜€ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
    window.location.href = 'dashboard.html';
    return;
  }

  // Pick question set
  const setKey   = attempt === 1 ? 'A' : 'B';
  questions      = QUIZ_BANK[setKey];
  document.getElementById('exam-subtitle').textContent = `${attempt}ì°¨ ì‹œí—˜ Â· ì´ ${questions.length}ë¬¸í•­ Â· ì‹œê°„ 40ë¶„`;

  buildPalette();
  renderQ();
  startTimer();
}

function renderQ() {
  const q = questions[curIdx];
  const n = curIdx + 1;
  const t = questions.length;

  document.getElementById('q-num').textContent  = `Q ${String(n).padStart(2,'0')} / ${String(t).padStart(2,'0')}`;
  document.getElementById('q-text').textContent = q.q;
  document.getElementById('ep-fill').style.width = (n / t * 100) + '%';
  document.getElementById('ep-text').textContent = `${n} / ${t}`;

  const sel = answers[curIdx];
  document.getElementById('q-opts').innerHTML = q.opts.map((o, i) => `
    <div class="exam-opt ${sel === i ? 'selected' : ''}" onclick="selectOpt(${i})">
      <span class="exam-opt-n">${i+1}</span>${o}
    </div>`).join('');

  document.getElementById('prev-btn').disabled = curIdx === 0;
  document.getElementById('next-btn').textContent =
    curIdx === questions.length - 1 ? 'ìµœì¢… ì œì¶œ ğŸ' : 'ë‹¤ìŒ â†’';

  updatePalette();
  document.getElementById('review-warn').classList.remove('show');
}

window.selectOpt = function(i) {
  answers[curIdx] = i;
  renderQ();
};

window.navigate = function(dir) {
  const isLast = curIdx === questions.length - 1;
  if (answers[curIdx] === undefined) {
    document.getElementById('review-warn').classList.add('show');
    if (isLast) return;
  }
  if (isLast && dir === 1) {
    // Final submit
    const unanswered = questions.filter((_, i) => answers[i] === undefined).length;
    if (unanswered > 0) {
      document.getElementById('review-warn').classList.add('show');
      showToast(`${unanswered}ë¬¸í•­ì´ ë¯¸ë‹µ ìƒíƒœì…ë‹ˆë‹¤.`, 'error');
      return;
    }
    if (confirm('ìµœì¢… ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì œì¶œ í›„ ìˆ˜ì •ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.')) submitExam();
    return;
  }
  curIdx = Math.max(0, Math.min(questions.length - 1, curIdx + dir));
  renderQ();
};

function buildPalette() {
  document.getElementById('palette').innerHTML = questions.map((_, i) => `
    <div class="palette-cell" id="pc-${i}" onclick="jumpTo(${i})">${i+1}</div>`).join('');
}
function updatePalette() {
  questions.forEach((_, i) => {
    const c = document.getElementById('pc-' + i);
    if (!c) return;
    c.className = 'palette-cell' +
      (answers[i] !== undefined ? ' answered' : '') +
      (i === curIdx ? ' current' : '');
  });
}
window.jumpTo = function(i) { curIdx = i; renderQ(); };

// Timer
function startTimer() {
  updateTimerEl();
  timerInt = setInterval(() => {
    timerSec--;
    updateTimerEl();
    if (timerSec <= 0) { clearInterval(timerInt); alert('ì‹œí—˜ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); submitExam(); }
  }, 1000);
}
function updateTimerEl() {
  const m = Math.floor(timerSec / 60).toString().padStart(2,'0');
  const s = (timerSec % 60).toString().padStart(2,'0');
  const el = document.getElementById('timer');
  el.textContent = `${m}:${s}`;
  el.className = 'timer-box' + (timerSec < 300 ? ' urgent' : '');
}

async function submitExam() {
  clearInterval(timerInt);
  const total  = questions.length;
  let correct  = 0;
  questions.forEach((q, i) => { if (answers[i] === q.ans) correct++; });
  const score  = Math.round(correct / total * 100);
  const passed = score >= 70;
  const now    = new Date();

  const updates = {
    attempt,
    finalScore: score,
    finalPassed: passed,
    lastExamDate: now.toISOString(),
    [`courseStatus/${courseId}`]: passed ? 'completed' : 'failed',
  };

  if (passed) {
    const certNo   = generateCertNo();
    const certDate = now.toISOString();
    updates.status   = 'completed';
    updates.certNo   = certNo;
    updates.certDate = certDate;
    updates[`courseCerts/${courseId}`] = { certNo, certDate, score };
    // Add to completions log
    await DB.push('completions', {
      name: user.name, org: user.org, safeId: user.safeId,
      courseId, courseTitle: course?.title || '',
      certNo, score, date: now.toISOString()
    });
  }

  await DB.update(`learners/${user.safeId}`, updates);

  // Store result in session for result page
  sessionStorage.setItem('kasg_result', JSON.stringify({ score, passed, correct, total, attempt }));
  window.location.href = 'result.html';
}

init();
</script>
</body>
</html>
