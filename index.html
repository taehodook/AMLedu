<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¡œê·¸ì¸ â€” KASG AML êµìœ¡ ì‹œìŠ¤í…œ</title>
<link rel="stylesheet" href="css/main.css">
<style>
body{background:linear-gradient(150deg,#050D1F 0%,#0C1F3F 55%,#091428 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;position:relative;overflow:hidden}
body::before{content:'';position:absolute;width:800px;height:800px;border-radius:50%;border:1px solid rgba(200,150,10,.06);top:-300px;right:-200px;pointer-events:none}
body::after{content:'';position:absolute;width:600px;height:600px;border-radius:50%;border:1px solid rgba(200,48,42,.05);bottom:-250px;left:-150px;pointer-events:none}

.auth-wrap{width:440px;max-width:100%;position:relative;z-index:1}

.auth-logo-wrap{text-align:center;margin-bottom:24px}
.auth-logo-img{height:52px;margin:0 auto 10px}
.auth-logo-sub{font-size:11px;color:rgba(255,255,255,.4);letter-spacing:2px;text-transform:uppercase}

.auth-card{background:#fff;border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 32px 80px rgba(0,0,0,.55);border-top:5px solid var(--kasg-gold);animation:cardIn .4s ease}
@keyframes cardIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:none}}

/* Tab */
.auth-tabs{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border)}
.auth-tab{padding:16px;text-align:center;font-size:14px;font-weight:500;cursor:pointer;color:var(--text-mid);border-bottom:3px solid transparent;margin-bottom:-1px;transition:all .2s}
.auth-tab.active{color:var(--navy);border-bottom-color:var(--kasg-gold);font-weight:700}

.auth-body{padding:28px 36px 34px}

.tab-panel{display:none}
.tab-panel.active{display:block;animation:fadeIn .25s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

.panel-title{font-family:'Noto Serif KR',serif;font-size:18px;font-weight:700;color:var(--navy);text-align:center;margin-bottom:22px}

.err-box{background:#FEE2E2;color:var(--error);padding:10px 14px;border-radius:var(--radius);font-size:13px;margin-bottom:14px;border-left:3px solid var(--error);display:none}
.err-box.show{display:block}
.ok-box{background:#D1FAE5;color:var(--success);padding:10px 14px;border-radius:var(--radius);font-size:13px;margin-bottom:14px;border-left:3px solid var(--success);display:none}
.ok-box.show{display:block}

.auth-footer{padding:14px 36px;background:var(--cream);border-top:1px solid var(--border);font-size:11px;color:var(--text-light);text-align:center;line-height:1.7}

.admin-link{text-align:center;margin-top:14px;font-size:12px;color:rgba(255,255,255,.4)}
.admin-link a{color:rgba(255,255,255,.6);cursor:pointer}
.admin-link a:hover{color:var(--kasg-gold)}

.pw-toggle{position:relative}
.pw-toggle input{padding-right:40px}
.pw-toggle-btn{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text-light);font-size:15px;padding:0}
</style>
</head>
<body>

<div class="auth-wrap">
  <div class="auth-logo-wrap">
    <img class="auth-logo-img" src="assets/logo-wide.png" alt="KASG">
    <div class="auth-logo-sub">AML Online Education System</div>
  </div>

  <div class="auth-card">
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchTab('login')">ë¡œê·¸ì¸</div>
      <div class="auth-tab" onclick="switchTab('register')">íšŒì›ê°€ì…</div>
    </div>

    <div class="auth-body">
      <!-- â”€â”€ LOGIN â”€â”€ -->
      <div class="tab-panel active" id="tab-login">
        <div class="panel-title">ìˆ˜ê°•ìƒ ë¡œê·¸ì¸</div>
        <div class="err-box" id="login-err"></div>
        <div class="form-group">
          <label class="form-label">ì•„ì´ë”” (ì´ë©”ì¼ ë˜ëŠ” ì„±í•¨)</label>
          <input class="form-input" id="l-id" type="text" placeholder="ê°€ì… ì‹œ ì…ë ¥í•œ ì•„ì´ë””" autocomplete="username">
        </div>
        <div class="form-group">
          <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
          <div class="pw-toggle">
            <input class="form-input" id="l-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
            <button class="pw-toggle-btn" onclick="togglePw('l-pw',this)">ğŸ‘</button>
          </div>
        </div>
        <button class="btn btn-primary btn-lg btn-block" onclick="doLogin()" id="login-btn">ë¡œê·¸ì¸</button>
      </div>

      <!-- â”€â”€ REGISTER â”€â”€ -->
      <div class="tab-panel" id="tab-register">
        <div class="panel-title">ìˆ˜ê°• ì‹ ì²­ / íšŒì›ê°€ì…</div>
        <div class="err-box" id="reg-err"></div>
        <div class="ok-box" id="reg-ok">âœ… ê°€ì… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!<br>ê´€ë¦¬ì ìŠ¹ì¸ í›„ ìˆ˜ê°•ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        <div class="form-group">
          <label class="form-label">ì•„ì´ë”” *</label>
          <input class="form-input" id="r-id" type="text" placeholder="ì˜ë¬¸/ìˆ«ì/ì´ë©”ì¼ í˜•ì‹">
        </div>
        <div class="form-group">
          <label class="form-label">ì„±ëª… *</label>
          <input class="form-input" id="r-name" type="text" placeholder="ì‹¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="form-group">
          <label class="form-label">ì†Œì† ê¸°ê´€ *</label>
          <input class="form-input" id="r-org" type="text" placeholder="ì†Œì† íšŒì‚¬ ë˜ëŠ” ê¸°ê´€ëª…">
        </div>
        <div class="form-group">
          <label class="form-label">ì—°ë½ì²˜</label>
          <input class="form-input" id="r-phone" type="tel" placeholder="010-0000-0000">
        </div>
        <div class="form-group">
          <label class="form-label">ë¹„ë°€ë²ˆí˜¸ *</label>
          <div class="pw-toggle">
            <input class="form-input" id="r-pw" type="password" placeholder="8ì ì´ìƒ">
            <button class="pw-toggle-btn" onclick="togglePw('r-pw',this)">ğŸ‘</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *</label>
          <input class="form-input" id="r-pw2" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥">
        </div>
        <div class="alert alert-warn" style="margin-bottom:16px;font-size:12px">
          âš ï¸ ê°€ì… í›„ ê´€ë¦¬ì ìŠ¹ì¸ì´ ì™„ë£Œë˜ì–´ì•¼ ê°•ì˜ë¥¼ ìˆ˜ê°•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
        <button class="btn btn-gold btn-lg btn-block" onclick="doRegister()" id="reg-btn">ìˆ˜ê°• ì‹ ì²­í•˜ê¸°</button>
      </div>
    </div>

    <div class="auth-footer">
      Â© 2025 í•œêµ­ìê¸ˆì„¸íƒë°©ì§€ì—°êµ¬íšŒ Â· Korea Anti-money Laundering Study Group
    </div>
  </div>

  <div class="admin-link">ê´€ë¦¬ì ë¡œê·¸ì¸ <a onclick="window.location.href='admin-login.html'">â†’ ê´€ë¦¬ì í˜ì´ì§€</a></div>
</div>

<div id="toast-container"></div>

<script type="module">
import { DB } from './js/firebase-config.js';
import { safeId, showToast } from './js/utils.js';

// Auto redirect if already logged in
if (sessionStorage.getItem('kasg_user')) window.location.href = 'dashboard.html';

window.switchTab = function(t) {
  document.querySelectorAll('.auth-tab').forEach((el,i)=>el.classList.toggle('active', (i===0&&t==='login')||(i===1&&t==='register')));
  document.getElementById('tab-login').classList.toggle('active', t==='login');
  document.getElementById('tab-register').classList.toggle('active', t==='register');
};

window.togglePw = function(id, btn) {
  const el = document.getElementById(id);
  el.type = el.type === 'password' ? 'text' : 'password';
  btn.textContent = el.type === 'password' ? 'ğŸ‘' : 'ğŸ™ˆ';
};

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.doLogin = async function() {
  const id = document.getElementById('l-id').value.trim();
  const pw = document.getElementById('l-pw').value;
  const errEl = document.getElementById('login-err');
  errEl.classList.remove('show');

  if (!id || !pw) { errEl.textContent='ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; errEl.classList.add('show'); return; }

  const btn = document.getElementById('login-btn');
  btn.disabled = true; btn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';

  try {
    const learner = await DB.get(`learners/${id.replace(/[.#$[\]]/g,'_')}`);
    if (!learner || learner.pw !== pw) {
      errEl.textContent = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
      errEl.classList.add('show');
      btn.disabled = false; btn.textContent = 'ë¡œê·¸ì¸';
      return;
    }
    if (learner.status === 'pending') {
      errEl.textContent = 'â³ ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ìŠ¹ì¸ í›„ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
      errEl.classList.add('show');
      btn.disabled = false; btn.textContent = 'ë¡œê·¸ì¸';
      return;
    }
    if (learner.status === 'rejected') {
      errEl.textContent = 'âŒ ê°€ì…ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
      errEl.classList.add('show');
      btn.disabled = false; btn.textContent = 'ë¡œê·¸ì¸';
      return;
    }
    sessionStorage.setItem('kasg_user', JSON.stringify({
      id: id.replace(/[.#$[\]]/g,'_'), name: learner.name, org: learner.org
    }));
    window.location.href = 'dashboard.html';
  } catch(e) {
    errEl.textContent = 'ì—°ê²° ì˜¤ë¥˜: ' + e.message;
    errEl.classList.add('show');
    btn.disabled = false; btn.textContent = 'ë¡œê·¸ì¸';
  }
};

// â”€â”€ REGISTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.doRegister = async function() {
  const id    = document.getElementById('r-id').value.trim();
  const name  = document.getElementById('r-name').value.trim();
  const org   = document.getElementById('r-org').value.trim();
  const phone = document.getElementById('r-phone').value.trim();
  const pw    = document.getElementById('r-pw').value;
  const pw2   = document.getElementById('r-pw2').value;
  const errEl = document.getElementById('reg-err');
  const okEl  = document.getElementById('reg-ok');
  errEl.classList.remove('show'); okEl.classList.remove('show');

  if (!id||!name||!org||!pw) { errEl.textContent='í•„ìˆ˜ í•­ëª©(*)ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; errEl.classList.add('show'); return; }
  if (pw.length < 8) { errEl.textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; errEl.classList.add('show'); return; }
  if (pw !== pw2)    { errEl.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; errEl.classList.add('show'); return; }

  const btn = document.getElementById('reg-btn');
  btn.disabled = true; btn.textContent = 'ì‹ ì²­ ì¤‘...';

  try {
    const dbKey = id.replace(/[.#$[\]]/g,'_');
    const exists = await DB.get(`learners/${dbKey}`);
    if (exists) { errEl.textContent='ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'; errEl.classList.add('show'); btn.disabled=false; btn.textContent='ìˆ˜ê°• ì‹ ì²­í•˜ê¸°'; return; }

    await DB.set(`learners/${dbKey}`, {
      id: dbKey, name, org, phone, pw,
      status: 'pending',        // ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸°
      approved: false,
      progress: 0, midQuizCorrect:0, midQuizTotal:0,
      finalScore: null, attempt: 0,
      certNo: null, certDate: null,
      createdAt: new Date().toISOString()
    });

    okEl.classList.add('show');
    ['r-id','r-name','r-org','r-phone','r-pw','r-pw2'].forEach(i=>document.getElementById(i).value='');
    btn.disabled = false; btn.textContent = 'ìˆ˜ê°• ì‹ ì²­í•˜ê¸°';
  } catch(e) {
    errEl.textContent = 'ì˜¤ë¥˜: ' + e.message;
    errEl.classList.add('show');
    btn.disabled = false; btn.textContent = 'ìˆ˜ê°• ì‹ ì²­í•˜ê¸°';
  }
};

document.addEventListener('keydown', e => {
  if (e.key==='Enter') {
    if (document.getElementById('tab-login').classList.contains('active')) window.doLogin();
    else window.doRegister();
  }
});
</script>
</body>
</html>
