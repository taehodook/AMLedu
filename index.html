<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¡œê·¸ì¸ â€” KASG AML êµìœ¡ ì‹œìŠ¤í…œ</title>
<link rel="stylesheet" href="css/main.css">
<style>
body{background:linear-gradient(150deg,#050D1F 0%,#0C1F3F 55%,#091428 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;position:relative;overflow-y:auto}
body::before{content:'';position:absolute;width:600px;height:600px;border-radius:50%;border:1px solid rgba(200,150,10,.05);top:-240px;right:-160px;pointer-events:none}
.auth-wrap{width:400px;max-width:100%;position:relative;z-index:1;margin:auto}
.auth-logo{text-align:center;margin-bottom:12px}
.auth-logo img{height:38px;margin:0 auto 5px}
.auth-logo-sub{font-size:9px;color:rgba(255,255,255,.3);letter-spacing:2px;text-transform:uppercase}
.auth-card{background:#fff;border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 24px 60px rgba(0,0,0,.55);border-top:4px solid var(--kasg-gold);animation:cardIn .35s ease}
@keyframes cardIn{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:none}}
.auth-tabs{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border)}
.auth-tab{padding:10px;text-align:center;font-size:12.5px;font-weight:500;cursor:pointer;color:var(--text-mid);border-bottom:3px solid transparent;margin-bottom:-1px;transition:all .18s}
.auth-tab.active{color:var(--navy);border-bottom-color:var(--kasg-gold);font-weight:700}
.auth-body{padding:16px 20px 18px}
.tab-panel{display:none}
.tab-panel.active{display:block;animation:fadeIn .18s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.panel-title{font-family:'Noto Serif KR',serif;font-size:14px;font-weight:700;color:var(--navy);text-align:center;margin-bottom:12px}
.err-box{background:#FEE2E2;color:var(--error);padding:7px 10px;border-radius:var(--radius);font-size:11px;margin-bottom:9px;border-left:3px solid var(--error);display:none}
.err-box.show{display:block}
.ok-box{background:#D1FAE5;color:var(--success);padding:7px 10px;border-radius:var(--radius);font-size:11px;margin-bottom:9px;border-left:3px solid var(--success);display:none}
.ok-box.show{display:block}
.auth-body .form-group{margin-bottom:8px}
.auth-body .form-label{font-size:11px;margin-bottom:3px;display:block;font-weight:600;color:var(--text-mid)}
.auth-body .form-input{padding:7px 10px;font-size:12px;height:34px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.pw-wrap{position:relative}
.pw-wrap input{padding-right:32px}
.pw-eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text-light);font-size:12px;padding:0}
.reg-notice{background:rgba(12,31,63,.04);border:1px solid rgba(12,31,63,.1);border-radius:var(--radius);padding:6px 10px;font-size:10px;color:var(--text-mid);margin-bottom:9px;line-height:1.5}
.auth-footer{padding:7px 20px;background:var(--cream);border-top:1px solid var(--border);font-size:9px;color:var(--text-light);text-align:center}
.admin-link{text-align:center;margin-top:7px;font-size:10px;color:rgba(255,255,255,.3)}
.admin-link a{color:rgba(255,255,255,.45);cursor:pointer;text-decoration:underline;text-underline-offset:2px}
.admin-link a:hover{color:var(--kasg-gold)}
</style>
</head>
<body>
<div class="auth-wrap">
  <div class="auth-logo">
    <img src="assets/logo-wide.png" alt="KASG">
    <div class="auth-logo-sub">AML Online Education System</div>
  </div>
  <div class="auth-card">
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchTab('login')" id="tab-btn-login">ë¡œê·¸ì¸</div>
      <div class="auth-tab" onclick="switchTab('register')" id="tab-btn-register">íšŒì› ê°€ì…</div>
    </div>
    <div class="auth-body">

      <!-- LOGIN -->
      <div class="tab-panel active" id="tab-login">
        <div class="panel-title">ìˆ˜ê°•ìƒ ë¡œê·¸ì¸</div>
        <div class="err-box" id="login-err"></div>
        <div class="form-group">
          <label class="form-label">ì•„ì´ë””</label>
          <input class="form-input" id="l-id" type="text" placeholder="ì•„ì´ë”” ì…ë ¥" autocomplete="username">
        </div>
        <div class="form-group" style="margin-bottom:13px">
          <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
          <div class="pw-wrap">
            <input class="form-input" id="l-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
            <button class="pw-eye" onclick="togglePw('l-pw',this)" type="button">ğŸ‘</button>
          </div>
        </div>
        <button class="btn btn-primary btn-lg btn-block" onclick="doLogin()" id="login-btn">ë¡œê·¸ì¸</button>
      </div>

      <!-- REGISTER -->
      <div class="tab-panel" id="tab-register">
        <div class="panel-title">íšŒì› ê°€ì…</div>
        <div class="err-box" id="reg-err"></div>
        <div class="ok-box" id="reg-ok">âœ… ê°€ì… ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì•„ì´ë”” *</label>
            <input class="form-input" id="r-id" type="text" placeholder="ì˜ë¬¸Â·ìˆ«ìÂ·_">
          </div>
          <div class="form-group">
            <label class="form-label">ì„±ëª… *</label>
            <input class="form-input" id="r-name" type="text" placeholder="í™ê¸¸ë™">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì†Œì† ê¸°ê´€ *</label>
            <input class="form-input" id="r-org" type="text" placeholder="íšŒì‚¬Â·ê¸°ê´€ëª…">
          </div>
          <div class="form-group">
            <label class="form-label">ë¶€ì„œ</label>
            <input class="form-input" id="r-dept" type="text" placeholder="ë¶€ì„œëª…">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì—°ë½ì²˜</label>
            <input class="form-input" id="r-phone" type="tel" placeholder="010-0000-0000">
          </div>
          <div class="form-group">
            <label class="form-label">ì´ë©”ì¼ * <span style="color:var(--kasg-blue);font-weight:400">(ì•Œë¦¼ìˆ˜ì‹ )</span></label>
            <input class="form-input" id="r-email" type="email" placeholder="example@co.kr">
          </div>
        </div>
        <div class="form-row" style="margin-bottom:9px">
          <div class="form-group">
            <label class="form-label">ë¹„ë°€ë²ˆí˜¸ * <span style="font-weight:400">(8ìâ†‘)</span></label>
            <div class="pw-wrap">
              <input class="form-input" id="r-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
              <button class="pw-eye" onclick="togglePw('r-pw',this)" type="button">ğŸ‘</button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *</label>
            <input class="form-input" id="r-pw2" type="password" placeholder="ì¬ì…ë ¥">
          </div>
        </div>
        <div class="reg-notice">âš ï¸ ê°€ì… í›„ <strong>ê´€ë¦¬ì ìŠ¹ì¸</strong> ì™„ë£Œ ì‹œ ë¡œê·¸ì¸Â·ê°•ì˜ ì‹ ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        <button class="btn btn-gold btn-lg btn-block" onclick="doRegister()" id="reg-btn">ê°€ì… ì‹ ì²­</button>
      </div>

    </div>
    <div class="auth-footer">Â© 2025 í•œêµ­ìê¸ˆì„¸íƒë°©ì§€ì—°êµ¬íšŒ Â· Korea Anti-money Laundering Study Group</div>
  </div>
  <div class="admin-link">ê´€ë¦¬ì <a onclick="window.location.href='admin-login.html'">â†’ ê´€ë¦¬ì ë¡œê·¸ì¸</a></div>
</div>

<div id="toast-container"></div>
<script type="module">
import { DB } from './js/firebase-config.js';
import { showToast } from './js/utils.js';

if (sessionStorage.getItem('kasg_user')) window.location.href = 'dashboard.html';

window.switchTab = function(t) {
  ['login','register'].forEach(r => {
    document.getElementById(`tab-btn-${r}`).classList.toggle('active', r===t);
    document.getElementById(`tab-${r}`).classList.toggle('active', r===t);
  });
};
window.togglePw = function(id, btn) {
  const el = document.getElementById(id);
  el.type = el.type==='password' ? 'text' : 'password';
  btn.textContent = el.type==='password' ? 'ğŸ‘' : 'ğŸ™ˆ';
};

window.doLogin = async function() {
  const id = document.getElementById('l-id').value.trim();
  const pw = document.getElementById('l-pw').value;
  const errEl = document.getElementById('login-err');
  errEl.classList.remove('show');
  if (!id || !pw) { errEl.textContent='ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; errEl.classList.add('show'); return; }
  const btn = document.getElementById('login-btn');
  btn.disabled=true; btn.textContent='í™•ì¸ ì¤‘...';
  try {
    const key = id.replace(/[.#$[\]]/g,'_');
    const learner = await DB.get(`learners/${key}`);
    if (!learner || learner.pw !== pw) {
      errEl.textContent='ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'; errEl.classList.add('show');
    } else if (learner.status==='pending') {
      errEl.textContent='â³ ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.'; errEl.classList.add('show');
    } else if (learner.status==='rejected') {
      errEl.textContent='âŒ ê°€ì…ì´ ê±°ì ˆëœ ìƒíƒœì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'; errEl.classList.add('show');
    } else {
      sessionStorage.setItem('kasg_user', JSON.stringify({
        id: key, name: learner.name, org: learner.org,
        grade: learner.grade||'general', dept: learner.dept||''
      }));
      window.location.href = 'dashboard.html';
    }
  } catch(e) { errEl.textContent='ì—°ê²° ì˜¤ë¥˜: '+e.message; errEl.classList.add('show'); }
  btn.disabled=false; btn.textContent='ë¡œê·¸ì¸';
};

window.doRegister = async function() {
  const id    = document.getElementById('r-id').value.trim();
  const name  = document.getElementById('r-name').value.trim();
  const email = document.getElementById('r-email').value.trim();
  const org   = document.getElementById('r-org').value.trim();
  const dept  = document.getElementById('r-dept').value.trim();
  const phone = document.getElementById('r-phone').value.trim();
  const pw    = document.getElementById('r-pw').value;
  const pw2   = document.getElementById('r-pw2').value;
  const errEl = document.getElementById('reg-err');
  const okEl  = document.getElementById('reg-ok');
  errEl.classList.remove('show'); okEl.classList.remove('show');

  if (!id||!name||!org)             { errEl.textContent='ì•„ì´ë””, ì„±ëª…, ì†Œì†ì„ ì…ë ¥í•˜ì„¸ìš”.'; errEl.classList.add('show'); return; }
  if (!email||!email.includes('@')) { errEl.textContent='ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; errEl.classList.add('show'); return; }
  if (pw.length < 8)                { errEl.textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; errEl.classList.add('show'); return; }
  if (pw !== pw2)                   { errEl.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; errEl.classList.add('show'); return; }

  const btn = document.getElementById('reg-btn');
  btn.disabled=true; btn.textContent='ì‹ ì²­ ì¤‘...';
  try {
    const key = id.replace(/[.#$[\]]/g,'_');
    if (await DB.get(`learners/${key}`)) {
      errEl.textContent='ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'; errEl.classList.add('show');
      btn.disabled=false; btn.textContent='ê°€ì… ì‹ ì²­'; return;
    }
    await DB.set(`learners/${key}`, {
      id:key, name, org, dept, phone, email, pw,
      grade:'general', gradeLabel:'ì¼ë°˜',
      status:'pending', approved:false,
      assignedCourses:[],
      progress:0, midQuizCorrect:0, midQuizTotal:0,
      finalScore:null, attempt:0,
      certNo:null, certDate:null,
      createdAt:new Date().toISOString()
    });
    okEl.classList.add('show');
    ['r-id','r-name','r-email','r-org','r-dept','r-phone','r-pw','r-pw2'].forEach(i=>document.getElementById(i).value='');
  } catch(e) { errEl.textContent='ì˜¤ë¥˜: '+e.message; errEl.classList.add('show'); }
  btn.disabled=false; btn.textContent='ê°€ì… ì‹ ì²­';
};

document.addEventListener('keydown', e => {
  if (e.key==='Enter') {
    if (document.getElementById('tab-login').classList.contains('active')) window.doLogin();
    else window.doRegister();
  }
});
</script>
</body>
</html>
