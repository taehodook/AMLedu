<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¡œê·¸ì¸ â€” KASG AML êµìœ¡ ì‹œìŠ¤í…œ</title>
<link rel="stylesheet" href="css/main.css">
<style>
body{background:linear-gradient(150deg,#050D1F 0%,#0C1F3F 55%,#091428 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;position:relative;overflow:hidden}
body::before{content:'';position:absolute;width:700px;height:700px;border-radius:50%;border:1px solid rgba(200,150,10,.05);top:-280px;right:-180px;pointer-events:none}
body::after{content:'';position:absolute;width:500px;height:500px;border-radius:50%;border:1px solid rgba(200,48,42,.04);bottom:-220px;left:-120px;pointer-events:none}
.auth-wrap{width:460px;max-width:100%;position:relative;z-index:1}
.auth-logo{text-align:center;margin-bottom:22px}
.auth-logo img{height:50px;margin:0 auto 8px}
.auth-logo-sub{font-size:10.5px;color:rgba(255,255,255,.38);letter-spacing:2px;text-transform:uppercase}
.auth-card{background:#fff;border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 32px 80px rgba(0,0,0,.55);border-top:5px solid var(--kasg-gold);animation:cardIn .4s ease}
@keyframes cardIn{from{opacity:0;transform:translateY(-18px)}to{opacity:1;transform:none}}
.auth-tabs{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border)}
.auth-tab{padding:14px;text-align:center;font-size:13.5px;font-weight:500;cursor:pointer;color:var(--text-mid);border-bottom:3px solid transparent;margin-bottom:-1px;transition:all .18s}
.auth-tab.active{color:var(--navy);border-bottom-color:var(--kasg-gold);font-weight:700}
.auth-body{padding:24px 32px 28px}
.tab-panel{display:none}
.tab-panel.active{display:block;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.panel-title{font-family:'Noto Serif KR',serif;font-size:17px;font-weight:700;color:var(--navy);text-align:center;margin-bottom:18px}
.err-box{background:#FEE2E2;color:var(--error);padding:9px 13px;border-radius:var(--radius);font-size:12.5px;margin-bottom:12px;border-left:3px solid var(--error);display:none}
.err-box.show{display:block}
.ok-box{background:#D1FAE5;color:var(--success);padding:9px 13px;border-radius:var(--radius);font-size:12.5px;margin-bottom:12px;border-left:3px solid var(--success);display:none}
.ok-box.show{display:block}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.pw-wrap{position:relative}
.pw-wrap input{padding-right:38px}
.pw-eye{position:absolute;right:11px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text-light);font-size:14px;padding:0;line-height:1}
.auth-footer{padding:12px 32px;background:var(--cream);border-top:1px solid var(--border);font-size:10.5px;color:var(--text-light);text-align:center}
.admin-link{text-align:center;margin-top:12px;font-size:11.5px;color:rgba(255,255,255,.38)}
.admin-link a{color:rgba(255,255,255,.58);cursor:pointer;text-decoration:underline;text-underline-offset:2px}
.admin-link a:hover{color:var(--kasg-gold)}

/* ë“±ê¸‰ ì„ íƒ ì¹´ë“œ */
.grade-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:4px}
.grade-card{padding:9px 10px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .15s;position:relative;overflow:hidden}
.grade-card:hover{border-color:var(--navy);background:rgba(12,31,63,.03)}
.grade-card.selected{border-color:var(--navy);background:var(--navy);color:#fff}
.grade-card input{position:absolute;opacity:0;pointer-events:none}
.grade-name{font-size:12px;font-weight:600;display:block;margin-bottom:2px}
.grade-desc{font-size:10px;opacity:.6;display:block;line-height:1.3}
</style>
</head>
<body>

<div class="auth-wrap">
  <div class="auth-logo">
    <img src="assets/logo-wide.png" alt="KASG">
    <div class="auth-logo-sub">AML Online Education System</div>
  </div>

  <div class="auth-card">
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchTab('login')" id="tab-btn-login">ë¡œê·¸ì¸</div>
      <div class="auth-tab" onclick="switchTab('register')" id="tab-btn-register">ìˆ˜ê°• ì‹ ì²­</div>
    </div>

    <div class="auth-body">

      <!-- â”€â”€ LOGIN â”€â”€ -->
      <div class="tab-panel active" id="tab-login">
        <div class="panel-title">ìˆ˜ê°•ìƒ ë¡œê·¸ì¸</div>
        <div class="err-box" id="login-err"></div>
        <div class="form-group">
          <label class="form-label">ì•„ì´ë””</label>
          <input class="form-input" id="l-id" type="text" placeholder="ê°€ì… ì‹œ ì…ë ¥í•œ ì•„ì´ë””" autocomplete="username">
        </div>
        <div class="form-group">
          <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
          <div class="pw-wrap">
            <input class="form-input" id="l-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
            <button class="pw-eye" onclick="togglePw('l-pw',this)" type="button">ğŸ‘</button>
          </div>
        </div>
        <button class="btn btn-primary btn-lg btn-block" onclick="doLogin()" id="login-btn">ë¡œê·¸ì¸</button>
      </div>

      <!-- â”€â”€ REGISTER â”€â”€ -->
      <div class="tab-panel" id="tab-register">
        <div class="panel-title">ìˆ˜ê°• ì‹ ì²­</div>
        <div class="err-box" id="reg-err"></div>
        <div class="ok-box" id="reg-ok">âœ… ì‹ ì²­ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ìˆ˜ê°• ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>

        <div class="form-group">
          <label class="form-label">ì•„ì´ë”” *</label>
          <input class="form-input" id="r-id" type="text" placeholder="ì˜ë¬¸Â·ìˆ«ìÂ·ì´ë©”ì¼ í˜•ì‹">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì„±ëª… *</label>
            <input class="form-input" id="r-name" type="text" placeholder="ì‹¤ëª…">
          </div>
          <div class="form-group">
            <label class="form-label">ì—°ë½ì²˜</label>
            <input class="form-input" id="r-phone" type="tel" placeholder="010-0000-0000">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì†Œì† ê¸°ê´€ *</label>
            <input class="form-input" id="r-org" type="text" placeholder="íšŒì‚¬Â·ê¸°ê´€ëª…">
          </div>
          <div class="form-group">
            <label class="form-label">ë¶€ì„œ</label>
            <input class="form-input" id="r-dept" type="text" placeholder="ë¶€ì„œëª…">
          </div>
        </div>

        <!-- ë“±ê¸‰ ì„ íƒ -->
        <div class="form-group">
          <label class="form-label">ìˆ˜ê°•ìƒ ë“±ê¸‰ *</label>
          <div class="grade-grid" id="grade-grid">
            <div class="grade-card" onclick="selectGrade('board',this)">
              <span class="grade-name">ğŸ› ì´ì‚¬íšŒÂ·ì„ì›</span>
              <span class="grade-desc">ê²½ì˜ì§„Â·ì´ì‚¬íšŒ êµ¬ì„±ì›</span>
            </div>
            <div class="grade-card" onclick="selectGrade('aml',this)">
              <span class="grade-name">ğŸ” AML ë‹´ë‹¹ì</span>
              <span class="grade-desc">ì»´í”Œë¼ì´ì–¸ìŠ¤Â·AML ì „ë‹´</span>
            </div>
            <div class="grade-card" onclick="selectGrade('general',this)">
              <span class="grade-name">ğŸ‘¤ ì¼ë°˜</span>
              <span class="grade-desc">ì¼ë°˜ ì§ì›Â·ìˆ˜ê°•ìƒ</span>
            </div>
            <div class="grade-card" onclick="selectGrade('research',this)">
              <span class="grade-name">ğŸ“ ì—°êµ¬íšŒ</span>
              <span class="grade-desc">í•œêµ­ìê¸ˆì„¸íƒë°©ì§€ì—°êµ¬íšŒ íšŒì›</span>
            </div>
          </div>
          <input type="hidden" id="r-grade" value="">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ë¹„ë°€ë²ˆí˜¸ * <span style="font-size:10px;font-weight:400">(8ìâ†‘)</span></label>
            <div class="pw-wrap">
              <input class="form-input" id="r-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
              <button class="pw-eye" onclick="togglePw('r-pw',this)" type="button">ğŸ‘</button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *</label>
            <input class="form-input" id="r-pw2" type="password" placeholder="ì¬ì…ë ¥">
          </div>
        </div>

        <div class="alert alert-warn" style="margin-bottom:14px;font-size:11.5px;padding:8px 12px">
          âš ï¸ ê´€ë¦¬ì ìŠ¹ì¸ ì™„ë£Œ í›„ ê°•ì˜ë¥¼ ìˆ˜ê°•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
        <button class="btn btn-gold btn-lg btn-block" onclick="doRegister()" id="reg-btn">ìˆ˜ê°• ì‹ ì²­í•˜ê¸°</button>
      </div>

    </div>
    <div class="auth-footer">Â© 2025 í•œêµ­ìê¸ˆì„¸íƒë°©ì§€ì—°êµ¬íšŒ Â· Korea Anti-money Laundering Study Group</div>
  </div>

  <div class="admin-link">ê´€ë¦¬ì <a onclick="window.location.href='admin-login.html'">â†’ ê´€ë¦¬ì ë¡œê·¸ì¸</a></div>
</div>

<div id="toast-container"></div>

<script type="module">
import { DB } from './js/firebase-config.js';
import { showToast } from './js/utils.js';

if (sessionStorage.getItem('kasg_user')) window.location.href = 'dashboard.html';

let selectedGrade = '';

window.switchTab = function(t) {
  document.getElementById('tab-btn-login').classList.toggle('active', t==='login');
  document.getElementById('tab-btn-register').classList.toggle('active', t==='register');
  document.getElementById('tab-login').classList.toggle('active', t==='login');
  document.getElementById('tab-register').classList.toggle('active', t==='register');
};

window.togglePw = function(id, btn) {
  const el = document.getElementById(id);
  el.type = el.type==='password' ? 'text' : 'password';
  btn.textContent = el.type==='password' ? 'ğŸ‘' : 'ğŸ™ˆ';
};

window.selectGrade = function(grade, el) {
  selectedGrade = grade;
  document.getElementById('r-grade').value = grade;
  document.querySelectorAll('.grade-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
};

// â”€â”€ LOGIN â”€â”€
window.doLogin = async function() {
  const id = document.getElementById('l-id').value.trim();
  const pw = document.getElementById('l-pw').value;
  const errEl = document.getElementById('login-err');
  errEl.classList.remove('show');
  if (!id || !pw) { errEl.textContent='ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; errEl.classList.add('show'); return; }
  const btn = document.getElementById('login-btn');
  btn.disabled=true; btn.textContent='í™•ì¸ ì¤‘...';
  try {
    const key = id.replace(/[.#$[\]]/g,'_');
    const learner = await DB.get(`learners/${key}`);
    if (!learner || learner.pw !== pw) {
      errEl.textContent='ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'; errEl.classList.add('show');
    } else if (learner.status==='pending') {
      errEl.textContent='â³ ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.'; errEl.classList.add('show');
    } else if (learner.status==='rejected') {
      errEl.textContent='âŒ ê°€ì… ê±°ì ˆ ìƒíƒœì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'; errEl.classList.add('show');
    } else {
      sessionStorage.setItem('kasg_user', JSON.stringify({
        id: key, name: learner.name, org: learner.org,
        grade: learner.grade||'general', dept: learner.dept||''
      }));
      window.location.href = 'dashboard.html';
    }
  } catch(e) {
    errEl.textContent='ì—°ê²° ì˜¤ë¥˜: '+e.message; errEl.classList.add('show');
  }
  btn.disabled=false; btn.textContent='ë¡œê·¸ì¸';
};

// â”€â”€ REGISTER â”€â”€
window.doRegister = async function() {
  const id    = document.getElementById('r-id').value.trim();
  const name  = document.getElementById('r-name').value.trim();
  const org   = document.getElementById('r-org').value.trim();
  const dept  = document.getElementById('r-dept').value.trim();
  const phone = document.getElementById('r-phone').value.trim();
  const grade = document.getElementById('r-grade').value;
  const pw    = document.getElementById('r-pw').value;
  const pw2   = document.getElementById('r-pw2').value;
  const errEl = document.getElementById('reg-err');
  const okEl  = document.getElementById('reg-ok');
  errEl.classList.remove('show'); okEl.classList.remove('show');

  if (!id||!name||!org)  { errEl.textContent='ì•„ì´ë””, ì„±ëª…, ì†Œì†ì„ ì…ë ¥í•˜ì„¸ìš”.'; errEl.classList.add('show'); return; }
  if (!grade)             { errEl.textContent='ìˆ˜ê°•ìƒ ë“±ê¸‰ì„ ì„ íƒí•˜ì„¸ìš”.'; errEl.classList.add('show'); return; }
  if (pw.length < 8)      { errEl.textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; errEl.classList.add('show'); return; }
  if (pw !== pw2)         { errEl.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; errEl.classList.add('show'); return; }

  const btn = document.getElementById('reg-btn');
  btn.disabled=true; btn.textContent='ì‹ ì²­ ì¤‘...';
  try {
    const key = id.replace(/[.#$[\]]/g,'_');
    if (await DB.get(`learners/${key}`)) {
      errEl.textContent='ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'; errEl.classList.add('show');
      btn.disabled=false; btn.textContent='ìˆ˜ê°• ì‹ ì²­í•˜ê¸°'; return;
    }
    const GRADE_LABELS = { board:'ì´ì‚¬íšŒÂ·ì„ì›', aml:'AML ë‹´ë‹¹ì', general:'ì¼ë°˜', research:'ì—°êµ¬íšŒ' };
    await DB.set(`learners/${key}`, {
      id: key, name, org, dept, phone, pw,
      grade, gradeLabel: GRADE_LABELS[grade]||grade,
      status: 'pending', approved: false,
      assignedCourses: [],   // ê´€ë¦¬ìê°€ ë°°ì •í•œ ê°•ì˜ ëª©ë¡
      progress: 0, midQuizCorrect:0, midQuizTotal:0,
      finalScore: null, attempt: 0,
      certNo: null, certDate: null,
      createdAt: new Date().toISOString()
    });
    okEl.classList.add('show');
    ['r-id','r-name','r-org','r-dept','r-phone','r-pw','r-pw2'].forEach(i => document.getElementById(i).value='');
    document.querySelectorAll('.grade-card').forEach(c=>c.classList.remove('selected'));
    selectedGrade='';
  } catch(e) {
    errEl.textContent='ì˜¤ë¥˜: '+e.message; errEl.classList.add('show');
  }
  btn.disabled=false; btn.textContent='ìˆ˜ê°• ì‹ ì²­í•˜ê¸°';
};

document.addEventListener('keydown', e => {
  if (e.key==='Enter') {
    if (document.getElementById('tab-login').classList.contains('active')) window.doLogin();
    else window.doRegister();
  }
});
</script>
</body>
</html>
