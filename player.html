<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê°•ì˜ ì‹œì²­ â€” KASG LMS</title>
<link rel="stylesheet" href="css/main.css">
<style>
body{background:#0A0A12;margin:0;overflow-x:hidden}
.player-layout{display:grid;grid-template-columns:1fr 340px;height:calc(100vh - 66px)}
@media(max-width:900px){.player-layout{grid-template-columns:1fr}}

/* Video */
.video-area{display:flex;flex-direction:column;background:#000}
.video-container{flex:1;position:relative;display:flex;align-items:center;justify-content:center;background:#000;min-height:300px;overflow:hidden}

/* YouTube iframe */
#yt-frame{width:100%;height:100%;border:none;position:relative;z-index:1}

/* Overlay to block YouTube controls & seeking on free plan */
.yt-block-overlay{position:absolute;bottom:0;left:0;right:0;height:60px;z-index:2;cursor:not-allowed;background:transparent}
.yt-top-overlay{position:absolute;top:0;left:0;right:80px;height:50px;z-index:2;cursor:not-allowed;background:transparent}

/* Fallback MP4 */
#main-video{width:100%;height:100%;object-fit:contain}

/* Quiz overlay */
.quiz-overlay{position:absolute;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;z-index:20;backdrop-filter:blur(8px)}
.quiz-overlay.active{display:flex;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.quiz-popup{background:#fff;border-radius:var(--radius-lg);width:540px;max-width:92vw;padding:34px 38px;border-top:5px solid var(--kasg-gold);box-shadow:0 32px 80px rgba(0,0,0,.7);animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(22px)}to{opacity:1;transform:none}}
.quiz-badge{display:flex;align-items:center;gap:10px;margin-bottom:18px}
.qbadge-num{width:34px;height:34px;border-radius:50%;background:var(--navy);color:var(--kasg-gold);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0}
.qbadge-title{font-size:11px;font-weight:600;color:var(--kasg-gold);letter-spacing:1px;text-transform:uppercase}
.qbadge-sub{font-size:12px;color:var(--text-mid)}
.quiz-q{font-family:'Noto Serif KR',serif;font-size:17px;font-weight:600;color:var(--navy);margin-bottom:20px;line-height:1.7}
.quiz-opts{display:flex;flex-direction:column;gap:8px}
.quiz-opt{padding:13px 15px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:14px;display:flex;align-items:center;gap:11px;transition:all .15s}
.quiz-opt:hover{border-color:var(--navy);background:rgba(12,31,63,.03)}
.quiz-opt.selected{border-color:var(--navy);background:var(--navy);color:#fff}
.quiz-opt.correct{border-color:var(--success);background:#D1FAE5;color:var(--success)}
.quiz-opt.wrong{border-color:var(--error);background:#FEE2E2;color:var(--error)}
.qopt-n{width:24px;height:24px;border-radius:50%;border:1.5px solid currentColor;opacity:.5;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}
.quiz-fb{margin-top:13px;padding:9px 13px;border-radius:var(--radius);font-size:13px;display:none}
.quiz-fb.show{display:block}
.quiz-fb.ok{background:#D1FAE5;color:var(--success);border-left:3px solid var(--success)}
.quiz-fb.err{background:#FEE2E2;color:var(--error);border-left:3px solid var(--error)}
.quiz-actions{margin-top:18px;display:flex;justify-content:flex-end;gap:8px}

/* Controls */
.video-controls{background:#14141E;padding:8px 18px;display:flex;align-items:center;gap:12px;border-top:1px solid rgba(255,255,255,.06)}
.vc-time{color:rgba(255,255,255,.55);font-size:12px;font-family:'DM Mono',monospace;white-space:nowrap}
.vc-bar{flex:1;height:4px;background:rgba(255,255,255,.1);border-radius:2px;position:relative}
.vc-fill{height:100%;background:linear-gradient(90deg,var(--kasg-gold),#E8C040);border-radius:2px;transition:width .5s;pointer-events:none}
.vc-marker{position:absolute;top:-8px;width:2px;height:20px;background:rgba(255,255,255,.25);transform:translateX(-50%)}
.vc-marker::before{content:attr(data-label);position:absolute;top:-16px;left:50%;transform:translateX(-50%);font-size:8px;color:var(--kasg-gold);white-space:nowrap}
.vc-lock{font-size:11px;color:rgba(255,165,0,.6);white-space:nowrap}

/* YouTube timer display */
.yt-timer-wrap{display:flex;align-items:center;gap:10px;flex:1}
.yt-warning{font-size:11px;color:rgba(255,165,0,.8)}

/* Sidebar */
.video-sidebar{background:var(--cream);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.sb-head{background:var(--navy);padding:18px;border-bottom:2px solid var(--kasg-gold)}
.sb-title{font-family:'Noto Serif KR',serif;font-size:13px;font-weight:700;color:#fff;margin-bottom:9px}
.sb-row{display:flex;justify-content:space-between;font-size:11px;color:rgba(255,255,255,.55);padding:3px 0}
.sb-row strong{color:rgba(255,255,255,.82)}
.sb-section{padding:16px 18px;border-bottom:1px solid var(--border)}
.sb-sec-title{font-size:10px;font-weight:600;letter-spacing:.5px;color:var(--text-mid);text-transform:uppercase;margin-bottom:11px}
.cp-list{display:flex;flex-direction:column;gap:7px}
.cp-item{display:flex;align-items:center;gap:9px;font-size:12px;color:var(--text-mid)}
.cp-dot{width:21px;height:21px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;transition:all .3s}
.cp-dot.done{background:var(--success);border-color:var(--success);color:#fff}
.cp-dot.active{border-color:var(--kasg-gold);background:rgba(200,150,10,.1);color:var(--kasg-gold)}
.score-block{padding:14px 18px;background:#fff}
.score-item{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid rgba(0,0,0,.05);font-size:12px;color:var(--text-mid)}
.score-item:last-child{border-bottom:none}
.score-val{font-weight:700;color:var(--navy);font-size:15px}
.score-big{font-family:'Noto Serif KR',serif;font-size:30px;font-weight:900;text-align:center;padding:6px 0}
.score-big.good{color:var(--success)}.score-big.bad{color:var(--error)}
.done-banner{margin:14px 18px;background:linear-gradient(135deg,var(--success) 0%,#2D8A5A 100%);border-radius:var(--radius-lg);padding:18px;text-align:center;color:#fff;display:none}
.done-banner.show{display:block;animation:fadeIn .5s ease}
.done-banner .icon{font-size:26px;margin-bottom:7px}
.done-banner .title{font-family:'Noto Serif KR',serif;font-size:14px;font-weight:700}
.done-banner .sub{font-size:11px;opacity:.8;margin-top:3px}
.sb-actions{padding:14px 18px;margin-top:auto;display:flex;flex-direction:column;gap:8px}

/* YouTube notice */
.yt-notice{padding:6px 12px;background:#1A1A2E;font-size:10px;color:rgba(255,255,255,.4);text-align:center}
</style>
</head>
<body>
<header class="site-header">
  <div class="header-brand">
    <img class="header-logo-img" src="assets/logo-wide.png" alt="KASG">
  </div>
  <div class="header-nav">
    <div class="header-chip">ğŸ‘¤ <span id="hd-name"></span></div>
    <button class="header-btn" onclick="window.location.href='dashboard.html'">â† ëª©ë¡</button>
  </div>
</header>

<div class="player-layout">
  <div class="video-area">
    <div class="video-container" id="video-container">
      <!-- YouTube or MP4 inserted here by JS -->
      <div class="quiz-overlay" id="quiz-overlay">
        <div class="quiz-popup">
          <div class="quiz-badge">
            <div class="qbadge-num" id="qz-num">1</div>
            <div><div class="qbadge-title">âš¡ ì´í•´ë„ í™•ì¸ ë¬¸ì œ</div><div class="qbadge-sub">ë¬¸ì œë¥¼ í’€ì–´ì•¼ ê³„ì† ì‹œì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div></div>
          </div>
          <div class="quiz-q" id="qz-q"></div>
          <div class="quiz-opts" id="qz-opts"></div>
          <div class="quiz-fb" id="qz-fb"></div>
          <div class="quiz-actions">
            <button class="btn btn-primary" id="qz-submit" onclick="submitMidQuiz()" disabled>ì œì¶œ</button>
            <button class="btn btn-gold" id="qz-continue" onclick="closeMidQuiz()" style="display:none">â–¶ ê³„ì† ì‹œì²­</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls: YouTube mode shows time estimate, MP4 mode shows real progress -->
    <div class="video-controls" id="vc-bar-wrap">
      <span class="vc-time" id="vc-time">00:00 / 00:00</span>
      <div class="vc-bar" id="vc-bar">
        <div class="vc-fill" id="vc-fill"></div>
      </div>
      <span class="vc-lock">ğŸ”’ ì•ìœ¼ë¡œ ë„˜ê¸°ê¸° ë¶ˆê°€</span>
    </div>
    <div class="yt-notice" id="yt-notice" style="display:none">
      ğŸ“Œ YouTube ì˜ìƒì˜ ì•ìœ¼ë¡œ ë„˜ê¸°ê¸° ë° ìŠ¤í‚µì„ ìì œí•´ ì£¼ì„¸ìš”. ì§„ë„ ì²´í¬ëŠ” ì‹œì²­ ì‹œê°„ ê¸°ì¤€ì…ë‹ˆë‹¤.
    </div>
  </div>

  <!-- Sidebar -->
  <div class="video-sidebar">
    <div class="sb-head">
      <div class="sb-title" id="sb-title">ê°•ì˜ ë¡œë”© ì¤‘...</div>
      <div class="sb-row"><span>êµìœ¡ëª©ì </span><strong id="sb-purpose">-</strong></div>
      <div class="sb-row"><span>êµìœ¡í˜•íƒœ</span><strong>ì˜¨ë¼ì¸ êµìœ¡</strong></div>
      <div class="sb-row"><span>ìˆ˜ë£Œê¸°ì¤€</span><strong>ìµœì¢…í‰ê°€ 70ì  ì´ìƒ</strong></div>
    </div>

    <div class="sb-section">
      <div class="sb-sec-title">ğŸ“ ì§„ë„ ì²´í¬í¬ì¸íŠ¸</div>
      <div class="cp-list" id="cp-list"></div>
    </div>

    <div class="score-block">
      <div class="sb-sec-title" style="margin-bottom:9px">ğŸ“Š ì¤‘ê°„ í€´ì¦ˆ í˜„í™©</div>
      <div class="score-item"><span>ì™„ë£Œ/ì „ì²´</span><span class="score-val" id="sc-done">0/3</span></div>
      <div class="score-item"><span>ì •ë‹µ ìˆ˜</span><span class="score-val" id="sc-correct">0</span></div>
      <div class="score-big" id="sc-pct" style="color:var(--text-mid);font-size:16px">-</div>
    </div>

    <div class="done-banner" id="done-banner">
      <div class="icon">ğŸ‰</div>
      <div class="title">ì˜ìƒ ì‹œì²­ ì™„ë£Œ!</div>
      <div class="sub">ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìµœì¢… í‰ê°€ë¥¼ ì‘ì‹œí•˜ì„¸ìš”</div>
    </div>

    <div class="sb-actions">
      <button class="btn btn-gold btn-block btn-lg" id="exam-btn" onclick="goExam()" style="display:none">ğŸ“ ìµœì¢… í‰ê°€ ì‘ì‹œ</button>
      <button class="btn btn-outline btn-block btn-sm" onclick="window.location.href='dashboard.html'">â† ê°•ì˜ ëª©ë¡</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script type="module">
import { DB } from './js/firebase-config.js';
import { requireAuth, fmtTime, showToast, toYoutubeEmbed } from './js/utils.js';
import { MID_QUIZZES } from './js/quiz-data.js';

const user     = requireAuth(); if (!user) throw 0;
const courseId = sessionStorage.getItem('kasg_course');
if (!courseId) { window.location.href = 'dashboard.html'; throw 0; }

document.getElementById('hd-name').textContent = user.name;

let course, learner;
let isYT         = false;
let ytPlayer     = null;
let ytDuration   = 0;
let ytChecked    = [false, false, false]; // checkpoint at 25,50,75%
let videoEnded   = false;
let maxProgress  = 0;
let midAnswered  = [false, false, false];
let midCorrect   = 0;
let activeMidIdx = -1;
let midSelected  = null;
let midDone      = false;
let saveTimer    = null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  [course, learner] = await Promise.all([
    DB.get(`courses/${courseId}`),
    DB.get(`learners/${user.id}`)
  ]);
  if (!course) { alert('ê°•ì˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); window.location.href = 'dashboard.html'; return; }

  document.getElementById('sb-title').textContent   = course.title;
  document.getElementById('sb-purpose').textContent = course.purpose || '-';

  // Restore saved data
  if (learner) {
    maxProgress = learner.courseProgress?.[courseId] || 0;
    if (learner.midAnswered?.[courseId]) midAnswered = learner.midAnswered[courseId];
    if (learner.midQuizCorrect)          midCorrect  = learner.midQuizCorrect;
    if (learner.completedStatus === 'completed' || learner.status === 'completed') {
      videoEnded = true;
      showCompletionUI();
    }
  }

  buildCheckpoints();
  updateScore();

  // YouTube or MP4?
  const ytEmbed = toYoutubeEmbed(course.videoURL || '');
  if (ytEmbed) {
    setupYouTube(ytEmbed);
  } else if (course.videoURL) {
    setupMP4(course.videoURL);
  } else {
    document.getElementById('video-container').innerHTML +=
      '<div style="color:rgba(255,255,255,.4);font-size:14px;position:absolute">ê°•ì˜ ì˜ìƒì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
  }

  // Periodic save
  saveTimer = setInterval(saveProgress, 15000);
}

// â”€â”€ YouTube Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupYouTube(embedUrl) {
  isYT = true;
  document.getElementById('yt-notice').style.display = '';

  // Parse video ID
  const m = embedUrl.match(/embed\/([A-Za-z0-9_-]{11})/);
  const videoId = m ? m[1] : '';

  // Load YouTube IFrame API
  const container = document.getElementById('video-container');
  container.insertAdjacentHTML('afterbegin', `
    <div id="yt-player" style="width:100%;height:100%;position:relative;z-index:1"></div>
    <div class="yt-block-overlay"></div>
    <div class="yt-top-overlay"></div>
  `);

  window.onYouTubeIframeAPIReady = function() {
    ytPlayer = new YT.Player('yt-player', {
      videoId,
      playerVars: { rel: 0, modestbranding: 1, controls: 1, fs: 0, disablekb: 1 },
      events: {
        onReady:       onYTReady,
        onStateChange: onYTState
      }
    });
  };

  const tag = document.createElement('script');
  tag.src = 'https://www.youtube.com/iframe_api';
  document.head.appendChild(tag);

  // Controls: just show elapsed time via polling
  document.getElementById('vc-bar-wrap').style.display = '';
}

function onYTReady(e) {
  ytDuration = ytPlayer.getDuration() || 0;
  // Restore position (capped at maxProgress)
  const restoreTime = Math.max(0, maxProgress * ytDuration - 3);
  if (restoreTime > 5) ytPlayer.seekTo(restoreTime, true);

  // Poll every 2s for time & seek prevention
  setInterval(() => {
    if (!ytPlayer || typeof ytPlayer.getCurrentTime !== 'function') return;
    const cur = ytPlayer.getCurrentTime();
    const dur = ytPlayer.getDuration() || ytDuration || 1;
    ytDuration = dur;

    // Prevent forward seek
    const allowed = maxProgress * dur + 5;
    if (cur > allowed + 5) {
      ytPlayer.seekTo(maxProgress * dur, true);
      showToast('ì•ìœ¼ë¡œ ë„˜ê¸°ê¸°ëŠ” í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'warn');
      return;
    }
    if (cur / dur > maxProgress) maxProgress = cur / dur;

    document.getElementById('vc-time').textContent = fmtTime(cur) + ' / ' + fmtTime(dur);
    document.getElementById('vc-fill').style.width = (cur/dur*100) + '%';
    updateCheckpoints();

    // Mid quiz triggers at 25,50,75%
    const ratio = cur / dur;
    if (!midAnswered[0] && ratio >= 0.25 && !ytChecked[0]) { ytChecked[0]=true; ytPlayer.pauseVideo(); showMidQuiz(0); }
    if (!midAnswered[1] && ratio >= 0.50 && !ytChecked[1]) { ytChecked[1]=true; ytPlayer.pauseVideo(); showMidQuiz(1); }
    if (!midAnswered[2] && ratio >= 0.75 && !ytChecked[2]) { ytChecked[2]=true; ytPlayer.pauseVideo(); showMidQuiz(2); }
  }, 2000);
}

function onYTState(e) {
  if (e.data === YT.PlayerState.ENDED) {
    videoEnded = true; maxProgress = 1;
    saveProgress();
    showCompletionUI();
  }
}

// â”€â”€ MP4 Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupMP4(url) {
  const container = document.getElementById('video-container');
  container.insertAdjacentHTML('afterbegin', `
    <video id="main-video" controlsList="nodownload nofullscreen noremoteplayback" disablePictureInPicture style="width:100%;height:100%;object-fit:contain">
      <source src="${url}" type="video/mp4">
    </video>`);

  const video = document.getElementById('main-video');
  let currentTime = 0;

  video.addEventListener('loadedmetadata', () => {
    const dur = video.duration;
    if (maxProgress > 0) video.currentTime = Math.max(0, maxProgress * dur - 2);
    buildVCMarkers(dur);
  });

  video.addEventListener('seeking', () => {
    const allowed = maxProgress * video.duration + 2;
    if (video.currentTime > allowed) { video.currentTime = currentTime; showToast('ì•ìœ¼ë¡œ ë„˜ê¸°ê¸°ëŠ” ë¶ˆê°€í•©ë‹ˆë‹¤.','warn'); }
  });

  video.addEventListener('timeupdate', () => {
    const cur = video.currentTime, dur = video.duration || 1;
    if (cur > maxProgress * dur + 2) { video.currentTime = maxProgress * dur; return; }
    if (cur / dur > maxProgress) maxProgress = cur / dur;
    currentTime = cur;
    document.getElementById('vc-time').textContent = fmtTime(cur) + ' / ' + fmtTime(dur);
    document.getElementById('vc-fill').style.width = (cur/dur*100) + '%';
    updateCheckpoints();
    const ratio = cur / dur;
    if (!midAnswered[0] && ratio >= 0.25) { video.pause(); showMidQuiz(0); }
    if (!midAnswered[1] && ratio >= 0.50) { video.pause(); showMidQuiz(1); }
    if (!midAnswered[2] && ratio >= 0.75) { video.pause(); showMidQuiz(2); }
  });

  video.addEventListener('ended', () => {
    videoEnded = true; maxProgress = 1;
    saveProgress(); showCompletionUI();
  });
}

function buildVCMarkers(dur) {
  const bar = document.getElementById('vc-bar');
  [0.25,0.50,0.75].forEach((r,i) => {
    const m = document.createElement('div');
    m.className = 'vc-marker';
    m.style.left = (r*100) + '%';
    m.setAttribute('data-label', `í€´ì¦ˆ${i+1}`);
    bar.appendChild(m);
  });
}

// â”€â”€ Checkpoints â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCheckpoints() {
  const items = ['ê°•ì˜ ì‹œì‘','êµ¬ê°„ í€´ì¦ˆ â‘  (25%)','êµ¬ê°„ í€´ì¦ˆ â‘¡ (50%)','êµ¬ê°„ í€´ì¦ˆ â‘¢ (75%)','ì˜ìƒ ì™„ë£Œ','ìµœì¢… í‰ê°€ ì‘ì‹œ','ìˆ˜ë£Œ ì™„ë£Œ'];
  document.getElementById('cp-list').innerHTML = items.map((c,i) =>
    `<div class="cp-item"><div class="cp-dot" id="cp-${i}">Â·</div><span>${c}</span></div>`
  ).join('');
}
function updateCheckpoints() {
  const dones = [
    maxProgress > 0.01,
    midAnswered[0], midAnswered[1], midAnswered[2],
    videoEnded,
    (learner?.attempt||0) > 0,
    learner?.completedStatus === 'completed' || learner?.status === 'completed'
  ];
  dones.forEach((done, i) => {
    const dot = document.getElementById('cp-'+i); if (!dot) return;
    const isNext = !done && dones.slice(0,i).every(Boolean);
    dot.className = 'cp-dot' + (done ? ' done' : isNext ? ' active' : '');
    dot.textContent = done ? 'âœ“' : 'Â·';
  });
}

// â”€â”€ Mid Quiz â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMidQuiz(idx) {
  activeMidIdx = idx; midSelected = null; midDone = false;
  const q = MID_QUIZZES[idx];
  document.getElementById('qz-num').textContent = idx+1;
  document.getElementById('qz-q').textContent = q.q;
  document.getElementById('qz-fb').className = 'quiz-fb';
  document.getElementById('qz-submit').disabled = true;
  document.getElementById('qz-submit').style.display = '';
  document.getElementById('qz-continue').style.display = 'none';
  document.getElementById('qz-opts').innerHTML = q.opts.map((o,i) =>
    `<div class="quiz-opt" id="qzo-${i}" onclick="selectMidOpt(${i})"><span class="qopt-n">${i+1}</span>${o}</div>`
  ).join('');
  document.getElementById('quiz-overlay').classList.add('active');
}

window.selectMidOpt = function(i) {
  if (midDone) return;
  midSelected = i;
  document.querySelectorAll('.quiz-opt').forEach((el,j) => el.className='quiz-opt'+(j===i?' selected':''));
  document.getElementById('qz-submit').disabled = false;
};

window.submitMidQuiz = function() {
  if (midSelected === null || midDone) return;
  midDone = true;
  const q = MID_QUIZZES[activeMidIdx], ok = midSelected === q.ans;
  if (ok) midCorrect++;
  midAnswered[activeMidIdx] = true;
  document.querySelectorAll('.quiz-opt').forEach((el,i) => {
    if (i===q.ans) el.className='quiz-opt correct';
    else if (i===midSelected) el.className='quiz-opt wrong';
  });
  const fb = document.getElementById('qz-fb');
  fb.className = 'quiz-fb show ' + (ok?'ok':'err');
  fb.textContent = ok ? 'âœ… ì •ë‹µì…ë‹ˆë‹¤!' : `âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µ: "${q.opts[q.ans]}"`;
  document.getElementById('qz-submit').style.display = 'none';
  document.getElementById('qz-continue').style.display = '';
  saveProgress(); updateScore();
};

window.closeMidQuiz = function() {
  document.getElementById('quiz-overlay').classList.remove('active');
  const vid = document.getElementById('main-video');
  if (vid) vid.play();
  else if (ytPlayer?.playVideo) ytPlayer.playVideo();
  updateCheckpoints();
};

function updateScore() {
  const done = midAnswered.filter(Boolean).length;
  document.getElementById('sc-done').textContent    = done+'/3';
  document.getElementById('sc-correct').textContent = midCorrect;
  if (done > 0) {
    const p = Math.round(midCorrect/done*100);
    const el = document.getElementById('sc-pct');
    el.textContent = p+'%'; el.className='score-big '+(p>=70?'good':'bad');
  }
}

function showCompletionUI() {
  document.getElementById('done-banner').classList.add('show');
  document.getElementById('exam-btn').style.display = '';
  updateCheckpoints();
}

window.goExam = function() {
  if (!videoEnded) { showToast('ì˜ìƒì„ ëê¹Œì§€ ì‹œì²­í•´ì•¼ í•©ë‹ˆë‹¤.','error'); return; }
  saveProgress(); window.location.href = 'exam.html';
};

async function saveProgress() {
  const up = {
    progress: maxProgress,
    [`courseProgress/${courseId}`]: maxProgress,
    [`courseStatus/${courseId}`]: videoEnded ? 'watched' : 'in_progress',
    [`midAnswered/${courseId}`]: midAnswered,
    midQuizCorrect: midCorrect,
    midQuizTotal: midAnswered.filter(Boolean).length,
    status: videoEnded ? 'in_progress' : (maxProgress > 0 ? 'in_progress' : 'approved')
  };
  await DB.update(`learners/${user.id}`, up);
}

init();
window.addEventListener('beforeunload', () => { clearInterval(saveTimer); saveProgress(); });
</script>
</body>
</html>
