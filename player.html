<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê°•ì˜ ì‹œì²­ â€” KASG LMS</title>
<link rel="stylesheet" href="css/main.css">
<style>
body{background:#0A0A12;margin:0;overflow:hidden}
.player-layout{display:grid;grid-template-columns:1fr 300px;height:calc(100vh - 66px)}
@media(max-width:900px){.player-layout{grid-template-columns:1fr;overflow-y:auto}}
.video-area{display:flex;flex-direction:column;background:#000;min-width:0}
.video-container{flex:1;position:relative;background:#000;overflow:hidden}
#yt-player,#yt-player iframe{width:100%!important;height:100%!important;border:none}
.yt-block-overlay{position:absolute;bottom:0;left:0;right:0;height:52px;z-index:2;background:transparent}

/* â”€â”€ QUIZ OVERLAY â”€â”€ */
.quiz-overlay{
  position:absolute;inset:0;background:rgba(0,0,0,.82);
  display:none;align-items:center;justify-content:center;
  z-index:30;backdrop-filter:blur(5px);padding:10px;overflow-y:auto;
}
.quiz-overlay.active{display:flex;animation:qzIn .22s ease}
@keyframes qzIn{from{opacity:0}to{opacity:1}}
.quiz-popup{
  background:#fff;border-radius:var(--radius-lg);
  width:100%;max-width:460px;
  max-height:min(520px,calc(100vh - 90px));
  overflow-y:auto;border-top:4px solid var(--kasg-gold);
  box-shadow:0 20px 60px rgba(0,0,0,.8);
  padding:16px 18px;flex-shrink:0;
  animation:popUp .22s ease;
}
@keyframes popUp{from{opacity:0;transform:scale(.97) translateY(10px)}to{opacity:1;transform:none}}
.qz-hd{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding-bottom:9px;border-bottom:1px solid rgba(0,0,0,.07)}
.qz-badge{width:24px;height:24px;border-radius:50%;background:var(--navy);color:var(--kasg-gold);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0}
.qz-hd-text{flex:1;min-width:0}
.qz-hd-title{font-size:9.5px;font-weight:700;color:var(--kasg-gold);letter-spacing:.8px;text-transform:uppercase}
.qz-hd-sub{font-size:10.5px;color:var(--text-mid)}
.qz-tag{font-size:9px;color:rgba(255,255,255,.7);padding:2px 7px;border-radius:8px;white-space:nowrap;flex-shrink:0}
.qz-tag.registered{background:#1A6B40}
.qz-tag.ai{background:var(--navy)}
.qz-loading-row{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-mid);margin-bottom:10px}
.mini-spin{width:12px;height:12px;border:2px solid rgba(0,0,0,.1);border-top-color:var(--navy);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
.qz-q{font-family:'Noto Serif KR',serif;font-size:13.5px;font-weight:600;color:var(--navy);line-height:1.6;margin-bottom:11px}
.qz-opts{display:flex;flex-direction:column;gap:5px}
.qz-opt{padding:8px 11px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:12.5px;display:flex;align-items:flex-start;gap:8px;transition:all .12s;line-height:1.45}
.qz-opt:hover{border-color:var(--navy);background:rgba(12,31,63,.04)}
.qz-opt.selected{border-color:var(--navy);background:var(--navy);color:#fff}
.qz-opt.correct{border-color:var(--success);background:#D1FAE5;color:var(--success)}
.qz-opt.wrong{border-color:var(--error);background:#FEE2E2;color:var(--error)}
.qz-n{width:18px;height:18px;border-radius:50%;border:1.5px solid currentColor;opacity:.5;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;flex-shrink:0;margin-top:1px}
.qz-fb{margin-top:9px;padding:7px 10px;border-radius:var(--radius);font-size:11.5px;display:none;line-height:1.5}
.qz-fb.show{display:block}
.qz-fb.ok{background:#D1FAE5;color:var(--success);border-left:3px solid var(--success)}
.qz-fb.err{background:#FEE2E2;color:var(--error);border-left:3px solid var(--error)}
.qz-acts{margin-top:10px;display:flex;justify-content:flex-end;gap:6px}

/* Controls */
.video-controls{background:#14141E;padding:6px 14px;display:flex;align-items:center;gap:10px;border-top:1px solid rgba(255,255,255,.06);flex-shrink:0}
.vc-time{color:rgba(255,255,255,.5);font-size:11px;font-family:'DM Mono',monospace;white-space:nowrap}
.vc-bar{flex:1;height:4px;background:rgba(255,255,255,.1);border-radius:2px;position:relative;cursor:not-allowed}
.vc-fill{height:100%;background:linear-gradient(90deg,var(--kasg-gold),#E8C040);border-radius:2px;transition:width .4s;pointer-events:none}
.vc-marker{position:absolute;top:-7px;width:2px;height:18px;background:rgba(255,255,255,.2);transform:translateX(-50%)}
.vc-marker::before{content:attr(data-label);position:absolute;top:-13px;left:50%;transform:translateX(-50%);font-size:7.5px;color:var(--kasg-gold);white-space:nowrap}
.vc-lock{font-size:10px;color:rgba(255,165,0,.5);white-space:nowrap}
.speed-wrap{display:flex;align-items:center;gap:4px}
.speed-lbl{font-size:9.5px;color:rgba(255,255,255,.38);white-space:nowrap}
.speed-sel{background:#22223A;color:rgba(255,255,255,.78);border:1px solid rgba(255,255,255,.16);border-radius:3px;padding:2px 5px;font-size:11px;cursor:pointer;outline:none}
.speed-sel option{background:#14141E}

/* Sidebar */
.video-sidebar{background:var(--cream);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;min-width:0}
.sb-hd{background:var(--navy);padding:13px 14px;border-bottom:2px solid var(--kasg-gold)}
.sb-title{font-family:'Noto Serif KR',serif;font-size:12px;font-weight:700;color:#fff;margin-bottom:6px;line-height:1.4}
.sb-row{display:flex;justify-content:space-between;font-size:9.5px;color:rgba(255,255,255,.48);padding:2px 0}
.sb-row strong{color:rgba(255,255,255,.78)}
.sb-sec{padding:11px 13px;border-bottom:1px solid var(--border)}
.sb-sec-t{font-size:9px;font-weight:600;letter-spacing:.5px;color:var(--text-mid);text-transform:uppercase;margin-bottom:9px}
.cp-list{display:flex;flex-direction:column;gap:5px}
.cp-item{display:flex;align-items:center;gap:7px;font-size:11px;color:var(--text-mid)}
.cp-dot{width:17px;height:17px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:8.5px;flex-shrink:0;transition:all .3s}
.cp-dot.done{background:var(--success);border-color:var(--success);color:#fff}
.cp-dot.active{border-color:var(--kasg-gold);background:rgba(200,150,10,.1);color:var(--kasg-gold)}
.score-blk{padding:11px 13px;background:#fff}
.sc-item{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(0,0,0,.05);font-size:11px;color:var(--text-mid)}
.sc-item:last-child{border-bottom:none}
.sc-val{font-weight:700;color:var(--navy);font-size:13px}
.sc-big{font-family:'Noto Serif KR',serif;font-size:22px;font-weight:900;text-align:center;padding:4px 0}
.sc-big.good{color:var(--success)}.sc-big.bad{color:var(--error)}
.done-banner{margin:10px 13px;background:linear-gradient(135deg,var(--success),#2D8A5A);border-radius:var(--radius-lg);padding:13px;text-align:center;color:#fff;display:none}
.done-banner.show{display:block;animation:qzIn .5s ease}
.done-banner .icon{font-size:20px;margin-bottom:4px}
.done-banner .t{font-family:'Noto Serif KR',serif;font-size:12px;font-weight:700}
.done-banner .s{font-size:10px;opacity:.8;margin-top:2px}
.sb-acts{padding:11px 13px;margin-top:auto;display:flex;flex-direction:column;gap:6px}
.yt-notice{padding:4px 10px;background:#1A1A2E;font-size:9px;color:rgba(255,255,255,.32);text-align:center;flex-shrink:0}
</style>
</head>
<body>
<header class="site-header">
  <div class="header-brand"><img class="header-logo-img" src="assets/logo-wide.png" alt="KASG"></div>
  <div class="header-nav">
    <div class="header-chip">ğŸ‘¤ <span id="hd-name"></span></div>
    <button class="header-btn" onclick="window.location.href='dashboard.html'">â† ëª©ë¡</button>
  </div>
</header>

<div class="player-layout">
  <div class="video-area">
    <div class="video-container" id="video-container">
      <!-- â”€â”€ QUIZ OVERLAY â”€â”€ -->
      <div class="quiz-overlay" id="quiz-overlay">
        <div class="quiz-popup">
          <div class="qz-hd">
            <div class="qz-badge" id="qz-num">1</div>
            <div class="qz-hd-text">
              <div class="qz-hd-title">âš¡ ì´í•´ë„ í™•ì¸ ë¬¸ì œ</div>
              <div class="qz-hd-sub">í’€ì–´ì•¼ ê³„ì† ì‹œì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
            </div>
            <span class="qz-tag" id="qz-tag" style="display:none"></span>
          </div>
          <div class="qz-loading-row" id="qz-loading" style="display:none">
            <div class="mini-spin"></div>ê°•ì˜ ë‚´ìš© ê¸°ë°˜ ë¬¸ì œ ìƒì„± ì¤‘...
          </div>
          <div class="qz-q" id="qz-q"></div>
          <div class="qz-opts" id="qz-opts"></div>
          <div class="qz-fb" id="qz-fb"></div>
          <div class="qz-acts">
            <button class="btn btn-sm btn-primary" id="qz-submit" onclick="submitMidQuiz()" disabled>ì œì¶œ</button>
            <button class="btn btn-sm btn-gold" id="qz-continue" onclick="closeMidQuiz()" style="display:none">â–¶ ê³„ì† ì‹œì²­</button>
          </div>
        </div>
      </div>
    </div>

    <div class="video-controls">
      <span class="vc-time" id="vc-time">00:00 / 00:00</span>
      <div class="vc-bar" id="vc-bar"><div class="vc-fill" id="vc-fill"></div></div>
      <div class="speed-wrap">
        <span class="speed-lbl">ë°°ì†</span>
        <select class="speed-sel" id="speed-sel" onchange="setSpeed(this.value)">
          <option value="0.75">0.75Ã—</option>
          <option value="1" selected>1Ã—</option>
          <option value="1.25">1.25Ã—</option>
          <option value="1.5">1.5Ã—</option>
          <option value="2">2Ã—</option>
        </select>
      </div>
      <span class="vc-lock">ğŸ”’ ì•ìœ¼ë¡œ ì´ë™ ë¶ˆê°€</span>
    </div>
    <div class="yt-notice" id="yt-notice" style="display:none">
      ğŸ“Œ YouTube ì˜ìƒì˜ ì•ìœ¼ë¡œ ë„˜ê¸°ê¸°ë¥¼ ìì œí•´ ì£¼ì„¸ìš”. ì§„ë„ëŠ” ì‹œì²­ ì‹œê°„ ê¸°ì¤€ì…ë‹ˆë‹¤.
    </div>
  </div>

  <div class="video-sidebar">
    <div class="sb-hd">
      <div class="sb-title" id="sb-title">ê°•ì˜ ë¡œë”© ì¤‘...</div>
      <div class="sb-row"><span>êµìœ¡ëª©ì </span><strong id="sb-purpose">-</strong></div>
      <div class="sb-row"><span>êµìœ¡í˜•íƒœ</span><strong>ì˜¨ë¼ì¸ êµìœ¡</strong></div>
      <div class="sb-row"><span>ìˆ˜ë£Œê¸°ì¤€</span><strong id="sb-pass">70ì  ì´ìƒ</strong></div>
    </div>
    <div class="sb-sec">
      <div class="sb-sec-t">ğŸ“ ì§„ë„ ì²´í¬í¬ì¸íŠ¸</div>
      <div class="cp-list" id="cp-list"></div>
    </div>
    <div class="score-blk">
      <div class="sb-sec-t" style="margin-bottom:7px">ğŸ“Š ì¤‘ê°„ í€´ì¦ˆ í˜„í™©</div>
      <div class="sc-item"><span>ì™„ë£Œ/ì „ì²´</span><span class="sc-val" id="sc-done">0/3</span></div>
      <div class="sc-item"><span>ì •ë‹µ ìˆ˜</span><span class="sc-val" id="sc-correct">0</span></div>
      <div class="sc-big" id="sc-pct" style="color:var(--text-mid);font-size:13px">-</div>
    </div>
    <div class="done-banner" id="done-banner">
      <div class="icon">ğŸ‰</div>
      <div class="t">ì˜ìƒ ì‹œì²­ ì™„ë£Œ!</div>
      <div class="s">ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ìµœì¢… í‰ê°€ ì‘ì‹œ</div>
    </div>
    <div class="sb-acts">
      <button class="btn btn-gold btn-block" id="exam-btn" onclick="goExam()" style="display:none;font-size:13px;padding:10px">ğŸ“ ìµœì¢… í‰ê°€ ì‘ì‹œ</button>
      <button class="btn btn-outline btn-block btn-sm" onclick="window.location.href='dashboard.html'">â† ê°•ì˜ ëª©ë¡</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script type="module">
import { DB } from './js/firebase-config.js';
import { requireAuth, fmtTime, showToast, toYoutubeEmbed } from './js/utils.js';
import { MID_QUIZZES } from './js/quiz-data.js';

const user     = requireAuth(); if (!user) throw 0;
const courseId = sessionStorage.getItem('kasg_course');
if (!courseId) { window.location.href='dashboard.html'; throw 0; }
document.getElementById('hd-name').textContent = user.name;

let course, learner;
let isYT=false, ytPlayer=null, ytDuration=0;
let ytChecked=[false,false,false];
let videoEnded=false, maxProgress=0;
let midAnswered=[false,false,false], midCorrect=0;
let activeMidIdx=-1, midSelected=null, midDone=false;
let currentSpeed=1, saveTimer=null;
// courseMidQuizzes: array of 3 questions from course registration (highest priority)
let courseMidQuizzes=[null,null,null];
// aiGeneratedQuizzes: cached AI-generated (fallback if no registered quiz)
let aiGeneratedQuizzes=[null,null,null];

async function init() {
  [course, learner] = await Promise.all([
    DB.get(`courses/${courseId}`), DB.get(`learners/${user.id}`)
  ]);
  if (!course) { alert('ê°•ì˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); window.location.href='dashboard.html'; return; }

  document.getElementById('sb-title').textContent   = course.title;
  document.getElementById('sb-purpose').textContent = course.purpose||'-';

  // Load registered mid quizzes from course
  if (course.midQuizzes && Array.isArray(course.midQuizzes)) {
    courseMidQuizzes = course.midQuizzes;
  }

  // Settings
  const settings = await DB.get('settings');
  const passScore = settings?.passScore || 70;
  document.getElementById('sb-pass').textContent = passScore+'ì  ì´ìƒ';

  if (learner) {
    maxProgress = learner.courseProgress?.[courseId]||0;
    if (learner.midAnswered?.[courseId])       midAnswered       = learner.midAnswered[courseId];
    if (learner.midQuizCorrect)                midCorrect        = learner.midQuizCorrect;
    if (learner.aiGeneratedQuizzes?.[courseId])aiGeneratedQuizzes= learner.aiGeneratedQuizzes[courseId];
    if (learner.completedStatus==='completed'||learner.status==='completed') {
      videoEnded=true; showCompletionUI();
    }
  }

  buildCheckpoints(); updateScore();

  const ytEmbed = toYoutubeEmbed(course.videoURL||'');
  if (ytEmbed) setupYouTube(ytEmbed);
  else if (course.videoURL) setupMP4(course.videoURL);
  else document.getElementById('video-container').insertAdjacentHTML('beforeend',
    '<div style="color:rgba(255,255,255,.4);font-size:14px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)">ê°•ì˜ ì˜ìƒì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>');

  saveTimer = setInterval(saveProgress, 15000);
}

/* â”€â”€ YouTube â”€â”€ */
function setupYouTube(embedUrl) {
  isYT=true; document.getElementById('yt-notice').style.display='';
  const m=embedUrl.match(/embed\/([A-Za-z0-9_-]{11})/), videoId=m?m[1]:'';
  document.getElementById('video-container').insertAdjacentHTML('afterbegin','<div id="yt-player"></div><div class="yt-block-overlay"></div>');
  window.onYouTubeIframeAPIReady=()=>{
    ytPlayer=new YT.Player('yt-player',{
      videoId,
      playerVars:{rel:0,modestbranding:1,controls:1,fs:0,playsinline:1},
      events:{onReady:onYTReady,onStateChange:onYTState}
    });
  };
  const s=document.createElement('script');s.src='https://www.youtube.com/iframe_api';document.head.appendChild(s);
}
function onYTReady(){
  ytDuration=ytPlayer.getDuration()||0;
  const rt=Math.max(0,maxProgress*ytDuration-3);
  if(rt>5) ytPlayer.seekTo(rt,true);
  ytPlayer.setPlaybackRate(currentSpeed);
  setInterval(()=>{
    if(!ytPlayer?.getCurrentTime) return;
    const cur=ytPlayer.getCurrentTime(), dur=ytPlayer.getDuration()||ytDuration||1;
    ytDuration=dur;
    if(cur>maxProgress*dur+6){ytPlayer.seekTo(maxProgress*dur,true);showToast('ì•ìœ¼ë¡œ ë„˜ê¸°ê¸°ëŠ” í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.','warn');return;}
    if(cur/dur>maxProgress) maxProgress=cur/dur;
    document.getElementById('vc-time').textContent=fmtTime(cur)+' / '+fmtTime(dur);
    document.getElementById('vc-fill').style.width=(cur/dur*100)+'%';
    updateCheckpoints();
    const r=cur/dur;
    if(!midAnswered[0]&&r>=0.25&&!ytChecked[0]){ytChecked[0]=true;ytPlayer.pauseVideo();openMidQuiz(0);}
    if(!midAnswered[1]&&r>=0.50&&!ytChecked[1]){ytChecked[1]=true;ytPlayer.pauseVideo();openMidQuiz(1);}
    if(!midAnswered[2]&&r>=0.75&&!ytChecked[2]){ytChecked[2]=true;ytPlayer.pauseVideo();openMidQuiz(2);}
  },2000);
}
function onYTState(e){
  if(e.data===YT.PlayerState.ENDED){videoEnded=true;maxProgress=1;saveProgress();showCompletionUI();}
}

/* â”€â”€ MP4 â”€â”€ */
function setupMP4(url){
  document.getElementById('video-container').insertAdjacentHTML('afterbegin',
    `<video id="main-video" controlsList="nodownload nofullscreen noremoteplayback" disablePictureInPicture style="width:100%;height:100%;object-fit:contain"><source src="${url}" type="video/mp4"></video>`);
  const video=document.getElementById('main-video');
  let ct=0;
  video.addEventListener('loadedmetadata',()=>{
    if(maxProgress>0) video.currentTime=Math.max(0,maxProgress*video.duration-2);
    buildVCMarkers(video.duration);
  });
  video.addEventListener('seeking',()=>{if(video.currentTime>maxProgress*video.duration+2){video.currentTime=ct;showToast('ì•ìœ¼ë¡œ ë„˜ê¸°ê¸° ë¶ˆê°€','warn');}});
  video.addEventListener('timeupdate',()=>{
    const cur=video.currentTime,dur=video.duration||1;
    if(cur>maxProgress*dur+2){video.currentTime=maxProgress*dur;return;}
    if(cur/dur>maxProgress) maxProgress=cur/dur;
    ct=cur;
    document.getElementById('vc-time').textContent=fmtTime(cur)+' / '+fmtTime(dur);
    document.getElementById('vc-fill').style.width=(cur/dur*100)+'%';
    updateCheckpoints();
    const r=cur/dur;
    if(!midAnswered[0]&&r>=0.25){video.pause();openMidQuiz(0);}
    if(!midAnswered[1]&&r>=0.50){video.pause();openMidQuiz(1);}
    if(!midAnswered[2]&&r>=0.75){video.pause();openMidQuiz(2);}
  });
  video.addEventListener('ended',()=>{videoEnded=true;maxProgress=1;saveProgress();showCompletionUI();});
}
function buildVCMarkers(dur){
  const bar=document.getElementById('vc-bar');
  [0.25,0.5,0.75].forEach((r,i)=>{const m=document.createElement('div');m.className='vc-marker';m.style.left=(r*100)+'%';m.setAttribute('data-label','í€´ì¦ˆ'+(i+1));bar.appendChild(m);});
}

/* â”€â”€ Speed â”€â”€ */
window.setSpeed=function(v){
  currentSpeed=parseFloat(v);
  const vid=document.getElementById('main-video');
  if(vid) vid.playbackRate=currentSpeed;
  if(ytPlayer?.setPlaybackRate) ytPlayer.setPlaybackRate(currentSpeed);
};

/* â”€â”€ Mid Quiz â”€â”€ */
async function openMidQuiz(idx){
  activeMidIdx=idx; midSelected=null; midDone=false;
  document.getElementById('qz-num').textContent=idx+1;
  document.getElementById('qz-q').textContent='';
  document.getElementById('qz-opts').innerHTML='';
  document.getElementById('qz-fb').className='qz-fb';
  document.getElementById('qz-submit').disabled=true;
  document.getElementById('qz-submit').style.display='';
  document.getElementById('qz-continue').style.display='none';
  document.getElementById('qz-tag').style.display='none';
  document.getElementById('qz-loading').style.display='none';
  document.getElementById('quiz-overlay').classList.add('active');

  // Priority 1: Registered quiz from course
  if (courseMidQuizzes[idx]) {
    const tag = document.getElementById('qz-tag');
    tag.textContent='ğŸ“ ë“±ë¡ ë¬¸ì œ'; tag.className='qz-tag registered'; tag.style.display='';
    renderMidQ(courseMidQuizzes[idx]);
    return;
  }

  // Priority 2: Cached AI quiz
  if (aiGeneratedQuizzes[idx]) {
    const tag = document.getElementById('qz-tag');
    tag.textContent='ğŸ¤– AI ìƒì„±'; tag.className='qz-tag ai'; tag.style.display='';
    renderMidQ(aiGeneratedQuizzes[idx]);
    return;
  }

  // Priority 3: Generate AI quiz
  document.getElementById('qz-loading').style.display='flex';
  document.getElementById('qz-q').textContent='ê°•ì˜ ë‚´ìš© ê¸°ë°˜ ë¬¸ì œ ìƒì„± ì¤‘...';
  const q = await generateAIQuiz(idx);
  aiGeneratedQuizzes[idx]=q;
  await DB.update(`learners/${user.id}`,{[`aiGeneratedQuizzes/${courseId}`]:aiGeneratedQuizzes});
  document.getElementById('qz-loading').style.display='none';
  if(q._isAI){ const tag=document.getElementById('qz-tag'); tag.textContent='ğŸ¤– AI ìƒì„±'; tag.className='qz-tag ai'; tag.style.display=''; }
  renderMidQ(q);
}

async function generateAIQuiz(idx){
  const labels=['ì „ë°˜ë¶€(25%)','ì¤‘ë°˜ë¶€(50%)','í›„ë°˜ë¶€(75%)'];
  const prompt=`ë‹¹ì‹ ì€ ìê¸ˆì„¸íƒë°©ì§€(AML) êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ê°•ì˜ëª…: ${course.title||'AML ì‹¤ë¬´ì êµìœ¡'}
êµìœ¡ëª©ì : ${course.purpose||'ìê¸ˆì„¸íƒë°©ì§€ ì‹¤ë¬´ ì´í•´'}
ê°•ì˜ ì‹œê°„: ${course.duration||2}ì‹œê°„
í˜„ì¬ ìœ„ì¹˜: ê°•ì˜ ${labels[idx]} ì‹œì 
ì´ ê°•ì˜ì˜ ${labels[idx]} ë‚´ìš©ì„ í•™ìŠµí•œ ìˆ˜ê°•ìƒì—ê²Œ ì í•©í•œ ì´í•´ë„ í™•ì¸ ë¬¸ì œë¥¼ 1ê°œ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.
ë°˜ë“œì‹œ ì•„ë˜ JSONë§Œ ì‘ë‹µ (ì„¤ëª… í…ìŠ¤íŠ¸ ì—†ì´):
{"q":"ë¬¸ì œ","opts":["â‘ ","â‘¡","â‘¢","â‘£"],"ans":0,"explanation":"ì •ë‹µ í•´ì„¤"}`;
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:500,messages:[{role:'user',content:prompt}]})
    });
    if(!res.ok) throw new Error('API '+res.status);
    const data=await res.json();
    const text=data.content?.[0]?.text||'';
    const parsed=JSON.parse(text.replace(/```json|```/g,'').trim());
    return {...parsed,_isAI:true};
  }catch(e){
    console.warn('AI quiz fallback:',e.message);
    return MID_QUIZZES[idx];
  }
}

function renderMidQ(q){
  document.getElementById('qz-q').textContent=q.q;
  document.getElementById('qz-opts').innerHTML=q.opts.map((o,i)=>
    `<div class="qz-opt" id="qzo-${i}" onclick="selectMidOpt(${i})"><span class="qz-n">${i+1}</span><span>${o}</span></div>`
  ).join('');
  document.getElementById('qz-submit').disabled=true;
}

window.selectMidOpt=function(i){
  if(midDone) return;
  midSelected=i;
  document.querySelectorAll('.qz-opt').forEach((el,j)=>el.className='qz-opt'+(j===i?' selected':''));
  document.getElementById('qz-submit').disabled=false;
};
window.submitMidQuiz=function(){
  if(midSelected===null||midDone) return;
  midDone=true;
  const q=courseMidQuizzes[activeMidIdx]||aiGeneratedQuizzes[activeMidIdx]||MID_QUIZZES[activeMidIdx];
  const ok=midSelected===q.ans;
  if(ok) midCorrect++;
  midAnswered[activeMidIdx]=true;
  document.querySelectorAll('.qz-opt').forEach((el,i)=>{
    if(i===q.ans) el.className='qz-opt correct';
    else if(i===midSelected) el.className='qz-opt wrong';
  });
  const fb=document.getElementById('qz-fb');
  fb.className='qz-fb show '+(ok?'ok':'err');
  const expl=q.explanation?'  '+q.explanation:'';
  fb.textContent=ok?'âœ… ì •ë‹µì…ë‹ˆë‹¤!'+expl:`âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µ: ${q.opts[q.ans]}${expl}`;
  document.getElementById('qz-submit').style.display='none';
  document.getElementById('qz-continue').style.display='';
  saveProgress(); updateScore();
};
window.closeMidQuiz=function(){
  document.getElementById('quiz-overlay').classList.remove('active');
  const v=document.getElementById('main-video');
  if(v) v.play(); else if(ytPlayer?.playVideo) ytPlayer.playVideo();
  updateCheckpoints();
};

/* â”€â”€ Checkpoints â”€â”€ */
function buildCheckpoints(){
  const items=['ê°•ì˜ ì‹œì‘','êµ¬ê°„ í€´ì¦ˆ â‘  (25%)','êµ¬ê°„ í€´ì¦ˆ â‘¡ (50%)','êµ¬ê°„ í€´ì¦ˆ â‘¢ (75%)','ì˜ìƒ ì™„ë£Œ','ìµœì¢… í‰ê°€','ìˆ˜ë£Œ ì™„ë£Œ'];
  document.getElementById('cp-list').innerHTML=items.map((c,i)=>
    `<div class="cp-item"><div class="cp-dot" id="cp-${i}">Â·</div><span>${c}</span></div>`
  ).join('');
}
function updateCheckpoints(){
  const d=[maxProgress>0.01,midAnswered[0],midAnswered[1],midAnswered[2],videoEnded,(learner?.attempt||0)>0,learner?.completedStatus==='completed'||learner?.status==='completed'];
  d.forEach((v,i)=>{const dot=document.getElementById('cp-'+i);if(!dot)return;const nx=!v&&d.slice(0,i).every(Boolean);dot.className='cp-dot'+(v?' done':nx?' active':'');dot.textContent=v?'âœ“':'Â·';});
}
function updateScore(){
  const done=midAnswered.filter(Boolean).length;
  document.getElementById('sc-done').textContent=done+'/3';
  document.getElementById('sc-correct').textContent=midCorrect;
  if(done>0){const p=Math.round(midCorrect/done*100);const el=document.getElementById('sc-pct');el.textContent=p+'%';el.className='sc-big '+(p>=70?'good':'bad');}
}
function showCompletionUI(){
  document.getElementById('done-banner').classList.add('show');
  document.getElementById('exam-btn').style.display='';
  updateCheckpoints();
}
window.goExam=function(){
  if(!videoEnded){showToast('ì˜ìƒì„ ëê¹Œì§€ ì‹œì²­í•´ì•¼ í•©ë‹ˆë‹¤.','error');return;}
  saveProgress(); window.location.href='exam.html';
};
async function saveProgress(){
  await DB.update(`learners/${user.id}`,{
    progress:maxProgress,
    [`courseProgress/${courseId}`]:maxProgress,
    [`courseStatus/${courseId}`]:videoEnded?'watched':'in_progress',
    [`midAnswered/${courseId}`]:midAnswered,
    midQuizCorrect:midCorrect,
    midQuizTotal:midAnswered.filter(Boolean).length,
    status:maxProgress>0?'in_progress':(learner?.status||'approved')
  });
}

init();
window.addEventListener('beforeunload',()=>{clearInterval(saveTimer);saveProgress();});
</script>
</body>
</html>
