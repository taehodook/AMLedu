<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ â€” KASG LMS</title>
<link rel="stylesheet" href="css/main.css">
<style>
body{background:#ECEAE4;min-height:100vh}
.admin-layout{display:grid;grid-template-columns:230px 1fr;min-height:calc(100vh - 66px)}

/* Sidebar Nav */
.admin-nav{background:var(--navy);position:sticky;top:66px;height:calc(100vh - 66px);overflow-y:auto;display:flex;flex-direction:column}
.nav-sec{padding:18px 18px 7px;font-size:9.5px;font-weight:600;color:rgba(255,255,255,.3);letter-spacing:1.5px;text-transform:uppercase}
.nav-item{display:flex;align-items:center;gap:9px;padding:11px 18px;color:rgba(255,255,255,.62);font-size:13px;cursor:pointer;border-left:3px solid transparent;transition:all .15s}
.nav-item:hover{background:rgba(255,255,255,.06);color:#fff}
.nav-item.active{background:rgba(255,255,255,.1);color:#fff;border-left-color:var(--kasg-gold)}
.nav-icon{width:17px;text-align:center;font-size:14px}
.nav-divider{height:1px;background:rgba(255,255,255,.07);margin:6px 0}
.nav-bottom{margin-top:auto;border-top:1px solid rgba(255,255,255,.07);padding:10px 0}

/* Content */
.admin-content{padding:28px}
.content-sec{display:none}
.content-sec.active{display:block}

/* Stats */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
@media(max-width:1200px){.stats-row{grid-template-columns:repeat(2,1fr)}}

/* Pending badge */
.pending-badge{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:var(--kasg-red);color:#fff;font-size:10px;font-weight:700;margin-left:4px}

/* Table toolbar */
.tbl-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap}
.filter-input{padding:8px 12px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:13px;color:var(--text);background:#fff;width:240px;outline:none}
.filter-input:focus{border-color:var(--navy)}
.tbl-actions{display:flex;gap:8px;margin-left:auto}

/* Action buttons in table */
.tbl-btn{padding:5px 11px;border-radius:var(--radius);font-size:11px;font-weight:600;cursor:pointer;border:none;transition:all .15s;white-space:nowrap}
.tbl-btn-approve{background:#D1FAE5;color:var(--success)}
.tbl-btn-approve:hover{background:var(--success);color:#fff}
.tbl-btn-reject{background:#FEE2E2;color:var(--error)}
.tbl-btn-reject:hover{background:var(--error);color:#fff}
.tbl-btn-reset{background:var(--warn-bg);color:var(--warn-text)}
.tbl-btn-reset:hover{background:#D97706;color:#fff}
.tbl-btn-delete{background:#F1F0EC;color:var(--error)}
.tbl-btn-delete:hover{background:var(--error);color:#fff}
.tbl-btn-pw{background:#DBEAFE;color:#1E40AF}
.tbl-btn-pw:hover{background:#1E40AF;color:#fff}

/* Course cards */
.course-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.course-card{background:#fff;border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-sm);border-left:4px solid var(--kasg-gold)}
.cc-head{padding:14px 18px}
.cc-title{font-family:'Noto Serif KR',serif;font-size:14px;font-weight:700;color:var(--navy);margin-bottom:4px}
.cc-meta{font-size:11px;color:var(--text-mid)}
.cc-url{font-size:11px;color:var(--kasg-blue);word-break:break-all;margin-top:4px;text-decoration:underline}
.cc-actions{padding:10px 14px;background:var(--cream);border-top:1px solid var(--border);display:flex;gap:7px;flex-wrap:wrap}

/* YouTube URL input */
.yt-preview{margin-top:10px;border-radius:var(--radius);overflow:hidden;background:#000;aspect-ratio:16/9;display:none}
.yt-preview.show{display:block}
.yt-preview iframe{width:100%;height:100%;border:none}

/* Settings */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
@media(max-width:900px){.settings-grid{grid-template-columns:1fr}}
.setting-box{background:#fff;border-radius:var(--radius-lg);padding:20px 22px;box-shadow:var(--shadow-sm)}
.sb-title{font-size:14px;font-weight:600;color:var(--navy);margin-bottom:14px}

/* Modal fields */
.modal-field{display:flex;flex-direction:column;gap:4px;margin-bottom:14px}
.modal-field label{font-size:12px;font-weight:500;color:var(--text-mid)}
.modal-field input{padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:14px;color:var(--text)}
.modal-field input:focus{border-color:var(--navy);outline:none}

/* Completion row */
.completions-count{font-size:11px;color:var(--text-light);margin-left:6px}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-brand">
    <img class="header-logo-img" src="assets/logo-wide.png" alt="KASG">
    <span style="color:var(--kasg-red);font-size:11px;font-weight:600;letter-spacing:1px;background:rgba(200,48,42,.15);padding:3px 10px;border-radius:10px;margin-left:8px">ADMIN</span>
  </div>
  <div class="header-nav">
    <button class="header-btn" onclick="window.open('index.html','_blank')">ìˆ˜ê°•ìƒ í™”ë©´ ë¯¸ë¦¬ë³´ê¸°</button>
    <button class="header-btn" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<div class="admin-layout">
  <!-- Nav -->
  <nav class="admin-nav">
    <div class="nav-sec">ëŒ€ì‹œë³´ë“œ</div>
    <div class="nav-item active" data-sec="overview" onclick="switchSec(this)"><span class="nav-icon">ğŸ“Š</span>ì „ì²´ í˜„í™©</div>
    <div class="nav-divider"></div>
    <div class="nav-sec">ìˆ˜ê°•ìƒ ê´€ë¦¬</div>
    <div class="nav-item" data-sec="pending" onclick="switchSec(this)"><span class="nav-icon">â³</span>ê°€ì… ìŠ¹ì¸ ëŒ€ê¸°<span class="pending-badge" id="pending-cnt">0</span></div>
    <div class="nav-item" data-sec="learners" onclick="switchSec(this)"><span class="nav-icon">ğŸ‘¥</span>ìˆ˜ê°•ìƒ í˜„í™©</div>
    <div class="nav-item" data-sec="completions" onclick="switchSec(this)"><span class="nav-icon">ğŸ†</span>ìˆ˜ë£Œ í˜„í™©</div>
    <div class="nav-divider"></div>
    <div class="nav-sec">ê°•ì˜ ê´€ë¦¬</div>
    <div class="nav-item" data-sec="courses" onclick="switchSec(this)"><span class="nav-icon">ğŸ¬</span>ê°•ì˜ ëª©ë¡</div>
    <div class="nav-item" data-sec="add-course" onclick="switchSec(this)"><span class="nav-icon">â•</span>ê°•ì˜ ë“±ë¡</div>
    <div class="nav-divider"></div>
    <div class="nav-sec">ì‹œìŠ¤í…œ</div>
    <div class="nav-item" data-sec="settings" onclick="switchSec(this)"><span class="nav-icon">âš™ï¸</span>ì„¤ì •</div>
    <div class="nav-bottom">
      <div class="nav-item" onclick="adminLogout()"><span class="nav-icon">ğŸšª</span>ë¡œê·¸ì•„ì›ƒ</div>
    </div>
  </nav>

  <!-- Content -->
  <div class="admin-content">

    <!-- â•â•â• OVERVIEW â•â•â• -->
    <div class="content-sec active" id="sec-overview">
      <div class="section-title">ğŸ“Š ì „ì²´ í˜„í™©</div>
      <div class="stats-row">
        <div class="stat-card"><div class="stat-value" id="ov-total">0</div><div class="stat-label">ì „ì²´ ìˆ˜ê°•ìƒ</div></div>
        <div class="stat-card" style="border-left-color:#FCA311"><div class="stat-value" id="ov-pending">0</div><div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸°</div></div>
        <div class="stat-card" style="border-left-color:var(--success)"><div class="stat-value" id="ov-done">0</div><div class="stat-label">ìˆ˜ë£Œ ì™„ë£Œ</div></div>
        <div class="stat-card" style="border-left-color:var(--kasg-blue)"><div class="stat-value" id="ov-rate">0%</div><div class="stat-label">ìˆ˜ë£Œìœ¨</div></div>
      </div>
      <div class="stats-row" style="grid-template-columns:repeat(4,1fr)">
        <div class="stat-card"><div class="stat-value" id="ov-courses">0</div><div class="stat-label">ë“±ë¡ ê°•ì˜ ìˆ˜</div></div>
        <div class="stat-card"><div class="stat-value" id="ov-avg">-</div><div class="stat-label">í‰ê·  ìµœì¢… ì ìˆ˜</div></div>
        <div class="stat-card"><div class="stat-value" id="ov-certs">0</div><div class="stat-label">ë°œê¸‰ ìˆ˜ë£Œì¦</div></div>
        <div class="stat-card"><div class="stat-value" id="ov-retake">0</div><div class="stat-label">ì¬ì‹œí—˜ ì‘ì‹œ</div></div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">ìµœê·¼ ìˆ˜ë£Œì</span></div>
        <div style="padding:0"><table class="data-table"><thead><tr><th>ì„±ëª…</th><th>ì†Œì†</th><th>ê°•ì˜ëª…</th><th>ì ìˆ˜</th><th>ìˆ˜ë£Œì¼</th></tr></thead><tbody id="ov-recent"></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• PENDING (ìŠ¹ì¸ ëŒ€ê¸°) â•â•â• -->
    <div class="content-sec" id="sec-pending">
      <div class="section-title">â³ ê°€ì… ìŠ¹ì¸ ëŒ€ê¸°</div>
      <div class="alert alert-info" style="margin-bottom:18px">ì‹ ì²­í•œ ìˆ˜ê°•ìƒì„ ê²€í† í•˜ê³  ìŠ¹ì¸ ë˜ëŠ” ê±°ì ˆí•˜ì„¸ìš”. ìŠ¹ì¸ í›„ ìˆ˜ê°•ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
      <div class="card" style="padding:0">
        <table class="data-table" id="pending-table">
          <thead><tr><th>ì„±ëª…</th><th>ì•„ì´ë””</th><th>ì†Œì†</th><th>ì—°ë½ì²˜</th><th>ì‹ ì²­ì¼</th><th style="text-align:center">ì²˜ë¦¬</th></tr></thead>
          <tbody id="pending-tbody"><tr class="empty-row"><td colspan="6">ë¡œë”© ì¤‘...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â•â•â• LEARNERS â•â•â• -->
    <div class="content-sec" id="sec-learners">
      <div class="section-title">ğŸ‘¥ ìˆ˜ê°•ìƒ í˜„í™©</div>
      <div class="tbl-toolbar">
        <input class="filter-input" id="learner-filter" placeholder="ğŸ” ì„±ëª… Â· ì†Œì† Â· ì•„ì´ë”” ê²€ìƒ‰" oninput="filterLearners()">
        <div class="tbl-actions">
          <button class="btn btn-sm btn-outline" onclick="exportLearners()">ğŸ“¥ CSV</button>
        </div>
      </div>
      <div class="card" style="padding:0;overflow:auto">
        <table class="data-table" style="min-width:900px">
          <thead><tr>
            <th>ì„±ëª…</th><th>ì•„ì´ë””</th><th>ì†Œì†</th><th>ì§„ë„</th><th>í€´ì¦ˆ</th><th>ì ìˆ˜</th><th>ì‘ì‹œ</th><th>ìƒíƒœ</th><th>ë“±ë¡ì¼</th><th style="text-align:center">ê´€ë¦¬</th>
          </tr></thead>
          <tbody id="learners-tbody"><tr class="empty-row"><td colspan="10">ë¡œë”© ì¤‘...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â•â•â• COMPLETIONS â•â•â• -->
    <div class="content-sec" id="sec-completions">
      <div class="section-title">ğŸ† ìˆ˜ë£Œ í˜„í™©</div>
      <div class="tbl-toolbar">
        <input class="filter-input" id="cert-filter" placeholder="ğŸ” ì„±ëª… Â· ë°œê¸‰ë²ˆí˜¸ ê²€ìƒ‰" oninput="filterCerts()">
        <div class="tbl-actions"><button class="btn btn-sm btn-outline" onclick="exportCerts()">ğŸ“¥ CSV</button></div>
      </div>
      <div class="card" style="padding:0">
        <table class="data-table">
          <thead><tr><th>ë°œê¸‰ë²ˆí˜¸</th><th>ì„±ëª…</th><th>ì†Œì†</th><th>ê°•ì˜ëª…</th><th>ì ìˆ˜</th><th>ìˆ˜ë£Œì¼</th></tr></thead>
          <tbody id="completions-tbody"><tr class="empty-row"><td colspan="6">ë¡œë”© ì¤‘...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â•â•â• COURSES â•â•â• -->
    <div class="content-sec" id="sec-courses">
      <div class="section-title">ğŸ¬ ê°•ì˜ ëª©ë¡</div>
      <div class="course-grid" id="course-grid"><div style="color:var(--text-light);padding:20px">ë¡œë”© ì¤‘...</div></div>
    </div>

    <!-- â•â•â• ADD COURSE â•â•â• -->
    <div class="content-sec" id="sec-add-course">
      <div class="section-title">â• ê°•ì˜ ë“±ë¡</div>
      <div class="card">
        <div class="card-header"><span class="card-title">ìƒˆ ê°•ì˜ ë“±ë¡ (YouTube URL ë°©ì‹)</span></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div class="form-group">
              <label class="form-label">ê°•ì˜ëª… *</label>
              <input class="form-input" id="cf-title" placeholder="ì˜ˆ: ìê¸ˆì„¸íƒë°©ì§€ ì‹¤ë¬´ì êµìœ¡ 2025">
            </div>
            <div class="form-group">
              <label class="form-label">êµìœ¡ ì‹œê°„ (ì‹œê°„) *</label>
              <input class="form-input" id="cf-duration" type="number" value="2" min="1" max="20">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">êµìœ¡ëª©ì  *</label>
            <input class="form-input" id="cf-purpose" placeholder="ì˜ˆ: ìê¸ˆì„¸íƒë°©ì§€(AML) ì‹¤ë¬´ ì´í•´ ë° ì—­ëŸ‰ ê°•í™”">
          </div>
          <div class="form-group">
            <label class="form-label">YouTube URL *</label>
            <input class="form-input" id="cf-yturl" placeholder="https://www.youtube.com/watch?v=..." oninput="previewYT()">
            <div class="form-hint">ìœ íŠœë¸Œ ì˜ìƒ URLì„ ë¶™ì—¬ë„£ìœ¼ë©´ ìë™ìœ¼ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.</div>
          </div>
          <div class="yt-preview" id="yt-preview">
            <iframe id="yt-preview-frame" allowfullscreen></iframe>
          </div>
          <div id="add-course-status" style="margin-top:12px"></div>
          <div style="margin-top:18px;display:flex;gap:10px;justify-content:flex-end">
            <button class="btn btn-outline" onclick="clearCourseForm()">ì´ˆê¸°í™”</button>
            <button class="btn btn-gold" onclick="saveCourse()">ê°•ì˜ ë“±ë¡í•˜ê¸°</button>
          </div>
        </div>
      </div>
      <div class="alert alert-info" style="margin-top:16px">
        ğŸ’¡ YouTube ë¹„ê³µê°œ ì˜ìƒì€ ì¬ìƒì´ ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. <strong>ì¼ë¶€ ê³µê°œ(ë§í¬ê°€ ìˆëŠ” ì‚¬ëŒ ëª¨ë‘)</strong> ë˜ëŠ” <strong>ê³µê°œ</strong>ë¡œ ì„¤ì •í•´ ì£¼ì„¸ìš”.
      </div>
    </div>

    <!-- â•â•â• SETTINGS â•â•â• -->
    <div class="content-sec" id="sec-settings">
      <div class="section-title">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</div>
      <div class="settings-grid">
        <div class="setting-box">
          <div class="sb-title">ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="form-group"><label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input class="form-input" type="password" id="new-pw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ)"></div>
          <div class="form-group"><label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input class="form-input" type="password" id="confirm-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"></div>
          <button class="btn btn-primary" onclick="changeAdminPw()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        </div>
        <div class="setting-box">
          <div class="sb-title">ğŸ“‹ ìˆ˜ë£Œ ê¸°ì¤€</div>
          <div class="form-group"><label class="form-label">ìµœì†Œ ìˆ˜ë£Œ ì ìˆ˜ (%)</label><input class="form-input" type="number" id="pass-score" value="70" min="50" max="100"></div>
          <div class="form-group"><label class="form-label">ìµœëŒ€ ì¬ì‹œí—˜ íšŸìˆ˜</label><input class="form-input" type="number" id="max-attempts" value="2" min="1" max="5"></div>
          <button class="btn btn-primary" onclick="saveSettings()">ì €ì¥</button>
        </div>
        <div class="setting-box" style="grid-column:1/-1">
          <div class="sb-title">ğŸ”— Firebase ì •ë³´</div>
          <div class="alert alert-info" style="margin:0">
            <div>
              <strong>Database URL:</strong> https://aml-2-5e6d5-default-rtdb.asia-southeast1.firebasedatabase.app/<br>
              <strong>Project ID:</strong> aml-2-5e6d5<br><br>
              âš ï¸ <strong>ì¤‘ìš”:</strong> <code>js/firebase-config.js</code> ì—ì„œ <code>apiKey</code>, <code>messagingSenderId</code>, <code>appId</code> ê°’ì„ ì‹¤ì œ ê°’ìœ¼ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.<br>
              Firebase Console â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì›¹ ì•± ì—ì„œ í™•ì¸í•˜ì„¸ìš”.
            </div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /admin-content -->
</div>

<!-- â•â• Reset PW Modal â•â• -->
<div class="modal-backdrop hidden" id="reset-pw-modal">
  <div class="modal-box">
    <div class="modal-header"><span class="modal-title">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”</span><button class="modal-close" onclick="closeModal('reset-pw-modal')">âœ•</button></div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text-mid);margin-bottom:18px"><strong id="reset-target-name"></strong>ë‹˜ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</p>
      <div class="modal-field">
        <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
        <input type="text" id="reset-new-pw" value="kasg1234" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('reset-pw-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-warn" onclick="doResetPw()">ì´ˆê¸°í™” ì ìš©</button>
    </div>
  </div>
</div>

<!-- â•â• Edit Course Modal â•â• -->
<div class="modal-backdrop hidden" id="edit-course-modal">
  <div class="modal-box">
    <div class="modal-header"><span class="modal-title">âœï¸ ê°•ì˜ ìˆ˜ì •</span><button class="modal-close" onclick="closeModal('edit-course-modal')">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="edit-course-id">
      <div class="modal-field"><label>ê°•ì˜ëª…</label><input type="text" class="form-input" id="edit-title"></div>
      <div class="modal-field"><label>êµìœ¡ëª©ì </label><input type="text" class="form-input" id="edit-purpose"></div>
      <div class="modal-field"><label>êµìœ¡ ì‹œê°„ (ì‹œê°„)</label><input type="number" class="form-input" id="edit-duration" min="1" max="20"></div>
      <div class="modal-field"><label>YouTube URL</label><input type="text" class="form-input" id="edit-yturl" placeholder="https://www.youtube.com/watch?v=..."></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('edit-course-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveEditCourse()">ìˆ˜ì • ì €ì¥</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script type="module">
import { DB } from './js/firebase-config.js';
import { requireAdmin, fmtDate, toYoutubeEmbed } from './js/utils.js';
import { showToast } from './js/utils.js';

requireAdmin();

let allLearners = [], allCompletions = [], allCourses = {};
let resetTargetId = '';

// â”€â”€ Section switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.switchSec = function(el) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.content-sec').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('sec-' + el.dataset.sec).classList.add('active');
  const map = { overview:'loadOverview', pending:'loadPending', learners:'loadLearners', completions:'loadCompletions', courses:'loadCourses' };
  if (map[el.dataset.sec]) window[map[el.dataset.sec]]();
};

window.adminLogout = () => { sessionStorage.removeItem('kasg_admin'); window.location.href = 'admin-login.html'; };
window.closeModal  = id => document.getElementById(id).classList.add('hidden');

// â”€â”€ Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadOverview = async function() {
  const [ld, cd, cmp] = await Promise.all([DB.get('learners'), DB.get('courses'), DB.get('completions')]);
  allLearners    = ld  ? Object.entries(ld).map(([id,v])=>({...v,_id:id})) : [];
  allCourses     = cd  || {};
  allCompletions = cmp ? Object.values(cmp) : [];

  const total    = allLearners.length;
  const pending  = allLearners.filter(l=>l.status==='pending').length;
  const done     = allLearners.filter(l=>l.completedStatus==='completed'||l.status==='completed').length;
  const approved = allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected').length;
  const rate     = approved ? Math.round(done/approved*100)+'%' : '0%';
  const scores   = allLearners.filter(l=>l.finalScore!=null).map(l=>l.finalScore);
  const avg      = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length)+'ì ' : '-';

  document.getElementById('ov-total').textContent   = total;
  document.getElementById('ov-pending').textContent = pending;
  document.getElementById('ov-done').textContent    = done;
  document.getElementById('ov-rate').textContent    = rate;
  document.getElementById('ov-courses').textContent = Object.keys(allCourses).length;
  document.getElementById('ov-avg').textContent     = avg;
  document.getElementById('ov-certs').textContent   = allCompletions.length;
  document.getElementById('ov-retake').textContent  = allLearners.filter(l=>(l.attempt||0)>=2).length;
  document.getElementById('pending-cnt').textContent = pending;

  const recent = [...allCompletions].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,6);
  document.getElementById('ov-recent').innerHTML = recent.length
    ? recent.map(c=>`<tr>
        <td><strong>${c.name}</strong></td>
        <td>${c.org}</td>
        <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.courseTitle||'-'}</td>
        <td><span class="badge badge-success">${c.score}ì </span></td>
        <td style="font-size:11px;color:var(--text-light)">${fmtDate(new Date(c.date))}</td>
      </tr>`).join('')
    : '<tr class="empty-row"><td colspan="5">ìˆ˜ë£Œì ì—†ìŒ</td></tr>';
};

// â”€â”€ Pending Approval â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadPending = async function() {
  const ld = await DB.get('learners') || {};
  allLearners = Object.entries(ld).map(([id,v])=>({...v,_id:id}));
  const pending = allLearners.filter(l=>l.status==='pending');
  document.getElementById('pending-cnt').textContent = pending.length;
  document.getElementById('pending-tbody').innerHTML = pending.length
    ? pending.map(l=>`<tr>
        <td><strong>${l.name}</strong></td>
        <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text-mid)">${l.id||l._id}</td>
        <td>${l.org}</td>
        <td>${l.phone||'-'}</td>
        <td style="font-size:11px;color:var(--text-light)">${fmtDate(new Date(l.createdAt))}</td>
        <td style="text-align:center">
          <div style="display:flex;gap:6px;justify-content:center">
            <button class="tbl-btn tbl-btn-approve" onclick="approveLearner('${l._id}','${l.name}')">âœ… ìŠ¹ì¸</button>
            <button class="tbl-btn tbl-btn-reject"  onclick="rejectLearner('${l._id}','${l.name}')">âŒ ê±°ì ˆ</button>
          </div>
        </td>
      </tr>`).join('')
    : '<tr class="empty-row"><td colspan="6">ìŠ¹ì¸ ëŒ€ê¸° ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
};

window.approveLearner = async function(id, name) {
  if (!confirm(`${name}ë‹˜ì˜ ê°€ì…ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  await DB.update(`learners/${id}`, { status: 'approved', approved: true, approvedAt: new Date().toISOString() });
  showToast(`${name}ë‹˜ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
  loadPending(); loadOverview();
};

window.rejectLearner = async function(id, name) {
  if (!confirm(`${name}ë‹˜ì˜ ê°€ì…ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  await DB.update(`learners/${id}`, { status: 'rejected' });
  showToast(`${name}ë‹˜ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.`, 'warn');
  loadPending();
};

// â”€â”€ Learners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadLearners = async function() {
  const ld = await DB.get('learners') || {};
  allLearners = Object.entries(ld).map(([id,v])=>({...v,_id:id}));
  renderLearners(allLearners.filter(l=>l.status!=='pending'));
};

function renderLearners(list) {
  document.getElementById('learners-tbody').innerHTML = list.length
    ? list.map(l => {
        const prog  = Math.round((l.progress||0)*100);
        const mq    = l.midQuizTotal>0 ? `${l.midQuizCorrect}/${l.midQuizTotal}` : '-';
        const score = l.finalScore!=null ? l.finalScore+'ì ' : '-';
        const att   = (l.attempt||0)+'/2';
        const st    = l.completedStatus||l.status||'approved';
        const badgeCls = st==='completed'?'badge-success':st==='in_progress'?'badge-warn':st==='rejected'?'badge-error':'badge-neutral';
        const badgeLbl = st==='completed'?'ìˆ˜ë£Œ':st==='in_progress'?'ìˆ˜ê°•ì¤‘':st==='rejected'?'ê±°ì ˆ':'ë¯¸ì‹œì‘';
        return `<tr>
          <td><strong>${l.name}</strong></td>
          <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text-mid)">${l.id||l._id}</td>
          <td>${l.org}</td>
          <td><div style="display:flex;align-items:center;gap:7px"><div class="progress-wrap" style="height:4px;width:70px"><div class="progress-fill" style="width:${prog}%"></div></div><span style="font-size:11px;color:var(--text-mid)">${prog}%</span></div></td>
          <td>${mq}</td>
          <td>${score}</td>
          <td>${att}</td>
          <td><span class="badge ${badgeCls}">${badgeLbl}</span></td>
          <td style="font-size:11px;color:var(--text-light)">${fmtDate(new Date(l.createdAt||Date.now()))}</td>
          <td>
            <div style="display:flex;gap:5px;justify-content:center;flex-wrap:wrap">
              <button class="tbl-btn tbl-btn-pw"     onclick="openResetPw('${l._id}','${l.name}')">ğŸ”‘ ë¹„ë²ˆ</button>
              <button class="tbl-btn tbl-btn-reset"   onclick="resetProgress('${l._id}','${l.name}')">ğŸ”„ ì´ˆê¸°í™”</button>
              <button class="tbl-btn tbl-btn-delete"  onclick="deleteLearner('${l._id}','${l.name}')">ğŸ—‘ ì‚­ì œ</button>
            </div>
          </td>
        </tr>`;
      }).join('')
    : '<tr class="empty-row"><td colspan="10">ìˆ˜ê°•ìƒ ì—†ìŒ</td></tr>';
}

window.filterLearners = function() {
  const q = document.getElementById('learner-filter').value.toLowerCase();
  renderLearners(allLearners.filter(l => l.status!=='pending' && (
    l.name?.toLowerCase().includes(q) || l.org?.toLowerCase().includes(q) ||
    (l.id||l._id)?.toLowerCase().includes(q)
  )));
};

// Password Reset
window.openResetPw = function(id, name) {
  resetTargetId = id;
  document.getElementById('reset-target-name').textContent = name;
  document.getElementById('reset-new-pw').value = 'kasg1234';
  document.getElementById('reset-pw-modal').classList.remove('hidden');
};
window.doResetPw = async function() {
  const newPw = document.getElementById('reset-new-pw').value.trim();
  if (!newPw || newPw.length < 4) { alert('4ì ì´ìƒì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  await DB.update(`learners/${resetTargetId}`, { pw: newPw });
  showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  closeModal('reset-pw-modal');
};

// Reset Progress
window.resetProgress = async function(id, name) {
  if (!confirm(`${name}ë‹˜ì˜ ìˆ˜ê°• ì§„ë„ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë¹„ë°€ë²ˆí˜¸ëŠ” ìœ ì§€ë˜ë©° ì§„ë„Â·í€´ì¦ˆÂ·í‰ê°€ ê¸°ë¡ë§Œ ì‚­ì œë©ë‹ˆë‹¤.)`)) return;
  await DB.update(`learners/${id}`, {
    progress: 0, midQuizCorrect: 0, midQuizTotal: 0,
    finalScore: null, finalPassed: null, attempt: 0,
    completedStatus: null, certNo: null, certDate: null,
    courseProgress: null, courseStatus: null, midAnswered: null, courseCerts: null,
    status: 'approved'
  });
  showToast(`${name}ë‹˜ì˜ ì§„ë„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
  loadLearners();
};

// Delete Learner
window.deleteLearner = async function(id, name) {
  if (!confirm(`${name}ë‹˜ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
  await DB.remove(`learners/${id}`);
  showToast(`${name}ë‹˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'warn');
  loadLearners();
};

window.exportLearners = function() {
  const list = allLearners.filter(l=>l.status!=='pending');
  const rows = [['ì„±ëª…','ì•„ì´ë””','ì†Œì†','ì§„ë„(%)','ì¤‘ê°„í€´ì¦ˆ','ìµœì¢…ì ìˆ˜','ì‘ì‹œ','ìƒíƒœ','ë“±ë¡ì¼']];
  list.forEach(l => {
    const st = l.completedStatus||l.status||'-';
    rows.push([l.name, l.id||l._id, l.org, Math.round((l.progress||0)*100)+'%',
      `${l.midQuizCorrect||0}/${l.midQuizTotal||0}`, l.finalScore!=null?l.finalScore+'ì ':'-',
      (l.attempt||0)+'/2', st==='completed'?'ìˆ˜ë£Œ':st==='in_progress'?'ìˆ˜ê°•ì¤‘':'ë¯¸ì‹œì‘',
      fmtDate(new Date(l.createdAt||Date.now()))]);
  });
  csvDownload('learners.csv', rows);
};

// â”€â”€ Completions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadCompletions = async function() {
  const data = await DB.get('completions') || {};
  allCompletions = Object.values(data).sort((a,b)=>new Date(b.date)-new Date(a.date));
  renderCompletions(allCompletions);
};
function renderCompletions(list) {
  document.getElementById('completions-tbody').innerHTML = list.length
    ? list.map(c=>`<tr>
        <td style="font-family:'DM Mono',monospace;font-size:11px">ì œ ${c.certNo}í˜¸</td>
        <td><strong>${c.name}</strong></td>
        <td>${c.org}</td>
        <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis">${c.courseTitle||'-'}</td>
        <td><span class="badge badge-success">${c.score}ì </span></td>
        <td style="font-size:11px;color:var(--text-light)">${fmtDate(new Date(c.date))}</td>
      </tr>`).join('')
    : '<tr class="empty-row"><td colspan="6">ìˆ˜ë£Œì ì—†ìŒ</td></tr>';
}
window.filterCerts = function() {
  const q = document.getElementById('cert-filter').value.toLowerCase();
  renderCompletions(allCompletions.filter(c =>
    c.name?.toLowerCase().includes(q) || (c.certNo||'').toLowerCase().includes(q)
  ));
};
window.exportCerts = function() {
  const rows = [['ë°œê¸‰ë²ˆí˜¸','ì„±ëª…','ì†Œì†','ê°•ì˜ëª…','ì ìˆ˜','ìˆ˜ë£Œì¼']];
  allCompletions.forEach(c=>rows.push([`ì œ ${c.certNo}í˜¸`,c.name,c.org,c.courseTitle||'-',c.score+'ì ',fmtDate(new Date(c.date))]));
  csvDownload('completions.csv', rows);
};

// â”€â”€ Courses â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadCourses = async function() {
  const data = await DB.get('courses') || {};
  allCourses = data;
  const arr  = Object.entries(data);
  const grid = document.getElementById('course-grid');
  if (!arr.length) {
    grid.innerHTML = '<div class="card" style="padding:44px;text-align:center;grid-column:1/-1"><div style="font-size:36px;margin-bottom:10px">ğŸ“‚</div><div style="color:var(--text-mid)">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤. "ê°•ì˜ ë“±ë¡" ë©”ë‰´ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div></div>';
    return;
  }
  grid.innerHTML = arr.map(([id,c])=>`
    <div class="course-card">
      <div class="cc-head">
        <div class="cc-title">${c.title}</div>
        <div class="cc-meta">â± ${c.duration||'?'}ì‹œê°„ Â· ë“±ë¡: ${fmtDate(new Date(c.createdAt||Date.now()))}</div>
        <div class="cc-meta" style="margin-top:3px">ğŸ¯ ${c.purpose||'-'}</div>
        ${c.videoURL ? `<div class="cc-url" onclick="window.open('${c.videoURL}','_blank')">â–¶ ${c.videoURL.slice(0,50)}...</div>` : '<div class="cc-meta" style="color:var(--error)">âš ï¸ ì˜ìƒ ë¯¸ë“±ë¡</div>'}
      </div>
      <div class="cc-actions">
        <span class="badge ${c.locked?'badge-error':'badge-success'}">${c.locked?'ğŸ”’ ì ê¹€':'âœ… ê³µê°œ'}</span>
        <button class="tbl-btn tbl-btn-approve" onclick="toggleLock('${id}',${!c.locked})">${c.locked?'ğŸ”“ ê³µê°œ':'ğŸ”’ ì ê¸ˆ'}</button>
        <button class="tbl-btn tbl-btn-pw"      onclick="editCourse('${id}')">âœï¸ ìˆ˜ì •</button>
        <button class="tbl-btn tbl-btn-delete"  onclick="deleteCourse('${id}','${c.title}')">ğŸ—‘ ì‚­ì œ</button>
      </div>
    </div>`).join('');
};

window.toggleLock = async function(id, lock) {
  await DB.update(`courses/${id}`, { locked: lock });
  showToast(lock ? 'ê°•ì˜ê°€ ì ê²¼ìŠµë‹ˆë‹¤.' : 'ê°•ì˜ê°€ ê³µê°œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  loadCourses();
};

window.deleteCourse = async function(id, title) {
  if (!confirm(`"${title}" ê°•ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  await DB.remove(`courses/${id}`);
  showToast('ê°•ì˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'warn');
  loadCourses();
};

window.editCourse = async function(id) {
  const c = allCourses[id]; if (!c) return;
  document.getElementById('edit-course-id').value = id;
  document.getElementById('edit-title').value     = c.title || '';
  document.getElementById('edit-purpose').value   = c.purpose || '';
  document.getElementById('edit-duration').value  = c.duration || 2;
  document.getElementById('edit-yturl').value     = c.videoURL || '';
  document.getElementById('edit-course-modal').classList.remove('hidden');
};

window.saveEditCourse = async function() {
  const id      = document.getElementById('edit-course-id').value;
  const title   = document.getElementById('edit-title').value.trim();
  const purpose = document.getElementById('edit-purpose').value.trim();
  const dur     = document.getElementById('edit-duration').value;
  const yturl   = document.getElementById('edit-yturl').value.trim();
  if (!title) { alert('ê°•ì˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const embedUrl = toYoutubeEmbed(yturl) || yturl;
  await DB.update(`courses/${id}`, { title, purpose, duration: Number(dur), videoURL: embedUrl });
  showToast('ê°•ì˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  closeModal('edit-course-modal');
  loadCourses();
};

// â”€â”€ Add Course â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.previewYT = function() {
  const url = document.getElementById('cf-yturl').value.trim();
  const embed = toYoutubeEmbed(url);
  const previewEl = document.getElementById('yt-preview');
  const frameEl   = document.getElementById('yt-preview-frame');
  if (embed) {
    frameEl.src = embed;
    previewEl.classList.add('show');
  } else {
    previewEl.classList.remove('show');
    frameEl.src = '';
  }
};

window.saveCourse = async function() {
  const title   = document.getElementById('cf-title').value.trim();
  const dur     = document.getElementById('cf-duration').value;
  const purpose = document.getElementById('cf-purpose').value.trim();
  const yturl   = document.getElementById('cf-yturl').value.trim();
  const statusEl= document.getElementById('add-course-status');

  if (!title)  { alert('ê°•ì˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  if (!purpose){ alert('êµìœ¡ëª©ì ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  if (!yturl)  { alert('YouTube URLì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  const embedUrl = toYoutubeEmbed(yturl);
  if (!embedUrl) { alert('ì˜¬ë°”ë¥¸ YouTube URLì´ ì•„ë‹™ë‹ˆë‹¤.\nì˜ˆ: https://www.youtube.com/watch?v=XXXXXXXXXXX'); return; }

  const courseId = 'course_' + Date.now();
  await DB.set(`courses/${courseId}`, {
    title, purpose, duration: Number(dur), videoURL: embedUrl,
    locked: false, createdAt: new Date().toISOString()
  });
  statusEl.innerHTML = `<div class="alert alert-success">âœ… <strong>${title}</strong> ê°•ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>`;
  showToast('ê°•ì˜ ë“±ë¡ ì™„ë£Œ!', 'success');
  clearCourseForm();
  setTimeout(() => { switchSec(document.querySelector('[data-sec="courses"]')); }, 1500);
};

window.clearCourseForm = function() {
  ['cf-title','cf-purpose','cf-yturl'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('cf-duration').value='2';
  document.getElementById('yt-preview').classList.remove('show');
  document.getElementById('yt-preview-frame').src='';
  document.getElementById('add-course-status').innerHTML='';
};

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.changeAdminPw = async function() {
  const np=document.getElementById('new-pw').value, cp=document.getElementById('confirm-pw').value;
  if (!np||np.length<8){alert('8ì ì´ìƒì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}
  if (np!==cp){alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');return;}
  await DB.set('admin/password', np);
  showToast('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.','success');
  document.getElementById('new-pw').value=''; document.getElementById('confirm-pw').value='';
};
window.saveSettings = async function() {
  await DB.set('settings',{passScore:Number(document.getElementById('pass-score').value),maxAttempts:Number(document.getElementById('max-attempts').value)});
  showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.','success');
};

// â”€â”€ CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function csvDownload(filename, rows) {
  const bom='\uFEFF',csv=bom+rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));a.download=filename;a.click();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadOverview();
</script>
</body>
</html>
