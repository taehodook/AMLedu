<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ â€” KASG LMS</title>
<link rel="stylesheet" href="css/main.css">
<style>
  body { background: #ECEAE4; min-height: 100vh; }

  .admin-layout {
    display: grid;
    grid-template-columns: 240px 1fr;
    min-height: calc(100vh - 68px);
  }

  /* â”€â”€ Sidebar â”€â”€ */
  .admin-nav {
    background: var(--navy);
    position: sticky; top: 68px;
    height: calc(100vh - 68px);
    overflow-y: auto;
    display: flex; flex-direction: column;
  }

  .nav-section-title {
    padding: 20px 20px 8px;
    font-size: 10px; font-weight: 600;
    color: rgba(255,255,255,0.35); letter-spacing: 1.5px;
    text-transform: uppercase;
  }

  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 20px;
    color: rgba(255,255,255,0.65);
    font-size: 13px; cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.15s;
  }
  .nav-item:hover { background: rgba(255,255,255,0.07); color: var(--white); }
  .nav-item.active { background: rgba(255,255,255,0.1); color: var(--white); border-left-color: var(--kasg-gold); }
  .nav-item .icon { width: 18px; text-align: center; font-size: 15px; }

  .nav-divider { height: 1px; background: rgba(255,255,255,0.08); margin: 8px 0; }

  .nav-bottom {
    margin-top: auto;
    border-top: 1px solid rgba(255,255,255,0.08);
    padding: 12px 0;
  }

  /* â”€â”€ Content â”€â”€ */
  .admin-content { padding: 32px; }

  .content-section { display: none; }
  .content-section.active { display: block; }

  /* â”€â”€ Stats row â”€â”€ */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px; margin-bottom: 28px;
  }

  /* â”€â”€ Upload Panel â”€â”€ */
  .upload-panel {
    background: var(--white);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    margin-bottom: 24px;
  }

  .upload-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .upload-progress-wrap {
    margin-top: 16px; display: none;
  }
  .upload-progress-wrap.show { display: block; }
  .up-label { font-size: 12px; color: var(--text-mid); margin-bottom: 6px; display: flex; justify-content: space-between; }
  .up-bar   { height: 8px; background: #EEE; border-radius: 4px; overflow: hidden; }
  .up-fill  { height: 100%; background: linear-gradient(90deg, var(--navy), var(--kasg-gold)); border-radius: 4px; transition: width 0.3s; width: 0%; }

  /* â”€â”€ Course Cards â”€â”€ */
  .course-grid-admin {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
  }

  .course-card-admin {
    background: var(--white);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    border-left: 4px solid var(--kasg-gold);
  }

  .course-card-head {
    padding: 16px 20px;
    display: flex; align-items: flex-start; justify-content: space-between;
  }
  .course-card-title { font-family: 'Noto Serif KR', serif; font-size: 15px; font-weight: 700; color: var(--navy); }
  .course-card-meta  { font-size: 11px; color: var(--text-mid); margin-top: 4px; }

  .course-card-actions {
    padding: 12px 16px;
    background: var(--cream);
    display: flex; gap: 8px;
    border-top: 1px solid var(--border);
  }

  /* Table filters */
  .table-toolbar {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 16px;
  }
  .filter-input {
    padding: 8px 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    font-size: 13px; color: var(--text);
    background: var(--white); flex: 1; max-width: 300px;
    outline: none;
  }
  .filter-input:focus { border-color: var(--navy); }

  .export-btn {
    padding: 8px 18px;
    background: var(--success); color: var(--white);
    border: none; border-radius: var(--radius);
    font-size: 13px; font-weight: 500; cursor: pointer;
  }

  /* Settings */
  .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .setting-item {
    background: var(--white);
    border-radius: var(--radius-lg);
    padding: 20px 24px;
    box-shadow: var(--shadow-sm);
  }
  .setting-title { font-size: 14px; font-weight: 600; color: var(--navy); margin-bottom: 14px; }
</style>
</head>
<body>

<!-- Header -->
<header class="site-header">
  <div class="header-brand">
    <img class="header-logo-img" src="assets/logo-wide.png" alt="KASG">
    <span style="color:var(--kasg-red);font-size:11px;font-weight:600;letter-spacing:1px;background:rgba(200,48,42,0.15);padding:3px 10px;border-radius:10px;margin-left:8px">ADMIN</span>
  </div>
  <div class="header-nav">
    <button class="header-btn" onclick="window.location.href='index.html'">ìˆ˜ê°•ìƒ í™”ë©´</button>
    <button class="header-btn" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<div class="admin-layout">
  <!-- Nav -->
  <nav class="admin-nav">
    <div class="nav-section-title">ëŒ€ì‹œë³´ë“œ</div>
    <div class="nav-item active" data-section="overview" onclick="switchSection(this)">
      <span class="icon">ğŸ“Š</span> ì „ì²´ í˜„í™©
    </div>

    <div class="nav-section-title">ê°•ì˜ ê´€ë¦¬</div>
    <div class="nav-item" data-section="courses" onclick="switchSection(this)">
      <span class="icon">ğŸ¬</span> ê°•ì˜ ëª©ë¡
    </div>
    <div class="nav-item" data-section="upload" onclick="switchSection(this)">
      <span class="icon">ğŸ“¤</span> ê°•ì˜ ì—…ë¡œë“œ
    </div>

    <div class="nav-section-title">ìˆ˜ê°•ìƒ ê´€ë¦¬</div>
    <div class="nav-item" data-section="learners" onclick="switchSection(this)">
      <span class="icon">ğŸ‘¥</span> ìˆ˜ê°•ìƒ í˜„í™©
    </div>
    <div class="nav-item" data-section="completions" onclick="switchSection(this)">
      <span class="icon">ğŸ†</span> ìˆ˜ë£Œ í˜„í™©
    </div>

    <div class="nav-section-title">ì‹œìŠ¤í…œ</div>
    <div class="nav-item" data-section="settings" onclick="switchSection(this)">
      <span class="icon">âš™ï¸</span> ì„¤ì •
    </div>

    <div class="nav-bottom">
      <div class="nav-item" onclick="adminLogout()">
        <span class="icon">ğŸšª</span> ë¡œê·¸ì•„ì›ƒ
      </div>
    </div>
  </nav>

  <!-- Content -->
  <div class="admin-content">

    <!-- â•â•â• OVERVIEW â•â•â• -->
    <div class="content-section active" id="sec-overview">
      <div class="section-title">ğŸ“Š ì „ì²´ í˜„í™©</div>
      <div class="stats-row">
        <div class="stat-card"><div class="stat-value" id="ov-total">0</div><div class="stat-label">ì „ì²´ ìˆ˜ê°•ìƒ</div></div>
        <div class="stat-card" style="border-left-color:var(--success)"><div class="stat-value" id="ov-done">0</div><div class="stat-label">ìˆ˜ë£Œ ì™„ë£Œ</div></div>
        <div class="stat-card" style="border-left-color:var(--kasg-blue)"><div class="stat-value" id="ov-prog">0</div><div class="stat-label">ìˆ˜ê°• ì¤‘</div></div>
        <div class="stat-card" style="border-left-color:var(--kasg-red)"><div class="stat-value" id="ov-rate">0%</div><div class="stat-label">ìˆ˜ë£Œìœ¨</div></div>
      </div>
      <div class="stats-row" style="grid-template-columns:repeat(4,1fr)">
        <div class="stat-card"><div class="stat-value" id="ov-courses">0</div><div class="stat-label">ë“±ë¡ ê°•ì˜ ìˆ˜</div></div>
        <div class="stat-card"><div class="stat-value" id="ov-avg-score">-</div><div class="stat-label">í‰ê·  ì ìˆ˜</div></div>
        <div class="stat-card"><div class="stat-value" id="ov-certs">0</div><div class="stat-label">ë°œê¸‰ ìˆ˜ë£Œì¦</div></div>
        <div class="stat-card"><div class="stat-value" id="ov-retake">0</div><div class="stat-label">ì¬ì‹œí—˜ ì‘ì‹œ</div></div>
      </div>

      <!-- Recent completions -->
      <div class="card">
        <div class="card-header"><span class="card-title">ìµœê·¼ ìˆ˜ë£Œì</span></div>
        <div class="card-body" style="padding:0">
          <table class="data-table" id="ov-recent-table">
            <thead>
              <tr><th>ì„±ëª…</th><th>ì†Œì†</th><th>ê°•ì˜</th><th>ì ìˆ˜</th><th>ìˆ˜ë£Œì¼</th></tr>
            </thead>
            <tbody id="ov-recent-body">
              <tr class="empty-row"><td colspan="5">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â•â•â• COURSES â•â•â• -->
    <div class="content-section" id="sec-courses">
      <div class="section-title">ğŸ¬ ê°•ì˜ ëª©ë¡</div>
      <div class="course-grid-admin" id="course-grid">
        <div style="padding:24px;color:var(--text-light)">ë¡œë”© ì¤‘...</div>
      </div>
    </div>

    <!-- â•â•â• UPLOAD â•â•â• -->
    <div class="content-section" id="sec-upload">
      <div class="section-title">ğŸ“¤ ê°•ì˜ ì—…ë¡œë“œ</div>

      <div class="upload-panel">
        <div class="card-header"><span class="card-title">ìƒˆ ê°•ì˜ ë“±ë¡</span></div>
        <div class="card-body">
          <div class="upload-form-grid">
            <div class="form-group">
              <label class="form-label">ê°•ì˜ëª… *</label>
              <input class="form-input" id="uf-title" placeholder="ì˜ˆ: ìê¸ˆì„¸íƒë°©ì§€ ì‹¤ë¬´ì êµìœ¡ 2026">
            </div>
            <div class="form-group">
              <label class="form-label">êµìœ¡ ì‹œê°„ (ì‹œê°„)</label>
              <input class="form-input" id="uf-duration" type="number" min="1" max="10" value="2" placeholder="2">
            </div>
            <div class="form-group" style="grid-column:1/-1">
              <label class="form-label">êµìœ¡ëª©ì  *</label>
              <input class="form-input" id="uf-purpose" placeholder="ì˜ˆ: ìê¸ˆì„¸íƒë°©ì§€(AML) ì‹¤ë¬´ ì´í•´ ë° ì—­ëŸ‰ ê°•í™”">
            </div>
          </div>

          <div class="form-group" style="margin-top:8px">
            <label class="form-label">ê°•ì˜ ì˜ìƒ íŒŒì¼ (MP4, MOV ë“±)</label>
            <div class="upload-zone" id="upload-zone" onclick="document.getElementById('video-file').click()">
              <div class="icon">ğŸ¬</div>
              <div class="text" id="upload-zone-text">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</div>
              <div class="subtext">MP4, MOV, AVI ì§€ì› Â· ìµœëŒ€ 2GB</div>
              <input type="file" id="video-file" accept="video/*" style="display:none" onchange="onFileSelect(event)">
            </div>
          </div>

          <div class="upload-progress-wrap" id="upload-progress">
            <div class="up-label">
              <span>ì—…ë¡œë“œ ì¤‘...</span>
              <span id="up-pct">0%</span>
            </div>
            <div class="up-bar"><div class="up-fill" id="up-fill"></div></div>
          </div>

          <div id="upload-status" style="margin-top:12px"></div>

          <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
            <button class="btn btn-outline" onclick="clearUpload()">ì´ˆê¸°í™”</button>
            <button class="btn btn-gold" id="upload-btn" onclick="doUpload()">ê°•ì˜ ë“±ë¡í•˜ê¸°</button>
          </div>
        </div>
      </div>

      <div class="alert alert-info">
        ğŸ’¡ <strong>Firebase Storage</strong>ì— ì˜ìƒì´ ì—…ë¡œë“œë˜ê³  Realtime DBì— ê°•ì˜ ì •ë³´ê°€ ë“±ë¡ë©ë‹ˆë‹¤.
        ê°•ì˜ ë“±ë¡ í›„ ìˆ˜ê°•ìƒë“¤ì´ ëŒ€ì‹œë³´ë“œì—ì„œ ë°”ë¡œ ìˆ˜ê°•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>

    <!-- â•â•â• LEARNERS â•â•â• -->
    <div class="content-section" id="sec-learners">
      <div class="section-title">ğŸ‘¥ ìˆ˜ê°•ìƒ í˜„í™©</div>
      <div class="table-toolbar">
        <input class="filter-input" id="learner-filter" placeholder="ğŸ” ì„±ëª… ë˜ëŠ” ì†Œì† ê²€ìƒ‰..." oninput="filterLearners()">
        <button class="export-btn" onclick="exportLearners()">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
      </div>
      <div class="card" style="padding:0">
        <table class="data-table" id="learners-table">
          <thead>
            <tr>
              <th>ì„±ëª…</th><th>ì†Œì†</th><th>ê°•ì˜ ì§„ë„</th>
              <th>ì¤‘ê°„í€´ì¦ˆ</th><th>ìµœì¢…ì ìˆ˜</th><th>ì‘ì‹œ</th><th>ìˆ˜ë£Œìƒíƒœ</th><th>ë“±ë¡ì¼</th>
            </tr>
          </thead>
          <tbody id="learners-tbody">
            <tr class="empty-row"><td colspan="8">ë¡œë”© ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- â•â•â• COMPLETIONS â•â•â• -->
    <div class="content-section" id="sec-completions">
      <div class="section-title">ğŸ† ìˆ˜ë£Œ í˜„í™©</div>
      <div class="table-toolbar">
        <input class="filter-input" id="cert-filter" placeholder="ğŸ” ì„±ëª… ë˜ëŠ” ë°œê¸‰ë²ˆí˜¸ ê²€ìƒ‰..." oninput="filterCerts()">
        <button class="export-btn" onclick="exportCerts()">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
      </div>
      <div class="card" style="padding:0">
        <table class="data-table">
          <thead>
            <tr><th>ë°œê¸‰ë²ˆí˜¸</th><th>ì„±ëª…</th><th>ì†Œì†</th><th>ê°•ì˜ëª…</th><th>ì ìˆ˜</th><th>ìˆ˜ë£Œì¼</th></tr>
          </thead>
          <tbody id="completions-tbody">
            <tr class="empty-row"><td colspan="6">ë¡œë”© ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- â•â•â• SETTINGS â•â•â• -->
    <div class="content-section" id="sec-settings">
      <div class="section-title">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</div>
      <div class="settings-grid">
        <div class="setting-item">
          <div class="setting-title">ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="form-group">
            <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input class="form-input" type="password" id="new-admin-pw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
          </div>
          <div class="form-group">
            <label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input class="form-input" type="password" id="confirm-admin-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥">
          </div>
          <button class="btn btn-primary" onclick="changeAdminPw()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        </div>

        <div class="setting-item">
          <div class="setting-title">ğŸ“‹ ìˆ˜ë£Œ ê¸°ì¤€ ì„¤ì •</div>
          <div class="form-group">
            <label class="form-label">ìµœì†Œ ìˆ˜ë£Œ ì ìˆ˜ (%)</label>
            <input class="form-input" type="number" id="pass-score" value="70" min="50" max="100">
          </div>
          <div class="form-group">
            <label class="form-label">ìµœëŒ€ ì¬ì‹œí—˜ íšŸìˆ˜</label>
            <input class="form-input" type="number" id="max-attempts" value="2" min="1" max="5">
          </div>
          <button class="btn btn-primary" onclick="saveSettings()">ì €ì¥</button>
        </div>

        <div class="setting-item" style="grid-column:1/-1">
          <div class="setting-title">ğŸ”— Firebase ì—°ê²° ì •ë³´</div>
          <div class="alert alert-info" style="margin:0">
            <div>
              <strong>Database URL:</strong> https://aml-2-5e6d5-default-rtdb.asia-southeast1.firebasedatabase.app/<br>
              <strong>Project ID:</strong> aml-2-5e6d5<br>
              <strong>Storage Bucket:</strong> aml-2-5e6d5.appspot.com<br>
              <br>
              âš ï¸ <strong>ì¤‘ìš”:</strong> Firebase Consoleì—ì„œ Storage ê·œì¹™ê³¼ Database ê·œì¹™ì„ ì„¤ì •í•´ì•¼ ì˜ìƒ ì—…ë¡œë“œ ë° ë°ì´í„° ì €ì¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /admin-content -->
</div>

<div id="toast-container"></div>

<script type="module">
import { DB, ST } from './js/firebase-config.js';
import { requireAdmin, fmtDate, fmtDateTime } from './js/utils.js';

requireAdmin();

let allLearners = [];
let allCompletions = [];
let allCourses = {};
let selectedFile = null;

// â”€â”€ Section switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.switchSection = function(el) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('sec-' + el.dataset.section).classList.add('active');

  if (el.dataset.section === 'overview')    loadOverview();
  if (el.dataset.section === 'courses')     loadCourses();
  if (el.dataset.section === 'learners')    loadLearners();
  if (el.dataset.section === 'completions') loadCompletions();
};

// â”€â”€ Load overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOverview() {
  const [learnersData, coursesData, completionsData] = await Promise.all([
    DB.get('learners'), DB.get('courses'), DB.get('completions')
  ]);

  allLearners    = learnersData ? Object.values(learnersData) : [];
  allCourses     = coursesData  || {};
  allCompletions = completionsData ? Object.values(completionsData) : [];

  const total     = allLearners.length;
  const done      = allLearners.filter(l => l.status === 'completed').length;
  const inProg    = allLearners.filter(l => l.status === 'in_progress').length;
  const rate      = total ? Math.round(done/total*100) + '%' : '0%';
  const avgScore  = allLearners.filter(l => l.finalScore != null).map(l => l.finalScore);
  const avg       = avgScore.length ? Math.round(avgScore.reduce((a,b)=>a+b,0)/avgScore.length) + 'ì ' : '-';
  const retake    = allLearners.filter(l => (l.attempt || 0) >= 2).length;

  document.getElementById('ov-total').textContent    = total;
  document.getElementById('ov-done').textContent     = done;
  document.getElementById('ov-prog').textContent     = inProg;
  document.getElementById('ov-rate').textContent     = rate;
  document.getElementById('ov-courses').textContent  = Object.keys(allCourses).length;
  document.getElementById('ov-avg-score').textContent= avg;
  document.getElementById('ov-certs').textContent    = allCompletions.length;
  document.getElementById('ov-retake').textContent   = retake;

  // Recent completions (last 5)
  const recent = [...allCompletions].sort((a,b) => new Date(b.date)-new Date(a.date)).slice(0, 5);
  document.getElementById('ov-recent-body').innerHTML = recent.length
    ? recent.map(c => `<tr>
        <td>${c.name}</td>
        <td>${c.org}</td>
        <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.courseTitle||'-'}</td>
        <td><span class="badge badge-success">${c.score}ì </span></td>
        <td>${fmtDate(new Date(c.date))}</td>
      </tr>`).join('')
    : '<tr class="empty-row"><td colspan="5">ìˆ˜ë£Œì ì—†ìŒ</td></tr>';
}

// â”€â”€ Load courses â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCourses() {
  const data = await DB.get('courses') || {};
  allCourses = data;
  const grid = document.getElementById('course-grid');
  const arr  = Object.entries(data);

  if (!arr.length) {
    grid.innerHTML = `<div class="card" style="padding:48px;text-align:center;grid-column:1/-1">
      <div style="font-size:36px;margin-bottom:12px">ğŸ“‚</div>
      <div style="color:var(--text-mid)">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ê°•ì˜ ì—…ë¡œë“œ ë©”ë‰´ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>
    </div>`;
    return;
  }

  grid.innerHTML = arr.map(([id, c]) => `
    <div class="course-card-admin">
      <div class="course-card-head">
        <div>
          <div class="course-card-title">${c.title}</div>
          <div class="course-card-meta">â± ${c.duration||'?'}ì‹œê°„ Â· ë“±ë¡: ${fmtDate(new Date(c.createdAt||Date.now()))}</div>
          <div class="course-card-meta" style="margin-top:4px">ğŸ¯ ${c.purpose||'-'}</div>
        </div>
        <span class="badge ${c.locked ? 'badge-error' : 'badge-success'}">${c.locked ? 'ì ê¹€' : 'ê³µê°œ'}</span>
      </div>
      <div class="course-card-actions">
        <button class="btn btn-sm btn-outline" onclick="toggleCourseLock('${id}', ${!c.locked})">
          ${c.locked ? 'ğŸ”“ ê³µê°œ' : 'ğŸ”’ ì ê¸ˆ'}
        </button>
        <button class="btn btn-sm btn-danger" onclick="deleteCourse('${id}')">ì‚­ì œ</button>
      </div>
    </div>`).join('');
}

window.toggleCourseLock = async function(id, lock) {
  await DB.update(`courses/${id}`, { locked: lock });
  loadCourses();
};

window.deleteCourse = async function(id) {
  if (!confirm('ê°•ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
  await DB.remove(`courses/${id}`);
  loadCourses();
};

// â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onFileSelect = function(e) {
  selectedFile = e.target.files[0];
  if (selectedFile) {
    document.getElementById('upload-zone-text').textContent =
      `âœ… ${selectedFile.name} (${(selectedFile.size/1024/1024).toFixed(1)}MB)`;
  }
};

// Drag & Drop
const zone = document.getElementById('upload-zone');
zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragging'); });
zone.addEventListener('dragleave', () => zone.classList.remove('dragging'));
zone.addEventListener('drop', e => {
  e.preventDefault(); zone.classList.remove('dragging');
  const f = e.dataTransfer.files[0];
  if (f && f.type.startsWith('video/')) {
    selectedFile = f;
    document.getElementById('upload-zone-text').textContent = `âœ… ${f.name} (${(f.size/1024/1024).toFixed(1)}MB)`;
  }
});

window.clearUpload = function() {
  selectedFile = null;
  document.getElementById('uf-title').value    = '';
  document.getElementById('uf-duration').value = '2';
  document.getElementById('uf-purpose').value  = '';
  document.getElementById('upload-zone-text').textContent = 'í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ';
  document.getElementById('upload-progress').classList.remove('show');
  document.getElementById('upload-status').innerHTML = '';
};

window.doUpload = async function() {
  const title    = document.getElementById('uf-title').value.trim();
  const duration = document.getElementById('uf-duration').value;
  const purpose  = document.getElementById('uf-purpose').value.trim();

  if (!title)    { alert('ê°•ì˜ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
  if (!purpose)  { alert('êµìœ¡ëª©ì ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
  if (!selectedFile) { alert('ë™ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }

  const btn = document.getElementById('upload-btn');
  btn.disabled = true;
  document.getElementById('upload-progress').classList.add('show');
  document.getElementById('upload-status').innerHTML = '';

  try {
    const courseId = 'course_' + Date.now();

    const task = ST.uploadVideo(selectedFile, courseId, pct => {
      document.getElementById('up-pct').textContent = pct + '%';
      document.getElementById('up-fill').style.width = pct + '%';
    });

    task.then(async snapshot => {
      const url = await ST.getURL(snapshot.ref.fullPath);
      await DB.set(`courses/${courseId}`, {
        title, duration: Number(duration), purpose,
        videoURL: url, videoPath: snapshot.ref.fullPath,
        locked: false, createdAt: new Date().toISOString()
      });
      document.getElementById('upload-status').innerHTML =
        `<div class="alert alert-success">âœ… <strong>${title}</strong> ê°•ì˜ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>`;
      btn.disabled = false;
      setTimeout(() => { clearUpload(); switchSection(document.querySelector('[data-section="courses"]')); }, 2000);
    });

    task.catch(err => {
      console.error(err);
      document.getElementById('upload-status').innerHTML =
        `<div class="alert alert-error">âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${err.message}</div>`;
      btn.disabled = false;
    });

  } catch(e) {
    document.getElementById('upload-status').innerHTML =
      `<div class="alert alert-error">âŒ ì˜¤ë¥˜: ${e.message}</div>`;
    btn.disabled = false;
  }
};

// â”€â”€ Learners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLearners() {
  const data = await DB.get('learners') || {};
  allLearners = Object.values(data);
  renderLearners(allLearners);
}

function renderLearners(list) {
  const tbody = document.getElementById('learners-tbody');
  tbody.innerHTML = list.length
    ? list.map(l => {
        const prog   = Math.round((Object.values(l.courseProgress || {})[0] || 0) * 100);
        const mq     = `${l.midQuizCorrect||0}/${l.midQuizTotal||0}`;
        const score  = l.finalScore != null ? l.finalScore+'ì ' : '-';
        const att    = (l.attempt||0) + '/2';
        const badgeCls = l.status==='completed' ? 'badge-success' : l.status==='in_progress' ? 'badge-warn' : 'badge-neutral';
        const badgeLabel = l.status==='completed' ? 'ìˆ˜ë£Œ' : l.status==='in_progress' ? 'ìˆ˜ê°•ì¤‘' : 'ë¯¸ì‹œì‘';
        return `<tr>
          <td><strong>${l.name}</strong></td>
          <td>${l.org}</td>
          <td>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="progress-wrap" style="height:4px;width:80px"><div class="progress-fill" style="width:${prog}%"></div></div>
              <span style="font-size:11px;color:var(--text-mid)">${prog}%</span>
            </div>
          </td>
          <td>${mq}</td>
          <td>${score}</td>
          <td>${att}</td>
          <td><span class="badge ${badgeCls}">${badgeLabel}</span></td>
          <td style="font-size:11px;color:var(--text-light)">${fmtDate(new Date(l.createdAt||Date.now()))}</td>
        </tr>`;
      }).join('')
    : '<tr class="empty-row"><td colspan="8">ìˆ˜ê°•ìƒ ì—†ìŒ</td></tr>';
}

window.filterLearners = function() {
  const q = document.getElementById('learner-filter').value.toLowerCase();
  renderLearners(allLearners.filter(l =>
    l.name?.toLowerCase().includes(q) || l.org?.toLowerCase().includes(q)
  ));
};

window.exportLearners = function() {
  const rows = [['ì„±ëª…','ì†Œì†','ì§„ë„(%)','ì¤‘ê°„í€´ì¦ˆ','ìµœì¢…ì ìˆ˜','ì‘ì‹œ','ìˆ˜ë£Œìƒíƒœ','ë“±ë¡ì¼']];
  allLearners.forEach(l => {
    const prog = Math.round((Object.values(l.courseProgress||{})[0]||0)*100);
    rows.push([l.name, l.org, prog+'%', `${l.midQuizCorrect||0}/${l.midQuizTotal||0}`,
      l.finalScore!=null?l.finalScore+'ì ':'-', (l.attempt||0)+'/2',
      l.status==='completed'?'ìˆ˜ë£Œ':l.status==='in_progress'?'ìˆ˜ê°•ì¤‘':'ë¯¸ì‹œì‘',
      fmtDate(new Date(l.createdAt||Date.now()))
    ]);
  });
  downloadCSV('learners.csv', rows);
};

// â”€â”€ Completions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCompletions() {
  const data = await DB.get('completions') || {};
  allCompletions = Object.values(data).sort((a,b) => new Date(b.date)-new Date(a.date));
  renderCompletions(allCompletions);
}

function renderCompletions(list) {
  document.getElementById('completions-tbody').innerHTML = list.length
    ? list.map(c => `<tr>
        <td style="font-family:'DM Mono',monospace;font-size:12px">ì œ ${c.certNo}í˜¸</td>
        <td><strong>${c.name}</strong></td>
        <td>${c.org}</td>
        <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis">${c.courseTitle||'-'}</td>
        <td><span class="badge badge-success">${c.score}ì </span></td>
        <td>${fmtDate(new Date(c.date))}</td>
      </tr>`).join('')
    : '<tr class="empty-row"><td colspan="6">ìˆ˜ë£Œì ì—†ìŒ</td></tr>';
}

window.filterCerts = function() {
  const q = document.getElementById('cert-filter').value.toLowerCase();
  renderCompletions(allCompletions.filter(c =>
    c.name?.toLowerCase().includes(q) || (c.certNo||'').toLowerCase().includes(q)
  ));
};

window.exportCerts = function() {
  const rows = [['ë°œê¸‰ë²ˆí˜¸','ì„±ëª…','ì†Œì†','ê°•ì˜ëª…','ì ìˆ˜','ìˆ˜ë£Œì¼']];
  allCompletions.forEach(c => {
    rows.push([`ì œ ${c.certNo}í˜¸`, c.name, c.org, c.courseTitle||'-', c.score+'ì ', fmtDate(new Date(c.date))]);
  });
  downloadCSV('completions.csv', rows);
};

function downloadCSV(filename, rows) {
  const bom  = '\uFEFF';
  const csv  = bom + rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.changeAdminPw = async function() {
  const np = document.getElementById('new-admin-pw').value;
  const cp = document.getElementById('confirm-admin-pw').value;
  if (!np) { alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  if (np !== cp) { alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
  await DB.set('admin/password', np);
  alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
};

window.saveSettings = async function() {
  await DB.set('settings', {
    passScore:   Number(document.getElementById('pass-score').value),
    maxAttempts: Number(document.getElementById('max-attempts').value)
  });
  alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
};

window.adminLogout = function() {
  sessionStorage.removeItem('kasg_admin');
  window.location.href = 'admin-login.html';
};

// Init
loadOverview();
</script>
</body>
</html>
