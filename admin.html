<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ â€” KASG LMS</title>
<link rel="stylesheet" href="css/main.css">
<style>
body{background:#ECEAE4;min-height:100vh}
.admin-layout{display:grid;grid-template-columns:220px 1fr;min-height:calc(100vh - 66px)}

/* â”€â”€ Nav â”€â”€ */
.admin-nav{background:var(--navy);position:sticky;top:66px;height:calc(100vh - 66px);overflow-y:auto;display:flex;flex-direction:column;flex-shrink:0}
.nav-sec{padding:16px 16px 6px;font-size:9px;font-weight:600;color:rgba(255,255,255,.28);letter-spacing:1.5px;text-transform:uppercase}
.nav-item{display:flex;align-items:center;gap:9px;padding:10px 16px;color:rgba(255,255,255,.6);font-size:12.5px;cursor:pointer;border-left:3px solid transparent;transition:all .14s}
.nav-item:hover{background:rgba(255,255,255,.06);color:#fff}
.nav-item.active{background:rgba(255,255,255,.09);color:#fff;border-left-color:var(--kasg-gold)}
.nav-icon{width:16px;text-align:center;font-size:13px;flex-shrink:0}
.nav-divider{height:1px;background:rgba(255,255,255,.07);margin:5px 0}
.nav-badge{min-width:17px;height:17px;border-radius:9px;background:var(--kasg-red);color:#fff;font-size:9.5px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;padding:0 4px;margin-left:auto}
.nav-bottom{margin-top:auto;border-top:1px solid rgba(255,255,255,.07);padding:8px 0}

/* â”€â”€ Content â”€â”€ */
.admin-content{padding:24px;min-width:0;overflow-x:hidden}
.content-sec{display:none}
.content-sec.active{display:block}

/* â”€â”€ Stats â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
@media(max-width:1200px){.stats-grid{grid-template-columns:repeat(2,1fr)}}

/* â”€â”€ Tables â”€â”€ */
.tbl-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.filter-input{padding:7px 12px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:12.5px;color:var(--text);background:#fff;width:220px;outline:none}
.filter-input:focus{border-color:var(--navy)}
.filter-select{padding:7px 28px 7px 10px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:12.5px;background:#fff;outline:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%235A6070' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;cursor:pointer}
.ml-auto{margin-left:auto}
.tbl-wrap{background:#fff;border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-sm)}
.tbl-wrap table{min-width:100%}

/* Inline action btns */
.tbl-btn{padding:4px 9px;border-radius:3px;font-size:10.5px;font-weight:600;cursor:pointer;border:none;white-space:nowrap;transition:all .12s}
.tb-approve{background:#D1FAE5;color:var(--success)}.tb-approve:hover{background:var(--success);color:#fff}
.tb-reject {background:#FEE2E2;color:var(--error)}.tb-reject:hover{background:var(--error);color:#fff}
.tb-reset  {background:#FEF3C7;color:#7A4F00}.tb-reset:hover{background:#D97706;color:#fff}
.tb-delete {background:#F1F0EC;color:var(--error)}.tb-delete:hover{background:var(--error);color:#fff}
.tb-pw     {background:#DBEAFE;color:#1E40AF}.tb-pw:hover{background:#1E40AF;color:#fff}
.tb-assign {background:#EDE9FF;color:#5B21B6}.tb-assign:hover{background:#5B21B6;color:#fff}
.tb-edit   {background:#F0FFF4;color:var(--success)}.tb-edit:hover{background:var(--success);color:#fff}

/* Course cards */
.course-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.cc{background:#fff;border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-sm);border-left:4px solid var(--kasg-gold)}
.cc-hd{padding:13px 15px}
.cc-title{font-family:'Noto Serif KR',serif;font-size:13px;font-weight:700;color:var(--navy);margin-bottom:3px}
.cc-meta{font-size:10.5px;color:var(--text-mid);line-height:1.5}
.cc-url{font-size:10px;color:var(--kasg-blue);word-break:break-all;margin-top:3px;text-decoration:underline;cursor:pointer}
.cc-ft{padding:9px 13px;background:var(--cream);border-top:1px solid var(--border);display:flex;gap:6px;flex-wrap:wrap;align-items:center}

/* YT preview */
.yt-preview{margin-top:9px;border-radius:var(--radius);overflow:hidden;background:#000;aspect-ratio:16/9;display:none}
.yt-preview.show{display:block}
.yt-preview iframe{width:100%;height:100%;border:none}

/* Settings */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:900px){.settings-grid{grid-template-columns:1fr}}
.sbox{background:#fff;border-radius:var(--radius-lg);padding:18px 20px;box-shadow:var(--shadow-sm)}
.sbox-title{font-size:13px;font-weight:700;color:var(--navy);margin-bottom:12px}

/* Grade pill */
.gp{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:10.5px;font-weight:600;white-space:nowrap}
.gp-board   {background:rgba(200,150,10,.12);color:#8B6800;border:1px solid rgba(200,150,10,.25)}
.gp-aml     {background:rgba(26,62,160,.1);color:#1A3EA0;border:1px solid rgba(26,62,160,.2)}
.gp-general {background:#F1F0EC;color:#5A6070;border:1px solid var(--border)}
.gp-research{background:rgba(200,48,42,.08);color:#8B1818;border:1px solid rgba(200,48,42,.15)}

/* â”€â”€ Assign Modal â”€â”€ */
.assign-modal .modal-box{width:640px}
.course-check-list{display:flex;flex-direction:column;gap:6px;max-height:340px;overflow-y:auto;padding:2px}
.course-check-item{display:flex;align-items:center;gap:10px;padding:10px 13px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .12s}
.course-check-item:hover{border-color:var(--navy);background:rgba(12,31,63,.02)}
.course-check-item.checked{border-color:var(--navy);background:rgba(12,31,63,.04)}
.course-check-item input[type=checkbox]{width:15px;height:15px;accent-color:var(--navy);cursor:pointer;flex-shrink:0}
.cck-title{font-size:13px;font-weight:600;color:var(--navy)}
.cck-meta{font-size:11px;color:var(--text-mid)}
.assign-grade-bar{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:14px}
.agb-btn{padding:5px 13px;border-radius:14px;font-size:11.5px;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:#fff;color:var(--text-mid);transition:all .12s}
.agb-btn:hover{border-color:var(--navy);color:var(--navy)}
.agb-btn.active{background:var(--navy);color:#fff;border-color:var(--navy)}

/* Edit learner modal */
.edit-section{margin-bottom:16px}
.edit-section-title{font-size:11px;font-weight:700;color:var(--text-mid);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-brand">
    <img class="header-logo-img" src="assets/logo-wide.png" alt="KASG">
    <span style="color:var(--kasg-red);font-size:10.5px;font-weight:700;letter-spacing:1px;background:rgba(200,48,42,.13);padding:2px 9px;border-radius:9px;margin-left:8px">ADMIN</span>
  </div>
  <div class="header-nav">
    <button class="header-btn" onclick="window.open('index.html','_blank')">ìˆ˜ê°•ìƒ í™”ë©´</button>
    <button class="header-btn" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<div class="admin-layout">
  <!-- â”€â”€ Sidebar â”€â”€ -->
  <nav class="admin-nav">
    <div class="nav-sec">ëŒ€ì‹œë³´ë“œ</div>
    <div class="nav-item active" data-sec="overview" onclick="go(this)"><span class="nav-icon">ğŸ“Š</span>ì „ì²´ í˜„í™©</div>
    <div class="nav-divider"></div>
    <div class="nav-sec">ìˆ˜ê°•ìƒ ê´€ë¦¬</div>
    <div class="nav-item" data-sec="pending" onclick="go(this)"><span class="nav-icon">â³</span>ê°€ì… ìŠ¹ì¸ ëŒ€ê¸°<span class="nav-badge" id="pending-cnt">0</span></div>
    <div class="nav-item" data-sec="learners" onclick="go(this)"><span class="nav-icon">ğŸ‘¥</span>ìˆ˜ê°•ìƒ ëª©ë¡</div>
    <div class="nav-item" data-sec="assign" onclick="go(this)"><span class="nav-icon">ğŸ“‹</span>ê°•ì˜ ë°°ì • ê´€ë¦¬</div>
    <div class="nav-item" data-sec="completions" onclick="go(this)"><span class="nav-icon">ğŸ†</span>ìˆ˜ë£Œ í˜„í™©</div>
    <div class="nav-divider"></div>
    <div class="nav-sec">ê°•ì˜ ê´€ë¦¬</div>
    <div class="nav-item" data-sec="courses" onclick="go(this)"><span class="nav-icon">ğŸ¬</span>ê°•ì˜ ëª©ë¡</div>
    <div class="nav-item" data-sec="add-course" onclick="go(this)"><span class="nav-icon">â•</span>ê°•ì˜ ë“±ë¡</div>
    <div class="nav-divider"></div>
    <div class="nav-sec">ì‹œìŠ¤í…œ</div>
    <div class="nav-item" data-sec="settings" onclick="go(this)"><span class="nav-icon">âš™ï¸</span>ì„¤ì •</div>
    <div class="nav-bottom">
      <div class="nav-item" onclick="adminLogout()"><span class="nav-icon">ğŸšª</span>ë¡œê·¸ì•„ì›ƒ</div>
    </div>
  </nav>

  <!-- â”€â”€ Content â”€â”€ -->
  <div class="admin-content">

    <!-- â•â• OVERVIEW â•â• -->
    <div class="content-sec active" id="sec-overview">
      <div class="section-title">ğŸ“Š ì „ì²´ í˜„í™©</div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="ov-total">0</div><div class="stat-label">ì „ì²´ ìˆ˜ê°•ìƒ</div></div>
        <div class="stat-card" style="border-left-color:#FCA311"><div class="stat-value" id="ov-pending">0</div><div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸°</div></div>
        <div class="stat-card" style="border-left-color:var(--success)"><div class="stat-value" id="ov-done">0</div><div class="stat-label">ìˆ˜ë£Œ ì™„ë£Œ</div></div>
        <div class="stat-card" style="border-left-color:var(--kasg-blue)"><div class="stat-value" id="ov-rate">0%</div><div class="stat-label">ìˆ˜ë£Œìœ¨</div></div>
      </div>
      <!-- Grade breakdown -->
      <div class="card" style="margin-bottom:18px">
        <div class="card-header"><span class="card-title">ë“±ê¸‰ë³„ í˜„í™©</span></div>
        <div class="card-body" style="padding:16px">
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px" id="grade-stats"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">ìµœê·¼ ìˆ˜ë£Œì</span></div>
        <div style="padding:0"><table class="data-table"><thead><tr><th>ì„±ëª…</th><th>ë“±ê¸‰</th><th>ì†Œì†</th><th>ê°•ì˜ëª…</th><th>ì ìˆ˜</th><th>ìˆ˜ë£Œì¼</th></tr></thead><tbody id="ov-recent"></tbody></table></div>
      </div>
    </div>

    <!-- â•â• PENDING â•â• -->
    <div class="content-sec" id="sec-pending">
      <div class="section-title">â³ ê°€ì… ìŠ¹ì¸ ëŒ€ê¸°</div>
      <div class="alert alert-info" style="margin-bottom:14px;font-size:12.5px">ìŠ¹ì¸ ì‹œ ìˆ˜ê°•ìƒì´ ë¡œê·¸ì¸ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤. ìŠ¹ì¸ í›„ ê°•ì˜ ë°°ì •ì„ ì§„í–‰í•˜ì„¸ìš”.</div>
      <div class="tbl-wrap">
        <table class="data-table">
          <thead><tr><th>ì„±ëª…</th><th>ì•„ì´ë””</th><th>ì†Œì†</th><th>ë“±ê¸‰</th><th>ì—°ë½ì²˜</th><th>ì‹ ì²­ì¼</th><th style="text-align:center">ì²˜ë¦¬</th></tr></thead>
          <tbody id="pending-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- â•â• LEARNERS â•â• -->
    <div class="content-sec" id="sec-learners">
      <div class="section-title">ğŸ‘¥ ìˆ˜ê°•ìƒ ëª©ë¡</div>
      <div class="tbl-toolbar">
        <input class="filter-input" id="lf-search" placeholder="ğŸ” ì„±ëª…Â·ì•„ì´ë””Â·ì†Œì† ê²€ìƒ‰" oninput="filterLearners()">
        <select class="filter-select" id="lf-grade" onchange="filterLearners()">
          <option value="">ì „ì²´ ë“±ê¸‰</option>
          <option value="board">ì´ì‚¬íšŒÂ·ì„ì›</option>
          <option value="aml">AML ë‹´ë‹¹ì</option>
          <option value="general">ì¼ë°˜</option>
          <option value="research">ì—°êµ¬íšŒ</option>
        </select>
        <select class="filter-select" id="lf-status" onchange="filterLearners()">
          <option value="">ì „ì²´ ìƒíƒœ</option>
          <option value="approved">ìŠ¹ì¸ë¨</option>
          <option value="in_progress">ìˆ˜ê°• ì¤‘</option>
          <option value="completed">ìˆ˜ë£Œ</option>
        </select>
        <div class="ml-auto" style="display:flex;gap:7px">
          <button class="btn btn-sm btn-outline" onclick="exportLearners()">ğŸ“¥ CSV</button>
        </div>
      </div>
      <div class="tbl-wrap" style="overflow-x:auto">
        <table class="data-table" style="min-width:900px">
          <thead><tr><th>ì„±ëª…</th><th>ë“±ê¸‰</th><th>ì†Œì†Â·ë¶€ì„œ</th><th>ë°°ì •ê°•ì˜</th><th>ì§„ë„</th><th>ì ìˆ˜</th><th>ìƒíƒœ</th><th>ë“±ë¡ì¼</th><th style="text-align:center">ê´€ë¦¬</th></tr></thead>
          <tbody id="learners-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- â•â• ASSIGN â•â• -->
    <div class="content-sec" id="sec-assign">
      <div class="section-title">ğŸ“‹ ê°•ì˜ ë°°ì • ê´€ë¦¬</div>
      <div class="alert alert-info" style="margin-bottom:16px;font-size:12.5px">
        ìˆ˜ê°•ìƒì˜ ë“±ê¸‰Â·ì†Œì†ì— ë”°ë¼ ê°•ì˜ë¥¼ ê°œë³„ ë˜ëŠ” ì¼ê´„ ë°°ì •í•˜ì„¸ìš”.
      </div>

      <!-- Bulk assign by grade -->
      <div class="card" style="margin-bottom:18px">
        <div class="card-header"><span class="card-title">ğŸ¯ ë“±ê¸‰ë³„ ì¼ê´„ ë°°ì •</span></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start">
            <div>
              <div class="form-label" style="margin-bottom:8px">ëŒ€ìƒ ë“±ê¸‰ ì„ íƒ</div>
              <div style="display:flex;gap:7px;flex-wrap:wrap" id="bulk-grade-btns">
                <button class="agb-btn" data-grade="board"    onclick="toggleBulkGrade(this)">ğŸ› ì´ì‚¬íšŒÂ·ì„ì›</button>
                <button class="agb-btn" data-grade="aml"      onclick="toggleBulkGrade(this)">ğŸ” AML ë‹´ë‹¹ì</button>
                <button class="agb-btn" data-grade="general"  onclick="toggleBulkGrade(this)">ğŸ‘¤ ì¼ë°˜</button>
                <button class="agb-btn" data-grade="research" onclick="toggleBulkGrade(this)">ğŸ“ ì—°êµ¬íšŒ</button>
              </div>
            </div>
            <div>
              <div class="form-label" style="margin-bottom:8px">ë°°ì •í•  ê°•ì˜</div>
              <div id="bulk-course-checks" style="display:flex;flex-direction:column;gap:5px;max-height:160px;overflow-y:auto"></div>
            </div>
          </div>
          <div style="margin-top:14px;display:flex;justify-content:flex-end;gap:8px">
            <button class="btn btn-outline btn-sm" onclick="previewBulk()">ëŒ€ìƒ ë¯¸ë¦¬ë³´ê¸°</button>
            <button class="btn btn-primary" onclick="doBulkAssign()">ì¼ê´„ ë°°ì • ì ìš©</button>
          </div>
          <div id="bulk-preview" style="margin-top:12px;display:none"></div>
        </div>
      </div>

      <!-- Individual assign table -->
      <div class="section-title" style="font-size:15px;margin-top:0">ê°œë³„ ìˆ˜ê°•ìƒ ë°°ì • í˜„í™©</div>
      <div class="tbl-toolbar">
        <input class="filter-input" id="af-search" placeholder="ğŸ” ì„±ëª…Â·ì†Œì† ê²€ìƒ‰" oninput="filterAssign()">
        <select class="filter-select" id="af-grade" onchange="filterAssign()">
          <option value="">ì „ì²´ ë“±ê¸‰</option>
          <option value="board">ì´ì‚¬íšŒÂ·ì„ì›</option>
          <option value="aml">AML ë‹´ë‹¹ì</option>
          <option value="general">ì¼ë°˜</option>
          <option value="research">ì—°êµ¬íšŒ</option>
        </select>
      </div>
      <div class="tbl-wrap" style="overflow-x:auto">
        <table class="data-table" style="min-width:760px">
          <thead><tr><th>ì„±ëª…</th><th>ë“±ê¸‰</th><th>ì†Œì†</th><th>ë°°ì •ëœ ê°•ì˜</th><th style="text-align:center">ë°°ì • ìˆ˜ì •</th></tr></thead>
          <tbody id="assign-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- â•â• COMPLETIONS â•â• -->
    <div class="content-sec" id="sec-completions">
      <div class="section-title">ğŸ† ìˆ˜ë£Œ í˜„í™©</div>
      <div class="tbl-toolbar">
        <input class="filter-input" id="cf-search" placeholder="ğŸ” ì„±ëª…Â·ë°œê¸‰ë²ˆí˜¸" oninput="filterCompletions()">
        <div class="ml-auto"><button class="btn btn-sm btn-outline" onclick="exportCompletions()">ğŸ“¥ CSV</button></div>
      </div>
      <div class="tbl-wrap">
        <table class="data-table">
          <thead><tr><th>ë°œê¸‰ë²ˆí˜¸</th><th>ì„±ëª…</th><th>ë“±ê¸‰</th><th>ì†Œì†</th><th>ê°•ì˜ëª…</th><th>ì ìˆ˜</th><th>ìˆ˜ë£Œì¼</th></tr></thead>
          <tbody id="completions-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- â•â• COURSES â•â• -->
    <div class="content-sec" id="sec-courses">
      <div class="section-title">ğŸ¬ ê°•ì˜ ëª©ë¡</div>
      <div class="course-grid" id="course-grid"></div>
    </div>

    <!-- â•â• ADD COURSE â•â• -->
    <div class="content-sec" id="sec-add-course">
      <div class="section-title">â• ê°•ì˜ ë“±ë¡</div>
      <div class="card">
        <div class="card-header"><span class="card-title">ìƒˆ ê°•ì˜ ë“±ë¡ (YouTube URL)</span></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
            <div class="form-group"><label class="form-label">ê°•ì˜ëª… *</label><input class="form-input" id="cf-title" placeholder="ì˜ˆ: AML ì‹¤ë¬´ì êµìœ¡ 2025"></div>
            <div class="form-group"><label class="form-label">êµìœ¡ ì‹œê°„(ì‹œê°„) *</label><input class="form-input" id="cf-duration" type="number" value="2" min="1" max="20"></div>
          </div>
          <div class="form-group"><label class="form-label">êµìœ¡ëª©ì  *</label><input class="form-input" id="cf-purpose" placeholder="ì˜ˆ: ìê¸ˆì„¸íƒë°©ì§€ ì‹¤ë¬´ ì´í•´ ë° ì—­ëŸ‰ ê°•í™”"></div>
          <div class="form-group">
            <label class="form-label">YouTube URL *</label>
            <input class="form-input" id="cf-yturl" placeholder="https://www.youtube.com/watch?v=..." oninput="previewYT()">
            <div class="form-hint">ìœ íŠœë¸Œ ì˜ìƒ URL ë¶™ì—¬ë„£ê¸° â†’ ìë™ ë³€í™˜</div>
          </div>
          <div class="yt-preview" id="yt-preview"><iframe id="yt-preview-frame" allowfullscreen></iframe></div>
          <div id="add-course-msg" style="margin-top:10px"></div>
          <div style="margin-top:16px;display:flex;gap:9px;justify-content:flex-end">
            <button class="btn btn-outline btn-sm" onclick="clearCF()">ì´ˆê¸°í™”</button>
            <button class="btn btn-gold" onclick="saveCourse()">ê°•ì˜ ë“±ë¡í•˜ê¸°</button>
          </div>
        </div>
      </div>
      <div class="alert alert-info" style="margin-top:14px;font-size:12px">
        ğŸ’¡ YouTube ì˜ìƒì€ <strong>ì¼ë¶€ ê³µê°œ(ë§í¬ ê³µìœ )</strong> ë˜ëŠ” <strong>ê³µê°œ</strong>ë¡œ ì„¤ì •í•´ì•¼ ì¬ìƒë©ë‹ˆë‹¤.
      </div>
    </div>

    <!-- â•â• SETTINGS â•â• -->
    <div class="content-sec" id="sec-settings">
      <div class="section-title">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</div>
      <div class="settings-grid">
        <div class="sbox">
          <div class="sbox-title">ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="form-group"><label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input class="form-input" type="password" id="new-pw" placeholder="8ì ì´ìƒ"></div>
          <div class="form-group"><label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input class="form-input" type="password" id="confirm-pw"></div>
          <button class="btn btn-primary btn-sm" onclick="changeAdminPw()">ë³€ê²½ ì ìš©</button>
        </div>
        <div class="sbox">
          <div class="sbox-title">ğŸ“‹ ìˆ˜ë£Œ ê¸°ì¤€</div>
          <div class="form-group"><label class="form-label">ìµœì†Œ ìˆ˜ë£Œ ì ìˆ˜ (%)</label><input class="form-input" type="number" id="pass-score" value="70" min="50" max="100"></div>
          <div class="form-group"><label class="form-label">ìµœëŒ€ ì¬ì‹œí—˜ íšŸìˆ˜</label><input class="form-input" type="number" id="max-attempts" value="2" min="1" max="5"></div>
          <button class="btn btn-primary btn-sm" onclick="saveSettings()">ì €ì¥</button>
        </div>
        <div class="sbox" style="grid-column:1/-1">
          <div class="sbox-title">ğŸ”— Firebase ì„¤ì • ì•ˆë‚´</div>
          <div class="alert alert-warn" style="margin:0;font-size:12px">
            <strong>í•„ìˆ˜:</strong> <code>js/firebase-config.js</code> ì—ì„œ <code>apiKey</code>, <code>messagingSenderId</code>, <code>appId</code>ë¥¼ êµì²´í•˜ì„¸ìš”.<br>
            Firebase Console â†’ í”„ë¡œì íŠ¸ aml-2-5e6d5 â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì›¹ ì•±ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>

  </div><!-- /admin-content -->
</div><!-- /admin-layout -->

<!-- â•â• MODALS â•â• -->

<!-- Reset PW -->
<div class="modal-backdrop hidden" id="modal-reset-pw">
  <div class="modal-box">
    <div class="modal-header"><span class="modal-title">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”</span><button class="modal-close" onclick="closeModal('modal-reset-pw')">âœ•</button></div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text-mid);margin-bottom:14px"><strong id="rp-name"></strong>ë‹˜ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</p>
      <div class="form-group"><label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="text" class="form-input" id="rp-new" value="kasg1234"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('modal-reset-pw')">ì·¨ì†Œ</button>
      <button class="btn btn-warn btn-sm" onclick="doResetPw()">ì´ˆê¸°í™” ì ìš©</button>
    </div>
  </div>
</div>

<!-- Edit Learner (grade/info) -->
<div class="modal-backdrop hidden" id="modal-edit-learner">
  <div class="modal-box">
    <div class="modal-header"><span class="modal-title">âœï¸ ìˆ˜ê°•ìƒ ì •ë³´ ìˆ˜ì •</span><button class="modal-close" onclick="closeModal('modal-edit-learner')">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="el-id">
      <div class="edit-section">
        <div class="edit-section-title">ê¸°ë³¸ ì •ë³´</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="form-group"><label class="form-label">ì„±ëª…</label><input class="form-input" id="el-name"></div>
          <div class="form-group"><label class="form-label">ì†Œì†</label><input class="form-input" id="el-org"></div>
          <div class="form-group"><label class="form-label">ë¶€ì„œ</label><input class="form-input" id="el-dept"></div>
          <div class="form-group"><label class="form-label">ì—°ë½ì²˜</label><input class="form-input" id="el-phone"></div>
        </div>
      </div>
      <div class="edit-section">
        <div class="edit-section-title">ìˆ˜ê°•ìƒ ë“±ê¸‰</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px" id="el-grade-grid">
          <label style="display:flex;align-items:center;gap:8px;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:12.5px">
            <input type="radio" name="el-grade" value="board"> ğŸ› ì´ì‚¬íšŒÂ·ì„ì›
          </label>
          <label style="display:flex;align-items:center;gap:8px;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:12.5px">
            <input type="radio" name="el-grade" value="aml"> ğŸ” AML ë‹´ë‹¹ì
          </label>
          <label style="display:flex;align-items:center;gap:8px;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:12.5px">
            <input type="radio" name="el-grade" value="general"> ğŸ‘¤ ì¼ë°˜
          </label>
          <label style="display:flex;align-items:center;gap:8px;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:12.5px">
            <input type="radio" name="el-grade" value="research"> ğŸ“ ì—°êµ¬íšŒ
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('modal-edit-learner')">ì·¨ì†Œ</button>
      <button class="btn btn-primary btn-sm" onclick="doEditLearner()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Assign Courses to Individual -->
<div class="modal-backdrop hidden assign-modal" id="modal-assign">
  <div class="modal-box">
    <div class="modal-header"><span class="modal-title">ğŸ“‹ ê°•ì˜ ë°°ì • â€” <span id="assign-name"></span></span><button class="modal-close" onclick="closeModal('modal-assign')">âœ•</button></div>
    <div class="modal-body">
      <div style="margin-bottom:12px">
        <div style="font-size:12px;color:var(--text-mid);margin-bottom:4px">ìˆ˜ê°•ìƒ ë“±ê¸‰: <strong id="assign-grade-lbl"></strong></div>
        <div style="font-size:12px;color:var(--text-mid)">ì²´í¬ëœ ê°•ì˜ê°€ ìˆ˜ê°•ìƒì—ê²Œ ë°°ì •ë©ë‹ˆë‹¤.</div>
      </div>
      <div class="course-check-list" id="assign-course-list"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('modal-assign')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="doAssign()">ë°°ì • ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Edit Course -->
<div class="modal-backdrop hidden" id="modal-edit-course">
  <div class="modal-box">
    <div class="modal-header"><span class="modal-title">âœï¸ ê°•ì˜ ìˆ˜ì •</span><button class="modal-close" onclick="closeModal('modal-edit-course')">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="ec-id">
      <div class="form-group"><label class="form-label">ê°•ì˜ëª…</label><input class="form-input" id="ec-title"></div>
      <div class="form-group"><label class="form-label">êµìœ¡ëª©ì </label><input class="form-input" id="ec-purpose"></div>
      <div class="form-group"><label class="form-label">êµìœ¡ ì‹œê°„(ì‹œê°„)</label><input class="form-input" type="number" id="ec-duration" min="1" max="20"></div>
      <div class="form-group"><label class="form-label">YouTube URL</label><input class="form-input" id="ec-yturl" placeholder="https://www.youtube.com/watch?v=..."></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('modal-edit-course')">ì·¨ì†Œ</button>
      <button class="btn btn-primary btn-sm" onclick="doEditCourse()">ìˆ˜ì • ì €ì¥</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script type="module">
import { DB } from './js/firebase-config.js';
import { requireAdmin, fmtDate, toYoutubeEmbed } from './js/utils.js';
import { showToast } from './js/utils.js';

requireAdmin();

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allLearners   = [];
let allCourses    = {};
let allCompletions= [];
let assignTargetId= '';
let resetTargetId = '';
let bulkGrades    = new Set();

const GRADE_LABEL = { board:'ì´ì‚¬íšŒÂ·ì„ì›', aml:'AML ë‹´ë‹¹ì', general:'ì¼ë°˜', research:'ì—°êµ¬íšŒ' };
const GRADE_ICON  = { board:'ğŸ›', aml:'ğŸ”', general:'ğŸ‘¤', research:'ğŸ“' };
const GRADE_CLS   = { board:'gp-board', aml:'gp-aml', general:'gp-general', research:'gp-research' };

function gradePill(g) {
  const lbl=GRADE_LABEL[g]||g, icon=GRADE_ICON[g]||'ğŸ‘¤', cls=GRADE_CLS[g]||'gp-general';
  return `<span class="gp ${cls}">${icon} ${lbl}</span>`;
}

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.go = function(el) {
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.querySelectorAll('.content-sec').forEach(s=>s.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('sec-'+el.dataset.sec).classList.add('active');
  const loaders = {
    overview:'loadOverview', pending:'loadPending', learners:'loadLearners',
    assign:'loadAssign', completions:'loadCompletions', courses:'loadCourses'
  };
  if (loaders[el.dataset.sec]) window[loaders[el.dataset.sec]]();
};

window.adminLogout = ()=>{ sessionStorage.removeItem('kasg_admin'); window.location.href='admin-login.html'; };
window.closeModal  = id=>document.getElementById(id).classList.add('hidden');

// â”€â”€ Data loaders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchAll() {
  const [ld,cd,cmp] = await Promise.all([DB.get('learners'), DB.get('courses'), DB.get('completions')]);
  allLearners    = ld  ? Object.entries(ld).map(([id,v])=>({...v,_id:id})) : [];
  allCourses     = cd  || {};
  allCompletions = cmp ? Object.values(cmp).sort((a,b)=>new Date(b.date)-new Date(a.date)) : [];
}

// â”€â”€ OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadOverview = async function() {
  await fetchAll();
  const approved  = allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected');
  const pending   = allLearners.filter(l=>l.status==='pending');
  const done      = approved.filter(l=>l.completedStatus==='completed'||l.status==='completed');
  const rate      = approved.length ? Math.round(done.length/approved.length*100) : 0;

  document.getElementById('ov-total').textContent   = approved.length;
  document.getElementById('ov-pending').textContent = pending.length;
  document.getElementById('ov-done').textContent    = done.length;
  document.getElementById('ov-rate').textContent    = rate+'%';
  document.getElementById('pending-cnt').textContent= pending.length;

  // Grade stats
  const gradeStats = document.getElementById('grade-stats');
  const grades = ['board','aml','general','research'];
  gradeStats.innerHTML = grades.map(g => {
    const members = approved.filter(l=>l.grade===g);
    const gDone   = members.filter(l=>l.completedStatus==='completed'||l.status==='completed').length;
    return `<div class="stat-card" style="border-left-color:var(--kasg-gold)">
      <div class="stat-value" style="font-size:26px">${members.length}</div>
      <div class="stat-label">${gradePill(g)}<br><span style="font-size:10px;color:var(--text-light)">ìˆ˜ë£Œ ${gDone}ëª…</span></div>
    </div>`;
  }).join('');

  // Recent completions
  document.getElementById('ov-recent').innerHTML = allCompletions.slice(0,6).map(c=>
    `<tr>
      <td><strong>${c.name}</strong></td>
      <td>${gradePill(c.grade||'general')}</td>
      <td>${c.org||'-'}</td>
      <td style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.courseTitle||'-'}</td>
      <td><span class="badge badge-success">${c.score}ì </span></td>
      <td style="font-size:10.5px;color:var(--text-light)">${fmtDate(new Date(c.date))}</td>
    </tr>`
  ).join('') || '<tr class="empty-row"><td colspan="6">ìˆ˜ë£Œì ì—†ìŒ</td></tr>';
};

// â”€â”€ PENDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadPending = async function() {
  await fetchAll();
  const pending = allLearners.filter(l=>l.status==='pending');
  document.getElementById('pending-cnt').textContent = pending.length;
  document.getElementById('pending-tbody').innerHTML = pending.length
    ? pending.map(l=>`<tr>
        <td><strong>${l.name}</strong></td>
        <td style="font-family:'DM Mono',monospace;font-size:10.5px;color:var(--text-mid)">${l._id}</td>
        <td>${l.org}${l.dept?'<br><span style="font-size:10px;color:var(--text-light)">'+l.dept+'</span>':''}</td>
        <td>${gradePill(l.grade||'general')}</td>
        <td>${l.phone||'-'}</td>
        <td style="font-size:10.5px;color:var(--text-light)">${fmtDate(new Date(l.createdAt||Date.now()))}</td>
        <td style="text-align:center">
          <div style="display:flex;gap:5px;justify-content:center">
            <button class="tbl-btn tb-approve" onclick="approveLearner('${l._id}','${l.name}')">âœ… ìŠ¹ì¸</button>
            <button class="tbl-btn tb-reject"  onclick="rejectLearner('${l._id}','${l.name}')">âŒ ê±°ì ˆ</button>
          </div>
        </td>
      </tr>`).join('')
    : '<tr class="empty-row"><td colspan="7">ìŠ¹ì¸ ëŒ€ê¸° ì—†ìŒ</td></tr>';
};

window.approveLearner = async function(id,name) {
  if (!confirm(`${name}ë‹˜ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  await DB.update(`learners/${id}`,{status:'approved',approved:true,approvedAt:new Date().toISOString()});
  showToast(`${name}ë‹˜ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`,'success');
  loadPending(); loadOverview();
};
window.rejectLearner = async function(id,name) {
  if (!confirm(`${name}ë‹˜ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  await DB.update(`learners/${id}`,{status:'rejected'});
  showToast(`ê±°ì ˆ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`,'warn');
  loadPending();
};

// â”€â”€ LEARNERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadLearners = async function() {
  await fetchAll();
  renderLearners(allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected'));
};

function renderLearners(list) {
  document.getElementById('learners-tbody').innerHTML = list.length
    ? list.map(l=>{
        const prog = Math.round((l.progress||0)*100);
        const score= l.finalScore!=null?l.finalScore+'ì ':'-';
        const st   = l.completedStatus||l.status||'approved';
        const bCls = st==='completed'?'badge-success':st==='in_progress'||st==='watched'?'badge-warn':'badge-neutral';
        const bLbl = st==='completed'?'ìˆ˜ë£Œ':st==='in_progress'||st==='watched'?'ìˆ˜ê°•ì¤‘':'ë¯¸ì‹œì‘';
        const assigned=(l.assignedCourses||[]).length;
        return `<tr>
          <td><strong>${l.name}</strong><br><span style="font-size:10px;color:var(--text-light);font-family:'DM Mono',monospace">${l._id}</span></td>
          <td>${gradePill(l.grade||'general')}</td>
          <td>${l.org||'-'}${l.dept?'<br><span style="font-size:10px;color:var(--text-light)">'+l.dept+'</span>':''}</td>
          <td><span class="badge badge-info">${assigned}ê°œ</span></td>
          <td><div style="display:flex;align-items:center;gap:7px">
            <div class="progress-wrap" style="height:4px;width:60px"><div class="progress-fill" style="width:${prog}%"></div></div>
            <span style="font-size:10.5px;color:var(--text-mid)">${prog}%</span>
          </div></td>
          <td>${score}</td>
          <td><span class="badge ${bCls}">${bLbl}</span></td>
          <td style="font-size:10px;color:var(--text-light)">${fmtDate(new Date(l.createdAt||Date.now()))}</td>
          <td>
            <div style="display:flex;gap:4px;flex-wrap:wrap;justify-content:center">
              <button class="tbl-btn tb-edit"   onclick="openEditLearner('${l._id}')">âœï¸ ì •ë³´</button>
              <button class="tbl-btn tb-assign" onclick="openAssign('${l._id}')">ğŸ“‹ ë°°ì •</button>
              <button class="tbl-btn tb-pw"     onclick="openResetPw('${l._id}','${l.name}')">ğŸ”‘ ë¹„ë²ˆ</button>
              <button class="tbl-btn tb-reset"  onclick="resetProgress('${l._id}','${l.name}')">ğŸ”„ ì´ˆê¸°í™”</button>
              <button class="tbl-btn tb-delete" onclick="deleteLearner('${l._id}','${l.name}')">ğŸ—‘</button>
            </div>
          </td>
        </tr>`;
      }).join('')
    : '<tr class="empty-row"><td colspan="9">ìˆ˜ê°•ìƒ ì—†ìŒ</td></tr>';
}

window.filterLearners = function() {
  const q  = document.getElementById('lf-search').value.toLowerCase();
  const gr = document.getElementById('lf-grade').value;
  const st = document.getElementById('lf-status').value;
  renderLearners(allLearners.filter(l=>{
    if (l.status==='pending'||l.status==='rejected') return false;
    if (gr && l.grade!==gr) return false;
    if (st) {
      const s=l.completedStatus||l.status||'approved';
      if (st==='completed'&&s!=='completed') return false;
      if (st==='in_progress'&&s!=='in_progress'&&s!=='watched') return false;
      if (st==='approved'&&s!=='approved') return false;
    }
    return !q || l.name?.toLowerCase().includes(q)||l.org?.toLowerCase().includes(q)||(l._id||'').toLowerCase().includes(q);
  }));
};

// â”€â”€ Edit Learner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openEditLearner = function(id) {
  const l = allLearners.find(x=>x._id===id); if(!l) return;
  document.getElementById('el-id').value    = id;
  document.getElementById('el-name').value  = l.name||'';
  document.getElementById('el-org').value   = l.org||'';
  document.getElementById('el-dept').value  = l.dept||'';
  document.getElementById('el-phone').value = l.phone||'';
  document.querySelectorAll('#el-grade-grid input[name="el-grade"]').forEach(r=>{ r.checked = r.value===(l.grade||'general'); });
  document.getElementById('modal-edit-learner').classList.remove('hidden');
};
window.doEditLearner = async function() {
  const id    = document.getElementById('el-id').value;
  const name  = document.getElementById('el-name').value.trim();
  const org   = document.getElementById('el-org').value.trim();
  const dept  = document.getElementById('el-dept').value.trim();
  const phone = document.getElementById('el-phone').value.trim();
  const grade = document.querySelector('#el-grade-grid input[name="el-grade"]:checked')?.value||'general';
  await DB.update(`learners/${id}`,{name,org,dept,phone,grade,gradeLabel:GRADE_LABEL[grade]});
  showToast('ìˆ˜ê°•ìƒ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.','success');
  closeModal('modal-edit-learner'); loadLearners();
};

// â”€â”€ Password Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openResetPw = function(id,name) {
  resetTargetId=id;
  document.getElementById('rp-name').textContent=name;
  document.getElementById('rp-new').value='kasg1234';
  document.getElementById('modal-reset-pw').classList.remove('hidden');
};
window.doResetPw = async function() {
  const pw=document.getElementById('rp-new').value.trim();
  if(!pw||pw.length<4){alert('4ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.');return;}
  await DB.update(`learners/${resetTargetId}`,{pw});
  showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.','success');
  closeModal('modal-reset-pw');
};

// â”€â”€ Reset Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.resetProgress = async function(id,name) {
  if(!confirm(`${name}ë‹˜ì˜ ìˆ˜ê°• ì§„ë„ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆê¹Œ?\n(ê³„ì •ì€ ìœ ì§€, ì§„ë„Â·ì ìˆ˜Â·ìˆ˜ë£Œ ê¸°ë¡ë§Œ ì‚­ì œ)`)) return;
  await DB.update(`learners/${id}`,{
    progress:0, midQuizCorrect:0, midQuizTotal:0,
    finalScore:null, finalPassed:null, attempt:0,
    completedStatus:null, certNo:null, certDate:null,
    courseProgress:null, courseStatus:null,
    midAnswered:null, courseCerts:null, generatedQuizzes:null
  });
  showToast(`${name}ë‹˜ì˜ ì§„ë„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`,'success');
  loadLearners();
};

// â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.deleteLearner = async function(id,name) {
  if(!confirm(`${name}ë‹˜ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
  await DB.remove(`learners/${id}`);
  showToast(`${name}ë‹˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`,'warn');
  loadLearners();
};

// â”€â”€ ASSIGN (individual) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openAssign = function(id) {
  assignTargetId = id;
  const l = allLearners.find(x=>x._id===id); if(!l) return;
  document.getElementById('assign-name').textContent    = l.name;
  document.getElementById('assign-grade-lbl').textContent= GRADE_LABEL[l.grade||'general']||'ì¼ë°˜';
  const courses = Object.entries(allCourses);
  const current = new Set(l.assignedCourses||[]);
  document.getElementById('assign-course-list').innerHTML = courses.length
    ? courses.map(([cid,c])=>`
        <div class="course-check-item ${current.has(cid)?'checked':''}" onclick="toggleCourseCheck(this,'${cid}')">
          <input type="checkbox" ${current.has(cid)?'checked':''} onclick="event.stopPropagation()">
          <div>
            <div class="cck-title">${c.title}</div>
            <div class="cck-meta">ğŸ• ${c.duration||'?'}ì‹œê°„ Â· ${c.purpose||'-'}</div>
          </div>
        </div>`).join('')
    : '<div style="text-align:center;padding:20px;color:var(--text-light)">ë“±ë¡ëœ ê°•ì˜ ì—†ìŒ</div>';
  document.getElementById('modal-assign').classList.remove('hidden');
};

window.toggleCourseCheck = function(el, cid) {
  el.classList.toggle('checked');
  el.querySelector('input[type=checkbox]').checked = el.classList.contains('checked');
};

window.doAssign = async function() {
  const checked = [...document.querySelectorAll('#assign-course-list .course-check-item.checked')].map(el=>{
    const m = el.getAttribute('onclick').match(/'([^']+)'(?:,'[^']+')?\)$/);
    return m?m[1]:null;
  }).filter(Boolean);
  await DB.update(`learners/${assignTargetId}`,{assignedCourses:checked});
  showToast('ê°•ì˜ ë°°ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.','success');
  closeModal('modal-assign'); loadLearners(); loadAssign();
};

// â”€â”€ ASSIGN section (table view) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadAssign = async function() {
  await fetchAll();
  buildBulkCourseChecks();
  renderAssign(allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected'));
};

function buildBulkCourseChecks() {
  const wrap = document.getElementById('bulk-course-checks');
  const courseArr = Object.entries(allCourses);
  wrap.innerHTML = courseArr.length
    ? courseArr.map(([id,c])=>
        `<label style="display:flex;align-items:center;gap:7px;font-size:12px;padding:4px 0;cursor:pointer">
          <input type="checkbox" data-cid="${id}" style="accent-color:var(--navy)"> ${c.title}
        </label>`
      ).join('')
    : '<span style="font-size:11.5px;color:var(--text-light)">ë“±ë¡ëœ ê°•ì˜ ì—†ìŒ</span>';
}

function renderAssign(list) {
  document.getElementById('assign-tbody').innerHTML = list.length
    ? list.map(l=>{
        const assigned = l.assignedCourses||[];
        const names = assigned.map(id=>allCourses[id]?.title||id).join(', ') || '-';
        return `<tr>
          <td><strong>${l.name}</strong></td>
          <td>${gradePill(l.grade||'general')}</td>
          <td>${l.org||'-'}</td>
          <td style="max-width:250px;font-size:11.5px;color:var(--text-mid)">${names}</td>
          <td style="text-align:center">
            <button class="tbl-btn tb-assign" onclick="openAssign('${l._id}')">ğŸ“‹ ë°°ì • ìˆ˜ì •</button>
          </td>
        </tr>`;
      }).join('')
    : '<tr class="empty-row"><td colspan="5">ìˆ˜ê°•ìƒ ì—†ìŒ</td></tr>';
}

window.filterAssign = function() {
  const q  = document.getElementById('af-search').value.toLowerCase();
  const gr = document.getElementById('af-grade').value;
  renderAssign(allLearners.filter(l=>{
    if(l.status==='pending'||l.status==='rejected') return false;
    if(gr&&l.grade!==gr) return false;
    return !q||l.name?.toLowerCase().includes(q)||l.org?.toLowerCase().includes(q);
  }));
};

// â”€â”€ Bulk Assign â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.toggleBulkGrade = function(btn) {
  const g = btn.dataset.grade;
  btn.classList.toggle('active');
  if (btn.classList.contains('active')) bulkGrades.add(g);
  else bulkGrades.delete(g);
};

window.previewBulk = function() {
  const targets = allLearners.filter(l=>
    l.status!=='pending'&&l.status!=='rejected' && bulkGrades.has(l.grade||'general')
  );
  const courses = [...document.querySelectorAll('#bulk-course-checks input:checked')].map(el=>el.dataset.cid);
  const wrap = document.getElementById('bulk-preview');
  wrap.style.display='';
  if (!bulkGrades.size) { wrap.innerHTML='<div class="alert alert-warn">ë“±ê¸‰ì„ ì„ íƒí•˜ì„¸ìš”.</div>'; return; }
  if (!courses.length)  { wrap.innerHTML='<div class="alert alert-warn">ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>'; return; }
  wrap.innerHTML=`<div class="alert alert-info" style="font-size:12px">
    <strong>${[...bulkGrades].map(g=>GRADE_LABEL[g]).join(', ')}</strong> ë“±ê¸‰ì˜
    <strong>${targets.length}ëª…</strong>ì—ê²Œ
    <strong>${courses.length}ê°œ</strong> ê°•ì˜ê°€ ì¶”ê°€ ë°°ì •ë©ë‹ˆë‹¤.<br>
    ëŒ€ìƒ: ${targets.map(l=>l.name).join(', ')||'ì—†ìŒ'}
  </div>`;
};

window.doBulkAssign = async function() {
  const targets = allLearners.filter(l=>
    l.status!=='pending'&&l.status!=='rejected' && bulkGrades.has(l.grade||'general')
  );
  const newCourses = [...document.querySelectorAll('#bulk-course-checks input:checked')].map(el=>el.dataset.cid);
  if (!targets.length){ showToast('ëŒ€ìƒ ìˆ˜ê°•ìƒ ì—†ìŒ','warn'); return; }
  if (!newCourses.length){ showToast('ë°°ì •í•  ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”','warn'); return; }
  if (!confirm(`${targets.length}ëª…ì—ê²Œ ${newCourses.length}ê°œ ê°•ì˜ë¥¼ ë°°ì •í•©ë‹ˆê¹Œ?`)) return;
  await Promise.all(targets.map(l=>{
    const merged = [...new Set([...(l.assignedCourses||[]), ...newCourses])];
    return DB.update(`learners/${l._id}`,{assignedCourses:merged});
  }));
  showToast(`${targets.length}ëª…ì—ê²Œ ê°•ì˜ê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`,'success');
  await fetchAll(); renderAssign(allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected'));
  document.getElementById('bulk-preview').style.display='none';
};

// â”€â”€ COMPLETIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadCompletions = async function() {
  await fetchAll();
  renderCompletions(allCompletions);
};
function renderCompletions(list) {
  document.getElementById('completions-tbody').innerHTML = list.length
    ? list.map(c=>`<tr>
        <td style="font-family:'DM Mono',monospace;font-size:10.5px">ì œ ${c.certNo}í˜¸</td>
        <td><strong>${c.name}</strong></td>
        <td>${gradePill(c.grade||'general')}</td>
        <td>${c.org||'-'}</td>
        <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.courseTitle||'-'}</td>
        <td><span class="badge badge-success">${c.score}ì </span></td>
        <td style="font-size:10.5px;color:var(--text-light)">${fmtDate(new Date(c.date))}</td>
      </tr>`).join('')
    : '<tr class="empty-row"><td colspan="7">ìˆ˜ë£Œì ì—†ìŒ</td></tr>';
}
window.filterCompletions = function() {
  const q = document.getElementById('cf-search').value.toLowerCase();
  renderCompletions(allCompletions.filter(c=>
    c.name?.toLowerCase().includes(q)||(c.certNo||'').toLowerCase().includes(q)
  ));
};

// â”€â”€ COURSES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadCourses = async function() {
  await fetchAll();
  const grid = document.getElementById('course-grid');
  const arr  = Object.entries(allCourses);
  if (!arr.length) {
    grid.innerHTML='<div class="card" style="padding:40px;text-align:center;grid-column:1/-1"><div style="font-size:36px;margin-bottom:10px">ğŸ“‚</div><div style="color:var(--text-mid)">ë“±ë¡ëœ ê°•ì˜ ì—†ìŒ</div></div>';
    return;
  }
  grid.innerHTML = arr.map(([id,c])=>`
    <div class="cc">
      <div class="cc-hd">
        <div class="cc-title">${c.title}</div>
        <div class="cc-meta">â± ${c.duration||'?'}ì‹œê°„ Â· ë“±ë¡: ${fmtDate(new Date(c.createdAt||Date.now()))}</div>
        <div class="cc-meta" style="margin-top:2px">ğŸ¯ ${c.purpose||'-'}</div>
        ${c.videoURL?`<div class="cc-url" onclick="window.open('${c.videoURL}','_blank')">â–¶ YouTube ì˜ìƒ ì—´ê¸°</div>`:'<div class="cc-meta" style="color:var(--error);margin-top:3px">âš ï¸ ì˜ìƒ ë¯¸ë“±ë¡</div>'}
      </div>
      <div class="cc-ft">
        <span class="badge ${c.locked?'badge-error':'badge-success'}">${c.locked?'ğŸ”’ ì ê¹€':'âœ… ê³µê°œ'}</span>
        <button class="tbl-btn ${c.locked?'tb-approve':'tb-reject'}" onclick="toggleLock('${id}',${!c.locked})">${c.locked?'ğŸ”“ ê³µê°œ':'ğŸ”’ ì ê¸ˆ'}</button>
        <button class="tbl-btn tb-edit" onclick="openEditCourse('${id}')">âœï¸ ìˆ˜ì •</button>
        <button class="tbl-btn tb-delete" onclick="deleteCourse('${id}','${c.title}')">ğŸ—‘</button>
      </div>
    </div>`).join('');
};
window.toggleLock = async function(id,lock) {
  await DB.update(`courses/${id}`,{locked:lock});
  showToast(lock?'ê°•ì˜ê°€ ì ê²¼ìŠµë‹ˆë‹¤.':'ê°•ì˜ê°€ ê³µê°œë˜ì—ˆìŠµë‹ˆë‹¤.','success');
  loadCourses();
};
window.deleteCourse = async function(id,title) {
  if(!confirm(`"${title}" ê°•ì˜ë¥¼ ì‚­ì œí•©ë‹ˆê¹Œ?`)) return;
  await DB.remove(`courses/${id}`);
  showToast('ê°•ì˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.','warn'); loadCourses();
};
window.openEditCourse = function(id) {
  const c=allCourses[id]; if(!c) return;
  document.getElementById('ec-id').value      = id;
  document.getElementById('ec-title').value   = c.title||'';
  document.getElementById('ec-purpose').value = c.purpose||'';
  document.getElementById('ec-duration').value= c.duration||2;
  document.getElementById('ec-yturl').value   = c.videoURL||'';
  document.getElementById('modal-edit-course').classList.remove('hidden');
};
window.doEditCourse = async function() {
  const id   = document.getElementById('ec-id').value;
  const title= document.getElementById('ec-title').value.trim();
  const pur  = document.getElementById('ec-purpose').value.trim();
  const dur  = document.getElementById('ec-duration').value;
  const yt   = document.getElementById('ec-yturl').value.trim();
  if(!title){alert('ê°•ì˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
  const embed= toYoutubeEmbed(yt)||yt;
  await DB.update(`courses/${id}`,{title,purpose:pur,duration:Number(dur),videoURL:embed});
  showToast('ê°•ì˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.','success');
  closeModal('modal-edit-course'); loadCourses();
};

// â”€â”€ ADD COURSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.previewYT = function() {
  const url=document.getElementById('cf-yturl').value.trim();
  const embed=toYoutubeEmbed(url);
  const pv=document.getElementById('yt-preview'), fr=document.getElementById('yt-preview-frame');
  if(embed){fr.src=embed;pv.classList.add('show');}
  else{pv.classList.remove('show');fr.src='';}
};
window.saveCourse = async function() {
  const title  = document.getElementById('cf-title').value.trim();
  const dur    = document.getElementById('cf-duration').value;
  const purpose= document.getElementById('cf-purpose').value.trim();
  const yturl  = document.getElementById('cf-yturl').value.trim();
  if(!title){ alert('ê°•ì˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  if(!purpose){alert('êµìœ¡ëª©ì ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
  if(!yturl){ alert('YouTube URLì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const embed=toYoutubeEmbed(yturl);
  if(!embed){alert('ì˜¬ë°”ë¥¸ YouTube URLì´ ì•„ë‹™ë‹ˆë‹¤.\nì˜ˆ: https://www.youtube.com/watch?v=XXXXXXXXXXX');return;}
  const id='course_'+Date.now();
  await DB.set(`courses/${id}`,{title,purpose,duration:Number(dur),videoURL:embed,locked:false,createdAt:new Date().toISOString()});
  document.getElementById('add-course-msg').innerHTML='<div class="alert alert-success">âœ… ê°•ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
  showToast('ê°•ì˜ ë“±ë¡ ì™„ë£Œ!','success');
  clearCF();
  setTimeout(()=>{ go(document.querySelector('[data-sec="courses"]')); },1400);
};
window.clearCF=function(){
  ['cf-title','cf-purpose','cf-yturl'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('cf-duration').value='2';
  document.getElementById('yt-preview').classList.remove('show');
  document.getElementById('yt-preview-frame').src='';
  document.getElementById('add-course-msg').innerHTML='';
};

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.changeAdminPw = async function() {
  const np=document.getElementById('new-pw').value,cp=document.getElementById('confirm-pw').value;
  if(!np||np.length<8){alert('8ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.');return;}
  if(np!==cp){alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');return;}
  await DB.set('admin/password',np);
  showToast('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.','success');
  document.getElementById('new-pw').value=''; document.getElementById('confirm-pw').value='';
};
window.saveSettings = async function() {
  await DB.set('settings',{passScore:Number(document.getElementById('pass-score').value),maxAttempts:Number(document.getElementById('max-attempts').value)});
  showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.','success');
};

// â”€â”€ CSV exports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function csvDl(filename,rows) {
  const bom='\uFEFF',csv=bom+rows.map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));a.download=filename;a.click();
}
window.exportLearners = function() {
  const list=allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected');
  const rows=[['ì„±ëª…','ì•„ì´ë””','ì†Œì†','ë¶€ì„œ','ë“±ê¸‰','ë°°ì •ê°•ì˜ìˆ˜','ì§„ë„(%)','ì ìˆ˜','ìƒíƒœ','ë“±ë¡ì¼']];
  list.forEach(l=>{
    const st=l.completedStatus||l.status||'-';
    rows.push([l.name,l._id,l.org||'',l.dept||'',GRADE_LABEL[l.grade||'general']||'-',
      (l.assignedCourses||[]).length, Math.round((l.progress||0)*100)+'%',
      l.finalScore!=null?l.finalScore+'ì ':'-',
      st==='completed'?'ìˆ˜ë£Œ':st==='in_progress'||st==='watched'?'ìˆ˜ê°•ì¤‘':'ë¯¸ì‹œì‘',
      fmtDate(new Date(l.createdAt||Date.now()))]);
  });
  csvDl('learners.csv',rows);
};
window.exportCompletions = function() {
  const rows=[['ë°œê¸‰ë²ˆí˜¸','ì„±ëª…','ë“±ê¸‰','ì†Œì†','ê°•ì˜ëª…','ì ìˆ˜','ìˆ˜ë£Œì¼']];
  allCompletions.forEach(c=>rows.push([`ì œ ${c.certNo}í˜¸`,c.name,GRADE_LABEL[c.grade||'general']||'-',c.org||'',c.courseTitle||'',c.score+'ì ',fmtDate(new Date(c.date))]));
  csvDl('completions.csv',rows);
};

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadOverview();
</script>
</body>
</html>
