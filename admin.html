<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ â€” KASG LMS</title>
<link rel="stylesheet" href="css/main.css">
<!-- SheetJS for Excel parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body{background:#ECEAE4;min-height:100vh}
.admin-layout{display:grid;grid-template-columns:220px 1fr;min-height:calc(100vh - 66px)}

/* Nav */
.admin-nav{background:var(--navy);position:sticky;top:66px;height:calc(100vh - 66px);overflow-y:auto;display:flex;flex-direction:column;flex-shrink:0}
.nav-sec{padding:14px 14px 5px;font-size:9px;font-weight:600;color:rgba(255,255,255,.28);letter-spacing:1.5px;text-transform:uppercase}
.nav-item{display:flex;align-items:center;gap:9px;padding:10px 14px;color:rgba(255,255,255,.6);font-size:12.5px;cursor:pointer;border-left:3px solid transparent;transition:all .14s}
.nav-item:hover{background:rgba(255,255,255,.06);color:#fff}
.nav-item.active{background:rgba(255,255,255,.09);color:#fff;border-left-color:var(--kasg-gold)}
.nav-icon{width:16px;text-align:center;font-size:13px;flex-shrink:0}
.nav-divider{height:1px;background:rgba(255,255,255,.07);margin:4px 0}
.nav-badge{min-width:17px;height:17px;border-radius:9px;background:var(--kasg-red);color:#fff;font-size:9.5px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;padding:0 4px;margin-left:auto}
.nav-bottom{margin-top:auto;border-top:1px solid rgba(255,255,255,.07);padding:8px 0}

/* Content */
.admin-content{padding:22px;min-width:0;overflow-x:hidden}
.content-sec{display:none}
.content-sec.active{display:block}

/* Stats grid */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px}
@media(max-width:1200px){.stats-grid{grid-template-columns:repeat(2,1fr)}}

/* Tables */
.tbl-toolbar{display:flex;align-items:center;gap:8px;margin-bottom:11px;flex-wrap:wrap}
.filter-input{padding:7px 11px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:12.5px;color:var(--text);background:#fff;width:200px;outline:none}
.filter-input:focus{border-color:var(--navy)}
.filter-select{padding:7px 26px 7px 10px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:12.5px;background:#fff;outline:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%235A6070' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 7px center;cursor:pointer}
.ml-auto{margin-left:auto}
.tbl-wrap{background:#fff;border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-sm)}

/* Action btns */
.tbl-btn{padding:4px 9px;border-radius:3px;font-size:10.5px;font-weight:600;cursor:pointer;border:none;white-space:nowrap;transition:all .12s}
.tb-approve{background:#D1FAE5;color:var(--success)}.tb-approve:hover{background:var(--success);color:#fff}
.tb-reject {background:#FEE2E2;color:var(--error)}.tb-reject:hover{background:var(--error);color:#fff}
.tb-reset  {background:#FEF3C7;color:#7A4F00}.tb-reset:hover{background:#D97706;color:#fff}
.tb-delete {background:#F1F0EC;color:var(--error)}.tb-delete:hover{background:var(--error);color:#fff}
.tb-pw     {background:#DBEAFE;color:#1E40AF}.tb-pw:hover{background:#1E40AF;color:#fff}
.tb-assign {background:#EDE9FF;color:#5B21B6}.tb-assign:hover{background:#5B21B6;color:#fff}
.tb-edit   {background:#F0FFF4;color:var(--success)}.tb-edit:hover{background:var(--success);color:#fff}
.tb-grade  {background:#FFF3DC;color:#8B4A00}.tb-grade:hover{background:#D97706;color:#fff}

/* Course cards */
.course-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(255px,1fr));gap:12px}
.cc{background:#fff;border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-sm);border-left:4px solid var(--kasg-gold)}
.cc-hd{padding:13px 15px}
.cc-title{font-family:'Noto Serif KR',serif;font-size:13px;font-weight:700;color:var(--navy);margin-bottom:3px}
.cc-meta{font-size:10.5px;color:var(--text-mid);line-height:1.5}
.cc-url{font-size:10px;color:var(--kasg-blue);word-break:break-all;margin-top:3px;text-decoration:underline;cursor:pointer}
.cc-ft{padding:9px 12px;background:var(--cream);border-top:1px solid var(--border);display:flex;gap:5px;flex-wrap:wrap;align-items:center}

/* YT preview */
.yt-preview{margin-top:8px;border-radius:var(--radius);overflow:hidden;background:#000;aspect-ratio:16/9;display:none}
.yt-preview.show{display:block}
.yt-preview iframe{width:100%;height:100%;border:none}

/* Settings */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:900px){.settings-grid{grid-template-columns:1fr}}
.sbox{background:#fff;border-radius:var(--radius-lg);padding:17px 19px;box-shadow:var(--shadow-sm)}
.sbox-t{font-size:13px;font-weight:700;color:var(--navy);margin-bottom:11px}

/* Grade pill */
.gp{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:9px;font-size:10.5px;font-weight:600;white-space:nowrap}
.gp-board   {background:rgba(200,150,10,.12);color:#8B6800;border:1px solid rgba(200,150,10,.25)}
.gp-aml     {background:rgba(26,62,160,.1);color:#1A3EA0;border:1px solid rgba(26,62,160,.2)}
.gp-general {background:#F1F0EC;color:#5A6070;border:1px solid var(--border)}
.gp-research{background:rgba(200,48,42,.08);color:#8B1818;border:1px solid rgba(200,48,42,.15)}

/* Excel upload */
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius-lg);padding:32px;text-align:center;cursor:pointer;transition:all .18s;background:#FAFAF8;position:relative}
.upload-zone:hover,.upload-zone.drag{border-color:var(--navy);background:rgba(12,31,63,.04)}
.upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-icon{font-size:36px;margin-bottom:10px}
.upload-title{font-size:14px;font-weight:600;color:var(--navy);margin-bottom:4px}
.upload-sub{font-size:12px;color:var(--text-mid)}
.excel-preview{margin-top:16px}
.ep-table-wrap{overflow-x:auto;max-height:320px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius);background:#fff}
.ep-table{width:100%;border-collapse:collapse;font-size:12px}
.ep-table th{padding:7px 10px;background:var(--navy);color:rgba(255,255,255,.8);font-weight:600;font-size:11px;white-space:nowrap;text-align:left;position:sticky;top:0}
.ep-table td{padding:7px 10px;border-bottom:1px solid rgba(0,0,0,.05)}
.ep-table tr.err td{background:#FEE2E2}
.ep-table tr.ok td{background:#F0FFF4}
.ep-status{display:inline-flex;align-items:center;gap:4px;font-size:10.5px;font-weight:600;padding:2px 7px;border-radius:8px}
.ep-status.new{background:#D1FAE5;color:var(--success)}
.ep-status.dup{background:#FEE2E2;color:var(--error)}
.ep-status.upd{background:#FEF3C7;color:#7A4F00}
.tmpl-guide{background:var(--cream);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;margin-top:12px}
.tmpl-guide-t{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:7px}
.tmpl-cols{display:flex;flex-wrap:wrap;gap:6px}
.tmpl-col{padding:3px 9px;background:#fff;border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text-mid)}
.tmpl-col strong{color:var(--navy)}

/* Assign modal */
.assign-modal .modal-box{width:620px;max-width:95vw}
.course-check-list{display:flex;flex-direction:column;gap:6px;max-height:320px;overflow-y:auto;padding:2px}
.course-check-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .12s}
.course-check-item:hover{border-color:var(--navy);background:rgba(12,31,63,.02)}
.course-check-item.checked{border-color:var(--navy);background:rgba(12,31,63,.04)}
.course-check-item input[type="checkbox"]{width:14px;height:14px;accent-color:var(--navy);cursor:pointer;flex-shrink:0}
.cck-title{font-size:12.5px;font-weight:600;color:var(--navy)}
.cck-meta{font-size:10.5px;color:var(--text-mid)}

/* Assign with deadline */
.assign-course-row{border:1.5px solid var(--border);border-radius:var(--radius);margin-bottom:7px;overflow:hidden;transition:border-color .12s}
.assign-course-row.checked{border-color:var(--navy)}
.acr-top{display:flex;align-items:center;gap:10px;padding:9px 12px;cursor:pointer;background:#fff;transition:background .12s}
.acr-top:hover{background:rgba(12,31,63,.02)}
.assign-course-row.checked .acr-top{background:rgba(12,31,63,.03)}
.acr-deadline{padding:8px 12px;border-top:1px dashed var(--border);background:#F8F7F4;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.dl-label{font-size:11.5px;color:var(--navy);font-weight:600;flex-shrink:0}
.dl-input{padding:5px 9px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:12.5px;color:var(--navy);cursor:pointer}
.dl-input:focus{border-color:var(--navy);outline:none}
.dl-clear{background:none;border:none;cursor:pointer;color:var(--text-light);font-size:11px;padding:2px 6px;border-radius:3px}
.dl-clear:hover{color:var(--error);background:#FEE2E2}
.dl-badge{font-size:10px;padding:2px 7px;border-radius:8px;font-weight:600}
.dl-badge.urgent{background:#FEE2E2;color:var(--error)}
.dl-badge.soon{background:#FEF3C7;color:#7A4F00}
.dl-badge.ok{background:#D1FAE5;color:var(--success)}

/* Email / notification */
.email-notif-panel{background:#F8F7F4;border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px 16px}
.enp-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:11px}
.enp-title{font-size:13px;font-weight:700;color:var(--navy);display:flex;align-items:center;gap:7px}
.enp-desc{font-size:11.5px;color:var(--text-mid);margin-bottom:12px;line-height:1.6}
.notif-row{display:flex;align-items:center;justify-content:space-between;padding:8px 11px;background:#fff;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:6px}
.notif-row:last-child{margin-bottom:0}
.notif-label{font-size:12.5px;color:var(--text);display:flex;align-items:center;gap:7px}
.notif-cnt{font-size:11px;color:var(--text-light)}
.notif-actions{display:flex;gap:6px;align-items:center}
.btn-send-now{padding:4px 11px;border:1.5px solid var(--kasg-blue);border-radius:var(--radius);font-size:11.5px;font-weight:600;color:var(--kasg-blue);background:rgba(26,62,160,.04);cursor:pointer;transition:all .13s}
.btn-send-now:hover{background:var(--kasg-blue);color:#fff}
.btn-send-now:disabled{opacity:.4;cursor:not-allowed}
.toggle-switch{position:relative;width:38px;height:21px;flex-shrink:0}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:#DDD;border-radius:21px;cursor:pointer;transition:.2s}
.toggle-slider:before{content:'';position:absolute;height:15px;width:15px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.2s}
.toggle-switch input:checked+.toggle-slider{background:var(--success)}
.toggle-switch input:checked+.toggle-slider:before{transform:translateX(17px)}

/* Bulk assign */
.agb-btn{padding:5px 12px;border-radius:12px;font-size:11.5px;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:#fff;color:var(--text-mid);transition:all .12s}
.agb-btn:hover{border-color:var(--navy);color:var(--navy)}
.agb-btn.active{background:var(--navy);color:#fff;border-color:var(--navy)}

/* Stats link card */
.stats-cta{background:linear-gradient(135deg,var(--navy),#1A3EA0);border-radius:var(--radius-lg);padding:18px 22px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:transform .18s;margin-bottom:16px}
.stats-cta:hover{transform:translateY(-2px)}
.stats-cta-left .t{font-family:'Noto Serif KR',serif;font-size:15px;font-weight:700;color:#fff}
.stats-cta-left .s{font-size:12px;color:rgba(255,255,255,.5);margin-top:2px}
.stats-cta-arr{font-size:22px;color:var(--kasg-gold)}

/* â”€â”€ Role & Permission UI â”€â”€ */
.role-badge-super{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:10px;font-size:10px;font-weight:700;background:rgba(200,48,42,.12);color:var(--kasg-red);border:1px solid rgba(200,48,42,.2)}
.role-badge-org{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:10px;font-size:10px;font-weight:700;background:rgba(26,62,160,.12);color:#1A3EA0;border:1px solid rgba(26,62,160,.2)}
.org-banner{background:linear-gradient(90deg,rgba(26,62,160,.08),rgba(26,62,160,.03));border:1px solid rgba(26,62,160,.18);border-radius:var(--radius);padding:11px 16px;display:flex;align-items:center;gap:12px;margin-bottom:16px}
.org-banner .ob-icon{font-size:22px}
.org-banner .ob-body strong{display:block;font-size:13px;color:var(--navy)}
.org-banner .ob-body span{font-size:11.5px;color:var(--text-mid)}
/* nav: ê¶Œí•œ ì—†ëŠ” í•­ëª© ì ê¸ˆ */
.nav-item.nav-locked{opacity:.3;cursor:not-allowed !important;pointer-events:none}
/* íšŒì‚¬ë³„ ê´€ë¦¬ì ê´€ë¦¬ */
.perm-checks{display:flex;flex-wrap:wrap;gap:7px}
.perm-check-label{display:flex;align-items:flex-start;gap:7px;padding:8px 12px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .13s;background:#fff;min-width:160px}
.perm-check-label:hover{border-color:var(--navy)}
.perm-check-label.active{border-color:var(--navy);background:rgba(12,31,63,.05)}
.perm-check-label input{margin-top:1px;width:14px;height:14px;accent-color:var(--navy);flex-shrink:0;cursor:pointer}
.perm-check-title{font-size:12px;font-weight:600;color:var(--navy);display:block}
.perm-check-desc{font-size:10.5px;color:var(--text-light);display:block;margin-top:1px}
.perm-pill{display:inline-flex;align-items:center;padding:1px 7px;border-radius:8px;font-size:10px;font-weight:600;background:rgba(26,62,160,.1);color:#1A3EA0;margin:1px 2px 1px 0}
.oa-status-on{color:var(--success);font-weight:600;font-size:11.5px}
.oa-status-off{color:var(--text-light);font-size:11.5px}


.quiz-section{margin-top:18px}
.quiz-section-hd{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;background:var(--navy);border-radius:var(--radius-lg) var(--radius-lg) 0 0;border-bottom:3px solid var(--kasg-gold)}
.quiz-section-title{font-family:'Noto Serif KR',serif;font-size:13px;font-weight:700;color:#fff;display:flex;align-items:center;gap:7px}
.quiz-section-badge{font-size:10px;background:var(--kasg-gold);color:var(--navy);padding:2px 8px;border-radius:8px;font-weight:700}
.quiz-section-body{background:#fff;border-radius:0 0 var(--radius-lg) var(--radius-lg);border:1px solid var(--border);border-top:none;padding:16px}
.mid-quiz-card{background:#F8F7F4;border:1.5px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:10px}
.mid-quiz-card:last-child{margin-bottom:0}
.mqc-hd{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.mqc-num{width:26px;height:26px;border-radius:50%;background:var(--navy);color:var(--kasg-gold);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0}
.mqc-label{font-size:12px;font-weight:700;color:var(--navy)}
.mqc-timing{font-size:10.5px;color:var(--text-light);margin-left:auto;background:rgba(12,31,63,.07);padding:2px 9px;border-radius:8px}
.mqc-q-input{width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:12.5px;resize:vertical;min-height:64px;font-family:inherit;line-height:1.5;margin-bottom:10px;box-sizing:border-box}
.mqc-q-input:focus{border-color:var(--navy);outline:none}
.opts-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
.opt-row{display:flex;align-items:center;gap:6px}
.opt-radio{width:15px;height:15px;accent-color:var(--success);cursor:pointer;flex-shrink:0}
.opt-input{flex:1;padding:7px 10px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:12px;font-family:inherit;box-sizing:border-box}
.opt-input:focus{border-color:var(--navy);outline:none}
.opt-row.is-answer .opt-input{border-color:var(--success);background:#F0FFF4}
.mqc-expl-input{width:100%;padding:7px 10px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:12px;font-family:inherit;box-sizing:border-box}
.mqc-expl-input:focus{border-color:var(--navy);outline:none}
.mqc-status{display:inline-flex;align-items:center;gap:4px;font-size:10px;padding:2px 8px;border-radius:8px;margin-top:8px}
.mqc-status.filled{background:#D1FAE5;color:var(--success)}
.mqc-status.empty{background:#FEE2E2;color:var(--error)}
.qbank-controls{display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.qbank-count strong{color:var(--navy);font-size:14px}
.qbank-count{font-size:12px;color:var(--text-mid)}
.q-card{background:#F8F7F4;border:1.5px solid var(--border);border-radius:var(--radius);margin-bottom:8px;overflow:hidden}
.q-card:last-child{margin-bottom:0}
.q-card-hd{display:flex;align-items:center;gap:8px;padding:9px 12px;cursor:pointer;user-select:none;background:#F8F7F4;transition:background .12s}
.q-card-hd:hover{background:#EEECEA}
.q-card-num{width:22px;height:22px;border-radius:50%;background:var(--kasg-blue);color:#fff;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0}
.q-card-q{flex:1;font-size:12.5px;color:var(--navy);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.q-card-chevron{font-size:10px;color:var(--text-light);transition:transform .2s;flex-shrink:0}
.q-card-chevron.open{transform:rotate(180deg)}
.q-card-body{padding:12px 14px;border-top:1px solid var(--border);background:#fff;display:none}
.q-card-body.open{display:block}
.q-del-btn{background:none;border:none;cursor:pointer;color:var(--text-light);font-size:13px;padding:2px 5px;border-radius:3px;flex-shrink:0}
.q-del-btn:hover{color:var(--error);background:#FEE2E2}
.exam-settings-bar{display:flex;align-items:center;gap:14px;padding:12px 14px;background:linear-gradient(90deg,rgba(12,31,63,.05),rgba(200,150,10,.06));border-radius:var(--radius);border:1px solid var(--border);margin-bottom:14px;flex-wrap:wrap}
.esb-item{display:flex;align-items:center;gap:7px;font-size:12.5px;color:var(--text-mid)}
.esb-input{width:64px;padding:5px 8px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:13px;font-weight:600;text-align:center;color:var(--navy)}
.esb-input:focus{border-color:var(--navy);outline:none}
.esb-warn{font-size:11px;color:var(--kasg-red);margin-left:4px}
.import-bank-btn{display:flex;align-items:center;gap:5px;padding:6px 13px;border:1.5px dashed var(--kasg-blue);border-radius:var(--radius);font-size:12px;color:var(--kasg-blue);cursor:pointer;background:rgba(26,62,160,.04);transition:all .15s}
.import-bank-btn:hover{background:rgba(26,62,160,.1)}
.quiz-modal .modal-box{width:min(900px,96vw);max-height:92vh;display:flex;flex-direction:column}
.quiz-modal .modal-body{overflow-y:auto;flex:1}

/* Q add tabs */
.q-add-tab{padding:5px 14px;font-size:12px;font-weight:600;cursor:pointer;border:none;background:#fff;color:var(--text-mid);transition:all .13s}
.q-add-tab.active{background:var(--navy);color:#fff}
.q-add-tab:first-child{border-right:1px solid var(--border)}

/* Q excel upload */
.q-upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:22px;text-align:center;cursor:pointer;transition:all .16s;background:#FAFAF8;position:relative}
.q-upload-zone:hover{border-color:var(--navy);background:rgba(12,31,63,.04)}
.q-upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.q-excel-tmpl-guide{background:rgba(26,62,160,.05);border:1px solid rgba(26,62,160,.15);border-radius:var(--radius);padding:8px 12px}
.q-col-chip{padding:2px 8px;background:#fff;border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text-mid)}

/* Q excel preview table */
.qp-wrap{margin-top:10px;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;max-height:260px;overflow-y:auto}
.qp-table{width:100%;border-collapse:collapse;font-size:11.5px}
.qp-table th{padding:6px 10px;background:var(--navy);color:rgba(255,255,255,.8);font-size:10.5px;font-weight:600;text-align:left;white-space:nowrap;position:sticky;top:0;z-index:1}
.qp-table td{padding:6px 10px;border-bottom:1px solid rgba(0,0,0,.05);vertical-align:top}
.qp-table tr.qp-ok td{background:#F0FFF4}
.qp-table tr.qp-err td{background:#FEE2E2}
.qp-status{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:600;padding:1px 6px;border-radius:6px}
.qp-status.ok{background:#D1FAE5;color:var(--success)}
.qp-status.err{background:#FEE2E2;color:var(--error)}
.qp-q-text{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500;color:var(--navy)}
.qp-actions{display:flex;align-items:center;gap:7px;margin-top:9px;flex-wrap:wrap}
.qp-summary{font-size:12.5px;font-weight:600;color:var(--navy)}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-brand">
    <img class="header-logo-img" src="assets/logo-wide.png" alt="KASG">
    <span id="hd-role-badge" style="margin-left:8px"></span>
    <span id="hd-user-name" style="font-size:11px;color:rgba(255,255,255,.55);margin-left:6px"></span>
  </div>
  <div class="header-nav">
    <button class="header-btn" id="hd-btn-stats" onclick="openStats()">ğŸ“Š í†µê³„ í˜„í™©</button>
    <button class="header-btn" id="hd-btn-learner" onclick="window.open('index.html','_blank')">ìˆ˜ê°•ìƒ í™”ë©´</button>
    <button class="header-btn" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<div class="admin-layout">
  <nav class="admin-nav">
    <div class="nav-sec">ëŒ€ì‹œë³´ë“œ</div>
    <div class="nav-item active" data-sec="overview" data-perm="overview" onclick="go(this)"><span class="nav-icon">ğŸ“Š</span>ì „ì²´ í˜„í™©</div>
    <div class="nav-divider"></div>
    <div class="nav-sec">ìˆ˜ê°•ìƒ ê´€ë¦¬</div>
    <div class="nav-item" data-sec="pending"       data-perm="pending"       onclick="go(this)"><span class="nav-icon">â³</span>ê°€ì… ìŠ¹ì¸<span class="nav-badge" id="pending-cnt">0</span></div>
    <div class="nav-item" data-sec="learners"      data-perm="learners"      onclick="go(this)"><span class="nav-icon">ğŸ‘¥</span>ìˆ˜ê°•ìƒ ëª©ë¡</div>
    <div class="nav-item" data-sec="bulk-register" data-super-only onclick="go(this)"><span class="nav-icon">ğŸ“¤</span>ëŒ€ëŸ‰ ë“±ë¡</div>
    <div class="nav-item" data-sec="assign"        data-super-only onclick="go(this)"><span class="nav-icon">ğŸ“‹</span>ê°•ì˜ ë°°ì •</div>
    <div class="nav-item" data-sec="completions"   data-perm="completions"   onclick="go(this)"><span class="nav-icon">ğŸ†</span>ìˆ˜ë£Œ í˜„í™©</div>
    <div class="nav-divider"></div>
    <div class="nav-sec">ê°•ì˜ ê´€ë¦¬</div>
    <div class="nav-item" data-sec="courses"       data-super-only onclick="go(this)"><span class="nav-icon">ğŸ¬</span>ê°•ì˜ ëª©ë¡</div>
    <div class="nav-item" data-sec="add-course"    data-super-only onclick="go(this)"><span class="nav-icon">â•</span>ê°•ì˜ ë“±ë¡</div>
    <div class="nav-divider"></div>
    <div class="nav-sec">í†µê³„Â·ì¦ì </div>
    <div class="nav-item" data-perm="stats" onclick="openStats()"><span class="nav-icon">ğŸ“ˆ</span>í†µê³„ í˜„í™© ë³´ê³ ì„œ</div>
    <div class="nav-divider"></div>
    <div class="nav-sec" id="nav-sec-system">ì‹œìŠ¤í…œ</div>
    <div class="nav-item" data-sec="settings"   data-super-only onclick="go(this)"><span class="nav-icon">âš™ï¸</span>ì„¤ì •</div>
    <div class="nav-item" data-sec="org-admins" data-super-only onclick="go(this)"><span class="nav-icon">ğŸ¢</span>íšŒì‚¬ë³„ ê´€ë¦¬ì</div>
    <div class="nav-bottom">
      <div class="nav-item" onclick="adminLogout()"><span class="nav-icon">ğŸšª</span>ë¡œê·¸ì•„ì›ƒ</div>
    </div>
    </div>
  </nav>

  <div class="admin-content">

    <!-- â•â• OVERVIEW â•â• -->
    <div class="content-sec active" id="sec-overview">
      <div class="section-title">ğŸ“Š ì „ì²´ í˜„í™©</div>
      <!-- íšŒì‚¬ë³„ ê´€ë¦¬ì ë°°ë„ˆ (JSë¡œ í‘œì‹œ ì œì–´) -->
      <div class="org-banner" id="org-banner" style="display:none">
        <div class="ob-icon">ğŸ¢</div>
        <div class="ob-body">
          <strong id="org-banner-title"></strong>
          <span id="org-banner-perms"></span>
        </div>
      </div>
      <!-- Stats CTA -->
      <div class="stats-cta" onclick="openStats()">
        <div class="stats-cta-left">
          <div class="t">ğŸ“Š êµìœ¡ í˜„í™© í†µê³„ ë³´ê³ ì„œ</div>
          <div class="s">ê¸°ê´€ë³„Â·ë“±ê¸‰ë³„Â·ë¶€ì„œë³„ í†µê³„ Â· ì¸ì‡„Â·PDFÂ·CSV ë‹¤ìš´ë¡œë“œ</div>
        </div>
        <div class="stats-cta-arr">â†’</div>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="ov-total">0</div><div class="stat-label">ì „ì²´ ìˆ˜ê°•ìƒ</div></div>
        <div class="stat-card" style="border-left-color:#FCA311"><div class="stat-value" id="ov-pending">0</div><div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸°</div></div>
        <div class="stat-card" style="border-left-color:var(--success)"><div class="stat-value" id="ov-done">0</div><div class="stat-label">ìˆ˜ë£Œ ì™„ë£Œ</div></div>
        <div class="stat-card" style="border-left-color:var(--kasg-blue)"><div class="stat-value" id="ov-rate">0%</div><div class="stat-label">ìˆ˜ë£Œìœ¨</div></div>
      </div>
      <div class="card" style="margin-bottom:16px">
        <div class="card-header"><span class="card-title">ë“±ê¸‰ë³„ í˜„í™©</span></div>
        <div class="card-body" style="padding:14px"><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px" id="grade-stats"></div></div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">ìµœê·¼ ìˆ˜ë£Œì</span></div>
        <div><table class="data-table"><thead><tr><th>ì„±ëª…</th><th>ë“±ê¸‰</th><th>ì†Œì†</th><th>ê°•ì˜ëª…</th><th>ì ìˆ˜</th><th>ìˆ˜ë£Œì¼</th></tr></thead><tbody id="ov-recent"></tbody></table></div>
      </div>
    </div>

    <!-- â•â• PENDING â•â• -->
    <div class="content-sec" id="sec-pending">
      <div class="section-title">â³ ê°€ì… ìŠ¹ì¸</div>
      <div class="alert alert-info" style="margin-bottom:12px;font-size:12.5px">
        ìŠ¹ì¸ ì‹œ ìˆ˜ê°•ìƒì´ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤. ìŠ¹ì¸ í›„ <strong>ë“±ê¸‰ ì§€ì • ë° ê°•ì˜ ë°°ì •</strong>ì„ ì§„í–‰í•˜ì„¸ìš”.
      </div>
      <div class="tbl-wrap"><table class="data-table">
        <thead><tr><th>ì„±ëª…</th><th>ì•„ì´ë””</th><th>ì†Œì†</th><th>ë¶€ì„œ</th><th>ì—°ë½ì²˜</th><th>ì‹ ì²­ì¼</th><th style="text-align:center">ì²˜ë¦¬</th></tr></thead>
        <tbody id="pending-tbody"></tbody>
      </table></div>
    </div>

    <!-- â•â• LEARNERS â•â• -->
    <div class="content-sec" id="sec-learners">
      <div class="section-title">ğŸ‘¥ ìˆ˜ê°•ìƒ ëª©ë¡</div>
      <div class="tbl-toolbar">
        <input class="filter-input" id="lf-search" placeholder="ğŸ” ì„±ëª…Â·ì•„ì´ë””Â·ì†Œì†" oninput="filterLearners()">
        <select class="filter-select" id="lf-grade" onchange="filterLearners()">
          <option value="">ì „ì²´ ë“±ê¸‰</option>
          <option value="board">ì´ì‚¬íšŒÂ·ì„ì›</option>
          <option value="aml">AML ë‹´ë‹¹ì</option>
          <option value="general">ì¼ë°˜</option>
          <option value="research">ì—°êµ¬íšŒ</option>
        </select>
        <select class="filter-select" id="lf-org" onchange="filterLearners()"><option value="">ì „ì²´ ê¸°ê´€</option></select>
        <select class="filter-select" id="lf-status" onchange="filterLearners()">
          <option value="">ì „ì²´ ìƒíƒœ</option>
          <option value="approved">ë¯¸ì‹œì‘</option>
          <option value="in_progress">ìˆ˜ê°•ì¤‘</option>
          <option value="completed">ìˆ˜ë£Œ</option>
        </select>
        <div class="ml-auto" style="display:flex;gap:6px">
          <button class="btn btn-sm btn-outline" onclick="exportLearners()">ğŸ“¥ CSV</button>
        </div>
      </div>
      <div class="tbl-wrap" style="overflow-x:auto">
        <table class="data-table" style="min-width:960px">
          <thead><tr><th>ì„±ëª…</th><th>ë“±ê¸‰</th><th>ì†Œì†Â·ë¶€ì„œ</th><th>ì´ë©”ì¼</th><th>ë°°ì •ê°•ì˜</th><th>ì§„ë„</th><th>ì ìˆ˜</th><th>ìƒíƒœ</th><th>ë“±ë¡ì¼</th><th style="text-align:center;min-width:200px">ê´€ë¦¬</th></tr></thead>
          <tbody id="learners-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- â•â• BULK REGISTER â•â• -->
    <div class="content-sec" id="sec-bulk-register">
      <div class="section-title">ğŸ“¤ ëŒ€ëŸ‰ ë“±ë¡ (ì—‘ì…€ ì—…ë¡œë“œ)</div>
      <div class="card" style="margin-bottom:14px">
        <div class="card-header">
          <span class="card-title">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</span>
          <button class="btn btn-sm btn-outline" onclick="downloadTemplate()">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <div class="card-body">
          <div class="tmpl-guide">
            <div class="tmpl-guide-t">ğŸ“‹ ì—‘ì…€ ì–‘ì‹ ì»¬ëŸ¼ ì•ˆë‚´</div>
            <div class="tmpl-cols">
              <div class="tmpl-col"><strong>ì•„ì´ë””*</strong> ë¡œê·¸ì¸ ID</div>
              <div class="tmpl-col"><strong>ì„±ëª…*</strong> ì‹¤ëª…</div>
              <div class="tmpl-col"><strong>ì†Œì†*</strong> íšŒì‚¬Â·ê¸°ê´€ëª…</div>
              <div class="tmpl-col">ë¶€ì„œ</div>
              <div class="tmpl-col">ì—°ë½ì²˜</div>
              <div class="tmpl-col"><strong>ë“±ê¸‰*</strong> board/aml/general/research</div>
              <div class="tmpl-col"><strong>ë¹„ë°€ë²ˆí˜¸*</strong> ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸</div>
            </div>
            <div style="margin-top:8px;font-size:11px;color:var(--text-light)">
              * í‘œì‹œ í•­ëª© í•„ìˆ˜ Â· ë“±ê¸‰: board(ì´ì‚¬íšŒÂ·ì„ì›) / aml(AMLë‹´ë‹¹ì) / general(ì¼ë°˜) / research(ì—°êµ¬íšŒ)
            </div>
          </div>

          <div class="upload-zone" id="upload-zone" style="margin-top:16px">
            <input type="file" id="excel-file" accept=".xlsx,.xls,.csv" onchange="parseExcel(this.files[0])">
            <div class="upload-icon">ğŸ“‚</div>
            <div class="upload-title">ì—‘ì…€ íŒŒì¼ì„ í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</div>
            <div class="upload-sub">.xlsx Â· .xls Â· .csv ì§€ì› Â· ìµœëŒ€ 1,000í–‰</div>
          </div>

          <div class="excel-preview" id="excel-preview" style="display:none">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px">
              <div style="font-size:13px;font-weight:600;color:var(--navy)" id="preview-summary"></div>
              <div style="display:flex;gap:7px">
                <button class="btn btn-outline btn-sm" onclick="clearExcel()">âœ• ì´ˆê¸°í™”</button>
                <button class="btn btn-gold" id="upload-btn" onclick="doUpload()">ğŸ“¤ ë“±ë¡ ì‹¤í–‰</button>
              </div>
            </div>
            <div class="ep-table-wrap">
              <table class="ep-table"><thead><tr><th>#</th><th>ì•„ì´ë””</th><th>ì„±ëª…</th><th>ì†Œì†</th><th>ë¶€ì„œ</th><th>ì—°ë½ì²˜</th><th>ë“±ê¸‰</th><th>ë¹„ë°€ë²ˆí˜¸</th><th>ìƒíƒœ</th></tr></thead>
              <tbody id="ep-tbody"></tbody></table>
            </div>
          </div>

          <div id="upload-result" style="margin-top:12px"></div>
        </div>
      </div>
    </div>

    <!-- â•â• ASSIGN â•â• -->
    <div class="content-sec" id="sec-assign">
      <div class="section-title">ğŸ“‹ ê°•ì˜ ë°°ì • ê´€ë¦¬</div>
      <div class="alert alert-info" style="margin-bottom:14px;font-size:12.5px">
        ìˆ˜ê°•ìƒ ë“±ê¸‰Â·ì†Œì†ë³„ë¡œ ê°•ì˜ë¥¼ ê°œë³„ ë˜ëŠ” ì¼ê´„ ë°°ì •í•˜ì„¸ìš”.
      </div>
      <!-- Bulk by grade -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-header"><span class="card-title">ğŸ¯ ë“±ê¸‰ë³„ ì¼ê´„ ë°°ì •</span></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start">
            <div>
              <div class="form-label" style="margin-bottom:7px">ëŒ€ìƒ ë“±ê¸‰</div>
              <div style="display:flex;gap:6px;flex-wrap:wrap">
                <button class="agb-btn" data-grade="board"    onclick="toggleBulkGrade(this)">ğŸ› ì´ì‚¬íšŒÂ·ì„ì›</button>
                <button class="agb-btn" data-grade="aml"      onclick="toggleBulkGrade(this)">ğŸ” AML ë‹´ë‹¹ì</button>
                <button class="agb-btn" data-grade="general"  onclick="toggleBulkGrade(this)">ğŸ‘¤ ì¼ë°˜</button>
                <button class="agb-btn" data-grade="research" onclick="toggleBulkGrade(this)">ğŸ“ ì—°êµ¬íšŒ</button>
              </div>
            </div>
            <div>
              <div class="form-label" style="margin-bottom:7px">ë°°ì •í•  ê°•ì˜</div>
              <div id="bulk-course-checks" style="display:flex;flex-direction:column;gap:5px;max-height:150px;overflow-y:auto"></div>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:7px">
            <button class="btn btn-outline btn-sm" onclick="previewBulk()">ëŒ€ìƒ ë¯¸ë¦¬ë³´ê¸°</button>
            <button class="btn btn-primary" onclick="doBulkAssign()">ì¼ê´„ ë°°ì • ì ìš©</button>
          </div>
          <div id="bulk-preview" style="margin-top:10px;display:none"></div>
        </div>
      </div>
      <!-- Individual table -->
      <div class="section-title" style="font-size:14px;margin-top:0">ê°œë³„ ë°°ì • í˜„í™©</div>
      <div class="tbl-toolbar">
        <input class="filter-input" id="af-search" placeholder="ğŸ” ì„±ëª…Â·ì†Œì† ê²€ìƒ‰" oninput="filterAssign()">
        <select class="filter-select" id="af-grade" onchange="filterAssign()">
          <option value="">ì „ì²´ ë“±ê¸‰</option>
          <option value="board">ì´ì‚¬íšŒÂ·ì„ì›</option>
          <option value="aml">AML ë‹´ë‹¹ì</option>
          <option value="general">ì¼ë°˜</option>
          <option value="research">ì—°êµ¬íšŒ</option>
        </select>
      </div>
      <div class="tbl-wrap" style="overflow-x:auto">
        <table class="data-table" style="min-width:700px">
          <thead><tr><th>ì„±ëª…</th><th>ë“±ê¸‰</th><th>ì†Œì†</th><th>ë°°ì •ëœ ê°•ì˜</th><th style="text-align:center">ìˆ˜ì •</th></tr></thead>
          <tbody id="assign-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- â•â• COMPLETIONS â•â• -->
    <div class="content-sec" id="sec-completions">
      <div class="section-title">ğŸ† ìˆ˜ë£Œ í˜„í™©</div>
      <div class="tbl-toolbar">
        <input class="filter-input" id="cf-search" placeholder="ğŸ” ì„±ëª…Â·ë°œê¸‰ë²ˆí˜¸" oninput="filterCompletions()">
        <div class="ml-auto"><button class="btn btn-sm btn-outline" onclick="exportCompletions()">ğŸ“¥ CSV</button></div>
      </div>
      <div class="tbl-wrap"><table class="data-table">
        <thead><tr><th>ë°œê¸‰ë²ˆí˜¸</th><th>ì„±ëª…</th><th>ë“±ê¸‰</th><th>ì†Œì†</th><th>ê°•ì˜ëª…</th><th>ì ìˆ˜</th><th>ìˆ˜ë£Œì¼</th></tr></thead>
        <tbody id="completions-tbody"></tbody>
      </table></div>
    </div>

    <!-- â•â• COURSES â•â• -->
    <div class="content-sec" id="sec-courses">
      <div class="section-title">ğŸ¬ ê°•ì˜ ëª©ë¡</div>
      <div class="course-grid" id="course-grid"></div>
    </div>

    <!-- â•â• ADD COURSE â•â• -->
    <div class="content-sec" id="sec-add-course">
      <div class="section-title">â• ê°•ì˜ ë“±ë¡</div>

      <!-- ê¸°ë³¸ ì •ë³´ -->
      <div class="card" style="margin-bottom:0;border-radius:var(--radius-lg) var(--radius-lg) 0 0;border-bottom:none">
        <div class="card-header" style="border-radius:var(--radius-lg) var(--radius-lg) 0 0"><span class="card-title">â‘  ê°•ì˜ ê¸°ë³¸ ì •ë³´</span></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px">
            <div class="form-group"><label class="form-label">ê°•ì˜ëª… *</label><input class="form-input" id="cf-title" placeholder="ì˜ˆ: AML ì‹¤ë¬´ì êµìœ¡ 2025"></div>
            <div class="form-group"><label class="form-label">êµìœ¡ ì‹œê°„(h)</label><input class="form-input" id="cf-duration" type="number" value="2" min="1" max="20"></div>
            <div class="form-group"><label class="form-label">ì‹œí—˜ ì œí•œì‹œê°„(ë¶„)</label><input class="form-input" id="cf-exam-time" type="number" value="40" min="10" max="120"></div>
          </div>
          <div class="form-group"><label class="form-label">êµìœ¡ëª©ì  *</label><input class="form-input" id="cf-purpose" placeholder="ì˜ˆ: ìê¸ˆì„¸íƒë°©ì§€ ì‹¤ë¬´ ì´í•´ ë° ì—­ëŸ‰ ê°•í™”"></div>
          <div class="form-group">
            <label class="form-label">YouTube URL *</label>
            <input class="form-input" id="cf-yturl" placeholder="https://www.youtube.com/watch?v=..." oninput="previewYT()">
          </div>
          <div class="yt-preview" id="yt-preview"><iframe id="yt-preview-frame" allowfullscreen></iframe></div>
        </div>
      </div>

      <!-- ì¤‘ê°„ í€´ì¦ˆ 3ê°œ -->
      <div style="background:#fff;border:1px solid var(--border);border-top:none;border-bottom:none">
        <div class="quiz-section-hd">
          <div class="quiz-section-title">âš¡ â‘¡ ì¤‘ê°„ í€´ì¦ˆ <span class="quiz-section-badge">25% Â· 50% Â· 75% ì§€ì </span></div>
          <span style="font-size:11px;color:rgba(255,255,255,.5)">ë¹„ì›Œë‘ë©´ AI ìë™ ìƒì„±</span>
        </div>
        <div style="padding:16px;display:flex;flex-direction:column;gap:10px" id="cf-mid-quizzes">
          <!-- JSë¡œ ë Œë” -->
        </div>
      </div>

      <!-- ìµœì¢… ë¬¸ì œ ì€í–‰ -->
      <div style="background:#fff;border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius-lg) var(--radius-lg)">
        <div class="quiz-section-hd" style="border-radius:0">
          <div class="quiz-section-title">ğŸ“ â‘¢ ìµœì¢… í‰ê°€ ë¬¸ì œ ì€í–‰ <span class="quiz-section-badge" id="cf-bank-badge">0ë¬¸í•­</span></div>
          <span style="font-size:11px;color:rgba(255,255,255,.5)">ë“±ë¡ ë¬¸í•­ ì¤‘ ëœë¤ ì¶œì œ</span>
        </div>
        <div style="padding:16px">
          <!-- ì¶œì œ ì„¤ì • -->
          <div class="exam-settings-bar">
            <div class="esb-item">ğŸ² ì¶œì œ ë¬¸í•­ ìˆ˜: <input class="esb-input" id="cf-exam-count" type="number" value="20" min="5" max="100" oninput="updateExamCountWarn('cf')"></div>
            <div class="esb-item" style="color:var(--text-light)">â± ì œí•œì‹œê°„: <strong id="cf-exam-time-disp">40ë¶„</strong></div>
            <span class="esb-warn" id="cf-exam-warn" style="display:none"></span>
            <div style="margin-left:auto;font-size:11px;color:var(--text-mid)">ë¬¸ì œ ì€í–‰ì´ ì¶œì œ ìˆ˜ë³´ë‹¤ ë§ìœ¼ë©´ ë§¤ ì‹œí—˜ë§ˆë‹¤ ë‹¤ë¥¸ ë¬¸ì œ ì¶œì œ</div>
          </div>
          <!-- ë¬¸ì œ ì¶”ê°€ í¼ -->
          <div style="background:#F8F7F4;border:1.5px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:12px" id="cf-add-q-form">
            <!-- íƒ­ í† ê¸€ -->
            <div style="display:flex;gap:0;margin-bottom:12px;border-radius:var(--radius);overflow:hidden;border:1.5px solid var(--border);width:fit-content">
              <button id="cf-tab-manual" class="q-add-tab active" onclick="switchQTab('cf','manual')">âœï¸ ì§ì ‘ ì…ë ¥</button>
              <button id="cf-tab-excel"  class="q-add-tab"        onclick="switchQTab('cf','excel')">ğŸ“‚ ì—‘ì…€ ì—…ë¡œë“œ</button>
            </div>

            <!-- ì§ì ‘ ì…ë ¥ íŒ¨ë„ -->
            <div id="cf-panel-manual">
              <div class="form-group" style="margin-bottom:8px">
                <textarea class="mqc-q-input" id="cf-new-q" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="min-height:56px"></textarea>
              </div>
              <div class="opts-grid" id="cf-new-opts-grid"></div>
              <div class="form-group" style="margin-bottom:6px">
                <input class="mqc-expl-input" id="cf-new-expl" placeholder="ì •ë‹µ í•´ì„¤ (ì„ íƒì‚¬í•­)">
              </div>
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                <button class="btn btn-sm btn-primary" onclick="addQToBank('cf')">ë¬¸ì œ ì¶”ê°€</button>
                <button class="import-bank-btn" onclick="importDefaultBank('cf')">ğŸ“š ê¸°ë³¸ ë¬¸ì œ ì€í–‰ ê°€ì ¸ì˜¤ê¸° (20ë¬¸í•­)</button>
                <span style="font-size:11px;color:var(--text-light)">â‘  ì •ë‹µ ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ í•„ìˆ˜</span>
              </div>
            </div>

            <!-- ì—‘ì…€ ì—…ë¡œë“œ íŒ¨ë„ -->
            <div id="cf-panel-excel" style="display:none">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:9px;flex-wrap:wrap;gap:6px">
                <div style="font-size:11.5px;color:var(--text-mid)">ì—‘ì…€ íŒŒì¼ë¡œ ë¬¸ì œë¥¼ ì¼ê´„ ë“±ë¡í•©ë‹ˆë‹¤.</div>
                <button class="btn btn-sm btn-outline" onclick="downloadQTemplate()">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
              </div>
              <div class="q-excel-tmpl-guide">
                <div style="font-size:11px;font-weight:700;color:var(--navy);margin-bottom:5px">ğŸ“‹ ì—‘ì…€ ì»¬ëŸ¼</div>
                <div style="display:flex;flex-wrap:wrap;gap:4px">
                  <span class="q-col-chip"><strong>ë¬¸ì œ*</strong></span>
                  <span class="q-col-chip"><strong>ë³´ê¸°1*</strong></span>
                  <span class="q-col-chip"><strong>ë³´ê¸°2*</strong></span>
                  <span class="q-col-chip"><strong>ë³´ê¸°3*</strong></span>
                  <span class="q-col-chip"><strong>ë³´ê¸°4*</strong></span>
                  <span class="q-col-chip"><strong>ì •ë‹µ*</strong> (1~4 ìˆ«ì)</span>
                  <span class="q-col-chip">í•´ì„¤ (ì„ íƒ)</span>
                </div>
              </div>
              <div class="q-upload-zone" id="cf-q-upload-zone" style="margin-top:10px">
                <input type="file" id="cf-q-excel-file" accept=".xlsx,.xls,.csv" onchange="parseQExcel(this.files[0],'cf')">
                <div style="font-size:22px;margin-bottom:6px">ğŸ“‚</div>
                <div style="font-size:12.5px;font-weight:600;color:var(--navy)">ì—‘ì…€ íŒŒì¼ í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸</div>
                <div style="font-size:11px;color:var(--text-light);margin-top:3px">.xlsx Â· .xls Â· .csv</div>
              </div>
              <div id="cf-q-excel-preview"></div>
            </div>
          </div>
          <!-- ë¬¸ì œ ëª©ë¡ -->
          <div id="cf-q-list"></div>
        </div>
      </div>

      <div id="add-course-msg" style="margin-top:10px"></div>
      <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-outline btn-sm" onclick="clearCF()">ì´ˆê¸°í™”</button>
        <button class="btn btn-gold" onclick="saveCourse()">ğŸ’¾ ê°•ì˜ ë“±ë¡ ì™„ë£Œ</button>
      </div>
    </div>

    <!-- â•â• SETTINGS â•â• -->
    <div class="content-sec" id="sec-settings">
      <div class="section-title">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</div>
      <div class="settings-grid">
        <div class="sbox">
          <div class="sbox-t">ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="form-group"><label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input class="form-input" type="password" id="new-pw" placeholder="8ì ì´ìƒ"></div>
          <div class="form-group"><label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input class="form-input" type="password" id="confirm-pw"></div>
          <button class="btn btn-primary btn-sm" onclick="changeAdminPw()">ë³€ê²½</button>
        </div>
        <div class="sbox">
          <div class="sbox-t">ğŸ“‹ ìˆ˜ë£Œ ê¸°ì¤€</div>
          <div class="form-group"><label class="form-label">ìµœì†Œ ìˆ˜ë£Œ ì ìˆ˜ (%)</label><input class="form-input" type="number" id="pass-score" value="70" min="50" max="100"></div>
          <div class="form-group"><label class="form-label">ìµœëŒ€ ì¬ì‹œí—˜ íšŸìˆ˜</label><input class="form-input" type="number" id="max-attempts" value="2" min="1" max="5"></div>
          <button class="btn btn-primary btn-sm" onclick="saveSettings()">ì €ì¥</button>
        </div>

        <!-- ì´ë©”ì¼ ë°œì‹  ì„¤ì • -->
        <div class="sbox" style="grid-column:1/-1">
          <div class="sbox-t">ğŸ“§ ì´ë©”ì¼ ì•Œë¦¼ ì„¤ì •</div>
          <div class="alert alert-info" style="margin-bottom:14px;font-size:12px">
            ìˆ˜ê°•ê¸°í•œ ì•Œë¦¼ ì´ë©”ì¼ì€ <strong>EmailJS</strong>ë¥¼ í†µí•´ ë°œì†¡ë©ë‹ˆë‹¤.
            ì•„ë˜ì— EmailJS ì„œë¹„ìŠ¤ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•˜ì„¸ìš”.
            ì•Œë¦¼ì€ ë§¤ì¼ 1íšŒ ê´€ë¦¬ìê°€ <strong>ã€Œì•Œë¦¼ ì‹¤í–‰ã€</strong>ì„ í´ë¦­í•˜ê±°ë‚˜, ìë™ ì‹¤í–‰(ë¸Œë¼ìš°ì € íƒ­ ì—´ì–´ë‘ê¸°)ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px">
            <div class="form-group">
              <label class="form-label">EmailJS Service ID</label>
              <input class="form-input" id="ejs-service" placeholder="service_xxxxxxx">
            </div>
            <div class="form-group">
              <label class="form-label">EmailJS Template ID</label>
              <input class="form-input" id="ejs-template" placeholder="template_xxxxxxx">
            </div>
            <div class="form-group">
              <label class="form-label">EmailJS Public Key</label>
              <input class="form-input" id="ejs-pubkey" placeholder="xxxxxxxxxxxxxxxxxxxx">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:12px">
            <label class="form-label">ë°œì‹ ì ì´ë¦„ (ë©”ì¼ì— í‘œì‹œ)</label>
            <input class="form-input" id="ejs-sender-name" placeholder="í•œêµ­ìê¸ˆì„¸íƒë°©ì§€ì—°êµ¬íšŒ êµìœ¡íŒ€" style="max-width:340px">
          </div>
          <div style="display:flex;gap:8px;margin-bottom:14px">
            <button class="btn btn-primary btn-sm" onclick="saveEmailSettings()">ğŸ’¾ ì €ì¥</button>
            <button class="btn btn-outline btn-sm" onclick="loadEmailSettings()">â†º ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>

          <!-- ì•Œë¦¼ íŠ¸ë¦¬ê±° -->
          <div style="font-size:12.5px;font-weight:700;color:var(--navy);margin-bottom:9px">ğŸ“¬ ìˆ˜ê°•ê¸°í•œ ì•Œë¦¼ ë°œì†¡</div>
          <div class="enp-desc">ìˆ˜ê°•ê¸°í•œì´ <strong>10ì¼Â·5ì¼Â·1ì¼Â·ë‹¹ì¼</strong>ì¸ ìˆ˜ê°•ìƒì—ê²Œ ìë™ìœ¼ë¡œ ì•Œë¦¼ ì´ë©”ì¼ì„ ë°œì†¡í•©ë‹ˆë‹¤.</div>

          <div class="notif-row">
            <div class="notif-label">ğŸ”´ ì˜¤ëŠ˜ ë§ˆê° ìˆ˜ê°•ìƒ <span class="notif-cnt" id="cnt-d0"></span></div>
            <div class="notif-actions">
              <button class="btn-send-now" onclick="sendDeadlineNotif(0)">ğŸ“§ ì¦‰ì‹œ ë°œì†¡</button>
            </div>
          </div>
          <div class="notif-row">
            <div class="notif-label">ğŸŸ  1ì¼ ì „ ìˆ˜ê°•ìƒ <span class="notif-cnt" id="cnt-d1"></span></div>
            <div class="notif-actions">
              <button class="btn-send-now" onclick="sendDeadlineNotif(1)">ğŸ“§ ì¦‰ì‹œ ë°œì†¡</button>
            </div>
          </div>
          <div class="notif-row">
            <div class="notif-label">ğŸŸ¡ 5ì¼ ì „ ìˆ˜ê°•ìƒ <span class="notif-cnt" id="cnt-d5"></span></div>
            <div class="notif-actions">
              <button class="btn-send-now" onclick="sendDeadlineNotif(5)">ğŸ“§ ì¦‰ì‹œ ë°œì†¡</button>
            </div>
          </div>
          <div class="notif-row">
            <div class="notif-label">ğŸ”µ 10ì¼ ì „ ìˆ˜ê°•ìƒ <span class="notif-cnt" id="cnt-d10"></span></div>
            <div class="notif-actions">
              <button class="btn-send-now" onclick="sendDeadlineNotif(10)">ğŸ“§ ì¦‰ì‹œ ë°œì†¡</button>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="runAllDeadlineNotifs()" id="btn-run-all-notifs">
              ğŸš€ ì „ì²´ ì•Œë¦¼ ì¼ê´„ ì‹¤í–‰ (10Â·5Â·1Â·ë‹¹ì¼)
            </button>
            <div style="display:flex;align-items:center;gap:7px;font-size:12.5px;color:var(--text-mid)">
              <label class="toggle-switch">
                <input type="checkbox" id="auto-notif-toggle" onchange="toggleAutoNotif(this.checked)">
                <span class="toggle-slider"></span>
              </label>
              <span>ìë™ ì•Œë¦¼ í™œì„±í™” <span style="font-size:10.5px">(í˜ì´ì§€ë¥¼ ì—´ì–´ë‘” ë™ì•ˆ ë§¤ì¼ ìì • ìë™ ì‹¤í–‰)</span></span>
            </div>
          </div>
          <div id="notif-log" style="margin-top:10px;max-height:120px;overflow-y:auto;font-size:11px;color:var(--text-light);background:#F8F7F4;border-radius:var(--radius);padding:8px 10px;display:none"></div>
        </div>

        <div class="sbox" style="grid-column:1/-1">
          <div class="sbox-t">ğŸ”— Firebase ì„¤ì •</div>
          <div class="alert alert-warn" style="margin:0;font-size:12px">
            <strong>í•„ìˆ˜:</strong> <code>js/firebase-config.js</code>ì—ì„œ <code>apiKey</code>, <code>messagingSenderId</code>, <code>appId</code>ë¥¼ êµì²´í•˜ì„¸ìš”.
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• ORG ADMINS â•â• -->
    <div class="content-sec" id="sec-org-admins">
      <div class="section-title">ğŸ¢ íšŒì‚¬ë³„ ê´€ë¦¬ì</div>

      <!-- ì•ˆë‚´ ë°•ìŠ¤ -->
      <div class="alert alert-info" style="margin-bottom:14px;font-size:12.5px">
        <strong>âš¡ ì‹œìŠ¤í…œ ê´€ë¦¬ì ì „ìš©</strong> â€” ê° íšŒì‚¬ë³„ ê´€ë¦¬ì ê³„ì •ì„ ë“±ë¡í•˜ê³  í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤.<br>
        íšŒì‚¬ë³„ ê´€ë¦¬ìëŠ” <strong>ìê¸° ì†Œì† íšŒì‚¬ ë°ì´í„°ë§Œ</strong> ì¡°íšŒ ê°€ëŠ¥í•˜ë©°, ë¶€ì—¬ëœ ê¶Œí•œ ë©”ë‰´ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>

      <!-- ë“±ë¡ í¼ -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-header"><span class="card-title">â• ìƒˆ ê´€ë¦¬ì ê³„ì • ë“±ë¡</span></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px">
            <div class="form-group">
              <label class="form-label">ì•„ì´ë”” * <span style="font-weight:400;color:var(--text-light)">(ì˜ë¬¸Â·ìˆ«ìÂ·_)</span></label>
              <input class="form-input" id="oa-id" placeholder="ì˜ˆ: samsung_admin">
            </div>
            <div class="form-group"><label class="form-label">ë‹´ë‹¹ì ì´ë¦„ *</label><input class="form-input" id="oa-name" placeholder="í™ê¸¸ë™"></div>
            <div class="form-group"><label class="form-label">ì†Œì† íšŒì‚¬ * <span style="font-weight:400;color:var(--text-light)">(ìˆ˜ê°•ìƒì˜ ì†Œì†ê³¼ ì¼ì¹˜)</span></label><input class="form-input" id="oa-org" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì"></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
            <div class="form-group"><label class="form-label">ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ * (6ì ì´ìƒ)</label><input class="form-input" type="password" id="oa-pw" placeholder="ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸"></div>
            <div class="form-group"><label class="form-label">ì—°ë½ì²˜</label><input class="form-input" id="oa-phone" placeholder="010-0000-0000"></div>
          </div>
          <div class="form-group" style="margin-bottom:14px">
            <label class="form-label" style="margin-bottom:9px">ğŸ“‹ í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ ì„¤ì • <span style="font-weight:400;color:var(--text-light)">(ì²´í¬í•œ ë©”ë‰´ë§Œ ì ‘ê·¼ ê°€ëŠ¥)</span></label>
            <div id="oa-perm-new"></div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px">
            <button class="btn btn-outline btn-sm" onclick="clearOAForm()">ì´ˆê¸°í™”</button>
            <button class="btn btn-primary" onclick="saveNewOA()">ğŸ’¾ ê´€ë¦¬ì ë“±ë¡</button>
          </div>
        </div>
      </div>

      <!-- ëª©ë¡ -->
      <div class="card">
        <div class="card-header" style="flex-wrap:wrap;gap:8px">
          <span class="card-title">ë“±ë¡ëœ ê´€ë¦¬ì ëª©ë¡</span>
          <input class="filter-input" id="oa-search" placeholder="ì•„ì´ë””Â·ì´ë¦„Â·íšŒì‚¬ ê²€ìƒ‰..." oninput="renderOAList()" style="margin-left:auto;width:200px">
        </div>
        <div style="background:#fff;border-radius:0 0 var(--radius-lg) var(--radius-lg);overflow:hidden">
          <table class="data-table">
            <thead>
              <tr><th>ì•„ì´ë””</th><th>ì´ë¦„</th><th>ì†Œì† íšŒì‚¬</th><th>ì—°ë½ì²˜</th><th>ë¶€ì—¬ëœ ê¶Œí•œ</th><th>ìƒíƒœ</th><th>ë“±ë¡ì¼</th><th>ê´€ë¦¬</th></tr>
            </thead>
            <tbody id="oa-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div><!-- /admin-content -->
</div><!-- /admin-layout -->

<!-- â”€â”€ Org Admin Edit Modal â”€â”€ -->
<div class="modal-backdrop hidden" id="modal-edit-oa">
  <div class="modal-box" style="width:min(640px,96vw)">
    <div class="modal-header">
      <span class="modal-title">âœï¸ ê´€ë¦¬ì ìˆ˜ì • â€” <span id="oa-edit-id-label" style="color:var(--kasg-gold)"></span></span>
      <button class="modal-close" onclick="closeModal('modal-edit-oa')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="oa-edit-key">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div class="form-group"><label class="form-label">ì´ë¦„</label><input class="form-input" id="oa-edit-name"></div>
        <div class="form-group"><label class="form-label">ì†Œì† íšŒì‚¬</label><input class="form-input" id="oa-edit-org"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
        <div class="form-group">
          <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ <span style="font-weight:400;color:var(--text-light)">(ë¹„ì›Œë‘ë©´ ìœ ì§€)</span></label>
          <input class="form-input" type="password" id="oa-edit-pw" placeholder="ë³€ê²½ ì‹œ ì…ë ¥ (6ì ì´ìƒ)">
        </div>
        <div class="form-group"><label class="form-label">ì—°ë½ì²˜</label><input class="form-input" id="oa-edit-phone"></div>
      </div>
      <div class="form-group">
        <label class="form-label" style="margin-bottom:9px">ğŸ“‹ í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ</label>
        <div id="oa-perm-edit"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('modal-edit-oa')">ì·¨ì†Œ</button>
      <button class="btn btn-primary btn-sm" onclick="doEditOA()">ğŸ’¾ ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Reset PW -->
<div class="modal-backdrop hidden" id="modal-reset-pw">
  <div class="modal-box">
    <div class="modal-header"><span class="modal-title">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”</span><button class="modal-close" onclick="closeModal('modal-reset-pw')">âœ•</button></div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text-mid);margin-bottom:14px"><strong id="rp-name"></strong>ë‹˜ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</p>
      <div class="form-group"><label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="text" class="form-input" id="rp-new" value="kasg1234"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('modal-reset-pw')">ì·¨ì†Œ</button>
      <button class="btn btn-warn btn-sm" onclick="doResetPw()">ì ìš©</button>
    </div>
  </div>
</div>

<!-- Edit Learner -->
<div class="modal-backdrop hidden" id="modal-edit-learner">
  <div class="modal-box">
    <div class="modal-header"><span class="modal-title">âœï¸ ìˆ˜ê°•ìƒ ì •ë³´Â·ë“±ê¸‰ ìˆ˜ì •</span><button class="modal-close" onclick="closeModal('modal-edit-learner')">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="el-id">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
        <div class="form-group"><label class="form-label">ì„±ëª…</label><input class="form-input" id="el-name"></div>
        <div class="form-group"><label class="form-label">ì†Œì†</label><input class="form-input" id="el-org"></div>
        <div class="form-group"><label class="form-label">ë¶€ì„œ</label><input class="form-input" id="el-dept"></div>
        <div class="form-group"><label class="form-label">ì—°ë½ì²˜</label><input class="form-input" id="el-phone"></div>
      </div>
      <div class="form-group" style="margin-bottom:14px">
        <label class="form-label">ì´ë©”ì¼ <span style="font-size:10px;color:var(--kasg-blue)">(ìˆ˜ê°•ê¸°í•œ ì•Œë¦¼ ìˆ˜ì‹ )</span></label>
        <input class="form-input" type="email" id="el-email" placeholder="example@company.com">
      </div>
      <div class="form-group">
        <label class="form-label">ìˆ˜ê°•ìƒ ë“±ê¸‰ <span style="font-size:10px;color:var(--kasg-red);font-weight:600">(ê´€ë¦¬ì ì§€ì •)</span></label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:6px" id="el-grade-grid">
          <label style="display:flex;align-items:center;gap:8px;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:12.5px">
            <input type="radio" name="el-grade" value="board" style="accent-color:var(--navy)"> ğŸ› ì´ì‚¬íšŒÂ·ì„ì›
          </label>
          <label style="display:flex;align-items:center;gap:8px;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:12.5px">
            <input type="radio" name="el-grade" value="aml" style="accent-color:var(--navy)"> ğŸ” AML ë‹´ë‹¹ì
          </label>
          <label style="display:flex;align-items:center;gap:8px;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:12.5px">
            <input type="radio" name="el-grade" value="general" style="accent-color:var(--navy)"> ğŸ‘¤ ì¼ë°˜
          </label>
          <label style="display:flex;align-items:center;gap:8px;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:12.5px">
            <input type="radio" name="el-grade" value="research" style="accent-color:var(--navy)"> ğŸ“ ì—°êµ¬íšŒ
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('modal-edit-learner')">ì·¨ì†Œ</button>
      <button class="btn btn-primary btn-sm" onclick="doEditLearner()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Assign Courses -->
<div class="modal-backdrop hidden assign-modal" id="modal-assign">
  <div class="modal-box" style="width:min(680px,96vw);max-height:90vh;display:flex;flex-direction:column">
    <div class="modal-header">
      <span class="modal-title">ğŸ“‹ ê°•ì˜ ë°°ì • â€” <span id="assign-name"></span></span>
      <button class="modal-close" onclick="closeModal('modal-assign')">âœ•</button>
    </div>
    <div class="modal-body" style="overflow-y:auto;flex:1;padding:16px 20px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap">
        <div style="font-size:12px;color:var(--text-mid)">ë“±ê¸‰: <strong id="assign-grade-lbl"></strong></div>
        <div style="font-size:11px;color:var(--text-light);margin-left:auto">ê°•ì˜ë³„ ìˆ˜ê°•ê¸°í•œì„ ì„¤ì •í•˜ë©´ ì´ë©”ì¼ ì•Œë¦¼ì´ ìë™ ë°œì†¡ë©ë‹ˆë‹¤</div>
      </div>
      <div id="assign-course-list"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('modal-assign')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="doAssign()">ğŸ’¾ ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Edit Course (with quiz editor) -->
<div class="modal-backdrop hidden quiz-modal" id="modal-edit-course">
  <div class="modal-box">
    <div class="modal-header">
      <span class="modal-title">âœï¸ ê°•ì˜ ìˆ˜ì • â€” <span id="ec-course-name"></span></span>
      <button class="modal-close" onclick="closeModal('modal-edit-course')">âœ•</button>
    </div>
    <div class="modal-body" style="padding:20px">
      <input type="hidden" id="ec-id">

      <!-- ê¸°ë³¸ ì •ë³´ -->
      <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px;margin-bottom:12px">
        <div class="form-group"><label class="form-label">ê°•ì˜ëª…</label><input class="form-input" id="ec-title"></div>
        <div class="form-group"><label class="form-label">êµìœ¡ ì‹œê°„(h)</label><input class="form-input" type="number" id="ec-duration" min="1" max="20"></div>
        <div class="form-group"><label class="form-label">ì‹œí—˜ ì œí•œì‹œê°„(ë¶„)</label><input class="form-input" type="number" id="ec-exam-time" value="40" min="10" max="120"></div>
      </div>
      <div class="form-group" style="margin-bottom:12px"><label class="form-label">êµìœ¡ëª©ì </label><input class="form-input" id="ec-purpose"></div>
      <div class="form-group" style="margin-bottom:16px"><label class="form-label">YouTube URL</label><input class="form-input" id="ec-yturl"></div>

      <!-- ì¤‘ê°„ í€´ì¦ˆ -->
      <div class="quiz-section-hd" style="border-radius:var(--radius) var(--radius) 0 0">
        <div class="quiz-section-title">âš¡ ì¤‘ê°„ í€´ì¦ˆ <span class="quiz-section-badge">25% Â· 50% Â· 75%</span></div>
        <span style="font-size:11px;color:rgba(255,255,255,.5)">ë¹„ì›Œë‘ë©´ AI ìë™ ìƒì„±</span>
      </div>
      <div style="background:#fff;border:1px solid var(--border);border-top:none;padding:14px;margin-bottom:14px;border-radius:0 0 var(--radius) var(--radius)" id="ec-mid-quizzes"></div>

      <!-- ìµœì¢… ë¬¸ì œ ì€í–‰ -->
      <div class="quiz-section-hd" style="border-radius:var(--radius) var(--radius) 0 0">
        <div class="quiz-section-title">ğŸ“ ìµœì¢… í‰ê°€ ë¬¸ì œ ì€í–‰ <span class="quiz-section-badge" id="ec-bank-badge">0ë¬¸í•­</span></div>
        <span style="font-size:11px;color:rgba(255,255,255,.5)">ëœë¤ ì¶œì œ</span>
      </div>
      <div style="background:#fff;border:1px solid var(--border);border-top:none;padding:14px;border-radius:0 0 var(--radius) var(--radius)">
        <div class="exam-settings-bar">
          <div class="esb-item">ğŸ² ì¶œì œ ë¬¸í•­ ìˆ˜: <input class="esb-input" id="ec-exam-count" type="number" value="20" min="5" max="100" oninput="updateExamCountWarn('ec')"></div>
          <div class="esb-item" style="color:var(--text-light)">â± ì œí•œì‹œê°„: <strong id="ec-exam-time-disp">40ë¶„</strong></div>
          <span class="esb-warn" id="ec-exam-warn" style="display:none"></span>
        </div>
        <!-- ë¬¸ì œ ì¶”ê°€ í¼ -->
        <div style="background:#F8F7F4;border:1.5px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:11px">
          <!-- íƒ­ í† ê¸€ -->
          <div style="display:flex;gap:0;margin-bottom:10px;border-radius:var(--radius);overflow:hidden;border:1.5px solid var(--border);width:fit-content">
            <button id="ec-tab-manual" class="q-add-tab active" onclick="switchQTab('ec','manual')">âœï¸ ì§ì ‘ ì…ë ¥</button>
            <button id="ec-tab-excel"  class="q-add-tab"        onclick="switchQTab('ec','excel')">ğŸ“‚ ì—‘ì…€ ì—…ë¡œë“œ</button>
          </div>

          <!-- ì§ì ‘ ì…ë ¥ -->
          <div id="ec-panel-manual">
            <textarea class="mqc-q-input" id="ec-new-q" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="min-height:52px"></textarea>
            <div class="opts-grid" id="ec-new-opts-grid"></div>
            <input class="mqc-expl-input" id="ec-new-expl" placeholder="ì •ë‹µ í•´ì„¤ (ì„ íƒì‚¬í•­)" style="margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px">
              <button class="btn btn-sm btn-primary" onclick="addQToBank('ec')">ë¬¸ì œ ì¶”ê°€</button>
              <button class="import-bank-btn" onclick="importDefaultBank('ec')">ğŸ“š ê¸°ë³¸ ë¬¸ì œ ì€í–‰ ê°€ì ¸ì˜¤ê¸°</button>
            </div>
          </div>

          <!-- ì—‘ì…€ ì—…ë¡œë“œ -->
          <div id="ec-panel-excel" style="display:none">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap;gap:6px">
              <div style="font-size:11.5px;color:var(--text-mid)">ì—‘ì…€ë¡œ ë¬¸ì œë¥¼ ì¼ê´„ ë“±ë¡í•©ë‹ˆë‹¤.</div>
              <button class="btn btn-sm btn-outline" onclick="downloadQTemplate()">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div class="q-excel-tmpl-guide">
              <div style="font-size:11px;font-weight:700;color:var(--navy);margin-bottom:5px">ğŸ“‹ ì»¬ëŸ¼: ë¬¸ì œ / ë³´ê¸°1~4 / ì •ë‹µ(ìˆ«ì1~4) / í•´ì„¤</div>
            </div>
            <div class="q-upload-zone" id="ec-q-upload-zone" style="margin-top:9px">
              <input type="file" id="ec-q-excel-file" accept=".xlsx,.xls,.csv" onchange="parseQExcel(this.files[0],'ec')">
              <div style="font-size:22px;margin-bottom:5px">ğŸ“‚</div>
              <div style="font-size:12.5px;font-weight:600;color:var(--navy)">ì—‘ì…€ íŒŒì¼ í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸</div>
              <div style="font-size:11px;color:var(--text-light);margin-top:2px">.xlsx Â· .xls Â· .csv</div>
            </div>
            <div id="ec-q-excel-preview"></div>
          </div>
        </div>
        <div id="ec-q-list"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('modal-edit-course')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="doEditCourse()">ğŸ’¾ ì €ì¥</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script type="module">
import { DB } from './js/firebase-config.js';
import { requireAdmin, isSuper, hasPerm, adminOrg, fmtDate, toYoutubeEmbed, showToast } from './js/utils.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì¸ì¦ & ê¶Œí•œ ì„¸íŒ…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SESSION   = requireAdmin(); if (!SESSION) throw 0;
const SUPER     = isSuper(SESSION);
const ORG_FILTER = adminOrg(SESSION); // null=ì „ì²´(super), 'XX'=ìê¸° íšŒì‚¬ë§Œ

// ê¶Œí•œ ì •ì˜
const ALL_PERMS = [
  // â”€â”€ ëŒ€ì‹œë³´ë“œ â”€â”€
  { key:'overview',    icon:'ğŸ“Š', label:'ì „ì²´ í˜„í™©',      group:'ëŒ€ì‹œë³´ë“œ',   desc:'KPI ì¹´ë“œ Â· ë“±ê¸‰ë³„ í˜„í™© Â· ìµœê·¼ ìˆ˜ë£Œì' },
  // â”€â”€ ìˆ˜ê°•ìƒ ê´€ë¦¬ â”€â”€
  { key:'pending',     icon:'â³', label:'ê°€ì… ìŠ¹ì¸',      group:'ìˆ˜ê°•ìƒ ê´€ë¦¬', desc:'ì‹ ê·œ ê°€ì… ìŠ¹ì¸Â·ê±°ì ˆ' },
  { key:'learners',    icon:'ğŸ‘¥', label:'ìˆ˜ê°•ìƒ ëª©ë¡',    group:'ìˆ˜ê°•ìƒ ê´€ë¦¬', desc:'ìì‚¬ ìˆ˜ê°•ìƒ ì¡°íšŒ Â· ì •ë³´ ì—´ëŒ' },
  { key:'learners_edit',icon:'âœï¸',label:'ìˆ˜ê°•ìƒ ì •ë³´ ìˆ˜ì •',group:'ìˆ˜ê°•ìƒ ê´€ë¦¬', desc:'ìˆ˜ê°•ìƒ ì •ë³´ í¸ì§‘ Â· ë“±ê¸‰ ë³€ê²½' },
  { key:'completions', icon:'ğŸ†', label:'ìˆ˜ë£Œ í˜„í™©',      group:'ìˆ˜ê°•ìƒ ê´€ë¦¬', desc:'ìˆ˜ë£Œì ëª©ë¡ ì¡°íšŒ' },
  // â”€â”€ í†µê³„ â”€â”€
  { key:'stats',       icon:'ğŸ“ˆ', label:'í†µê³„ ë³´ê³ ì„œ',    group:'í†µê³„Â·ì¦ì ', desc:'í†µê³„ í˜ì´ì§€ ì ‘ê·¼ Â· CSV/PDF ì¶œë ¥' },
];

// ë°ì´í„° í•„í„° (org adminì€ ìê¸° íšŒì‚¬ë§Œ)
function filterByOrg(arr, orgField='org') {
  if (!ORG_FILTER) return arr;
  return arr.filter(item => (item[orgField] || '') === ORG_FILTER);
}

// â”€â”€ UI ì—­í•  ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initRoleUI() {
  const badgeEl = document.getElementById('hd-role-badge');
  const nameEl  = document.getElementById('hd-user-name');

  if (SUPER) {
    badgeEl.innerHTML = '<span class="role-badge-super">âš¡ ì‹œìŠ¤í…œ ê´€ë¦¬ì</span>';
  } else {
    badgeEl.innerHTML = '<span class="role-badge-org">ğŸ¢ íšŒì‚¬ ê´€ë¦¬ì</span>';
    nameEl.textContent = `${SESSION.name}  Â·  ${SESSION.org}`;
    // ìˆ˜ê°•ìƒ í™”ë©´ ë²„íŠ¼ ìˆ¨ê¹€
    const lb = document.getElementById('hd-btn-learner');
    if (lb) lb.style.display = 'none';

    // íšŒì‚¬ ë°°ë„ˆ
    const banner = document.getElementById('org-banner');
    if (banner) {
      banner.style.display = '';
      document.getElementById('org-banner-title').textContent =
        `ğŸ¢ ${SESSION.org}  â€”  ${SESSION.name}ë‹˜ (íšŒì‚¬ë³„ ê´€ë¦¬ì í¬í„¸)`;
      // ê·¸ë£¹ë³„ ê¶Œí•œ í‘œì‹œ
      const groups = {};
      ALL_PERMS.forEach(p => { if (!groups[p.group]) groups[p.group]=[]; groups[p.group].push(p); });
      const permHtml = Object.entries(groups).map(([grp, perms]) => {
        const granted = perms.filter(p => hasPerm(SESSION, p.key));
        if (!granted.length) return '';
        return `<span style="margin-right:8px"><strong style="color:var(--kasg-gold)">${grp}:</strong> ${granted.map(p=>p.icon+' '+p.label).join(' Â· ')}</span>`;
      }).filter(Boolean).join('');
      document.getElementById('org-banner-perms').innerHTML =
        permHtml || '<span style="color:rgba(255,255,255,.5)">âš  ë¶€ì—¬ëœ ê¶Œí•œ ì—†ìŒ â€” ì‹œìŠ¤í…œ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”</span>';
    }
  }

  // â”€â”€ ë„¤ë¹„ ë©”ë‰´ ê¶Œí•œ ì œì–´ â”€â”€
  document.querySelectorAll('.nav-item[data-super-only]').forEach(el => {
    if (!SUPER) el.style.display = 'none';
  });
  document.querySelectorAll('.nav-item[data-perm]').forEach(el => {
    const perm = el.dataset.perm;
    if (!hasPerm(SESSION, perm)) {
      el.classList.add('nav-locked');
      el.removeAttribute('onclick');
      el.addEventListener('click', () =>
        showToast(`"${ALL_PERMS.find(p=>p.key===perm)?.label||perm}" ë©”ë‰´ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.`, 'warn'));
    }
  });
  if (!SUPER) {
    const sysLabel = document.getElementById('nav-sec-system');
    if (sysLabel) sysLabel.style.display = 'none';
  }

  // â”€â”€ learners_edit ê¶Œí•œ ì œì–´ (ìˆ˜ê°•ìƒ ìˆ˜ì • ë²„íŠ¼) â”€â”€
  // ê¶Œí•œ ì—†ëŠ” ê²½ìš° ë™ì  ë Œë”ë§ ì‹œ ì²´í¬
  window._canEditLearner = SUPER || hasPerm(SESSION, 'learners_edit');
}

const GRADE_LABEL = { board:'ì´ì‚¬íšŒÂ·ì„ì›', aml:'AML ë‹´ë‹¹ì', general:'ì¼ë°˜', research:'ì—°êµ¬íšŒ' };
const GRADE_COLOR = { board:'#C8960A', aml:'#1A3EA0', general:'#5A6070', research:'#C8302A' };
const VALID_GRADES= new Set(['board','aml','general','research']);

let allLearners=[], allCourses={}, allCompletions=[], allOrgAdmins={};
let assignTargetId='', resetTargetId='';
let bulkGrades=new Set();
let parsedRows=[];

function gradePill(g){
  const cls={board:'gp-board',aml:'gp-aml',general:'gp-general',research:'gp-research'}[g]||'gp-general';
  const icon={board:'ğŸ›',aml:'ğŸ”',general:'ğŸ‘¤',research:'ğŸ“'}[g]||'ğŸ‘¤';
  return `<span class="gp ${cls}">${icon} ${GRADE_LABEL[g]||g}</span>`;
}

// â”€â”€ Default Question Bank (fallback / import source) â”€â”€
const DEFAULT_BANK_QUESTIONS = [
  {q:"ìê¸ˆì„¸íƒë°©ì§€(AML)ì˜ ì£¼ìš” ëª©ì ìœ¼ë¡œ ê°€ì¥ ì ì ˆí•œ ê²ƒì€?",opts:["ë²”ì£„ ìˆ˜ìµì˜ í•©ë²•í™”ë¥¼ ì°¨ë‹¨í•˜ì—¬ ê¸ˆìœµì‹œìŠ¤í…œ ê±´ì „ì„± ë³´í˜¸","ê³ ê° ì„œë¹„ìŠ¤ í’ˆì§ˆ í–¥ìƒ","ê¸ˆìœµê¸°ê´€ì˜ ìˆ˜ìµ ì¦ëŒ€","ì§ì› êµìœ¡ ë¹„ìš© ì ˆê°"],ans:0,explanation:"AMLì˜ í•µì‹¬ ëª©ì ì€ ë²”ì£„ ìˆ˜ìµì´ í•©ë²•ì ì¸ ê¸ˆìœµì‹œìŠ¤í…œìœ¼ë¡œ ìœ ì…ë˜ëŠ” ê²ƒì„ ì°¨ë‹¨í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤."},
  {q:"FATF ê¶Œê³ ì‚¬í•­ì—ì„œ ê·œì •í•˜ëŠ” ê³ ê°í™•ì¸ì œë„(CDD)ì˜ í•µì‹¬ ìš”ì†Œê°€ ì•„ë‹Œ ê²ƒì€?",opts:["ê³ ê° ì‹ ì› í™•ì¸","ì‹¤ì†Œìœ ì íŒŒì•…","ì§€ì†ì ì¸ ëª¨ë‹ˆí„°ë§","ë°°ë‹¹ê¸ˆ ì§€ê¸‰ ì—¬ë¶€ í™•ì¸"],ans:3,explanation:"CDDì˜ í•µì‹¬ ìš”ì†ŒëŠ” ì‹ ì›í™•ì¸, ì‹¤ì†Œìœ ì íŒŒì•…, ì§€ì†ì  ëª¨ë‹ˆí„°ë§ì…ë‹ˆë‹¤."},
  {q:"ì˜ì‹¬ê±°ë˜ë³´ê³ (STR)ë¥¼ ì œì¶œí•´ì•¼ í•˜ëŠ” ìš”ê±´ìœ¼ë¡œ ì˜¬ë°”ë¥¸ ê²ƒì€?",opts:["ì¼ì • ê¸ˆì•¡ ì´ìƒì˜ ê±°ë˜ ë°œìƒ ì‹œ ë¬´ì¡°ê±´ ë³´ê³ ","ìê¸ˆì„¸íƒ ë“± ìœ„ë²•í–‰ìœ„ì™€ ê´€ë ¨ëœë‹¤ê³  ì˜ì‹¬ë˜ëŠ” ê²½ìš°","ê³ ê°ì´ ì§ì ‘ ìš”ì²­í•  ê²½ìš°","ê¸ˆìœµê°ë…ì›ì˜ ì‚¬ì „ ìŠ¹ì¸ì„ ë°›ì€ ê²½ìš°"],ans:1,explanation:"STRì€ ê¸ˆì•¡ ê¸°ì¤€ì´ ì•„ë‹Œ ì˜ì‹¬ ì—¬ë¶€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³´ê³ í•©ë‹ˆë‹¤."},
  {q:"ê°•í™”ëœ ê³ ê°í™•ì¸(EDD)ì´ ì ìš©ë˜ì–´ì•¼ í•˜ëŠ” ëŒ€ìƒìœ¼ë¡œ ê°€ì¥ ì ì ˆí•œ ê²ƒì€?",opts:["ì¼ë°˜ ì›”ê¸‰ìƒí™œì","ì •ì¹˜ì  ì£¼ìš”ì¸ë¬¼(PEP)","ë‹¨ìˆœ í™˜ì „ ê³ ê°","ì†Œì•¡ ê²Œì„ ì´ìš©ì"],ans:1,explanation:"PEPëŠ” ë¶€íŒ¨ ìœ„í—˜ì´ ë†’ì•„ ê°•í™”ëœ ê³ ê°í™•ì¸ ëŒ€ìƒì…ë‹ˆë‹¤."},
  {q:"ìê¸ˆì„¸íƒì˜ 3ë‹¨ê³„ ì¤‘ 'í†µí•©(Integration)' ë‹¨ê³„ì˜ íŠ¹ì§•ì€?",opts:["ë²”ì£„ ìˆ˜ìµì„ ê¸ˆìœµì‹œìŠ¤í…œì— ìµœì´ˆ ìœ ì…ì‹œí‚¤ëŠ” ë‹¨ê³„","ì„¸íƒëœ ìê¸ˆì„ í•©ë²•ì ì¸ ìì‚°ì²˜ëŸ¼ ê²½ì œì— ì¬íˆ¬ì…í•˜ëŠ” ë‹¨ê³„","ìê¸ˆ ì¶œì²˜ë¥¼ ì€íí•˜ê¸° ìœ„í•´ ë³µì¡í•œ ê±°ë˜ë¥¼ ë§Œë“œëŠ” ë‹¨ê³„","ê¸ˆìœµê¸°ê´€ì— ì˜ì‹¬ê±°ë˜ë¥¼ ë³´ê³ í•˜ëŠ” ë‹¨ê³„"],ans:1,explanation:"í†µí•© ë‹¨ê³„ëŠ” ì„¸íƒëœ ìê¸ˆì„ ì •ìƒ ê²½ì œì— ì¬ìœ ì…ì‹œí‚¤ëŠ” ë§ˆì§€ë§‰ ë‹¨ê³„ì…ë‹ˆë‹¤."},
  {q:"ê³ ì•¡í˜„ê¸ˆê±°ë˜ë³´ê³ (CTR) ê¸°ì¤€ ê¸ˆì•¡ì€?",opts:["500ë§Œì› ì´ìƒ","1,000ë§Œì› ì´ìƒ","2,000ë§Œì› ì´ìƒ","5,000ë§Œì› ì´ìƒ"],ans:3,explanation:"í•œêµ­ì˜ CTR ê¸°ì¤€ì€ 5,000ë§Œì› ì´ìƒì…ë‹ˆë‹¤."},
  {q:"ì¹´ì§€ë…¸ AML ëª¨ë‹ˆí„°ë§ì—ì„œ ì£¼ì˜í•´ì•¼ í•  'ë¹„ì •ìƒì  í–‰ë™ íŒ¨í„´'ì€?",opts:["ì •í•´ì§„ í•œë„ ë‚´ì—ì„œ ê·œì¹™ì ìœ¼ë¡œ ê²Œì„","ì†Œì•¡ í™˜ì „ í›„ ì¦‰ì‹œ ì¶œêµ¬","ê³ ì•¡ í˜„ê¸ˆì„ ì§€ì†ì ìœ¼ë¡œ ì¹©ìœ¼ë¡œ êµí™˜í•˜ê³  ëŒ€ë¶€ë¶„ í™˜ì „ í›„ ë°˜í™˜","ì‹ ë¶„ì¦ ì œì‹œ í›„ ì •ìƒì ì¸ ê²Œì„ ì§„í–‰"],ans:2,explanation:"ê²Œì„ ì—†ì´ ì¹©ì„ í˜„ê¸ˆìœ¼ë¡œ êµí™˜í•˜ëŠ” íŒ¨í„´ì€ ìê¸ˆì„¸íƒ ì˜ì‹¬ í–‰ìœ„ì…ë‹ˆë‹¤."},
  {q:"ê¸ˆìœµì •ë³´ë¶„ì„ì›(KoFIU)ì˜ ì£¼ìš” ì—­í• ì€?",opts:["ê¸ˆìœµê¸°ê´€ì— ëŒ€í•œ ì§ì ‘ ì˜ì—… ì§€ë„","ì˜ì‹¬ê±°ë˜ë³´ê³  ì •ë³´ ìˆ˜ì§‘Â·ë¶„ì„ ë° ìˆ˜ì‚¬ê¸°ê´€ ì œê³µ","ì™¸í™˜ê±°ë˜ ì§ì ‘ ê·œì œ","ê³ ê° ì‹ ìš©ë“±ê¸‰ í‰ê°€"],ans:1,explanation:"KoFIUëŠ” ê¸ˆìœµì •ë³´ ìˆ˜ì§‘Â·ë¶„ì„ê¸°ê´€ìœ¼ë¡œ ìˆ˜ì‚¬ê¸°ê´€ì— ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤."},
  {q:"'ìœ„í—˜ ê¸°ë°˜ ì ‘ê·¼ë²•(RBA)'ì˜ í•µì‹¬ ì›ì¹™ì€?",opts:["ëª¨ë“  ê³ ê°ì—ê²Œ ë™ì¼í•œ ìˆ˜ì¤€ì˜ í™•ì¸ ì ˆì°¨ ì ìš©","ê³ ìœ„í—˜ ê³ ê°ê³¼ ê±°ë˜ì— ë” ë§ì€ ìì› ì§‘ì¤‘","ì €ìœ„í—˜ ê³ ê°ì—ê²ŒëŠ” ì•„ë¬´ëŸ° í™•ì¸ ì ˆì°¨ ë¶ˆí•„ìš”","ìœ„í—˜ë„ì™€ ë¬´ê´€í•˜ê²Œ ì •í˜•í™”ëœ ì ˆì°¨ ì¤€ìˆ˜"],ans:1,explanation:"RBAëŠ” ìœ„í—˜ë„ì— ë¹„ë¡€í•˜ì—¬ ìì›ì„ ë°°ë¶„í•˜ëŠ” ì›ì¹™ì…ë‹ˆë‹¤."},
  {q:"í…ŒëŸ¬ìê¸ˆì¡°ë‹¬ ë°©ì§€(CFT)ì™€ ìê¸ˆì„¸íƒë°©ì§€(AML)ì˜ ì°¨ì´ì ìœ¼ë¡œ ì˜³ì€ ê²ƒì€?",opts:["CFTëŠ” ë¶ˆë²• ìˆ˜ìµì˜ í•©ë²•í™”ë¥¼ ë°©ì§€í•˜ê³ , AMLì€ í…ŒëŸ¬ ëª©ì ì˜ ìê¸ˆ ì´ë™ì„ ì°¨ë‹¨","AMLì€ ë¶ˆë²• ìˆ˜ìµì˜ í•©ë²•í™”ë¥¼ ë°©ì§€í•˜ê³ , CFTëŠ” í…ŒëŸ¬ ëª©ì ì˜ ìê¸ˆ ì´ë™ì„ ì°¨ë‹¨","ë‘ ê°œë…ì€ ë™ì¼í•œ ì˜ë¯¸","CFTëŠ” êµ­ë‚´ë²•ì´ê³ , AMLì€ êµ­ì œë²•"],ans:1,explanation:"AMLì€ ë¶ˆë²•ìê¸ˆ ì„¸íƒ ë°©ì§€, CFTëŠ” í…ŒëŸ¬ ëª©ì  ìê¸ˆ ì´ë™ ì°¨ë‹¨ì…ë‹ˆë‹¤."},
  {q:"'ì‹¤ì†Œìœ ì(UBO)'ì˜ ê¸°ì¤€ì€?",opts:["íšŒì‚¬ ì§€ë¶„ 5% ì´ìƒ ë³´ìœ ì","íšŒì‚¬ ì§€ë¶„ 25% ì´ìƒì„ ì§Â·ê°„ì ‘ì ìœ¼ë¡œ ë³´ìœ í•˜ê±°ë‚˜ ê²½ì˜ì„ ì‹¤ì§ˆì ìœ¼ë¡œ ì§€ë°°í•˜ëŠ” ì","ë“±ê¸°ì´ì‚¬ ì „ì›","ì£¼ìš” ê±°ë˜ì²˜ ë‹´ë‹¹ì"],ans:1,explanation:"UBOëŠ” 25% ì´ìƒ ì§€ë¶„ ë³´ìœ  ë˜ëŠ” ì‹¤ì§ˆ ì§€ë°°ìë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤."},
  {q:"'ê±°ë˜ ëª¨ë‹ˆí„°ë§(Transaction Monitoring)'ì˜ ëª©ì ì€?",opts:["ê³ ê°ì˜ ìì‚° ì¦ëŒ€ë¥¼ ë•ê¸° ìœ„í•œ íˆ¬ì ë¶„ì„","ë¹„ì •ìƒì ì¸ ê±°ë˜ íŒ¨í„´ì„ íƒì§€í•˜ì—¬ ì˜ì‹¬ê±°ë˜ë¥¼ ì‹ë³„","ê³ ê° ì„œë¹„ìŠ¤ ë§Œì¡±ë„ ì¸¡ì •","ê¸ˆìœµê¸°ê´€ì˜ ìˆ˜ìµì„± ë¶„ì„"],ans:1,explanation:"ê±°ë˜ ëª¨ë‹ˆí„°ë§ì€ ë¹„ì •ìƒ íŒ¨í„´ íƒì§€ë¥¼ í†µí•´ ì˜ì‹¬ê±°ë˜ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤."},
  {q:"ìê¸ˆì„¸íƒì˜ 'ë°°ì¹˜(Placement)' ë‹¨ê³„ì—ì„œ í”íˆ ì‚¬ìš©ë˜ëŠ” ìˆ˜ë²•ì€?",opts:["ë²•ì¸ ì„¤ë¦½ í›„ ì •ìƒì ì¸ ì‚¬ì—… í™œë™ìœ¼ë¡œ ìœ„ì¥","ìŠ¤ë¨¸í•‘(Smurfing): ëŒ€ê·œëª¨ í˜„ê¸ˆì„ ì†Œì•¡ìœ¼ë¡œ ë¶„ì‚° ì…ê¸ˆ","ë¶€ë™ì‚° íˆ¬ìë¥¼ í†µí•œ í•©ë²•ì  ìì‚°í™”","ì£¼ì‹ ë¶„ì‚° íˆ¬ì"],ans:1,explanation:"ìŠ¤ë¨¸í•‘ì€ ë³´ê³  ì˜ë¬´ë¥¼ íšŒí”¼í•˜ê¸° ìœ„í•´ ì†Œì•¡ìœ¼ë¡œ ë¶„ì‚° ì…ê¸ˆí•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤."},
  {q:"AML ì˜ì‹¬ê±°ë˜ë³´ê³ (STR) ì œì¶œ í›„ ì ì ˆí•œ í–‰ë™ì€?",opts:["ë³´ê³  ì‚¬ì‹¤ì„ ê³ ê°ì—ê²Œ ì¦‰ì‹œ ì•Œë¦¼","ë³´ê³  ì‚¬ì‹¤ì„ ëŒ€ì™¸ë¹„ë¡œ ìœ ì§€ (Tipping-off ê¸ˆì§€)","SNSì— ì˜ì‹¬ ê±°ë˜ ë‚´ìš© ê³µìœ ","ì–¸ë¡ ì‚¬ì— ì •ë³´ ì œê³µ"],ans:1,explanation:"Tipping-off ê¸ˆì§€ ì›ì¹™ì— ë”°ë¼ ë³´ê³  ì‚¬ì‹¤ì€ ì ˆëŒ€ ê³ ê°ì—ê²Œ ì•Œë¦¬ë©´ ì•ˆë©ë‹ˆë‹¤."},
  {q:"FATF ë¹„í˜‘ì¡° êµ­ê°€ì™€ì˜ ê±°ë˜ ì‹œ ì·¨í•´ì•¼ í•  ì¡°ì¹˜ëŠ”?",opts:["ê±°ë˜ë¥¼ ì™„ì „íˆ ê¸ˆì§€","ê°•í™”ëœ ê³ ê°í™•ì¸(EDD) ì ˆì°¨ ì ìš© ë° ìœ„í—˜ í‰ê°€ ê°•í™”","ì¼ë°˜ì ì¸ CDD ì ìš©ìœ¼ë¡œ ì¶©ë¶„","ê¸ˆìœµì •ë³´ë¶„ì„ì›ì— ì‚¬ì „ ìŠ¹ì¸ ìš”ì²­"],ans:1,explanation:"FATF ê³ ìœ„í—˜ êµ­ê°€ëŠ” EDD ì ˆì°¨ë¥¼ ê°•í™”í•˜ì—¬ ì ìš©í•´ì•¼ í•©ë‹ˆë‹¤."},
  {q:"ì¹´ì§€ë…¸ì—ì„œ ê³ ê°ì´ ëŒ€ê·œëª¨ í˜„ê¸ˆìœ¼ë¡œ ì¹©ì„ êµ¬ë§¤ í›„ ê²Œì„ ì—†ì´ í™˜ì „ì„ ìš”ì²­í•˜ëŠ” í–‰ìœ„ëŠ”?",opts:["ì •ìƒì ì¸ ê²Œì„ í™œë™","ìê¸ˆì„¸íƒ ì˜ì‹¬ í–‰ìœ„ë¡œ ë³´ê³  ëŒ€ìƒ","ì„¸ê¸ˆ ì ˆì•½ì„ ìœ„í•œ í•©ë²•ì  í–‰ìœ„","ì¹´ì§€ë…¸ ë³´ë„ˆìŠ¤ ìˆ˜ë ¹ì„ ìœ„í•œ í–‰ìœ„"],ans:1,explanation:"ê²Œì„ ì—†ì´ ì¹©ì„ í˜„ê¸ˆìœ¼ë¡œ í™˜ì „í•˜ëŠ” ê²ƒì€ ì „í˜•ì ì¸ ìê¸ˆì„¸íƒ ì˜ì‹¬ í–‰ìœ„ì…ë‹ˆë‹¤."},
  {q:"'ê³ ê° ì•Œê¸° ì œë„(KYC)'ì—ì„œ í•„ìˆ˜ì ìœ¼ë¡œ í™•ì¸í•´ì•¼ í•˜ëŠ” ì •ë³´ëŠ”?",opts:["ê³ ê°ì˜ ì·¨ë¯¸ ë° ì—¬ê°€ í™œë™","ê³ ê°ì˜ ì‹ ì›, ê±°ë˜ ëª©ì , ìê¸ˆ ì¶œì²˜","ê³ ê°ì˜ í•™ë ¥ ë° ê²½ë ¥ ì‚¬í•­","ê³ ê°ì˜ ê°€ì¡± êµ¬ì„±ì› ìˆ˜"],ans:1,explanation:"KYCì˜ í•µì‹¬ì€ ì‹ ì›, ê±°ë˜ ëª©ì , ìê¸ˆ ì¶œì²˜ í™•ì¸ì…ë‹ˆë‹¤."},
  {q:"AML 'ì œì¬(Sanctions) ìŠ¤í¬ë¦¬ë‹'ì˜ ëª©ì ì€?",opts:["ê³ ê° ì‹ ìš© ë“±ê¸‰ í™•ì¸","ì œì¬ ëŒ€ìƒìœ¼ë¡œ ì§€ì •ëœ ê°œì¸Â·ë²•ì¸Â·êµ­ê°€ì™€ì˜ ê±°ë˜ ì°¨ë‹¨","ì„¸ê¸ˆ ë‚©ë¶€ ì—¬ë¶€ í™•ì¸","ê³ ê° íˆ¬ì ì„±í–¥ ë¶„ì„"],ans:1,explanation:"ì œì¬ ìŠ¤í¬ë¦¬ë‹ì€ ì œì¬ ëŒ€ìƒê³¼ì˜ ê±°ë˜ë¥¼ ì‚¬ì „ì— ì°¨ë‹¨í•˜ê¸° ìœ„í•œ ì ˆì°¨ì…ë‹ˆë‹¤."},
  {q:"'ìŠ¤íŠ¸ëŸ­ì²˜ë§(Structuring)'ì´ë€ AML ê´€ì ì—ì„œ ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ”ê°€?",opts:["ê¸ˆìœµ ìƒí’ˆì„ êµ¬ì¡°í™”í•˜ì—¬ íˆ¬ì ìˆ˜ìµì„ ê·¹ëŒ€í™”í•˜ëŠ” í–‰ìœ„","ë³´ê³  ì˜ë¬´ íšŒí”¼ë¥¼ ìœ„í•´ ëŒ€ê·œëª¨ ê±°ë˜ë¥¼ ì†Œì•¡ìœ¼ë¡œ ë¶„ì‚°í•˜ëŠ” í–‰ìœ„","ë³µì¡í•œ ê¸°ì—… êµ¬ì¡°ë¥¼ í†µí•œ ì„¸ê¸ˆ ì ˆê°","íŒŒìƒìƒí’ˆì„ í™œìš©í•œ ìœ„í—˜ í—¤ì§€"],ans:1,explanation:"ìŠ¤íŠ¸ëŸ­ì²˜ë§ì€ ë³´ê³  ê¸°ì¤€ì•¡ì„ í”¼í•˜ê¸° ìœ„í•´ ê±°ë˜ë¥¼ ì†Œì•¡ìœ¼ë¡œ ë¶„ì‚°í•˜ëŠ” í–‰ìœ„ì…ë‹ˆë‹¤."},
  {q:"ë‹¤ìŒ ì¤‘ ìê¸ˆì„¸íƒ ì˜ì‹¬ ì§•í›„ì— í•´ë‹¹í•˜ëŠ” ê²ƒì€?",opts:["ì‹ ë¶„ì¦ ì œì‹œ í›„ ì •ìƒì ì¸ ê¸ˆì•¡ì„ ì…ê¸ˆ","ì¶œì²˜ë¥¼ ì„¤ëª…í•˜ì§€ ëª»í•˜ëŠ” ëŒ€ê·œëª¨ í˜„ê¸ˆ ê±°ë˜","ì •ê¸°ì ì¸ ê¸‰ì—¬ ì´ì²´","ì†Œì•¡ í•´ì™¸ ì†¡ê¸ˆ"],ans:1,explanation:"ìê¸ˆ ì¶œì²˜ë¥¼ ì„¤ëª…í•˜ì§€ ëª»í•˜ëŠ” ëŒ€ê·œëª¨ í˜„ê¸ˆ ê±°ë˜ëŠ” ëŒ€í‘œì ì¸ ì˜ì‹¬ ì§•í›„ì…ë‹ˆë‹¤."},
  {q:"ì¹´ì§€ë…¸ ì—…ê¶Œì—ì„œ ìê¸ˆì„¸íƒ ìœ„í—˜ì´ ë†’ì€ ì´ìœ ë¡œ ê°€ì¥ ì ì ˆí•˜ì§€ ì•Šì€ ê²ƒì€?",opts:["í˜„ê¸ˆ ê±°ë˜ ë¹„ì¤‘ì´ ë†’ìŒ","ìµëª…ì„±ì´ ë³´ì¥ë˜ëŠ” ê²½ìš°ê°€ ìˆìŒ","ì¹©ê³¼ í˜„ê¸ˆ êµí™˜ ê³¼ì •ì—ì„œ ìê¸ˆ ì¶œì²˜ ì€í ê°€ëŠ¥","24ì‹œê°„ ëª¨ë“  ê±°ë˜ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³´ê³ í•˜ëŠ” ì²´ê³„ê°€ ì—†ìŒ"],ans:3,explanation:"ì‹¤ì‹œê°„ ë³´ê³  ì²´ê³„ ë¯¸ë¹„ëŠ” ìœ„í—˜ ì›ì¸ ì¤‘ í•˜ë‚˜ì´ì§€ë§Œ, ê°€ì¥ ì§ì ‘ì ì¸ ì´ìœ ë¡œëŠ” ë¶€ì ì ˆí•©ë‹ˆë‹¤."}
];

// â”€â”€ Navigation â”€â”€
window.go=function(el){
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.querySelectorAll('.content-sec').forEach(s=>s.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('sec-'+el.dataset.sec).classList.add('active');
  const m={overview:'loadOverview',pending:'loadPending',learners:'loadLearners',
    assign:'loadAssign',completions:'loadCompletions',courses:'loadCourses',
    'bulk-register':'loadBulkRegister','add-course':'initAddCourseForm',
    'settings':'loadSettings',
    'org-admins':'loadOrgAdmins'};
  if(m[el.dataset.sec]) window[m[el.dataset.sec]]();
};
window.openStats=function(){
  if(!hasPerm(SESSION,'stats')){showToast('í†µê³„ ë³´ê³ ì„œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.','warn');return;}
  const url=ORG_FILTER?`stats.html?org=${encodeURIComponent(ORG_FILTER)}`:'stats.html';
  window.open(url,'_blank');
};
window.adminLogout=()=>{sessionStorage.removeItem('kasg_admin');window.location.href='admin-login.html';};
window.closeModal=id=>document.getElementById(id).classList.add('hidden');

async function fetchAll(){
  const[ld,cd,cmp,oad]=await Promise.all([
    DB.get('learners'),DB.get('courses'),DB.get('completions'),DB.get('orgAdmins')
  ]);
  allLearners   =ld ?Object.entries(ld).map(([id,v])=>({...v,_id:id})):[];
  allCourses    =cd ||{};
  allCompletions=cmp?Object.values(cmp).sort((a,b)=>new Date(b.date)-new Date(a.date)):[];
  allOrgAdmins  =oad||{};
}

// â”€â”€ OVERVIEW â”€â”€
window.loadOverview=async function(){
  await fetchAll();
  // íšŒì‚¬ë³„ ê´€ë¦¬ìëŠ” ìê¸° íšŒì‚¬ ë°ì´í„°ë§Œ
  const baseL = filterByOrg(allLearners);
  const baseC = ORG_FILTER ? allCompletions.filter(c=>c.org===ORG_FILTER) : allCompletions;

  const approved=baseL.filter(l=>l.status!=='pending'&&l.status!=='rejected');
  const pending =allLearners.filter(l=>l.status==='pending'); // pendingì€ ì „ì²´(superê°€ ì²˜ë¦¬)
  const done    =approved.filter(l=>l.completedStatus==='completed'||l.status==='completed');
  const rate    =approved.length?Math.round(done.length/approved.length*100):0;

  document.getElementById('ov-total').textContent   = approved.length;
  document.getElementById('ov-pending').textContent = SUPER ? pending.length : '-';
  document.getElementById('ov-done').textContent    = done.length;
  document.getElementById('ov-rate').textContent    = rate+'%';
  if(SUPER) document.getElementById('pending-cnt').textContent = pending.length;

  const grades=['board','aml','general','research'];
  document.getElementById('grade-stats').innerHTML=grades.map(g=>{
    const m=approved.filter(l=>l.grade===g);
    const d=m.filter(l=>l.completedStatus==='completed'||l.status==='completed').length;
    return `<div class="stat-card" style="border-left-color:${GRADE_COLOR[g]}"><div class="stat-value" style="font-size:26px">${m.length}</div>
      <div class="stat-label">${gradePill(g)}<br><span style="font-size:10px;color:var(--text-light)">ìˆ˜ë£Œ ${d}ëª…</span></div></div>`;
  }).join('');

  document.getElementById('ov-recent').innerHTML=baseC.slice(0,6).map(c=>
    `<tr><td><strong>${c.name}</strong></td><td>${gradePill(c.grade||'general')}</td><td>${c.org||'-'}</td>
    <td style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.courseTitle||'-'}</td>
    <td><span class="badge badge-success">${c.score}ì </span></td>
    <td style="font-size:10.5px;color:var(--text-light)">${fmtDate(new Date(c.date))}</td></tr>`
  ).join('')||'<tr class="empty-row"><td colspan="6">ìˆ˜ë£Œì ì—†ìŒ</td></tr>';
};

// â”€â”€ PENDING â”€â”€
window.loadPending=async function(){
  await fetchAll();
  const pending=allLearners.filter(l=>l.status==='pending');
  document.getElementById('pending-cnt').textContent=pending.length;
  document.getElementById('pending-tbody').innerHTML=pending.length
    ?pending.map(l=>`<tr>
      <td><strong>${l.name}</strong></td>
      <td style="font-family:'DM Mono',monospace;font-size:10.5px">${l._id}</td>
      <td>${l.org||'-'}</td><td>${l.dept||'-'}</td><td>${l.phone||'-'}</td>
      <td style="font-size:10.5px;color:var(--text-light)">${fmtDate(new Date(l.createdAt||Date.now()))}</td>
      <td style="text-align:center"><div style="display:flex;gap:5px;justify-content:center">
        <button class="tbl-btn tb-approve" onclick="approveLearner('${l._id}','${l.name}')">âœ… ìŠ¹ì¸</button>
        <button class="tbl-btn tb-reject"  onclick="rejectLearner('${l._id}','${l.name}')">âŒ ê±°ì ˆ</button>
      </div></td></tr>`)
    .join(''):'<tr class="empty-row"><td colspan="7">ìŠ¹ì¸ ëŒ€ê¸° ì—†ìŒ</td></tr>';
};
window.approveLearner=async function(id,name){
  if(!confirm(`${name}ë‹˜ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  await DB.update(`learners/${id}`,{status:'approved',approved:true,approvedAt:new Date().toISOString()});
  showToast(`${name}ë‹˜ ìŠ¹ì¸ ì™„ë£Œ`,'success');loadPending();loadOverview();
};
window.rejectLearner=async function(id,name){
  if(!confirm(`${name}ë‹˜ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  await DB.update(`learners/${id}`,{status:'rejected'});
  showToast('ê±°ì ˆ ì²˜ë¦¬ ì™„ë£Œ','warn');loadPending();
};

// â”€â”€ LEARNERS â”€â”€
window.loadLearners=async function(){
  await fetchAll();
  // Populate org filter
  const orgs=[...new Set(allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected').map(l=>l.org||'').filter(Boolean))].sort();
  const sel=document.getElementById('lf-org');
  sel.innerHTML='<option value="">ì „ì²´ ê¸°ê´€</option>'+orgs.map(o=>`<option value="${o}">${o}</option>`).join('');
  renderLearners(allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected'));
};
function renderLearners(list){
  document.getElementById('learners-tbody').innerHTML=list.length?list.map(l=>{
    const prog=Math.round((l.progress||0)*100);
    const score=l.finalScore!=null?l.finalScore+'ì ':'-';
    const st=l.completedStatus||l.status||'approved';
    const bCls=st==='completed'?'badge-success':st==='in_progress'||st==='watched'?'badge-warn':'badge-neutral';
    const bLbl=st==='completed'?'ìˆ˜ë£Œ':st==='in_progress'||st==='watched'?'ìˆ˜ê°•ì¤‘':'ë¯¸ì‹œì‘';
    return `<tr>
      <td><strong>${l.name}</strong><br><span style="font-size:10px;color:var(--text-light);font-family:'DM Mono',monospace">${l._id}</span></td>
      <td>${gradePill(l.grade||'general')}</td>
      <td>${l.org||'-'}${l.dept?'<br><span style="font-size:10px;color:var(--text-light)">'+l.dept+'</span>':''}</td>
      <td style="font-size:11px;color:var(--text-mid)">${l.email?`<a href="mailto:${l.email}" style="color:var(--kasg-blue)">${l.email}</a>`:'<span style="color:var(--error);font-size:10px">ë¯¸ë“±ë¡</span>'}</td>
      <td><span class="badge badge-info">${(l.assignedCourses||[]).length}ê°œ</span></td>
      <td><div style="display:flex;align-items:center;gap:6px">
        <div class="progress-wrap" style="height:4px;width:55px"><div class="progress-fill" style="width:${prog}%"></div></div>
        <span style="font-size:10.5px;color:var(--text-mid)">${prog}%</span></div></td>
      <td>${score}</td>
      <td><span class="badge ${bCls}">${bLbl}</span></td>
      <td style="font-size:10px;color:var(--text-light)">${fmtDate(new Date(l.createdAt||Date.now()))}</td>
      <td><div style="display:flex;gap:3px;flex-wrap:wrap;justify-content:center">
        ${window._canEditLearner ? `<button class="tbl-btn tb-edit"   onclick="openEditLearner('${l._id}')">âœï¸ ì •ë³´Â·ë“±ê¸‰</button>` : ''}
        ${SUPER ? `<button class="tbl-btn tb-assign" onclick="openAssign('${l._id}')">ğŸ“‹ ë°°ì •</button>` : ''}
        ${window._canEditLearner ? `<button class="tbl-btn tb-pw"     onclick="openResetPw('${l._id}','${l.name}')">ğŸ”‘</button>` : ''}
        ${SUPER ? `<button class="tbl-btn tb-reset"  onclick="resetProgress('${l._id}','${l.name}')">ğŸ”„</button>` : ''}
        ${SUPER ? `<button class="tbl-btn tb-delete" onclick="deleteLearner('${l._id}','${l.name}')">ğŸ—‘</button>` : ''}
        ${!window._canEditLearner && !SUPER ? '<span style="font-size:11px;color:var(--text-light)">ì—´ëŒ ì „ìš©</span>' : ''}
      </div></td></tr>`;
  }).join(''):'<tr class="empty-row"><td colspan="10">ìˆ˜ê°•ìƒ ì—†ìŒ</td></tr>';
}
window.filterLearners=function(){
  const q=document.getElementById('lf-search').value.toLowerCase();
  const gr=document.getElementById('lf-grade').value;
  const org=document.getElementById('lf-org').value;
  const st=document.getElementById('lf-status').value;
  renderLearners(allLearners.filter(l=>{
    if(l.status==='pending'||l.status==='rejected') return false;
    if(gr&&l.grade!==gr) return false;
    if(org&&l.org!==org) return false;
    if(st){const s=l.completedStatus||l.status||'approved';
      if(st==='completed'&&s!=='completed') return false;
      if(st==='in_progress'&&s!=='in_progress'&&s!=='watched') return false;
      if(st==='approved'&&s!=='approved') return false;
    }
    return !q||l.name?.toLowerCase().includes(q)||l.org?.toLowerCase().includes(q)||(l._id||'').toLowerCase().includes(q);
  }));
};

// â”€â”€ Edit Learner / Grade â”€â”€
window.openEditLearner=function(id){
  const l=allLearners.find(x=>x._id===id);if(!l)return;
  document.getElementById('el-id').value    =id;
  document.getElementById('el-name').value  =l.name||'';
  document.getElementById('el-org').value   =l.org||'';
  document.getElementById('el-dept').value  =l.dept||'';
  document.getElementById('el-phone').value =l.phone||'';
  document.getElementById('el-email').value =l.email||'';
  document.querySelectorAll('#el-grade-grid input[name="el-grade"]').forEach(r=>{r.checked=r.value===(l.grade||'general');});
  document.getElementById('modal-edit-learner').classList.remove('hidden');
};
window.doEditLearner=async function(){
  const id   =document.getElementById('el-id').value;
  const name =document.getElementById('el-name').value.trim();
  const org  =document.getElementById('el-org').value.trim();
  const dept =document.getElementById('el-dept').value.trim();
  const phone=document.getElementById('el-phone').value.trim();
  const email=document.getElementById('el-email').value.trim();
  const grade=document.querySelector('#el-grade-grid input[name="el-grade"]:checked')?.value||'general';
  await DB.update(`learners/${id}`,{name,org,dept,phone,email,grade,gradeLabel:GRADE_LABEL[grade]});
  showToast('ìˆ˜ì • ì™„ë£Œ','success');closeModal('modal-edit-learner');loadLearners();
};

// â”€â”€ PW Reset â”€â”€
window.openResetPw=function(id,name){resetTargetId=id;document.getElementById('rp-name').textContent=name;document.getElementById('rp-new').value='kasg1234';document.getElementById('modal-reset-pw').classList.remove('hidden');};
window.doResetPw=async function(){
  const pw=document.getElementById('rp-new').value.trim();
  if(!pw||pw.length<4){alert('4ì ì´ìƒ');return;}
  await DB.update(`learners/${resetTargetId}`,{pw});
  showToast('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì™„ë£Œ','success');closeModal('modal-reset-pw');
};

// â”€â”€ Reset Progress â”€â”€
window.resetProgress=async function(id,name){
  if(!confirm(`${name}ë‹˜ì˜ ìˆ˜ê°• ì§„ë„ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆê¹Œ?`))return;
  await DB.update(`learners/${id}`,{progress:0,midQuizCorrect:0,midQuizTotal:0,finalScore:null,finalPassed:null,attempt:0,completedStatus:null,certNo:null,certDate:null,courseProgress:null,courseStatus:null,midAnswered:null,courseCerts:null,generatedQuizzes:null});
  showToast('ì§„ë„ ì´ˆê¸°í™” ì™„ë£Œ','success');loadLearners();
};

// â”€â”€ Delete â”€â”€
window.deleteLearner=async function(id,name){
  if(!confirm(`${name}ë‹˜ì„ ì™„ì „íˆ ì‚­ì œí•©ë‹ˆê¹Œ?`))return;
  await DB.remove(`learners/${id}`);showToast('ì‚­ì œ ì™„ë£Œ','warn');loadLearners();
};

// â”€â”€ BULK REGISTER (Excel) â”€â”€
window.loadBulkRegister=function(){/* nothing to init */};

window.parseExcel=function(file){
  if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:'binary'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const raw=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    if(raw.length<2){alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');return;}
    // Find header row
    const header=raw[0].map(h=>String(h).trim().toLowerCase());
    const col=k=>header.findIndex(h=>h.includes(k));
    const ci={id:col('ì•„ì´ë””'),name:col('ì„±ëª…'),org:col('ì†Œì†'),dept:col('ë¶€ì„œ'),phone:col('ì—°ë½ì²˜'),grade:col('ë“±ê¸‰'),pw:col('ë¹„ë°€ë²ˆí˜¸')};

    parsedRows=raw.slice(1).filter(r=>r.some(v=>String(v).trim())).map(r=>{
      const id  =String(ci.id  >=0?r[ci.id]  :'').trim().replace(/[.#$[\] ]/g,'_');
      const name=String(ci.name>=0?r[ci.name] :'').trim();
      const org =String(ci.org >=0?r[ci.org]  :'').trim();
      const dept=String(ci.dept>=0?r[ci.dept] :'').trim();
      const phone=String(ci.phone>=0?r[ci.phone]:'').trim();
      const gradeRaw=String(ci.grade>=0?r[ci.grade]:'general').trim().toLowerCase();
      const grade=VALID_GRADES.has(gradeRaw)?gradeRaw:'general';
      const pw  =String(ci.pw>=0?r[ci.pw]:'kasg1234').trim()||'kasg1234';
      const err =!id?'ì•„ì´ë”” ì—†ìŒ':!name?'ì„±ëª… ì—†ìŒ':!org?'ì†Œì† ì—†ìŒ':'';
      return {id,name,org,dept,phone,grade,pw,err,status:'new'};
    });

    // Check duplicates against existing
    const existing=new Set(allLearners.map(l=>l._id));
    parsedRows.forEach(r=>{if(!r.err&&existing.has(r.id)) r.status='dup';});

    const ok=parsedRows.filter(r=>!r.err&&r.status==='new').length;
    const dup=parsedRows.filter(r=>r.status==='dup').length;
    const err=parsedRows.filter(r=>r.err).length;
    document.getElementById('preview-summary').textContent=`ì´ ${parsedRows.length}í–‰ Â· ì‹ ê·œ ${ok}ëª… Â· ì¤‘ë³µ ${dup}ëª… Â· ì˜¤ë¥˜ ${err}ê±´`;
    document.getElementById('ep-tbody').innerHTML=parsedRows.map((r,i)=>{
      const cls=r.err?'err':r.status==='dup'?'err':'ok';
      const stTag=r.err?`<span class="ep-status dup">âš ï¸ ${r.err}</span>`:r.status==='dup'?'<span class="ep-status dup">ì¤‘ë³µ</span>':'<span class="ep-status new">ì‹ ê·œ</span>';
      return `<tr class="${cls}"><td>${i+1}</td><td>${r.id}</td><td>${r.name}</td><td>${r.org}</td><td>${r.dept}</td><td>${r.phone}</td>
        <td>${GRADE_LABEL[r.grade]||r.grade}</td><td style="font-family:'DM Mono',monospace;font-size:11px">${r.pw}</td><td>${stTag}</td></tr>`;
    }).join('');
    document.getElementById('excel-preview').style.display='';
    const uploadBtn=document.getElementById('upload-btn');
    uploadBtn.disabled=ok===0;
    uploadBtn.textContent=`ğŸ“¤ ì‹ ê·œ ${ok}ëª… ë“±ë¡ ì‹¤í–‰`;
  };
  reader.readAsBinaryString(file);
};

window.clearExcel=function(){
  parsedRows=[];
  document.getElementById('excel-file').value='';
  document.getElementById('excel-preview').style.display='none';
  document.getElementById('upload-result').innerHTML='';
};

window.doUpload=async function(){
  const toAdd=parsedRows.filter(r=>!r.err&&r.status==='new');
  if(!toAdd.length){showToast('ë“±ë¡í•  ì‹ ê·œ ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤.','warn');return;}
  if(!confirm(`${toAdd.length}ëª…ì„ ë“±ë¡í•©ë‹ˆê¹Œ?\n- ë“±ê¸‰: ì§€ì •ëœ ë“±ê¸‰ìœ¼ë¡œ ìë™ ì„¤ì •\n- ìƒíƒœ: ìŠ¹ì¸ë¨(ë°”ë¡œ ë¡œê·¸ì¸ ê°€ëŠ¥)`))return;
  const btn=document.getElementById('upload-btn');
  btn.disabled=true;btn.textContent='ë“±ë¡ ì¤‘...';
  let done=0,fail=0;
  for(const r of toAdd){
    try{
      await DB.set(`learners/${r.id}`,{
        id:r.id,name:r.name,org:r.org,dept:r.dept,phone:r.phone,pw:r.pw,
        grade:r.grade,gradeLabel:GRADE_LABEL[r.grade]||'ì¼ë°˜',
        status:'approved',approved:true,approvedAt:new Date().toISOString(),
        assignedCourses:[],progress:0,midQuizCorrect:0,midQuizTotal:0,
        finalScore:null,attempt:0,certNo:null,certDate:null,
        createdAt:new Date().toISOString(),bulkRegistered:true
      });
      done++;
    }catch(e){ fail++; }
  }
  document.getElementById('upload-result').innerHTML=`<div class="alert ${fail?'alert-warn':'alert-success'}">
    âœ… ${done}ëª… ë“±ë¡ ì™„ë£Œ${fail?` Â· âš ï¸ ${fail}ê±´ ì‹¤íŒ¨`:''}</div>`;
  showToast(`${done}ëª… ë“±ë¡ ì™„ë£Œ`,'success');
  btn.disabled=false;btn.textContent='ì™„ë£Œ';
  await fetchAll();// refresh allLearners for dup check
};

window.downloadTemplate=function(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet([
    ['ì•„ì´ë””','ì„±ëª…','ì†Œì†','ë¶€ì„œ','ì—°ë½ì²˜','ë“±ê¸‰','ë¹„ë°€ë²ˆí˜¸'],
    ['hong_gildong','í™ê¸¸ë™','í•œêµ­ì€í–‰','AMLíŒ€','010-1234-5678','aml','kasg1234'],
    ['kim_manager','ê¹€ê´€ë¦¬','ABCìºí”¼íƒˆ','ì¤€ë²•ê°ì‹œ','010-2345-6789','general','kasg1234'],
    ['lee_board','ì´ì´ì‚¬','XYZê¸ˆìœµ','ì´ì‚¬íšŒ','010-3456-7890','board','kasg1234'],
  ]);
  ws['!cols']=[{wch:20},{wch:10},{wch:20},{wch:12},{wch:16},{wch:12},{wch:12}];
  XLSX.utils.book_append_sheet(wb,ws,'ìˆ˜ê°•ìƒëª©ë¡');
  XLSX.writeFile(wb,'KASG_ìˆ˜ê°•ìƒ_ë“±ë¡ì–‘ì‹.xlsx');
};

// â”€â”€ ASSIGN (individual) â”€â”€
window.openAssign=function(id){
  assignTargetId=id;
  const l=allLearners.find(x=>x._id===id);if(!l)return;
  document.getElementById('assign-name').textContent    =l.name;
  document.getElementById('assign-grade-lbl').textContent=GRADE_LABEL[l.grade||'general'];
  const courses=Object.entries(allCourses);
  const current=new Set(l.assignedCourses||[]);
  const deadlines=l.courseDeadlines||{};
  document.getElementById('assign-course-list').innerHTML=courses.length
    ?courses.map(([cid,c])=>{
      const checked=current.has(cid);
      const dl=deadlines[cid]||'';
      return `<div class="assign-course-row ${checked?'checked':''}" id="acr-${cid}">
        <div class="acr-top" onclick="toggleACR('${cid}')">
          <input type="checkbox" data-cid="${cid}" ${checked?'checked':''} onclick="event.stopPropagation();this.closest('.assign-course-row').classList.toggle('checked',this.checked)">
          <div style="flex:1">
            <div class="cck-title">${c.title}</div>
            <div class="cck-meta">ğŸ• ${c.duration||'?'}ì‹œê°„ Â· ${c.purpose||'-'}</div>
          </div>
          ${dl?`<span class="dl-badge ${getDlBadgeClass(dl)}">ğŸ“… ${dl}</span>`:'<span style="font-size:10.5px;color:var(--text-light)">ê¸°í•œ ë¯¸ì„¤ì •</span>'}
        </div>
        <div class="acr-deadline">
          <span class="dl-label">ğŸ“… ìˆ˜ê°•ê¸°í•œ:</span>
          <input type="date" class="dl-input" data-deadline-cid="${cid}" value="${dl}"
            min="${new Date().toISOString().slice(0,10)}">
          <button class="dl-clear" onclick="document.querySelector('[data-deadline-cid=${cid}]').value=''">âœ• ê¸°í•œ ì‚­ì œ</button>
          <span style="font-size:11px;color:var(--text-light)">ë§ˆê° 10Â·5Â·1ì¼ì „Â·ë‹¹ì¼ ì´ë©”ì¼ ë°œì†¡</span>
        </div>
      </div>`;
    }).join('')
    :'<div style="text-align:center;padding:20px;color:var(--text-light)">ë“±ë¡ëœ ê°•ì˜ ì—†ìŒ</div>';
  document.getElementById('modal-assign').classList.remove('hidden');
};
function getDlBadgeClass(dl){
  if(!dl) return '';
  const diff=Math.round((new Date(dl)-new Date())/86400000);
  if(diff<0) return 'urgent';
  if(diff<=5) return 'soon';
  return 'ok';
}
window.toggleACR=function(cid){
  const row=document.getElementById(`acr-${cid}`);
  const cb=row.querySelector('input[type=checkbox]');
  cb.checked=!cb.checked;
  row.classList.toggle('checked',cb.checked);
};
window.toggleCourseCheck=function(el){
  el.classList.toggle('checked');
  el.querySelector('input[type=checkbox]').checked=el.classList.contains('checked');
};
window.doAssign=async function(){
  const checked=[...document.querySelectorAll('#assign-course-list input[type=checkbox][data-cid]:checked')].map(el=>el.dataset.cid).filter(Boolean);
  // ìˆ˜ê°•ê¸°í•œ ìˆ˜ì§‘
  const deadlines={};
  document.querySelectorAll('#assign-course-list input[data-deadline-cid]').forEach(el=>{
    if(el.value) deadlines[el.dataset.deadlineCid]=el.value;
  });
  await DB.update(`learners/${assignTargetId}`,{assignedCourses:checked,courseDeadlines:deadlines});
  showToast('ê°•ì˜ ë°°ì • ë° ìˆ˜ê°•ê¸°í•œ ì €ì¥ ì™„ë£Œ','success');
  closeModal('modal-assign');loadLearners();loadAssign();
  // ë°°ì • ì™„ë£Œ í›„ ë§ˆê°ì•Œë¦¼ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
  updateDeadlineCounts();
};

// â”€â”€ ASSIGN section â”€â”€
window.loadAssign=async function(){
  await fetchAll();
  buildBulkCourseChecks();
  renderAssign(allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected'));
};
function buildBulkCourseChecks(){
  document.getElementById('bulk-course-checks').innerHTML=Object.entries(allCourses).map(([id,c])=>
    `<label style="display:flex;align-items:center;gap:7px;font-size:12px;padding:3px 0;cursor:pointer">
      <input type="checkbox" data-cid="${id}" style="accent-color:var(--navy)"> ${c.title}</label>`
  ).join('')||'<span style="font-size:11.5px;color:var(--text-light)">ë“±ë¡ëœ ê°•ì˜ ì—†ìŒ</span>';
}
function renderAssign(list){
  document.getElementById('assign-tbody').innerHTML=list.length?list.map(l=>{
    const names=(l.assignedCourses||[]).map(id=>allCourses[id]?.title||id).join(', ')||'-';
    return `<tr><td><strong>${l.name}</strong></td><td>${gradePill(l.grade||'general')}</td><td>${l.org||'-'}</td>
      <td style="max-width:240px;font-size:11.5px;color:var(--text-mid)">${names}</td>
      <td style="text-align:center"><button class="tbl-btn tb-assign" onclick="openAssign('${l._id}')">ğŸ“‹ ìˆ˜ì •</button></td></tr>`;
  }).join(''):'<tr class="empty-row"><td colspan="5">ìˆ˜ê°•ìƒ ì—†ìŒ</td></tr>';
}
window.filterAssign=function(){
  const q=document.getElementById('af-search').value.toLowerCase();
  const gr=document.getElementById('af-grade').value;
  renderAssign(allLearners.filter(l=>{
    if(l.status==='pending'||l.status==='rejected')return false;
    if(gr&&l.grade!==gr)return false;
    return !q||l.name?.toLowerCase().includes(q)||l.org?.toLowerCase().includes(q);
  }));
};
window.toggleBulkGrade=function(btn){
  btn.classList.toggle('active');
  bulkGrades[btn.classList.contains('active')?'add':'delete'](btn.dataset.grade);
};
window.previewBulk=function(){
  const targets=allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected'&&bulkGrades.has(l.grade||'general'));
  const courses=[...document.querySelectorAll('#bulk-course-checks input:checked')].map(el=>el.dataset.cid);
  const wrap=document.getElementById('bulk-preview');wrap.style.display='';
  if(!bulkGrades.size){wrap.innerHTML='<div class="alert alert-warn">ë“±ê¸‰ì„ ì„ íƒí•˜ì„¸ìš”.</div>';return;}
  if(!courses.length){wrap.innerHTML='<div class="alert alert-warn">ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>';return;}
  wrap.innerHTML=`<div class="alert alert-info" style="font-size:12px">
    <strong>${[...bulkGrades].map(g=>GRADE_LABEL[g]).join(', ')}</strong> ë“±ê¸‰ì˜ <strong>${targets.length}ëª…</strong>ì—ê²Œ
    <strong>${courses.length}ê°œ</strong> ê°•ì˜ ì¶”ê°€ ë°°ì • ì˜ˆì •<br>ëŒ€ìƒ: ${targets.map(l=>l.name).join(', ')||'ì—†ìŒ'}</div>`;
};
window.doBulkAssign=async function(){
  const targets=allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected'&&bulkGrades.has(l.grade||'general'));
  const newC=[...document.querySelectorAll('#bulk-course-checks input:checked')].map(el=>el.dataset.cid);
  if(!targets.length){showToast('ëŒ€ìƒ ì—†ìŒ','warn');return;}
  if(!newC.length){showToast('ê°•ì˜ ì„ íƒ','warn');return;}
  if(!confirm(`${targets.length}ëª…ì—ê²Œ ${newC.length}ê°œ ê°•ì˜ ë°°ì •?`))return;
  await Promise.all(targets.map(l=>DB.update(`learners/${l._id}`,{assignedCourses:[...new Set([...(l.assignedCourses||[]),...newC])]})));
  showToast(`${targets.length}ëª…ì—ê²Œ ê°•ì˜ ë°°ì • ì™„ë£Œ`,'success');
  await fetchAll();renderAssign(allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected'));
  document.getElementById('bulk-preview').style.display='none';
};

// â”€â”€ COMPLETIONS â”€â”€
window.loadCompletions=async function(){
  await fetchAll();renderCompletions(allCompletions);
};
function renderCompletions(list){
  document.getElementById('completions-tbody').innerHTML=list.length?list.map(c=>
    `<tr><td style="font-family:'DM Mono',monospace;font-size:10.5px">ì œ ${c.certNo}í˜¸</td>
    <td><strong>${c.name}</strong></td><td>${gradePill(c.grade||'general')}</td><td>${c.org||'-'}</td>
    <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.courseTitle||'-'}</td>
    <td><span class="badge badge-success">${c.score}ì </span></td>
    <td style="font-size:10.5px;color:var(--text-light)">${fmtDate(new Date(c.date))}</td></tr>`
  ).join(''):'<tr class="empty-row"><td colspan="7">ìˆ˜ë£Œì ì—†ìŒ</td></tr>';
}
window.filterCompletions=function(){
  const q=document.getElementById('cf-search').value.toLowerCase();
  renderCompletions(allCompletions.filter(c=>c.name?.toLowerCase().includes(q)||(c.certNo||'').toLowerCase().includes(q)));
};

// â”€â”€ QUIZ EDITOR ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// pfx: 'cf'(ì‹ ê·œ) ë˜ëŠ” 'ec'(ìˆ˜ì •)
// State
const qState = { cf: { midQuizzes:[null,null,null], bank:[], answerMap:{} },
                  ec: { midQuizzes:[null,null,null], bank:[], answerMap:{} } };

const TIMINGS=['ì˜ìƒ 25% ì§€ì ','ì˜ìƒ 50% ì§€ì ','ì˜ìƒ 75% ì§€ì '];

// â”€â”€ ì¤‘ê°„ í€´ì¦ˆ ë Œë” â”€â”€
function renderMidQuizForms(pfx) {
  const container=document.getElementById(`${pfx}-mid-quizzes`);
  if(!container) return;
  container.innerHTML='';
  for(let i=0;i<3;i++) {
    const q=qState[pfx].midQuizzes[i]||{q:'',opts:['','','',''],ans:0,explanation:''};
    const div=document.createElement('div');
    div.className='mid-quiz-card';
    div.innerHTML=`
      <div class="mqc-hd">
        <div class="mqc-num">${i+1}</div>
        <div class="mqc-label">ì¤‘ê°„ í€´ì¦ˆ ${i+1}</div>
        <div class="mqc-timing">ğŸ“ ${TIMINGS[i]}</div>
      </div>
      <textarea class="mqc-q-input" id="${pfx}-mq${i}-q" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ë¹„ì›Œë‘ë©´ AI ìë™ ìƒì„±)">${q.q||''}</textarea>
      <div class="opts-grid">
        ${[0,1,2,3].map(j=>`
          <div class="opt-row ${q.ans===j?'is-answer':''}" id="${pfx}-mq${i}-optrow${j}">
            <input type="radio" class="opt-radio" name="${pfx}-mq${i}-ans" value="${j}" ${q.ans===j?'checked':''} onchange="onMidAnsChange('${pfx}',${i})">
            <input class="opt-input" id="${pfx}-mq${i}-opt${j}" placeholder="ë³´ê¸° ${j+1}" value="${q.opts[j]||''}" oninput="updateMidStatus('${pfx}',${i})">
          </div>`).join('')}
      </div>
      <input class="mqc-expl-input" id="${pfx}-mq${i}-expl" placeholder="ì •ë‹µ í•´ì„¤ (ì„ íƒì‚¬í•­)" value="${q.explanation||''}">
      <div id="${pfx}-mq${i}-status"></div>
    `;
    container.appendChild(div);
    updateMidStatus(pfx,i);
  }
}

window.onMidAnsChange=function(pfx,i){
  const ans=parseInt(document.querySelector(`input[name="${pfx}-mq${i}-ans"]:checked`)?.value??'0');
  for(let j=0;j<4;j++){
    const row=document.getElementById(`${pfx}-mq${i}-optrow${j}`);
    if(row) row.className='opt-row'+(ans===j?' is-answer':'');
  }
  updateMidStatus(pfx,i);
};

function updateMidStatus(pfx,i){
  const q   =document.getElementById(`${pfx}-mq${i}-q`)?.value.trim();
  const opts=[0,1,2,3].map(j=>document.getElementById(`${pfx}-mq${i}-opt${j}`)?.value.trim()||'');
  const filled=q&&opts.every(o=>o);
  const el=document.getElementById(`${pfx}-mq${i}-status`);
  if(el) el.innerHTML=`<div class="mqc-status ${filled?'filled':'empty'}">${filled?'âœ… ì…ë ¥ ì™„ë£Œ':'â¬œ ë¯¸ì…ë ¥ (AI ìë™ ìƒì„± ì˜ˆì •)'}</div>`;
}

function getMidQuizFromForm(pfx,i){
  const q   =document.getElementById(`${pfx}-mq${i}-q`)?.value.trim();
  const opts=[0,1,2,3].map(j=>document.getElementById(`${pfx}-mq${i}-opt${j}`)?.value.trim()||'');
  const ans =parseInt(document.querySelector(`input[name="${pfx}-mq${i}-ans"]:checked`)?.value??'0');
  const expl=document.getElementById(`${pfx}-mq${i}-expl`)?.value.trim();
  if(!q||opts.some(o=>!o)) return null; // not filled = AI generates
  return {q,opts,ans,explanation:expl||''};
}

// â”€â”€ ìµœì¢… ë¬¸ì œ ì€í–‰ â”€â”€
function renderNewQForm(pfx){
  const grid=document.getElementById(`${pfx}-new-opts-grid`);
  if(!grid) return;
  if(!qState[pfx].answerMap[pfx]) qState[pfx].answerMap[pfx]=0;
  grid.innerHTML=[0,1,2,3].map(j=>`
    <div class="opt-row ${qState[pfx].answerMap[pfx]===j?'is-answer':''}" id="${pfx}-noptrow${j}">
      <input type="radio" class="opt-radio" name="${pfx}-new-ans" value="${j}" ${qState[pfx].answerMap[pfx]===j?'checked':''} onchange="onNewAnsChange('${pfx}',${j})">
      <input class="opt-input" id="${pfx}-nopt${j}" placeholder="ë³´ê¸° ${j+1}">
    </div>`).join('');
}

window.onNewAnsChange=function(pfx,ans){
  qState[pfx].answerMap[pfx]=ans;
  for(let j=0;j<4;j++){
    const row=document.getElementById(`${pfx}-noptrow${j}`);
    if(row) row.className='opt-row'+(ans===j?' is-answer':'');
  }
};

window.addQToBank=function(pfx){
  const q   =document.getElementById(`${pfx}-new-q`)?.value.trim();
  const opts=[0,1,2,3].map(j=>document.getElementById(`${pfx}-nopt${j}`)?.value.trim()||'');
  const ans =parseInt(document.querySelector(`input[name="${pfx}-new-ans"]:checked`)?.value??'0');
  const expl=document.getElementById(`${pfx}-new-expl`)?.value.trim()||'';
  if(!q){showToast('ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”','warn');return;}
  if(opts.some(o=>!o)){showToast('4ê°œ ë³´ê¸°ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”','warn');return;}
  qState[pfx].bank.push({q,opts,ans,explanation:expl});
  // clear form
  document.getElementById(`${pfx}-new-q`).value='';
  document.getElementById(`${pfx}-new-expl`).value='';
  [0,1,2,3].forEach(j=>{const el=document.getElementById(`${pfx}-nopt${j}`);if(el)el.value='';});
  renderQBank(pfx);
  updateExamCountWarn(pfx);
};

window.deleteQFromBank=function(pfx,idx){
  qState[pfx].bank.splice(idx,1);
  renderQBank(pfx);
  updateExamCountWarn(pfx);
};

window.toggleQCard=function(el){
  const body=el.nextElementSibling;
  body.classList.toggle('open');
  el.querySelector('.q-card-chevron').classList.toggle('open');
};

function renderQBank(pfx){
  const list=document.getElementById(`${pfx}-q-list`);
  const badge=document.getElementById(`${pfx}-bank-badge`);
  const bank=qState[pfx].bank;
  if(badge) badge.textContent=bank.length+'ë¬¸í•­';
  if(!list) return;
  if(!bank.length){
    list.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-light);font-size:12px">ğŸ“­ ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ë¬¸ì œë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ê¸°ë³¸ ë¬¸ì œ ì€í–‰ì„ ê°€ì ¸ì˜¤ì„¸ìš”.</div>';
    return;
  }
  list.innerHTML=bank.map((q,i)=>`
    <div class="q-card">
      <div class="q-card-hd" onclick="toggleQCard(this)">
        <div class="q-card-num">${i+1}</div>
        <div class="q-card-q" title="${q.q}">${q.q}</div>
        <button class="q-del-btn" onclick="event.stopPropagation();deleteQFromBank('${pfx}',${i})" title="ì‚­ì œ">ğŸ—‘</button>
        <div class="q-card-chevron">â–¼</div>
      </div>
      <div class="q-card-body">
        <div style="font-size:12.5px;color:var(--navy);font-weight:600;margin-bottom:8px">${q.q}</div>
        ${q.opts.map((o,j)=>`
          <div style="display:flex;align-items:flex-start;gap:7px;padding:4px 0;font-size:12px">
            <span style="width:18px;height:18px;border-radius:50%;${j===q.ans?'background:var(--success);color:#fff':'background:#F1F0EC;color:var(--text-mid)'};display:flex;align-items:center;justify-content:center;font-size:9.5px;font-weight:700;flex-shrink:0">${j+1}</span>
            <span style="${j===q.ans?'color:var(--success);font-weight:600':''}">${o}</span>
            ${j===q.ans?'<span style="font-size:10px;color:var(--success);margin-left:auto">âœ“ ì •ë‹µ</span>':''}
          </div>`).join('')}
        ${q.explanation?`<div style="margin-top:7px;padding:6px 9px;background:#F0FFF4;border-radius:var(--radius);font-size:11.5px;color:var(--success)">ğŸ’¡ ${q.explanation}</div>`:''}
      </div>
    </div>`).join('');
}

window.updateExamCountWarn=function(pfx){
  const count=parseInt(document.getElementById(`${pfx}-exam-count`)?.value||'20');
  const bankSize=qState[pfx].bank.length;
  const warn=document.getElementById(`${pfx}-exam-warn`);
  // sync time display
  const timeVal=document.getElementById(`${pfx==='cf'?'cf-exam-time':'ec-exam-time'}`)?.value||'40';
  const timeDisp=document.getElementById(`${pfx}-exam-time-disp`);
  if(timeDisp) timeDisp.textContent=timeVal+'ë¶„';
  if(!warn) return;
  if(bankSize>0&&bankSize<count){
    warn.textContent=`âš ï¸ ë¬¸ì œ ì€í–‰(${bankSize}ë¬¸í•­) < ì¶œì œ ìˆ˜(${count}ë¬¸í•­). ê¸°ë³¸ ë¬¸ì œ ì€í–‰ìœ¼ë¡œ ë³´ì™„ë©ë‹ˆë‹¤.`;
    warn.style.display='';
  } else if(bankSize===0){
    warn.textContent='âš ï¸ ë¬¸ì œ ì€í–‰ ë¯¸ë“±ë¡ ì‹œ ë‚´ì¥ ê¸°ë³¸ ë¬¸ì œë¡œ ì¶œì œë©ë‹ˆë‹¤.';
    warn.style.display='';
  } else {
    warn.style.display='none';
  }
};

window.importDefaultBank=function(pfx){
  if(!confirm(`ê¸°ë³¸ AML ë¬¸ì œ ì€í–‰ 20ë¬¸í•­ì„ ê°€ì ¸ì˜µë‹ˆê¹Œ?\n(ê¸°ì¡´ ë¬¸ì œ ì€í–‰ì— ì¶”ê°€ë©ë‹ˆë‹¤)`)) return;
  // import from QUIZ_BANK
  const added=DEFAULT_BANK_QUESTIONS.filter(q=>!qState[pfx].bank.find(e=>e.q===q.q));
  qState[pfx].bank.push(...added);
  renderQBank(pfx);
  updateExamCountWarn(pfx);
  showToast(`${added.length}ë¬¸í•­ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`,'success');
};

// â”€â”€ íƒ­ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.switchQTab=function(pfx, tab){
  document.getElementById(`${pfx}-tab-manual`).classList.toggle('active', tab==='manual');
  document.getElementById(`${pfx}-tab-excel`).classList.toggle('active', tab==='excel');
  document.getElementById(`${pfx}-panel-manual`).style.display = tab==='manual' ? '' : 'none';
  document.getElementById(`${pfx}-panel-excel`).style.display  = tab==='excel'  ? '' : 'none';
};

// â”€â”€ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.downloadQTemplate=function(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet([
    ['ë¬¸ì œ','ë³´ê¸°1','ë³´ê¸°2','ë³´ê¸°3','ë³´ê¸°4','ì •ë‹µ(1~4ìˆ«ì)','í•´ì„¤(ì„ íƒ)'],
    ['ìê¸ˆì„¸íƒë°©ì§€(AML)ì˜ ì£¼ìš” ëª©ì ì€?',
     'ë²”ì£„ ìˆ˜ìµì˜ í•©ë²•í™”ë¥¼ ì°¨ë‹¨í•˜ì—¬ ê¸ˆìœµì‹œìŠ¤í…œ ê±´ì „ì„± ë³´í˜¸',
     'ê³ ê° ì„œë¹„ìŠ¤ í’ˆì§ˆ í–¥ìƒ','ê¸ˆìœµê¸°ê´€ì˜ ìˆ˜ìµ ì¦ëŒ€','ì§ì› êµìœ¡ ë¹„ìš© ì ˆê°','1',
     'AMLì˜ í•µì‹¬ ëª©ì ì€ ë²”ì£„ ìˆ˜ìµì´ í•©ë²• ê¸ˆìœµì‹œìŠ¤í…œì— ìœ ì…ë˜ëŠ” ê²ƒì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.'],
    ['STR(ì˜ì‹¬ê±°ë˜ë³´ê³ )ì˜ ê¸°ì¤€ì€?',
     'ì¼ì • ê¸ˆì•¡ ì´ìƒ ë¬´ì¡°ê±´ ë³´ê³ ','ìê¸ˆì„¸íƒ ìœ„ë²•í–‰ìœ„ ì˜ì‹¬ ì‹œ ë³´ê³ ',
     'ê³ ê° ìš”ì²­ ì‹œ ë³´ê³ ','ê°ë…ì› ìŠ¹ì¸ í›„ ë³´ê³ ','2',
     'STRì€ ê¸ˆì•¡ì´ ì•„ë‹Œ ì˜ì‹¬ ì—¬ë¶€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤.'],
    ['KYCì—ì„œ í•„ìˆ˜ í™•ì¸ ì‚¬í•­ì€?',
     'ì·¨ë¯¸ ë° ì—¬ê°€ í™œë™','ì‹ ì›Â·ê±°ë˜ëª©ì Â·ìê¸ˆì¶œì²˜','í•™ë ¥ ë° ê²½ë ¥','ê°€ì¡± êµ¬ì„±ì› ìˆ˜','2',''],
  ]);
  ws['!cols']=[{wch:40},{wch:28},{wch:22},{wch:22},{wch:22},{wch:12},{wch:40}];
  XLSX.utils.book_append_sheet(wb, ws, 'ìµœì¢…ë¬¸ì œì€í–‰');

  // ì¤‘ê°„ í€´ì¦ˆ ì‹œíŠ¸
  const ws2=XLSX.utils.aoa_to_sheet([
    ['ë²ˆí˜¸(1~3)','ë¬¸ì œ','ë³´ê¸°1','ë³´ê¸°2','ë³´ê¸°3','ë³´ê¸°4','ì •ë‹µ(1~4)','í•´ì„¤'],
    ['1','ìê¸ˆì„¸íƒ 3ë‹¨ê³„ ì¤‘ ë°°ì¹˜ ë‹¨ê³„ë€?',
     'ê¸ˆìœµì‹œìŠ¤í…œì— ìµœì´ˆ ìœ ì…','ìê¸ˆ ì¶œì²˜ ì€í','ì„¸íƒ ìê¸ˆ ì¬íˆ¬ì…','STR ì œì¶œ','1',''],
    ['2','Tipping-off ê¸ˆì§€ ì›ì¹™ì´ë€?',
     'ìˆ˜ìƒ ê±°ë˜ë¥¼ ì–¸ë¡ ì— ì œë³´','STR ë³´ê³  ì‚¬ì‹¤ì„ ê³ ê°ì—ê²Œ ì•Œë¦¬ëŠ” ê²ƒ ê¸ˆì§€',
     'ë‚´ë¶€ ë³´ê³  ê¸ˆì§€','ì–¸ë¡  ì œë³´ ê¶Œê³ ','2',''],
    ['3','RBA(ìœ„í—˜ ê¸°ë°˜ ì ‘ê·¼ë²•)ì˜ í•µì‹¬ì€?',
     'ëª¨ë“  ê³ ê° ë™ì¼ í™•ì¸','ê³ ìœ„í—˜ì— ìì› ì§‘ì¤‘',
     'ì €ìœ„í—˜ í™•ì¸ ìƒëµ','ì •í˜•í™”ëœ ì ˆì°¨ ì¤€ìˆ˜','2',''],
  ]);
  ws2['!cols']=[{wch:8},{wch:40},{wch:22},{wch:22},{wch:22},{wch:22},{wch:10},{wch:35}];
  XLSX.utils.book_append_sheet(wb, ws2, 'ì¤‘ê°„í€´ì¦ˆ(ì„ íƒ)');

  XLSX.writeFile(wb,'KASG_ë¬¸ì œ_ë“±ë¡ì–‘ì‹.xlsx');
};

// â”€â”€ ì—‘ì…€ íŒŒì‹± (ìµœì¢… + ì¤‘ê°„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.parseQExcel=function(file, pfx){
  if(!file) return;
  const preview=document.getElementById(`${pfx}-q-excel-preview`);
  preview.innerHTML='<div style="text-align:center;padding:14px;color:var(--text-mid);font-size:12px">ğŸ“Š íŒŒì¼ ë¶„ì„ ì¤‘...</div>';
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(e.target.result,{type:'binary'});

      // â”€â”€ Sheet 1: ìµœì¢… ë¬¸ì œ ì€í–‰ â”€â”€
      const ws=wb.Sheets[wb.SheetNames[0]];
      const raw=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      if(raw.length<2){ preview.innerHTML='<div class="alert alert-warn">ë°ì´í„° í–‰ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

      const header=raw[0].map(h=>String(h).trim().toLowerCase());
      const colI=k=>header.findIndex(h=>h.includes(k));
      const ci={
        q   : colI('ë¬¸ì œ'),
        o1  : header.findIndex(h=>/ë³´ê¸°\s*1/.test(h)),
        o2  : header.findIndex(h=>/ë³´ê¸°\s*2/.test(h)),
        o3  : header.findIndex(h=>/ë³´ê¸°\s*3/.test(h)),
        o4  : header.findIndex(h=>/ë³´ê¸°\s*4/.test(h)),
        ans : header.findIndex(h=>h.includes('ì •ë‹µ')||h.includes('ë‹µ')),
        expl: header.findIndex(h=>h.includes('í•´ì„¤')||h.includes('ì„¤ëª…'))
      };

      const rows=raw.slice(1).filter(r=>r.some(v=>String(v).trim()));
      const parsed=rows.map((r,i)=>{
        const q   =String(ci.q  >=0?r[ci.q]  :'').trim();
        const o1  =String(ci.o1 >=0?r[ci.o1] :'').trim();
        const o2  =String(ci.o2 >=0?r[ci.o2] :'').trim();
        const o3  =String(ci.o3 >=0?r[ci.o3] :'').trim();
        const o4  =String(ci.o4 >=0?r[ci.o4] :'').trim();
        const ansR=String(ci.ans>=0?r[ci.ans] :'').trim();
        const ansN=parseInt(ansR);
        const expl=String(ci.expl>=0?r[ci.expl]:'').trim();
        let err='';
        if(!q)                               err='ë¬¸ì œ ì—†ìŒ';
        else if(!o1||!o2||!o3||!o4)         err='ë³´ê¸° ëˆ„ë½';
        else if(isNaN(ansN)||ansN<1||ansN>4) err='ì •ë‹µ ì˜¤ë¥˜(1~4)';
        return {q,opts:[o1,o2,o3,o4],ans:ansN-1,explanation:expl,_row:i+2,_err:err};
      });

      // â”€â”€ Sheet 2 (optional): ì¤‘ê°„ í€´ì¦ˆ â”€â”€
      let midDetected=0;
      if(wb.SheetNames.length>1){
        const ws2=wb.Sheets[wb.SheetNames[1]];
        const raw2=XLSX.utils.sheet_to_json(ws2,{header:1,defval:''});
        const mq=parseMidQuizSheet(raw2);
        mq.forEach((q,i)=>{ if(q){ qState[pfx].midQuizzes[i]=q; midDetected++; } });
        if(midDetected>0){
          renderMidQuizForms(pfx);
          showToast(`ì¤‘ê°„ í€´ì¦ˆ ${midDetected}ê°œ ê°€ì ¸ì˜´`,'success');
        }
      }

      renderQExcelPreview(parsed, pfx, midDetected);
    }catch(err2){
      preview.innerHTML=`<div class="alert alert-warn">íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ${err2.message}</div>`;
    }
  };
  reader.readAsBinaryString(file);
};

function parseMidQuizSheet(raw){
  if(!raw||raw.length<2) return [null,null,null];
  const h=raw[0].map(v=>String(v).trim().toLowerCase());
  const ci={
    num :h.findIndex(v=>v.includes('ë²ˆí˜¸')||v==='no'||v==='num'),
    q   :h.findIndex(v=>v.includes('ë¬¸ì œ')),
    o1  :h.findIndex(v=>/ë³´ê¸°\s*1/.test(v)),
    o2  :h.findIndex(v=>/ë³´ê¸°\s*2/.test(v)),
    o3  :h.findIndex(v=>/ë³´ê¸°\s*3/.test(v)),
    o4  :h.findIndex(v=>/ë³´ê¸°\s*4/.test(v)),
    ans :h.findIndex(v=>v.includes('ì •ë‹µ')||v.includes('ë‹µ')),
    expl:h.findIndex(v=>v.includes('í•´ì„¤')||v.includes('ì„¤ëª…'))
  };
  const result=[null,null,null];
  raw.slice(1).filter(r=>r.some(v=>String(v).trim())).forEach(r=>{
    const numRaw=parseInt(String(ci.num>=0?r[ci.num]:'0').trim());
    const idx=(numRaw>=1&&numRaw<=3)?numRaw-1:-1;
    if(idx<0) return;
    const q   =String(ci.q  >=0?r[ci.q]  :'').trim();
    const o1  =String(ci.o1 >=0?r[ci.o1] :'').trim();
    const o2  =String(ci.o2 >=0?r[ci.o2] :'').trim();
    const o3  =String(ci.o3 >=0?r[ci.o3] :'').trim();
    const o4  =String(ci.o4 >=0?r[ci.o4] :'').trim();
    const ansN=parseInt(String(ci.ans>=0?r[ci.ans]:'1').trim());
    const expl=String(ci.expl>=0?r[ci.expl]:'').trim();
    if(q&&o1&&o2&&o3&&o4&&ansN>=1&&ansN<=4){
      result[idx]={q,opts:[o1,o2,o3,o4],ans:ansN-1,explanation:expl};
    }
  });
  return result;
}

function renderQExcelPreview(parsed, pfx, midDetected=0){
  const preview=document.getElementById(`${pfx}-q-excel-preview`);
  const ok =parsed.filter(r=>!r._err);
  const bad=parsed.filter(r=>r._err);

  let html=`<div class="qp-actions"><span class="qp-summary">
    ì´ ${parsed.length}í–‰ Â· <span style="color:var(--success);font-weight:700">${ok.length}ë¬¸í•­ ìœ íš¨</span>
    ${bad.length?`Â· <span style="color:var(--error)">${bad.length}ê±´ ì˜¤ë¥˜</span>`:''}
    ${midDetected?`Â· <span style="color:var(--navy)">âš¡ì¤‘ê°„í€´ì¦ˆ ${midDetected}ê°œ</span>`:''}
  </span>`;
  if(ok.length>0){
    // Store parsed data in a temporary dataset to avoid innerHTML attribute encoding issues
    html+=`<button class="btn btn-primary btn-sm" id="${pfx}-import-btn" data-pfx="${pfx}">âœ… ${ok.length}ë¬¸í•­ ì¶”ê°€</button>`;
  }
  html+=`<button class="btn btn-outline btn-sm" onclick="clearQExcel('${pfx}')">âœ• ì´ˆê¸°í™”</button></div>`;

  html+=`<div class="qp-wrap"><table class="qp-table">
    <thead><tr><th>í–‰</th><th>ë¬¸ì œ</th><th>ë³´ê¸°1</th><th>ë³´ê¸°2</th><th>ë³´ê¸°3</th><th>ë³´ê¸°4</th><th>ì •ë‹µ</th><th>í•´ì„¤</th><th>ìƒíƒœ</th></tr></thead>
    <tbody>${parsed.map(r=>`<tr class="${r._err?'qp-err':'qp-ok'}">
      <td style="font-size:10.5px;color:var(--text-light)">${r._row}</td>
      <td><div class="qp-q-text" title="${r.q.replace(/"/g,'&quot;')}">${r.q||'-'}</div></td>
      ${r.opts.map(o=>`<td style="font-size:10.5px;color:var(--text-mid);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${o.replace(/"/g,'&quot;')}">${o||'-'}</td>`).join('')}
      <td style="text-align:center;font-weight:700;color:var(--navy)">${r._err?'-':(r.ans+1)+'ë²ˆ'}</td>
      <td style="font-size:10px;color:var(--text-light);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.explanation||'-'}</td>
      <td>${r._err?`<span class="qp-status err">âš  ${r._err}</span>`:'<span class="qp-status ok">âœ“</span>'}</td>
    </tr>`).join('')}</tbody></table></div>`;

  preview.innerHTML=html;

  // Attach click handler using stored data (avoids JSON encoding in HTML attr)
  const importBtn=document.getElementById(`${pfx}-import-btn`);
  if(importBtn){
    importBtn._okRows=ok;
    importBtn.addEventListener('click',function(){
      const questions=this._okRows;
      const dupes=questions.filter(q=>qState[pfx].bank.find(e=>e.q===q.q)).length;
      let msg=`${questions.length}ë¬¸í•­ì„ ë¬¸ì œ ì€í–‰ì— ì¶”ê°€í•©ë‹ˆë‹¤.`;
      if(dupes>0) msg+=`\n(ì¤‘ë³µ ${dupes}ê±´ í¬í•¨)`;
      if(!confirm(msg)) return;
      qState[pfx].bank.push(...questions.map(({q,opts,ans,explanation})=>({q,opts,ans,explanation:explanation||''})));
      renderQBank(pfx);
      updateExamCountWarn(pfx);
      showToast(`${questions.length}ë¬¸í•­ ì¶”ê°€ ì™„ë£Œ`,'success');
      clearQExcel(pfx);
    });
  }
}

window.clearQExcel=function(pfx){
  const fileEl=document.getElementById(`${pfx}-q-excel-file`);
  if(fileEl) fileEl.value='';
  const prev=document.getElementById(`${pfx}-q-excel-preview`);
  if(prev) prev.innerHTML='';
};

// â”€â”€ COURSES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadCourses=async function(){
  await fetchAll();
  const arr=Object.entries(allCourses);
  document.getElementById('course-grid').innerHTML=arr.length?arr.map(([id,c])=>{
    const midCnt=(c.midQuizzes||[]).filter(q=>q&&q.q).length;
    const bankCnt=(c.questionBank||[]).length;
    return `<div class="cc"><div class="cc-hd">
      <div class="cc-title">${c.title}</div>
      <div class="cc-meta">â± ${c.duration||'?'}ì‹œê°„ Â· ì‹œí—˜ ${c.examTime||40}ë¶„ Â· ì¶œì œ ${c.examCount||20}ë¬¸</div>
      <div class="cc-meta" style="margin-top:3px">ğŸ¯ ${c.purpose||'-'}</div>
      <div class="cc-meta" style="margin-top:3px;display:flex;gap:6px;flex-wrap:wrap">
        <span style="background:${midCnt>0?'#D1FAE5':'#FEF3C7'};color:${midCnt>0?'var(--success)':'#7A4F00'};padding:1px 7px;border-radius:8px;font-size:10px">âš¡ì¤‘ê°„í€´ì¦ˆ ${midCnt}/3</span>
        <span style="background:${bankCnt>0?'#DBEAFE':'#FEE2E2'};color:${bankCnt>0?'#1E40AF':'var(--error)'};padding:1px 7px;border-radius:8px;font-size:10px">ğŸ“ë¬¸ì œì€í–‰ ${bankCnt}ë¬¸í•­</span>
      </div>
      ${c.videoURL?`<div class="cc-url" onclick="window.open('${c.videoURL}','_blank')">â–¶ YouTube ì˜ìƒ</div>`:'<div class="cc-meta" style="color:var(--error)">âš ï¸ ì˜ìƒ ë¯¸ë“±ë¡</div>'}
    </div>
    <div class="cc-ft">
      <span class="badge ${c.locked?'badge-error':'badge-success'}">${c.locked?'ğŸ”’ ì ê¹€':'âœ… ê³µê°œ'}</span>
      <button class="tbl-btn ${c.locked?'tb-approve':'tb-reject'}" onclick="toggleLock('${id}',${!c.locked})">${c.locked?'ğŸ”“ ê³µê°œ':'ğŸ”’ ì ê¸ˆ'}</button>
      <button class="tbl-btn tb-edit" onclick="openEditCourse('${id}')">âœï¸ ë¬¸ì œ í¸ì§‘</button>
      <button class="tbl-btn tb-delete" onclick="deleteCourse('${id}','${c.title}')">ğŸ—‘</button>
    </div></div>`;
  }).join('')
  :'<div class="card" style="padding:40px;text-align:center;grid-column:1/-1"><div style="font-size:36px;margin-bottom:10px">ğŸ“‚</div><div style="color:var(--text-mid)">ë“±ë¡ëœ ê°•ì˜ ì—†ìŒ</div></div>';
};
window.toggleLock=async function(id,lock){await DB.update(`courses/${id}`,{locked:lock});showToast(lock?'ì ê¸ˆ':'ê³µê°œ','success');loadCourses();};
window.deleteCourse=async function(id,title){if(!confirm(`"${title}" ì‚­ì œ?`))return;await DB.remove(`courses/${id}`);showToast('ì‚­ì œ ì™„ë£Œ','warn');loadCourses();};

window.openEditCourse=function(id){
  const c=allCourses[id]; if(!c) return;
  document.getElementById('ec-id').value      =id;
  document.getElementById('ec-course-name').textContent=c.title||'';
  document.getElementById('ec-title').value   =c.title||'';
  document.getElementById('ec-purpose').value =c.purpose||'';
  document.getElementById('ec-duration').value=c.duration||2;
  document.getElementById('ec-exam-time').value=c.examTime||40;
  document.getElementById('ec-yturl').value   =c.videoURL||'';
  document.getElementById('ec-exam-count').value=c.examCount||20;
  // Load quizzes into state
  qState.ec.midQuizzes=c.midQuizzes?[...c.midQuizzes]:[null,null,null];
  qState.ec.bank=[...(c.questionBank||[])];
  qState.ec.answerMap={ec:0};
  // Render
  renderMidQuizForms('ec');
  renderNewQForm('ec');
  renderQBank('ec');
  updateExamCountWarn('ec');
  document.getElementById('modal-edit-course').classList.remove('hidden');
};

window.doEditCourse=async function(){
  const id   =document.getElementById('ec-id').value;
  const title=document.getElementById('ec-title').value.trim();
  if(!title){alert('ê°•ì˜ëª… í•„ìˆ˜');return;}
  const pur   =document.getElementById('ec-purpose').value.trim();
  const dur   =document.getElementById('ec-duration').value;
  const yt    =document.getElementById('ec-yturl').value.trim();
  const eTime =parseInt(document.getElementById('ec-exam-time').value)||40;
  const eCount=parseInt(document.getElementById('ec-exam-count').value)||20;
  const embed =toYoutubeEmbed(yt)||yt;
  // Collect mid quizzes
  const midQuizzes=[0,1,2].map(i=>getMidQuizFromForm('ec',i));
  await DB.update(`courses/${id}`,{
    title,purpose:pur,duration:Number(dur),videoURL:embed,
    examTime:eTime,examCount:eCount,
    midQuizzes,
    questionBank:qState.ec.bank
  });
  showToast('ê°•ì˜ ìˆ˜ì • ì™„ë£Œ','success');
  closeModal('modal-edit-course');
  loadCourses();
};

// â”€â”€ ADD COURSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initAddCourseForm(){
  qState.cf.midQuizzes=[null,null,null];
  qState.cf.bank=[];
  qState.cf.answerMap={cf:0};
  renderMidQuizForms('cf');
  renderNewQForm('cf');
  renderQBank('cf');
  updateExamCountWarn('cf');
  // sync time display on exam-time input change
  document.getElementById('cf-exam-time')?.addEventListener('input',()=>updateExamCountWarn('cf'));
  document.getElementById('ec-exam-time')?.addEventListener('input',()=>updateExamCountWarn('ec'));
}

window.previewYT=function(){
  const url=document.getElementById('cf-yturl').value.trim();
  const embed=toYoutubeEmbed(url);
  const pv=document.getElementById('yt-preview'),fr=document.getElementById('yt-preview-frame');
  if(embed){fr.src=embed;pv.classList.add('show');}else{pv.classList.remove('show');fr.src='';}
};

window.saveCourse=async function(){
  const title  =document.getElementById('cf-title').value.trim();
  const dur    =document.getElementById('cf-duration').value;
  const purpose=document.getElementById('cf-purpose').value.trim();
  const yturl  =document.getElementById('cf-yturl').value.trim();
  const eTime  =parseInt(document.getElementById('cf-exam-time').value)||40;
  const eCount =parseInt(document.getElementById('cf-exam-count').value)||20;
  if(!title){alert('ê°•ì˜ëª… í•„ìˆ˜');return;}
  if(!purpose){alert('êµìœ¡ëª©ì  í•„ìˆ˜');return;}
  if(!yturl){alert('YouTube URL í•„ìˆ˜');return;}
  const embed=toYoutubeEmbed(yturl);
  if(!embed){alert('ì˜¬ë°”ë¥¸ YouTube URLì´ ì•„ë‹™ë‹ˆë‹¤.');return;}
  // Collect mid quizzes
  const midQuizzes=[0,1,2].map(i=>getMidQuizFromForm('cf',i));
  const id='course_'+Date.now();
  await DB.set(`courses/${id}`,{
    title,purpose,duration:Number(dur),videoURL:embed,
    examTime:eTime,examCount:eCount,
    midQuizzes,
    questionBank:qState.cf.bank,
    locked:false,createdAt:new Date().toISOString()
  });
  const midCount=midQuizzes.filter(Boolean).length;
  const bankCount=qState.cf.bank.length;
  document.getElementById('add-course-msg').innerHTML=
    `<div class="alert alert-success">âœ… ê°•ì˜ ë“±ë¡ ì™„ë£Œ! ì¤‘ê°„í€´ì¦ˆ ${midCount}/3ê°œ Â· ë¬¸ì œì€í–‰ ${bankCount}ë¬¸í•­</div>`;
  showToast('ê°•ì˜ ë“±ë¡ ì™„ë£Œ!','success');
  clearCF();
  setTimeout(()=>go(document.querySelector('[data-sec="courses"]')),1600);
};

window.clearCF=function(){
  ['cf-title','cf-purpose','cf-yturl'].forEach(i=>{const el=document.getElementById(i);if(el)el.value='';});
  document.getElementById('cf-duration').value='2';
  document.getElementById('cf-exam-time').value='40';
  document.getElementById('cf-exam-count').value='20';
  const pv=document.getElementById('yt-preview');if(pv)pv.classList.remove('show');
  const fr=document.getElementById('yt-preview-frame');if(fr)fr.src='';
  document.getElementById('add-course-msg').innerHTML='';
  qState.cf.bank=[];
  qState.cf.midQuizzes=[null,null,null];
  qState.cf.answerMap={cf:0};
  // force re-render
  const mc=document.getElementById('cf-mid-quizzes');if(mc)mc.innerHTML='';
  renderMidQuizForms('cf');
  renderNewQForm('cf');
  renderQBank('cf');
  updateExamCountWarn('cf');
};

// â”€â”€ ORG ADMIN MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPermChecks(containerId, currentPerms=[]) {
  const el = document.getElementById(containerId);
  if (!el) return;
  // Group by group label
  const groups = {};
  ALL_PERMS.forEach(p => {
    if (!groups[p.group]) groups[p.group] = [];
    groups[p.group].push(p);
  });
  el.innerHTML = Object.entries(groups).map(([grp, perms]) => `
    <div style="margin-bottom:10px">
      <div style="font-size:10px;font-weight:700;color:var(--text-light);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px">${grp}</div>
      <div class="perm-checks">
        ${perms.map(p => `
          <label class="perm-check-item" style="cursor:pointer;display:flex;align-items:flex-start;gap:7px;padding:7px 10px;border:1.5px solid var(--border);border-radius:var(--radius);transition:all .12s;background:${currentPerms.includes(p.key)?'rgba(12,31,63,.05)':'#fff'}">
            <input type="checkbox" name="${containerId}-perm" value="${p.key}" ${currentPerms.includes(p.key)?'checked':''} style="width:14px;height:14px;accent-color:var(--navy);flex-shrink:0;margin-top:1px" onchange="this.closest('label').style.background=this.checked?'rgba(12,31,63,.05)':'#fff'">
            <span>
              <span class="perm-check-title">${p.icon} ${p.label}</span>
              <span class="perm-check-desc">${p.desc}</span>
            </span>
          </label>`).join('')}
      </div>
    </div>`).join('');
}

function getCheckedPerms(containerId) {
  return [...document.querySelectorAll(`input[name="${containerId}-perm"]:checked`)].map(el => el.value);
}

window.loadOrgAdmins = async function() {
  const raw = await DB.get('orgAdmins');
  allOrgAdmins = raw || {};
  renderPermChecks('oa-perm-new', []);
  renderOAList();
};

window.renderOAList = function() {
  const q = (document.getElementById('oa-search')?.value || '').toLowerCase();
  const tbody = document.getElementById('oa-tbody');
  if (!tbody) return;
  const entries = Object.entries(allOrgAdmins).filter(([k, a]) =>
    !q || k.includes(q) || (a.name||'').toLowerCase().includes(q) || (a.org||'').toLowerCase().includes(q)
  );
  if (!entries.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-light);padding:24px">ë“±ë¡ëœ ê´€ë¦¬ì ì—†ìŒ</td></tr>';
    return;
  }
  tbody.innerHTML = entries.map(([key, a]) => {
    const perms = (a.permissions || []);
    const permHtml = perms.length
      ? perms.map(pk => { const p=ALL_PERMS.find(x=>x.key===pk); return p ? `<span class="perm-pill">${p.icon} ${p.label}</span>` : ''; }).join('')
      : '<span style="font-size:11px;color:var(--text-light)">ì—†ìŒ</span>';
    return `<tr>
      <td style="font-weight:600;color:var(--navy);font-size:12px">${key}</td>
      <td>${a.name||'-'}</td>
      <td><span style="background:rgba(12,31,63,.08);padding:2px 9px;border-radius:8px;font-size:11.5px;font-weight:600">${a.org||'-'}</span></td>
      <td style="font-size:11.5px;color:var(--text-mid)">${a.phone||'-'}</td>
      <td style="max-width:240px;white-space:normal">${permHtml}</td>
      <td>${a.disabled
        ? '<span class="oa-status-off">ğŸ”´ ë¹„í™œì„±</span>'
        : '<span class="oa-status-on">ğŸŸ¢ í™œì„±</span>'}</td>
      <td style="font-size:11px;color:var(--text-light)">${a.createdAt ? fmtDate(new Date(a.createdAt)) : '-'}</td>
      <td>
        <div style="display:flex;gap:4px;flex-wrap:wrap">
          <button class="tbl-btn tb-edit"    onclick="openEditOA('${key}')">âœï¸ ìˆ˜ì •</button>
          <button class="tbl-btn ${a.disabled?'tb-approve':'tb-reject'}" onclick="toggleOA('${key}',${!a.disabled})">${a.disabled?'âœ… í™œì„±í™”':'ğŸ”’ ë¹„í™œì„±'}</button>
          <button class="tbl-btn tb-delete"  onclick="deleteOA('${key}','${a.name||key}')">ğŸ—‘</button>
        </div>
      </td>
    </tr>`;
  }).join('');
};

window.saveNewOA = async function() {
  const rawId = document.getElementById('oa-id').value.trim();
  const name  = document.getElementById('oa-name').value.trim();
  const org   = document.getElementById('oa-org').value.trim();
  const pw    = document.getElementById('oa-pw').value;
  const phone = document.getElementById('oa-phone').value.trim();
  if (!rawId) { alert('ì•„ì´ë”” í•„ìˆ˜'); return; }
  if (!name)  { alert('ì´ë¦„ í•„ìˆ˜'); return; }
  if (!org)   { alert('ì†Œì† íšŒì‚¬ í•„ìˆ˜'); return; }
  if (!pw || pw.length < 6) { alert('ë¹„ë°€ë²ˆí˜¸ 6ì ì´ìƒ'); return; }
  const key = rawId.replace(/[.#$[\]/\s]/g, '_');
  if (allOrgAdmins[key]) { alert(`"${key}" ì•„ì´ë””ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`); return; }
  const permissions = getCheckedPerms('oa-perm-new');
  await DB.set(`orgAdmins/${key}`, {
    name, org, phone, password: pw,
    permissions, disabled: false,
    createdAt: new Date().toISOString()
  });
  showToast(`${name}ë‹˜ ê´€ë¦¬ì ê³„ì • ë“±ë¡ ì™„ë£Œ`, 'success');
  clearOAForm();
  loadOrgAdmins();
};

window.clearOAForm = function() {
  ['oa-id','oa-name','oa-org','oa-pw','oa-phone'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  renderPermChecks('oa-perm-new', []);
};

window.openEditOA = function(key) {
  const a = allOrgAdmins[key]; if (!a) return;
  document.getElementById('oa-edit-key').value = key;
  document.getElementById('oa-edit-id-label').textContent = key;
  document.getElementById('oa-edit-name').value  = a.name  || '';
  document.getElementById('oa-edit-org').value   = a.org   || '';
  document.getElementById('oa-edit-pw').value    = '';
  document.getElementById('oa-edit-phone').value = a.phone || '';
  renderPermChecks('oa-perm-edit', a.permissions || []);
  document.getElementById('modal-edit-oa').classList.remove('hidden');
};

window.doEditOA = async function() {
  const key   = document.getElementById('oa-edit-key').value;
  const name  = document.getElementById('oa-edit-name').value.trim();
  const org   = document.getElementById('oa-edit-org').value.trim();
  const pw    = document.getElementById('oa-edit-pw').value;
  const phone = document.getElementById('oa-edit-phone').value.trim();
  if (!name) { alert('ì´ë¦„ í•„ìˆ˜'); return; }
  if (!org)  { alert('ì†Œì† íšŒì‚¬ í•„ìˆ˜'); return; }
  const permissions = getCheckedPerms('oa-perm-edit');
  const upd = { name, org, phone, permissions };
  if (pw) {
    if (pw.length < 6) { alert('ë¹„ë°€ë²ˆí˜¸ 6ì ì´ìƒ'); return; }
    upd.password = pw;
  }
  await DB.update(`orgAdmins/${key}`, upd);
  showToast('ìˆ˜ì • ì™„ë£Œ', 'success');
  closeModal('modal-edit-oa');
  // í˜„ì¬ ì„¸ì…˜ì´ ì´ ê³„ì •ì´ë©´ permissions ì—…ë°ì´íŠ¸
  if (!SUPER && SESSION.id === key) {
    const updated = { ...SESSION, permissions };
    sessionStorage.setItem('kasg_admin', JSON.stringify(updated));
  }
  loadOrgAdmins();
};

window.toggleOA = async function(key, disable) {
  const a = allOrgAdmins[key];
  if (!a) return;
  const msg = disable ? `"${a.name||key}"ë‹˜ì„ ë¹„í™œì„±í™”í•©ë‹ˆê¹Œ?` : `"${a.name||key}"ë‹˜ì„ í™œì„±í™”í•©ë‹ˆê¹Œ?`;
  if (!confirm(msg)) return;
  await DB.update(`orgAdmins/${key}`, { disabled: disable });
  showToast(disable ? 'ë¹„í™œì„±í™” ì™„ë£Œ' : 'í™œì„±í™” ì™„ë£Œ', disable ? 'warn' : 'success');
  loadOrgAdmins();
};

window.deleteOA = async function(key, name) {
  if (!confirm(`"${name}" ê´€ë¦¬ì ê³„ì •ì„ ì‚­ì œí•©ë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
  await DB.remove(`orgAdmins/${key}`);
  showToast('ì‚­ì œ ì™„ë£Œ', 'warn');
  loadOrgAdmins();
};

// â”€â”€ SETTINGS â”€â”€
window.changeAdminPw=async function(){
  const np=document.getElementById('new-pw').value,cp=document.getElementById('confirm-pw').value;
  if(!np||np.length<8){alert('8ì ì´ìƒ');return;}if(np!==cp){alert('ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜');return;}
  await DB.set('admin/password',np);showToast('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ','success');
  document.getElementById('new-pw').value='';document.getElementById('confirm-pw').value='';
};
window.saveSettings=async function(){
  await DB.set('settings',{passScore:Number(document.getElementById('pass-score').value),maxAttempts:Number(document.getElementById('max-attempts').value)});
  showToast('ì €ì¥ ì™„ë£Œ','success');
};

// â”€â”€ EMAIL SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.saveEmailSettings=async function(){
  const cfg={
    serviceId:  document.getElementById('ejs-service').value.trim(),
    templateId: document.getElementById('ejs-template').value.trim(),
    pubKey:     document.getElementById('ejs-pubkey').value.trim(),
    senderName: document.getElementById('ejs-sender-name').value.trim()||'KASG êµìœ¡íŒ€',
  };
  if(!cfg.serviceId||!cfg.templateId||!cfg.pubKey){alert('Service ID, Template ID, Public Keyë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');return;}
  await DB.set('emailSettings',cfg);
  showToast('ì´ë©”ì¼ ì„¤ì • ì €ì¥ ì™„ë£Œ','success');
  // EmailJS ì¬ì´ˆê¸°í™”
  if(window.emailjs) emailjs.init(cfg.pubKey);
};
window.loadEmailSettings=async function(){
  const cfg=await DB.get('emailSettings');
  if(!cfg){showToast('ì €ì¥ëœ ì´ë©”ì¼ ì„¤ì • ì—†ìŒ','warn');return;}
  document.getElementById('ejs-service').value     =cfg.serviceId||'';
  document.getElementById('ejs-template').value    =cfg.templateId||'';
  document.getElementById('ejs-pubkey').value      =cfg.pubKey||'';
  document.getElementById('ejs-sender-name').value =cfg.senderName||'';
  if(window.emailjs&&cfg.pubKey) emailjs.init(cfg.pubKey);
  showToast('ì´ë©”ì¼ ì„¤ì • ë¶ˆëŸ¬ì˜´','success');
  updateDeadlineCounts();
};

// â”€â”€ DEADLINE NOTIFICATION ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì˜¤ëŠ˜ ê¸°ì¤€ D-Nì¸ ìˆ˜ê°•ìƒ + ê°•ì˜ ëª©ë¡ ë°˜í™˜
function getDeadlineTargets(daysLeft){
  const today=new Date(); today.setHours(0,0,0,0);
  const targets=[];
  allLearners.forEach(l=>{
    if(l.status==='pending'||l.status==='rejected') return;
    const deadlines=l.courseDeadlines||{};
    Object.entries(deadlines).forEach(([cid,dl])=>{
      if(!dl) return;
      const due=new Date(dl); due.setHours(0,0,0,0);
      const diff=Math.round((due-today)/86400000);
      if(diff!==daysLeft) return;
      // ì´ë¯¸ ìˆ˜ë£Œí•œ ê°•ì˜ëŠ” ì œì™¸
      const cs=l.courseStatus?.[cid];
      if(cs==='completed') return;
      // ì´ë©”ì¼ ìˆëŠ” ê²½ìš°ë§Œ
      if(!l.email) return;
      const course=allCourses[cid];
      if(!course) return;
      targets.push({learner:l, courseId:cid, course, deadline:dl, daysLeft:diff});
    });
  });
  return targets;
}

window.updateDeadlineCounts=function(){
  [0,1,5,10].forEach(d=>{
    const el=document.getElementById(`cnt-d${d}`);
    if(el){ const n=getDeadlineTargets(d).length; el.textContent=n?`(${n}ëª…)`:''; }
  });
};

function addNotifLog(msg){
  const log=document.getElementById('notif-log');
  if(!log) return;
  log.style.display='';
  const ts=new Date().toLocaleTimeString('ko-KR');
  log.innerHTML+=`<div>[${ts}] ${msg}</div>`;
  log.scrollTop=log.scrollHeight;
}

async function getEmailConfig(){
  const cfg=await DB.get('emailSettings');
  if(!cfg||!cfg.serviceId||!cfg.templateId||!cfg.pubKey){
    showToast('ì´ë©”ì¼ ì„¤ì •ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš” (âš™ï¸ ì„¤ì • ë©”ë‰´)','warn');return null;
  }
  if(window.emailjs) emailjs.init(cfg.pubKey);
  return cfg;
}

async function sendOneEmail(cfg, learner, course, deadline, daysLeft){
  const pageOrigin=window.location.origin+window.location.pathname.replace('admin.html','');
  const courseLink=`${pageOrigin}player.html`;
  const dLabel=daysLeft===0?'ì˜¤ëŠ˜ì´ ë§ˆê°ì…ë‹ˆë‹¤':
               daysLeft===1?'ë‚´ì¼ì´ ë§ˆê°ì…ë‹ˆë‹¤':
               `${daysLeft}ì¼ í›„ ë§ˆê°ì…ë‹ˆë‹¤`;
  try{
    await emailjs.send(cfg.serviceId, cfg.templateId, {
      to_name:    learner.name,
      to_email:   learner.email,
      from_name:  cfg.senderName||'KASG êµìœ¡íŒ€',
      course_title: course.title,
      deadline_date: deadline,
      days_left:  dLabel,
      course_link: courseLink,
      learner_id: learner._id,
      learner_org: learner.org||'-',
    });
    // ë°œì†¡ ê¸°ë¡ ì €ì¥
    const logKey=`emailLogs/${learner._id}_${course.title.replace(/\s/g,'_')}_d${daysLeft}_${deadline}`;
    await DB.set(logKey,{sentAt:new Date().toISOString(),daysLeft,email:learner.email});
    return true;
  }catch(e){
    return false;
  }
}

window.sendDeadlineNotif=async function(daysLeft){
  const cfg=await getEmailConfig(); if(!cfg) return;
  const targets=getDeadlineTargets(daysLeft);
  if(!targets.length){showToast(`D-${daysLeft}: í•´ë‹¹ ìˆ˜ê°•ìƒ ì—†ìŒ`,'info');return;}
  const label=daysLeft===0?'ë‹¹ì¼ ë§ˆê°':`D-${daysLeft}`;
  if(!confirm(`${label} ìˆ˜ê°•ìƒ ${targets.length}ëª…ì—ê²Œ ì´ë©”ì¼ì„ ë°œì†¡í•©ë‹ˆê¹Œ?`)) return;
  const btn=event.target; btn.disabled=true; btn.textContent='ë°œì†¡ ì¤‘...';
  let ok=0,fail=0;
  for(const t of targets){
    const res=await sendOneEmail(cfg,t.learner,t.course,t.deadline,t.daysLeft);
    res?ok++:fail++;
    addNotifLog(`${res?'âœ…':'âŒ'} ${t.learner.name} (${t.learner.email}) â€” ${t.course.title} [${label}]`);
  }
  showToast(`ë°œì†¡ ì™„ë£Œ: ì„±ê³µ ${ok}ê±´ / ì‹¤íŒ¨ ${fail}ê±´`,fail>0?'warn':'success');
  btn.disabled=false; btn.textContent='ğŸ“§ ì¦‰ì‹œ ë°œì†¡';
};

window.runAllDeadlineNotifs=async function(){
  const cfg=await getEmailConfig(); if(!cfg) return;
  const allTargets=[0,1,5,10].flatMap(d=>getDeadlineTargets(d));
  if(!allTargets.length){showToast('ë°œì†¡ ëŒ€ìƒ ìˆ˜ê°•ìƒ ì—†ìŒ','info');return;}
  if(!confirm(`ì´ ${allTargets.length}ê±´ ì´ë©”ì¼ì„ ì¼ê´„ ë°œì†¡í•©ë‹ˆê¹Œ?\n(10Â·5Â·1ì¼ ì „Â·ë‹¹ì¼ ë§ˆê° ìˆ˜ê°•ìƒ)`)) return;
  const btn=document.getElementById('btn-run-all-notifs');
  btn.disabled=true; btn.textContent='â³ ë°œì†¡ ì¤‘...';
  let ok=0,fail=0;
  for(const t of allTargets){
    const res=await sendOneEmail(cfg,t.learner,t.course,t.deadline,t.daysLeft);
    res?ok++:fail++;
    addNotifLog(`${res?'âœ…':'âŒ'} ${t.learner.name} â€” ${t.course.title} [D-${t.daysLeft}]`);
  }
  // ì˜¤ëŠ˜ ì‹¤í–‰ ê¸°ë¡
  await DB.set('lastNotifRun',{date:new Date().toISOString().slice(0,10),ok,fail});
  showToast(`ì¼ê´„ ë°œì†¡ ì™„ë£Œ: âœ…${ok} / âŒ${fail}`,fail>0?'warn':'success');
  btn.disabled=false; btn.textContent='ğŸš€ ì „ì²´ ì•Œë¦¼ ì¼ê´„ ì‹¤í–‰ (10Â·5Â·1Â·ë‹¹ì¼)';
};

// ìë™ ì•Œë¦¼ (ìì • ì²´í¬)
let _autoNotifTimer=null;
window.toggleAutoNotif=async function(on){
  if(_autoNotifTimer){clearTimeout(_autoNotifTimer);_autoNotifTimer=null;}
  if(!on) return;
  const stored=await DB.get('lastNotifRun');
  const today=new Date().toISOString().slice(0,10);
  if(stored?.date===today){
    addNotifLog(`â„¹ï¸ ì˜¤ëŠ˜(${today}) ì´ë¯¸ ë°œì†¡ ì™„ë£Œ. ë‚´ì¼ ìì •ì— ì¬ì‹¤í–‰ë©ë‹ˆë‹¤.`);
  } else {
    addNotifLog('ğŸ”„ ìë™ ì•Œë¦¼ í™œì„±í™” â€” ì˜¤ëŠ˜ ì•Œë¦¼ ì‹¤í–‰ ì¤‘...');
    await runAllDeadlineNotifs();
  }
  // ë‹¤ìŒ ìì •ê¹Œì§€ ëŒ€ê¸°
  const now=new Date();
  const midnight=new Date(now); midnight.setDate(midnight.getDate()+1); midnight.setHours(0,5,0,0);
  const ms=midnight-now;
  _autoNotifTimer=setTimeout(()=>{ if(document.getElementById('auto-notif-toggle')?.checked) window.runAllDeadlineNotifs(); },ms);
  addNotifLog(`â° ë‹¤ìŒ ìë™ ì‹¤í–‰: ${midnight.toLocaleString('ko-KR')}`);
};

// settings ì„¹ì…˜ ì§„ì… ì‹œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ë° ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
window.loadSettings=async function(){
  await loadEmailSettings();
  const cfg=await DB.get('settings')||{};
  if(cfg.passScore) document.getElementById('pass-score').value=cfg.passScore;
  if(cfg.maxAttempts) document.getElementById('max-attempts').value=cfg.maxAttempts;
  updateDeadlineCounts();
};

window.initAddCourseForm=function(){
  if(document.getElementById('cf-mid-quizzes')?.children.length>0) return;
  qState.cf.midQuizzes=[null,null,null];
  qState.cf.bank=[];
  qState.cf.answerMap={cf:0};
  renderMidQuizForms('cf');
  renderNewQForm('cf');
  renderQBank('cf');
  updateExamCountWarn('cf');
  const etEl=document.getElementById('cf-exam-time');
  if(etEl&&!etEl._initBound){etEl._initBound=true;etEl.addEventListener('input',()=>updateExamCountWarn('cf'));}
  const ecEl=document.getElementById('ec-exam-time');
  if(ecEl&&!ecEl._initBound){ecEl._initBound=true;ecEl.addEventListener('input',()=>updateExamCountWarn('ec'));}
};

// â”€â”€ CSV â”€â”€
function csvDl(fn,rows){
  const bom='\uFEFF',csv=bom+rows.map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));a.download=fn;a.click();
}
window.exportLearners=function(){
  const list=allLearners.filter(l=>l.status!=='pending'&&l.status!=='rejected');
  const rows=[['ì„±ëª…','ì•„ì´ë””','ì†Œì†','ë¶€ì„œ','ë“±ê¸‰','ë°°ì •ê°•ì˜ìˆ˜','ì§„ë„(%)','ì ìˆ˜','ìƒíƒœ','ë“±ë¡ì¼']];
  list.forEach(l=>{const st=l.completedStatus||l.status||'-';rows.push([l.name,l._id,l.org||'',l.dept||'',GRADE_LABEL[l.grade||'general']||'-',(l.assignedCourses||[]).length,Math.round((l.progress||0)*100)+'%',l.finalScore!=null?l.finalScore:'',st==='completed'?'ìˆ˜ë£Œ':st==='in_progress'||st==='watched'?'ìˆ˜ê°•ì¤‘':'ë¯¸ì‹œì‘',fmtDate(new Date(l.createdAt||Date.now()))]);});
  csvDl('learners.csv',rows);
};
window.exportCompletions=function(){
  const rows=[['ë°œê¸‰ë²ˆí˜¸','ì„±ëª…','ë“±ê¸‰','ì†Œì†','ê°•ì˜ëª…','ì ìˆ˜','ìˆ˜ë£Œì¼']];
  allCompletions.forEach(c=>rows.push([`ì œ ${c.certNo}í˜¸`,c.name,GRADE_LABEL[c.grade||'general']||'-',c.org||'',c.courseTitle||'',c.score+'ì ',fmtDate(new Date(c.date))]));
  csvDl('completions.csv',rows);
};

// â”€â”€ Boot â”€â”€
loadOverview();
setTimeout(()=>window.initAddCourseForm(),200);
</script>
<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</body>
</html>

